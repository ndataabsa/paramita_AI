<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NP Notebook</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/notebook.css', v='2.7') }}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fff;
            color: #222;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .header {
            background: #1a202c;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 400;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Ï£ºÌîºÌÑ∞ ÎÖ∏Ìä∏Î∂Å Ïä§ÌÉÄÏùº Î†àÏù¥ÏïÑÏõÉ */
        .jupyter-layout {
            display: flex;
            height: calc(100vh - 140px);
            margin-top: 10px;
        }

        /* ÌååÏùº Î∏åÎùºÏö∞Ï†Ä: ÌÉ≠ÏùÑ ÏôºÏ™Ω ÏÑ∏Î°úÎ°ú */
        .file-browser-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            overflow: hidden;
            height: 100%;
        }
        .sidebar-tabs {
            width: 40px;
            background: #f5f6fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        .sidebar-tab {
            width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }
        .sidebar-tab.active {
            color: #222;
            background: #fff;
            border-right: 3px solid #999;
        }
        .sidebar-tab:hover {
            color: #222;
            background: #fff;
        }
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-panel {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        .sidebar-panel.active {
            display: flex;
        }

        .file-browser-header {
            background: #fff;
            padding: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-browser-header h3 {
            margin: 0 0 0.5rem 0;
            color: #222;
            font-size: 1rem;
        }

        .file-browser-controls {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .file-browser-controls .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
            color: #222;
        }

        .search-box::placeholder {
            color: #999;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            max-height: calc(100vh - 280px);
        }
        .file-tree {
            display: flex !important;
            flex-direction: column !important;
        }
        .file-item {
            display: block !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        .file-row {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
        }
        .file-info {
            display: flex !important;
            align-items: center !important;
            flex: 1 !important;
            min-width: 0 !important;
            overflow: hidden !important;
        }
        .file-actions {
            display: flex !important;
            align-items: center !important;
            color: #111 !important;
        }
        .file-action-btn {
            color: #111 !important;
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* depthÏóê Îî∞Î•∏ Îì§Ïó¨Ïì∞Í∏∞ */
        .file-item[data-depth="1"] { padding-left: 2rem !important; }
        .file-item[data-depth="2"] { padding-left: 3rem !important; }
        .file-item[data-depth="3"] { padding-left: 4rem !important; }
        .file-item[data-depth="4"] { padding-left: 5rem !important; }
        
        /* ÏÖÄ Ï∂úÎ†• Ïä§ÌÉÄÏùº */
        .cell-output-running {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            color: #856404;
        }
        
        .cell-output-new {
            background: #d4edda;
            border-left: 3px solid #28a745;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            white-space: pre-wrap;
            color: #155724;
        }
        .file-item[data-depth="5"] { padding-left: 6rem !important; }

        .file-item.selected {
            background: #f8f9fa !important;
            border-left: 3px solid #999 !important;
        }

        .file-name {
            flex: 1 !important;
            margin-left: 0 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            min-width: 0 !important;
            font-size: 0.85rem !important;
        }

        .folder-toggle {
            cursor: pointer !important;
            color: #666 !important;
            font-size: 0.8rem !important;
            margin-right: 0.3rem !important;
            user-select: none !important;
            flex-shrink: 0 !important;
        }

        .folder-children {
            display: none !important;
            flex-direction: column !important;
            width: 100% !important;
        }

        .folder-children.expanded {
            display: flex !important;
            flex-direction: column !important;
        }

        .file-icon::before {
            margin-right: 0 !important;
        }

        .folder-item .file-icon::before {
            content: "" !important;
        }

        .file-item:not(.folder-item) .file-icon::before {
            content: "" !important;
        }

        .file-action-btn {
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0.2rem !important;
            border-radius: 3px !important;
            color: #666 !important;
            flex-shrink: 0 !important;
        }

        /* ÎÖ∏Ìä∏Î∂Å ÏÖÄ Ïä§ÌÉÄÏùº */
        .notebook-toolbar {
            background: #4a5568;
            border: 1px solid #718096;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ÏÖÄ Ïä§ÌÉÄÏùºÏùÄ CSS ÌååÏùºÏóêÏÑú Í¥ÄÎ¶¨ */

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ÏÖÄ ÏÉÅÌÉú Ïä§ÌÉÄÏùºÏùÄ CSS ÌååÏùºÏóêÏÑú Í¥ÄÎ¶¨ */

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* Î°úÎî© Î∞è ÏóêÎü¨ ÏÉÅÌÉú */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            color: #dc3545;
            padding: 1rem;
            background: #f8d7da;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .success-message {
            color: #155724;
            padding: 1rem;
            background: #d4edda;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .empty-content {
            text-align: center;
            padding: 2rem;
            color: #aaa;
        }

        .empty-content div {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .current-file-info {
            background: #f5f6fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #222;
        }

        .current-file-info span {
            font-weight: 600;
            color: #63b3ed;
        }

        /* ÏÉÅÎã® ÌÉ≠(ÌååÏùº ÌÉ≠) Îçî ÏûëÍ≤å + Ï¢åÏö∞ Ïó¨Î∞± */
        .file-tabs {
            height: 28px;
            font-size: 0.78rem;
            padding-left: 0.5rem;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            background: #f5f6fa;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        .file-tabs-container {
            display: flex;
            align-items: center;
            min-width: 0;
            padding-right: 0.3rem;
        }
        .file-tab {
            display: flex;
            align-items: center;
            background: #f5f6fa;
            color: #222;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 7px 7px 0 0;
            margin: 0 0.18rem;
            padding: 0.18rem 0.7rem 0.18rem 0.5rem;
            font-size: 0.82rem;
            min-width: 40px;
            height: 26px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }
        .file-tab.active {
            background: #fff;
            color: #222;
            border-color: #ddd;
        }
        .file-tab .close-btn {
            margin-left: 0.3rem;
            color: #666;
            font-size: 0.95rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.1rem;
            border-radius: 3px;
        }
        .file-tab .close-btn:hover {
            background: #e0e0e0;
            color: #333;
        }
        /* ÏÖÄ Ìó§Îçî Î≤ÑÌäº */
        .cell-btn {
            font-size: 0.82rem;
            min-width: 1.1rem;
            min-height: 1.1rem;
            padding: 0.08rem 0.18rem;
            margin: 0 0.08rem;
            border-radius: 5px;
            background: #f5f6fa;
            border: 1px solid #e0e0e0;
            color: #222;
            transition: background 0.2s, color 0.2s;
        }
        .cell-btn:hover {
            background: #e2e8f0;
            color: #2b6cb0;
        }
        .cell-actions {
            gap: 0.08rem !important;
        }

        .file-browser-header {
            background: #fff;
            padding: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-browser-header h3 {
            margin: 0 0 0.5rem 0;
            color: #222;
            font-size: 1rem;
        }

        .file-browser-controls {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .file-browser-controls .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
            color: #222;
        }

        .search-box::placeholder {
            color: #999;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            max-height: calc(100vh - 280px);
        }
        .file-tree {
            display: flex !important;
            flex-direction: column !important;
        }
        .file-item {
            display: block !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        .file-row {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
        }
        .file-info {
            display: flex !important;
            align-items: center !important;
            flex: 1 !important;
            min-width: 0 !important;
            overflow: hidden !important;
        }
        .file-actions {
            display: flex !important;
            align-items: center !important;
            color: #111 !important;
        }
        .file-action-btn {
            color: #111 !important;
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* depthÏóê Îî∞Î•∏ Îì§Ïó¨Ïì∞Í∏∞ */
        .file-item[data-depth="1"] { padding-left: 2rem !important; }
        .file-item[data-depth="2"] { padding-left: 3rem !important; }
        .file-item[data-depth="3"] { padding-left: 4rem !important; }
        .file-item[data-depth="4"] { padding-left: 5rem !important; }
        
        /* ÏÖÄ Ï∂úÎ†• Ïä§ÌÉÄÏùº */
        .cell-output-running {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            color: #856404;
        }
        
        .cell-output-new {
            background: #d4edda;
            border-left: 3px solid #28a745;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            white-space: pre-wrap;
            color: #155724;
        }
        .file-item[data-depth="5"] { padding-left: 6rem !important; }

        .file-item.selected {
            background: #f8f9fa !important;
            border-left: 3px solid #999 !important;
        }

        .file-name {
            flex: 1 !important;
            margin-left: 0 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            min-width: 0 !important;
            font-size: 0.85rem !important;
        }

        .folder-toggle {
            cursor: pointer !important;
            color: #666 !important;
            font-size: 0.8rem !important;
            margin-right: 0.3rem !important;
            user-select: none !important;
            flex-shrink: 0 !important;
        }

        .folder-children {
            display: none !important;
            flex-direction: column !important;
            width: 100% !important;
        }

        .folder-children.expanded {
            display: flex !important;
            flex-direction: column !important;
        }

        .file-icon::before {
            margin-right: 0 !important;
        }

        .folder-item .file-icon::before {
            content: "" !important;
        }

        .file-item:not(.folder-item) .file-icon::before {
            content: "" !important;
        }

        .file-action-btn {
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0.2rem !important;
            border-radius: 3px !important;
            color: #666 !important;
            flex-shrink: 0 !important;
        }

        /* ÎÖ∏Ìä∏Î∂Å ÏÖÄ Ïä§ÌÉÄÏùº */
        .notebook-toolbar {
            background: #4a5568;
            border: 1px solid #718096;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ÏÖÄ Ïä§ÌÉÄÏùºÏùÄ CSS ÌååÏùºÏóêÏÑú Í¥ÄÎ¶¨ */

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ÏÖÄ ÏÉÅÌÉú Ïä§ÌÉÄÏùºÏùÄ CSS ÌååÏùºÏóêÏÑú Í¥ÄÎ¶¨ */

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* Î°úÎî© Î∞è ÏóêÎü¨ ÏÉÅÌÉú */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            color: #dc3545;
            padding: 1rem;
            background: #f8d7da;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .success-message {
            color: #155724;
            padding: 1rem;
            background: #d4edda;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .empty-content {
            text-align: center;
            padding: 2rem;
            color: #aaa;
        }

        .empty-content div {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .current-file-info {
            background: #f5f6fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #222;
        }

        .current-file-info span {
            font-weight: 600;
            color: #63b3ed;
        }

        /* ÏÉÅÎã® ÌÉ≠(ÌååÏùº ÌÉ≠) Îçî ÏûëÍ≤å + Ï¢åÏö∞ Ïó¨Î∞± */
        .file-tabs {
            height: 24px;
            font-size: 0.62rem;
            padding-left: 0.2rem;
            margin-bottom: 0.1rem;
        }
        .file-tabs-container {
            min-width: 0;
            padding-right: 0.1rem;
        }
        .file-tab {
            height: 20px;
            min-width: 28px;
            padding: 0.04rem 0.18rem 0.04rem 0.12rem;
            font-size: 0.58rem;
            margin: 0 0.18rem;
            border-radius: 5px 5px 0 0;
        }
        .file-tab .close-btn {
            font-size: 0.7rem;
            margin-left: 0.12rem;
        }

        .file-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .file-tabs::-webkit-scrollbar-track {
            background: #1a202c;
        }

        .file-tabs::-webkit-scrollbar-thumb {
            background: #718096;
            border-radius: 3px;
        }

        .file-tabs::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .file-tab {
            display: flex;
            align-items: center;
            background: #f5f6fa;
            color: #222;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            padding: 0.5rem 1.2rem 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.95rem;
            position: relative;
            transition: background 0.2s, color 0.2s;
        }
        .file-tab.active {
            background: #fff;
            color: #222;
            border-color: #ddd;
        }
        .file-tab .close-btn {
            margin-left: 0.7rem;
            color: #666;
            font-size: 1.1rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.2rem;
            border-radius: 3px;
        }
        .file-tab .close-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        /* crawl ÏÖÄ Ïä§ÌÉÄÏùº */
        .crawl-cell-content {
            padding: 0.5rem;
        }

        .crawl-controls {
            margin-bottom: 1rem;
        }

        .crawl-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .crawl-row label {
            min-width: 100px;
            font-weight: 500;
            color: #222;
            font-size: 0.8rem;
        }

        .crawl-row select,
        .crawl-row input {
            flex: 1;
            padding: 0.5rem 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #000;
            font-size: 0.8rem;
            min-height: 35px;
            transition: all 0.2s ease;
        }

        .crawl-row select:focus,
        .crawl-row input:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            background: #fff;
        }

        .crawl-row select:hover,
        .crawl-row input:hover {
            border-color: #999;
            background: #fff;
        }

        .crawl-params {
            margin-top: 1.5rem;
        }

        .crawl-param-field {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .crawl-param-field label {
            min-width: 120px;
            font-weight: 500;
            color: #222;
            font-size: 0.8rem;
        }

        .crawl-param-field input,
        .crawl-param-field select {
            flex: 1;
            padding: 0.5rem 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #000;
            font-size: 0.8rem;
            min-height: 35px;
            transition: all 0.2s ease;
        }

        .crawl-param-field input:focus,
        .crawl-param-field select:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            background: #fff;
        }

        .crawl-param-field input:hover,
        .crawl-param-field select:hover {
            border-color: #999;
            background: #fff;
        }

        /* JSON Ï∂úÎ†• Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .xml-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .xml-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        /* ÌÜ†Í∏Ä Ïä§ÏúÑÏπò Ïä§ÌÉÄÏùº */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ddd;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: #fff;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #666;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        /* JSON Ï∂úÎ†• ÏÑπÏÖò */
        .xml-output-section {
            margin-top: 1rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 1rem;
        }

        .xml-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .xml-header h4 {
            margin: 0;
            color: #222;
            font-size: 0.9rem;
        }

        .xml-copy-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #e2e8f0;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .xml-copy-btn:hover {
            background: #63b3ed;
            border-color: #63b3ed;
        }

        .xml-output-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.8rem;
            border: 1px solid #718096;
            border-radius: 4px;
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            resize: vertical;
        }

        .xml-output-textarea:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.2);
        }

        /* Crawl ÏÖÄ ÌäπÎ≥Ñ Ïä§ÌÉÄÏùº */
        .crawl-cell-content {
            padding: 1rem;
        }

        .crawl-controls {
            margin-bottom: 1rem;
        }

        .crawl-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            gap: 0.8rem;
        }

        .crawl-row label {
            min-width: 80px;
            font-weight: 500;
            color: #e2e8f0;
        }

        .crawl-row select,
        .crawl-row input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #000;
        }

        .crawl-params {
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .jupyter-layout {
                flex-direction: column;
                height: auto;
            }
            
            .file-browser-sidebar {
                width: 100%;
                height: 300px;
            }
        }

        .crawl-row select,
        .crawl-row input,
        .crawl-param-field input,
        .crawl-param-field select {
            flex: 1;
            padding: 0.4rem 0.7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            color: #000;
            font-size: 0.8rem;
            min-height: 32px;
            transition: all 0.2s ease;
        }

        .crawl-row label,
        .crawl-param-field label {
            font-size: 0.92rem;
            min-width: 90px;
        }



        #currentFileInfo {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 0.7rem 2rem 0.7rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        #notebookCellsWrapper {
            overflow-y: auto;
            flex: 1 1 0%;
            height: auto;
        }

        /* Î≤ÑÌäº ÏïÑÏù¥ÏΩò+ÎùºÎ≤® Íµ¨Ï°∞ - ÌÜµÌï©Îêú .btn Ïä§ÌÉÄÏùº */
        .btn {
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 0.4em;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            gap: 0.5em;
            font-size: 1em;
            transition: all 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }
        .btn .icon {
            display: inline-block;
            font-size: 1.1em;
            min-width: 1.2em;
            text-align: center;
        }
        .btn .label {
            display: inline-block;
            flex: 1;
            text-align: left;
            font-size: 1em;
        }
        
        /* Ïö∞Ï∏° Ìå®ÎÑê Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .right-panel .btn {
            font-size: 0.75rem;
            padding: 0.5em 0.8em;
            margin-bottom: 0.5em;
        }
        
        /* Ïö∞Ï∏° Ìå®ÎÑê Ï†ëÌòîÏùÑ Îïå ÏïÑÏù¥ÏΩòÎßå ÌëúÏãú */
        .right-panel.collapsed .btn .label {
            display: none !important;
        }
        .right-panel.collapsed .btn .icon {
            display: inline-block !important;
            margin-right: 0 !important;
        }
        .right-panel.collapsed .btn {
            padding: 0.4rem !important;
            min-width: 28px !important;
            justify-content: center !important;
            width: auto !important;
        }
        
        /* Ìå®ÎÑê Î≤ÑÌäºÎì§ Î†àÏù¥ÏïÑÏõÉ */
        .panel-btns {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            width: 100%;
        }




        /* ÌÉ≠ ÌÅ¨Í∏∞ Ï†ÅÎãπÌûà ÌÇ§ÏõÄ */
        .file-tabs {
            height: 26px;
            font-size: 0.7rem;
            padding-left: 0.3rem;
            margin-bottom: 0.12rem;
        }
        .file-tabs-container {
            min-width: 0;
            padding-right: 0.15rem;
        }
        .file-tab {
            height: 22px;
            min-width: 28px;
            padding: 0.08rem 0.32rem 0.08rem 0.18rem;
            font-size: 0.68rem;
            margin: 0 0.13rem;
            border-radius: 5px 5px 0 0;
        }
        .file-tab .close-btn {
            font-size: 0.8rem;
            margin-left: 0.13rem;
        }
        /* ÏÖÄ Ìó§Îçî Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .cell-btn {
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.72rem;
            min-width: 0.85rem;
            min-height: 0.85rem;
            padding: 0.03rem 0.13rem;
            margin: 0 0.05rem;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .cell-btn:hover {
            background: #e9ecef;
        }
        .cell-actions {
            gap: 0.05rem !important;
        }
        /* Ïö∞Ï∏° Ìå®ÎÑê Ïä§ÌÉÄÏùº/Íµ¨Ï°∞ ÏõêÎ≥µ */
        .right-panel {
            width: 280px;
            background: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            transition: width 0.2s;
            position: relative;
            flex-shrink: 0;
            min-width: 200px;
            max-width: 600px;
        }
        
        /* Ìå®ÎÑê ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .panel-section {
            margin-bottom: 1.5rem;
            width: 100%;
        }
        
        .panel-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 0.8rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .right-panel.collapsed {
            width: 40px;
            min-width: 40px;
            padding: 0;
            overflow: hidden;
        }
        
        .right-panel.collapsed .right-panel-tabs {
            margin-right: 0;
        }
        .right-panel .panel-section,
        .right-panel .panel-title,
        .right-panel .panel-btns,
        .right-panel #currentFileName,
        .right-panel #kernelStatusDisplay,
        .right-panel #kernelTimeDisplay {
            transition: opacity 0.2s, visibility 0.2s;
        }
        .right-panel.collapsed .panel-section,
        .right-panel.collapsed .panel-title,
        .right-panel.collapsed .panel-btns,
        .right-panel.collapsed #currentFileName,
        .right-panel.collapsed #kernelStatusDisplay,
        .right-panel.collapsed #kernelTimeDisplay {
            opacity: 0 !important;
            visibility: hidden !important;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        
        /* Ïö∞Ï∏° Ìå®ÎÑê ÌÉ≠ Ïä§ÌÉÄÏùº */
        .right-panel-tabs {
            display: flex;
            flex-direction: column;
            width: 40px;
            background: #f5f6fa;
            border-right: 1px solid #e0e0e0;
            margin-right: 10px;
            transition: margin-right 0.2s;
        }
        
        .right-tab {
            width: 100%;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            padding: 5px 0;
        }
        
        .right-tab.active {
            color: #222;
            background: #fff;
            border-right: 3px solid #007bff;
        }
        
        .right-tab:hover {
            color: #222;
            background: #fff;
        }
        
        .right-tab.active {
            color: #222;
            background: #fff;
            border-right: 3px solid #007bff;
            position: relative;
        }
        
        .right-tab.active::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid #007bff;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
        
        .right-tab .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        
        .right-tab .tab-label {
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .right-panel-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            transition: padding 0.2s;
        }
        
        .right-panel.collapsed .right-panel-content {
            padding: 0;
        }
        
        .right-panel-content.active {
            display: block;
        }
        
        /* Ïö∞Ï∏° Ìå®ÎÑê Íµ¨Ï°∞ Î≥ÄÍ≤Ω */
        .right-panel {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            transition: width 0.2s ease;
        }
        
        .right-panel.collapsed .right-panel-content {
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        .right-panel.collapsed .right-panel-tabs {
            opacity: 1 !important;
            visibility: visible !important;
            width: 100%;
        }
        
        /* Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ Ïä§ÌÉÄÏùº */
        .right-panel-resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            cursor: col-resize;
            z-index: 10;
        }
        
        .right-panel-resize-handle:hover {
            background: rgba(0, 123, 255, 0.3);
        }
        
        .right-panel-resize-handle:active {
            background: rgba(0, 123, 255, 0.5);
        }
        
        .right-panel.collapsed .right-panel-resize-handle {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header" style="display:flex;align-items:center;justify-content:center;position:relative;">
        <div class="header-menu" style="position:absolute;left:2rem;top:0;bottom:0;display:flex;align-items:center;">
            <nav class="jupyter-menubar" style="background:transparent;border:none;box-shadow:none;padding:0;">
                <ul class="menu-list" style="display:flex;gap:1.2rem;list-style:none;margin:0;padding:0;height:38px;align-items:center;">
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>File</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">New Notebook</li>
                            <li class="dropdown-item">Open...</li>
                            <li class="dropdown-item">Save</li>
                            <li class="dropdown-item">Save As...</li>
                            <li class="dropdown-item">Download</li>
                            <li class="dropdown-item">Rename</li>
                            <li class="dropdown-item">Close</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Edit</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Undo</li>
                            <li class="dropdown-item">Redo</li>
                            <li class="dropdown-item">Cut Cell</li>
                            <li class="dropdown-item">Copy Cell</li>
                            <li class="dropdown-item">Paste Cell Below</li>
                            <li class="dropdown-item">Delete Cell</li>
                            <li class="dropdown-item">Select All</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>View</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Toggle Toolbar</li>
                            <li class="dropdown-item">Toggle Line Numbers</li>
                            <li class="dropdown-item">Expand All</li>
                            <li class="dropdown-item">Collapse All</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Insert</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Insert Cell Above</li>
                            <li class="dropdown-item">Insert Cell Below</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Cell</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Run Cell</li>
                            <li class="dropdown-item">Run All</li>
                            <li class="dropdown-item">Run Above</li>
                            <li class="dropdown-item">Run Below</li>
                            <li class="dropdown-item">Cell Type: Code</li>
                            <li class="dropdown-item">Cell Type: Markdown</li>
                            <li class="dropdown-item">Cell Type: Raw</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Kernel</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Restart</li>
                            <li class="dropdown-item">Interrupt</li>
                            <li class="dropdown-item">Reconnect</li>
                            <li class="dropdown-item">Shutdown</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Help</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Keyboard Shortcuts</li>
                            <li class="dropdown-item">About</li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <h1 style="flex:1;text-align:center;margin:0;font-size:1.8rem;font-weight:400;">üìì NP Notebook</h1>
        <div class="nav-links" style="position:absolute;right:2rem;top:0;bottom:0;display:flex;align-items:center;gap:1rem;">
            <a href="/" class="nav-link">Ìôà</a>
            <a href="/worker" class="nav-link">Worker</a>
            <a href="/jobs" class="nav-link">Jobs</a>
            <a href="/kernel" class="nav-link">Ïª§ÎÑê</a>
        </div>
    </div>

    <!-- ÌååÏùºÎ≥Ñ ÌÉ≠ Î∞î -->
    <div class="file-tabs" id="fileTabs">
        <div class="file-tabs-container"></div>
    </div>

    <div class="notebook-layout-wrapper" style="display: flex; flex-direction: row; height: calc(100vh - 70px - 44px); min-height:0; width: 100vw;">
      <!-- ÌååÏùº Î∏åÎùºÏö∞Ï†Ä ÏÇ¨Ïù¥ÎìúÎ∞î -->
      <div class="file-browser-sidebar">
        <div class="sidebar-tabs">
          <div class="sidebar-tab active" onclick="switchSidebarTab('fileTreePanel')" title="ÌååÏùº ÌÉêÏÉâÍ∏∞">üìÅ</div>
          <div class="sidebar-tab" onclick="switchSidebarTab('kernelPanel')" title="Ïª§ÎÑê">üß†</div>
        </div>
        <div class="sidebar-content">
          <div id="fileTreePanel" class="sidebar-panel active">
            <div class="file-browser-header">
              <div class="file-browser-controls">
                <button class="btn btn-primary" onclick="refreshFileTree()"><span class="icon">üîÑ</span><span class="label">Í∞±Ïã†</span></button>
                <button class="btn btn-success" onclick="createNewFile()"><span class="icon">üìÑ</span><span class="label">ÏÉà ÌååÏùº</span></button>
                <button class="btn btn-secondary" onclick="uploadFile()"><span class="icon">üì§</span><span class="label">ÏóÖÎ°úÎìú</span></button>
              </div>
              <input type="text" class="search-box" placeholder="ÌååÏùº Í≤ÄÏÉâ..." onkeyup="filterFiles(this.value)">
            </div>
            <div class="file-tree" id="fileTree">
              <div class="loading">
                <div class="spinner"></div>
                ÌååÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
              </div>
            </div>
          </div>
          <div id="kernelPanel" class="sidebar-panel">
            <div class="file-browser-header">
              <h3 style="color: #000000;">üß† Ïª§ÎÑê Í¥ÄÎ¶¨</h3>
            </div>
            <div style="padding: 1rem; color: #000000; font-size: 0.9rem;">
              <div style="margin-bottom: 1rem;">
                <strong>ÌòÑÏû¨ ÌôúÏÑ± Ïª§ÎÑê:</strong><br>
                <span id="currentKernelInfo">ÏóÜÏùå</span>
              </div>
              <div style="margin-bottom: 1rem;">
                <strong>ÌôúÏÑ± Ïª§ÎÑê ÏÉÅÌÉú:</strong><br>
                <span id="kernelStatusText">Ï§ÄÎπÑÎê®</span>
              </div>
              <div style="margin-bottom: 1rem;">
                <strong>Ïó¥Î¶∞ ÌååÏùº:</strong><br>
                <div id="openFilesList" style="font-size: 0.8rem; margin-top: 0.5rem;">
                  ÏóÜÏùå
                </div>
              </div>
              <div style="margin-bottom: 1rem;">
                <strong>Î™®Îì† Ïª§ÎÑê Î™©Î°ù:</strong><br>
                <div id="allKernelsList" style="font-size: 0.8rem; margin-top: 0.5rem;">
                  ÏóÜÏùå
                </div>
              </div>
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #718096;">
                <strong>Ïª§ÎÑê Ï†ïÎ¶¨:</strong><br>
                <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                  <button class="btn btn-warning" onclick="cleanupInactiveKernels()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                    <span class="icon">üßπ</span><span class="label">ÎπÑÌôúÏÑ± Ïª§ÎÑê Ï†ïÎ¶¨</span>
                  </button>
                  <button class="btn btn-danger" onclick="cleanupAllKernels()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                    <span class="icon">üí•</span><span class="label">Î™®Îì† Ïª§ÎÑê Ï†ïÎ¶¨</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ÎÖ∏Ìä∏Î∂Å Î©îÏù∏ ÏòÅÏó≠ -->
      <div class="notebook-main" style="flex: 1 1 0; overflow-y: auto; height: 100%;">
        <div class="notebook-cells-area">
          <div id="notebookCells"></div>
          <div style="height: 200px; padding: 20px; text-align: center; color: #a0aec0; font-size: 0.9rem;">
            <div style="margin-top: 50px;">
              <div style="font-size: 2rem; margin-bottom: 10px;">üìù</div>
              <div>ÎÖ∏Ìä∏Î∂Å ÎÅù</div>
              <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">Îçî ÎßéÏùÄ ÏÖÄÏùÑ Ï∂îÍ∞ÄÌïòÎ†§Î©¥ ÏúÑÏùò ‚ûï Î≤ÑÌäºÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî</div>
            </div>
          </div>
        </div>
      </div>
              <!-- Ïö∞Ï∏° Ìå®ÎÑê -->
      <div class="right-panel" id="rightPanel" style="height: 100vh; position: sticky; top: 0;">
        <div class="right-panel-resize-handle" id="rightPanelResizeHandle"></div>
        
        <!-- Ïö∞Ï∏° Ìå®ÎÑê ÌÉ≠ Íµ¨Ï°∞ -->
        <div class="right-panel-tabs">
          <div class="right-tab active" onclick="switchRightTab('np')" data-tab="np" title="NP Ìå®ÎÑê (ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)">
            <span class="tab-icon">üìì</span>
            <span class="tab-label">NP</span>
          </div>
          <div class="right-tab" onclick="switchRightTab('view')" data-tab="view" title="HTML Î∑∞Ïñ¥ (ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)">
            <span class="tab-icon">üëÅÔ∏è</span>
            <span class="tab-label">view</span>
          </div>
        </div>
        
        <!-- NP Ìå®ÎÑê (Í∏∞Ï°¥ Í∏∞Îä•) -->
        <div class="right-panel-content active" id="npPanel">
          <div class="panel-section">
            <div class="panel-title">ÌååÏùº Ï†ïÎ≥¥</div>
            <span id="currentFileName"></span>
          </div>
          <div class="panel-section">
            <div class="panel-title">Ïª§ÎÑê Ï†úÏñ¥</div>
            <div class="panel-btns">
              <button class="btn btn-primary" onclick="initializeKernel()"><span class="icon">üîÑ</span><span class="label">Ïª§ÎÑê Ï¥àÍ∏∞Ìôî</span></button>
              <button class="btn btn-success" onclick="extendKernelTimeout()"><span class="icon">‚è∞</span><span class="label">12ÏãúÍ∞Ñ Ïó∞Ïû•</span></button>
              <button class="btn btn-danger" onclick="shutdownKernel()"><span class="icon">‚èπÔ∏è</span><span class="label">Ïª§ÎÑê Ï¢ÖÎ£å</span></button>
            </div>
          </div>
          <div class="panel-section">
            <div class="panel-title">ÎÖ∏Ìä∏Î∂Å</div>
            <div class="panel-btns">
              <button class="btn btn-secondary" onclick="saveNotebookToFile()"><span class="icon">üíæ</span><span class="label">ÎÖ∏Ìä∏Î∂Å Ï†ÄÏû•</span></button>
            </div>
          </div>
          <div class="panel-section">
            <div class="panel-title">ÏÉÅÌÉú</div>
            <span id="kernelStatusDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background: #4a5568; border-radius: 4px; color: #000000;">Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±</span>
            <span id="kernelTimeDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background: #2d3748; border-radius: 4px; color: #ffffff; display:block; margin-top:0.5rem;">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: --:--:--</span>
          </div>
        </div>
        
        <!-- view Ìå®ÎÑê (HTML Î∑∞Ïñ¥) -->
        <div class="right-panel-content" id="viewPanel">
          <div id="htmlViewerContainer" style="height: 100%; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span>üìì NP Notebook v1.0</span>
            </div>
            <div class="footer-right">
                <span id="footer-status">copyright paramita ai</span>
            </div>
        </div>
    </footer>

    <!-- Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ -->
    <div class="context-menu" id="contextMenu" style="display: none;">
        <div class="context-menu-item" onclick="openFile()">Ïó¥Í∏∞</div>
        <div class="context-menu-item" onclick="renameFile()">Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="copyFilePath()">Í≤ΩÎ°ú Î≥µÏÇ¨</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteFile()" style="color: #dc3545;">ÏÇ≠Ï†ú</div>
    </div>

    <script src="templates/component/screenshot_monitor/screenshot_monitor.js"></script>

    <script>
        let currentFile = null;
        let fileTreeData = [];
        let selectedFileItem = null;
        let cellCounter = 0;
        let cells = [];
        let openFiles = [];
        let fileCells = {}; // { filePath: [cell, ...] }
        let fileKernels = {}; // { filePath: kernelId }
        let activeFile = null;

        // ÏÖÄ Ïã§Ìñâ ÌÅê ÏãúÏä§ÌÖú
        let cellExecutionQueue = []; // Ïã§Ìñâ ÎåÄÍ∏∞ Ï§ëÏù∏ ÏÖÄÎì§
        let isExecuting = false; // ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ÏßÄ Ïó¨Î∂Ä
        let currentExecutingCell = null; // ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ ÏÖÄ ID

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // ÌååÏùº Î∏åÎùºÏö∞Ï†Ä ÏΩúÎ∞± ÏÑ§Ï†ï
            window.onFileSelect = selectFile;
            
            // ÌÉ≠ ÌÅ¨Í∏∞ Î°úÎìú
            loadTabSizes();
            
            loadFileTree();
            setupEventListeners();
            loadJobTypes();
            
            // ÏÉàÎ°úÍ≥†Ïπ® Ïãú Ïª§ÎÑê ÏÉÅÌÉú Î≥µÏõê
            restoreKernelState();
            
            // ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÏóêÏÑú Í∏∞Î≥∏ ÏÖÄ Ï∂îÍ∞Ä
            if (!activeFile) {
                addCell(); // Ï≤´ Î≤àÏß∏ ÏÖÄ Ï∂îÍ∞Ä
            }
            
            // ÌôúÏÑ± ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ ÏãúÍ∞ÑÏ†úÌïú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            if (activeFile) {
                startKernelTimeUpdate();
            }
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïùò ÌÅ¨Í∏∞ Ï†ÅÏö©
            const activeTab = document.querySelector('.right-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const tabSize = tabSizes[tabName] || 280;
                const rightPanel = document.getElementById('rightPanel');
                rightPanel.style.width = tabSize + 'px';
            }
            
            // checkKernelStatus(); // ÏÑ∏ÏÖò Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ Ï†úÍ±∞
        });
        
        // Job Types Î°úÎìú
        async function loadJobTypes() {
            try {
                const response = await fetch('/api/job_types');
                const data = await response.json();
                window.jobTypes = data.job_types;
                window.focusTypes = data.focus_types;
        
            } catch (error) {
                console.error('Failed to load job types:', error);
            }
        }

        // Í∏∞Ï°¥ ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Ìï®ÏàòÎì§...
        function setupEventListeners() {
            // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ Ïà®Í∏∞Í∏∞
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // ESC ÌÇ§Î°ú Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ Ïà®Í∏∞Í∏∞
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });
            
            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ Ïù¥Î≤§Ìä∏
            const resizeHandle = document.getElementById('rightPanelResizeHandle');
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', startResize);
            }

        }

        // ÏÑúÎ≤ÑÏóêÏÑú ÌôúÏÑ± Ïª§ÎÑê Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        function restoreKernelState() {
            // ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏôÄÏÑú Î≥µÏõê
            fetch('/api/kernels/file-mappings')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.mappings) {
        
                        
                        // ÏÑúÎ≤ÑÏùò Îß§Ìïë Ï†ïÎ≥¥Î•º ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉÅÌÉúÎ°ú Î≥µÏõê
                        fileKernels = data.mappings;
                        
                        // UI ÏóÖÎç∞Ïù¥Ìä∏
                        updateKernelInfo();
                        
                        // Í∞Å ÌååÏùºÏùò Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
                        Object.keys(fileKernels).forEach(filePath => {
                            const kernelId = fileKernels[filePath];

                        });
                    }
                })
                .catch(error => {
                    console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                });
        }

        function loadFileTree() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    fileTreeData = data.files || [];
                    renderFileTree(fileTreeData);
                })
                .catch(error => {
                    console.error('ÌååÏùº Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                    document.getElementById('fileTree').innerHTML = 
                        '<div class="error-message">ÌååÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                });
        }

        function renderFileTree(files) {
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = '';
            if (!files || files.length === 0) {
                fileTree.innerHTML = '<div class="empty-content"><p>ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§</p></div>';
                return;
            }
            files.forEach(file => {
                const fileItem = createFileItemRecursive(file, 0);
                fileTree.appendChild(fileItem);
            });
        }

        function createFileItemRecursive(file, depth = 0) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.setAttribute('data-path', file.path);
            fileItem.setAttribute('data-type', file.type);
            fileItem.setAttribute('data-depth', depth);

            // Ìè¥Îçî/ÌååÏùº ÏïÑÏù¥ÏΩò
            let folderIcon = '';
            if (file.type === 'directory') {
                folderIcon = '<span class="folder-toggle" style="user-select:none;cursor:pointer;">‚ñ∂</span>';
            }

            fileItem.innerHTML = `
                <div class="file-row">
                    <div class="file-info">
                        ${folderIcon}
                        <span class="file-icon"></span>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn" onclick="event.stopPropagation(); showContextMenu(event, '${file.path}')">‚ãÆ</button>
                    </div>
                </div>
            `;

            // Ìè¥Îçî ÌÅ¥Î¶≠ Ïãú children ÌÜ†Í∏Ä
            if (file.type === 'directory') {
                fileItem.addEventListener('click', function(e) {
                    e.stopPropagation(); // Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Ï§ëÎã®
                    if (e.target.classList.contains('folder-toggle')) {
                        const childrenContainer = fileItem.querySelector('.folder-children');
                        const toggle = fileItem.querySelector('.folder-toggle');
                        if (childrenContainer) {
                            const isOpen = childrenContainer.classList.contains('expanded');
                            if (isOpen) {
                                childrenContainer.classList.remove('expanded');
                                toggle.textContent = '‚ñ∂';
                            } else {
                                childrenContainer.classList.add('expanded');
                                toggle.textContent = '‚ñº';
                            }
                        }
                    }
                });
            } else {
                fileItem.addEventListener('click', (e) => {
                    e.stopPropagation(); // Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Ï§ëÎã®
                    selectFile(file);
                });
            }

            fileItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, file.path);
            });

            // childrenÏù¥ ÏûàÏúºÎ©¥ Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú Î†åÎçîÎßÅ, Í∏∞Î≥∏ÏùÄ Îã´Ìûò
            if (file.type === 'directory' && file.children && file.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'folder-children';
                file.children.forEach(child => {
                    const childItem = createFileItemRecursive(child, depth + 1);
                    childrenContainer.appendChild(childItem);
                });
                fileItem.appendChild(childrenContainer);
            }

            return fileItem;
        }

        // ÌååÏùº Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÌååÏùº ÌÅ¥Î¶≠ Ïãú
        function selectFile(file) {
            // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (imageExtensions.includes(fileExtension)) {
                // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù∏ Í≤ΩÏö∞ Î™®Îã¨ÏóêÏÑú Ïù¥ÎØ∏ÏßÄ Î≥¥Ïó¨Ï£ºÍ∏∞
                showImageModal(file);
                return;
            }
            
            // ÌÉ≠Ïù¥ Ïù¥ÎØ∏ Ïó¥Î†§ ÏûàÏúºÎ©¥ Ìï¥Îãπ ÌÉ≠ÏúºÎ°ú Ï†ÑÌôò
            if (openFiles.includes(file.path)) {
                setActiveFileTab(file.path);
                return;
            }
            // ÌÉ≠ Ï∂îÍ∞Ä
            openFiles.push(file.path);
            renderFileTabs();
            setActiveFileTab(file.path);
            
            // ÌååÏùºÎ≥Ñ ÏÉàÎ°úÏö¥ Ïª§ÎÑê ÏÉùÏÑ± Ï†úÍ±∞ - ÏàòÎèôÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω
            // const fileName = file.name.toLowerCase();
            // if (fileName.endsWith('.py') || fileName.endsWith('.ipynb') || fileName.endsWith('.npn')) {
            //     createKernelForFile(file.path);
            // }
            
            // ÌååÏùº ÎÇ¥Ïö© Î°úÎìú Î∞è ÏÖÄ ÏÉùÏÑ±
            fetch(`/api/files/content?path=${encodeURIComponent(file.path)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('ÌååÏùº Î°úÎìú Ïã§Ìå®:', data.message);
                        return;
                    }
                    
                    let cells = [];
                    
                    if (!data.content) {
                        cells.push({ content: '', output: '', status: 'idle', id: null });
                        //fileCells[file.path] = cells;
                        fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));
                        renderNotebookCells();
                        return;
                    }
                    
                    // ipynb/npn ÌååÏùº Ï≤òÎ¶¨
                    if (file.name.endsWith('.ipynb') || file.name.endsWith('.npn')) {
                        try {
                            const notebook = JSON.parse(data.content);
                            if (notebook.cells && Array.isArray(notebook.cells)) {
                                notebook.cells.forEach(cell => {
                                    let content = '';
                                    let cellType = cell.cell_type;
                                    
                                    if (cell.cell_type === 'code') {
                                        const source = cell.source || '';
                                        content = Array.isArray(source) ? source.join('') : source;
                                    } else if (cell.cell_type === 'markdown') {
                                        const source = cell.source || '';
                                        content = `# ${Array.isArray(source) ? source.join('') : source}`;
                                    } else if (cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') {
                                        const source = cell.source || '';
                                        
                                        if (Array.isArray(source)) {
                                            content = source.join('');
                                        } else if (typeof source === 'object' && source !== null) {
                                            content = JSON.stringify(source, null, 2);
                                        } else {
                                            content = source;
                                        }
                                    }
                                    
                                    const cellData = {
                                        content: content, 
                                        output: '', 
                                        status: 'idle', 
                                        id: null,
                                        cell_type: cellType
                                    };
                                    
                                    // ipynb ÌëúÏ§Ä outputsÎ•º output_historyÎ°ú Î≥ÄÌôò
                                    if (cell.outputs && Array.isArray(cell.outputs)) {
                                        cellData.output_history = cell.outputs.map(output => ({
                                            timestamp: new Date().toISOString(),
                                            output: output.text || output.data || '',
                                            execution_count: cell.execution_count || 1
                                        }));
                                    } else if (cell.output_history) {
                                        cellData.output_history = cell.output_history;
                                    }
                                    
                                    cells.push(cellData);
                                });
                            } else {
                                cells.push({ content: data.content, output: '', status: 'idle', id: null });
                            }
                        } catch (e) {
                            cells.push({ content: data.content, output: '', status: 'idle', id: null });
                        }
                    } else {
                        // ÏùºÎ∞ò ÌååÏùº
                        cells.push({ content: data.content, output: '', status: 'idle', id: null });
                    }
                    
                    fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));
                    
                    // crawl ÏÖÄÎì§Ïóê ÏûêÎèô Î≤àÌò∏ Î∂ÄÏó¨
                    cells.forEach((cell, index) => {
                        if ((cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') && (!cell.name || cell.name === '')) {
                            cell.name = `Crawl_${index + 1}`;
                        }
                    });
                    
                    renderNotebookCells();
                    // Îπà ÌååÏùº(0Í∞ú ÏÖÄ)Ïùº Îïå ÏûêÎèôÏúºÎ°ú ÏÖÄ Ï∂îÍ∞Ä
                    if (fileCells[file.path] && fileCells[file.path].length === 0) {
                        activeFile = file.path;
                        addCell();
                    }
                });
        }

        // ÌååÏùºÎ≥Ñ Ïª§ÎÑê ÏÉùÏÑ±
        function createKernelForFile(filePath) {
            
            
            // ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
            const fileName = filePath.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {

                return;
            }
            
            fetch('/api/kernels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}) // Îπà JSON Í∞ùÏ≤¥ Ï∂îÍ∞Ä
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    fileKernels[filePath] = data.kernel_id;
                    const kernelIdStr = typeof data.kernel_id === 'object' ? JSON.stringify(data.kernel_id) : String(data.kernel_id);

                    updateKernelInfo();
                    // Ïª§ÎÑê ÏÉùÏÑ± ÌõÑ ÏÉÅÌÉú ÌôïÏù∏
                    setTimeout(() => checkKernelStatus(), 1000);
                } else {
                    console.error('Ïª§ÎÑê ÏÉùÏÑ± Ïã§Ìå®:', data.error || data.message);
                    alert(`Ïª§ÎÑê ÏÉùÏÑ± Ïã§Ìå®: ${data.error || data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
                }
            })
            .catch(error => {
                console.error('Ïª§ÎÑê ÏÉùÏÑ± Ïò§Î•ò:', error);
                alert(`Ïª§ÎÑê ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
            });
        }

        function renderFileTabs() {
            const fileTabs = document.getElementById('fileTabs');
            const fileTabsContainer = fileTabs.querySelector('.file-tabs-container');
            fileTabsContainer.innerHTML = '';
            openFiles.forEach(path => {
                const tab = document.createElement('div');
                tab.className = 'file-tab' + (activeFile === path ? ' active' : '');
                
                // ÌååÏùºÎ™Ö ÌëúÏãú
                const fileName = path.split('/').pop();
                const hasKernel = fileKernels[path];
                const kernelIcon = hasKernel ? 'üß†' : '‚ö™';
                tab.innerHTML = `<span>${kernelIcon} ${fileName}</span>`;
                
                tab.onclick = () => setActiveFileTab(path);
                // Îã´Í∏∞ Î≤ÑÌäº
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeFileTab(path);
                };
                tab.appendChild(closeBtn);
                fileTabsContainer.appendChild(tab);
            });
        }

        function setActiveFileTab(path) {
            activeFile = path;
            renderFileTabs();
            renderNotebookCells();
            // ÌååÏùºÎ™Ö Î∞è Ï†ÄÏû• Î≤ÑÌäº ÌëúÏãú
            var currentFileInfoElem = document.getElementById('currentFileInfo');
            if (currentFileInfoElem) {
                currentFileInfoElem.style.display = 'flex';
            }
            const fileName = path.split('/').pop();
            
            const hasKernel = fileKernels[path];
            const kernelId = hasKernel ? fileKernels[path] : 'ÏóÜÏùå';
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            document.getElementById('currentFileName').textContent = fileName;
            
            // Ïª§ÎÑê Ï¥àÍ∏∞Ìôî Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const initButton = document.querySelector('#currentFileInfo .btn-primary');
            if (initButton) {
                initButton.innerHTML = hasKernel ? 'üîÑ Ïª§ÎÑê Ïû¨ÏãúÏûë' : 'üîÑ Ïª§ÎÑê Ï¥àÍ∏∞Ìôî';
            }
            
            // ÏÖÄÏù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÏÖÄ Ï∂îÍ∞Ä
            if (!fileCells[path] || fileCells[path].length === 0) {
                addCell();
            }
            
            // Ïª§ÎÑê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÏãúÍ∞ÑÏ†úÌïú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            updateKernelInfo();
            startKernelTimeUpdate();
            
            // ÎÖ∏Ìä∏Î∂Å ÌÉ≠ Î≥ÄÍ≤Ω ÏΩúÎ∞± Ïã§Ìñâ
            executeCallbacks('notebook');
        }

        function closeFileTab(path) {
            const idx = openFiles.indexOf(path);
            if (idx !== -1) {
                openFiles.splice(idx, 1);
                delete fileCells[path];
                
                // Ìï¥Îãπ ÌååÏùºÏùò Ïª§ÎÑê Ï¢ÖÎ£å
                if (fileKernels[path]) {
                    shutdownKernelForFile(path);
                }
                delete fileKernels[path];
                
                // ÌÉ≠ Îã´ÏùÄ ÌõÑ Îã§Î•∏ ÌÉ≠ÏúºÎ°ú Ï†ÑÌôò
                if (openFiles.length > 0) {
                    setActiveFileTab(openFiles[Math.max(0, idx - 1)]);
                } else {
                    activeFile = null;
                    renderFileTabs();
                    document.getElementById('notebookCells').innerHTML = '';
                    document.getElementById('currentFileInfo').style.display = 'none';
                }
                
                // ÎÖ∏Ìä∏Î∂Å ÌÉ≠ Î≥ÄÍ≤Ω ÏΩúÎ∞± Ïã§Ìñâ
                executeCallbacks('notebook');
            }
        }

        // ÌååÏùºÎ≥Ñ Ïª§ÎÑê Ï¢ÖÎ£å
        function shutdownKernelForFile(filePath) {
            const kernelId = fileKernels[filePath];
            if (!kernelId) return;
            
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            if (!confirm(`"${filePath.split('/').pop()}" ÌååÏùºÏùò Ïª§ÎÑêÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            fetch(`/api/kernels/${kernelIdStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `Ïª§ÎÑêÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§: ${filePath.split('/').pop()}`;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞
                    fetch('/api/kernels/file-mapping', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file_path: filePath
                        })
                    })
                    .then(response => response.json())
                    .then(mappingData => {
                        if (!mappingData.success) {
                            console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ Ïã§Ìå®:', mappingData.error);
                        }
                    })
                    .catch(error => {
                        console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ Ïò§Î•ò:', error);
                    });
                    
                    // Ïª§ÎÑê ID Ï†úÍ±∞
                    delete fileKernels[filePath];
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateKernelInfo();
                    
                    // ÎßåÏïΩ Ï¢ÖÎ£åÎêú Ïª§ÎÑêÏù¥ ÌòÑÏû¨ ÌôúÏÑ± ÌååÏùºÏùò Ïª§ÎÑêÏù¥ÏóàÎã§Î©¥
                    if (filePath === activeFile) {
                        document.getElementById('currentKernelInfo').textContent = 'ÏóÜÏùå';
                        document.getElementById('kernelStatusText').textContent = 'Ïª§ÎÑê ÏóÜÏùå';
                    }
                } else {
                    alert(data.message || 'Ïª§ÎÑê Ï¢ÖÎ£åÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Ïª§ÎÑê Ï¢ÖÎ£å Ïò§Î•ò:', error);
                alert('Ïª§ÎÑê Ï¢ÖÎ£åÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function renderNotebookCells() {
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            
            // Î™®Îì† ÏÖÄÏùò textarea ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ÏÖÄ Ï∂îÍ∞Ä Ìï®Ïàò (ÌååÏùºÎ≥Ñ)
        function addCell(content = '', cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: content,
                cell_type: 'code'
            });
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, newCell);
                } else {
                    cells.push(newCell);
                }
            } else {
                cells.push(newCell);
            }
            renderNotebookCells();
            setTimeout(() => {
                const textarea = document.getElementById(newCell.id)?.querySelector('.cell-input');
                if (textarea) textarea.focus();
            }, 50);
            return newCell;
        }

        function addCellAfter(cellId) {
            syncCellContentsToMemory();
            return addCell('', cellId);
        }

        function addCrawlCell(cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const crawlData = {
                job_type: 'do',
                action: 'click',
                params: {
                    focus: '{"xpath": "//button[@id=\'login\']"}',
                    speed: 1.0
                }
            };
            const crawlDataWithDefaults = addDefaultParams(crawlData);
            const cell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: JSON.stringify(crawlDataWithDefaults, null, 2),
                cell_type: 'crawl_ui',
                crawl_data: crawlDataWithDefaults,
                name: `Crawl_${cells.length + 1}`
            });
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, cell);
                } else {
                    cells.push(cell);
                }
            } else {
                cells.push(cell);
            }
            renderNotebookCells();
            setTimeout(() => {
                const newCell = document.getElementById(cell.id);
                if (newCell) {
                    newCell.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
            return cell;
        }

        // ÏÖÄ ÏÉùÏÑ± Ìï®Ïàò (ÌååÏùºÎ≥Ñ)
        function createCellElement(cell, idx) {
            const cellDiv = document.createElement('div');
            cellDiv.className = 'cell';
            cellDiv.id = cell.id;
            
            // ÌòÑÏû¨ ÌååÏùºÏùò ÏÖÄ Í∞úÏàò ÌôïÏù∏
            const currentCells = fileCells[activeFile] || [];
            const isOnlyCell = currentCells.length === 1;
            const isFirstCell = idx === 0;
            const isLastCell = idx === currentCells.length - 1;
            
            // crawl ÌÉÄÏûÖ ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            const isJsonMode = cell.cell_type === 'crawl_json';
            
            // ÏÖÄ Ìó§Îçî Î≤ÑÌäº(Ïã§Ìñâ, Ï∂îÍ∞Ä, ÏÇ≠Ï†ú, ÏúÑ/ÏïÑÎûò Ïù¥Îèô, Î≥µÏÇ¨)
            let cellActionButtons = `
                <button class="cell-btn run" onclick="runCell('${cell.id}')" title="Ïã§Ìñâ">‚ñ∂Ô∏è</button>
                <button class="cell-btn add" onclick="addCell('', '${cell.id}')" title="ÏÖÄ Ï∂îÍ∞Ä">‚ûï</button>
                ${isOnlyCell ? '' : `<button class="cell-btn delete" onclick="deleteCell('${cell.id}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>`}
                <button class="cell-btn copy" onclick="copyCell('${cell.id}')" title="Î≥µÏÇ¨">üìã</button>
                ${!isFirstCell ? `<button class="cell-btn up" onclick="moveCellUp('${cell.id}')" title="ÏúÑÎ°ú Ïù¥Îèô">‚¨ÜÔ∏è</button>` : ''}
                ${!isLastCell ? `<button class="cell-btn down" onclick="moveCellDown('${cell.id}')" title="ÏïÑÎûòÎ°ú Ïù¥Îèô">‚¨áÔ∏è</button>` : ''}
                ${activeFile && activeFile.toLowerCase().endsWith('.npn') ? `<button class="cell-btn add" onclick="addCrawlCell('${cell.id}')" title="ÏàòÏßë Ï∂îÍ∞Ä">üï∑Ô∏è</button>` : ''}
            `;
            
            if (isCrawlCell) {
                cellDiv.innerHTML = `
                    <div class="cell-header" draggable="true" ondragstart="handleCellDragStart(event, '${cell.id}')" ondragover="handleCellDragOver(event)" ondrop="handleCellDrop(event, '${cell.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-drag-handle" style="cursor: grab; margin-right: 0.5em;" title="ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω">
                              <svg width="18" height="18" viewBox="0 0 18 18" style="vertical-align:middle"><circle cx="4" cy="5" r="1.5" fill="#888"/><circle cx="4" cy="9" r="1.5" fill="#888"/><circle cx="4" cy="13" r="1.5" fill="#888"/><circle cx="10" cy="5" r="1.5" fill="#888"/><circle cx="10" cy="9" r="1.5" fill="#888"/><circle cx="10" cy="13" r="1.5" fill="#888"/></svg>
                            </span>
                            <span class="cell-number">Crawl [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            <div class="cell-name-input">
                                <input type="text" id="cell-name-${cell.id}" placeholder="ÏÖÄ Ïù¥Î¶Ñ" value="${cell.name || ''}" onchange="updateCellName('${cell.id}', this.value)" style="width: 120px; padding: 0.3rem 0.5rem; font-size: 0.8rem; border: 1px solid #718096; border-radius: 4px; background: #4a5568; color: #e2e8f0;">
                            </div>
                            <div class="xml-toggle">
                                <label class="switch">
                                    <input type="checkbox" id="xml-toggle-${cell.id}" onchange="toggleJsonOutput('${cell.id}')" ${isJsonMode ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <span class="xml-label">JSON</span>
                            </div>
                            ${cellActionButtons}
                        </div>
                    </div>
                    <div class="crawl-cell-content" id="crawl-controls-${cell.id}" ${isJsonMode ? 'style=\"display: none;\"' : ''}>
                        <div class="crawl-row">
                            <label>Job Type:</label>
                            <select class="crawl-job-type" onchange="updateCrawlCell('${cell.id}', 'job_type', this.value)"></select>
                        </div>
                        <div class="crawl-row">
                            <label id="action-label-${cell.id}">Action:</label>
                            <select class="crawl-action" onchange="updateCrawlCell('${cell.id}', 'action', this.value)"></select>
                        </div>
                        <div class="crawl-params" id="crawl-params-${cell.id}"></div>
                    </div>
                    <div class="xml-output-section" id="xml-output-${cell.id}" ${isJsonMode ? '' : 'style=\"display: none;\"'}>
                        <div class="xml-header">
                            <h4>JSON Ï∂úÎ†•</h4>
                            <button class="xml-copy-btn" onclick="copyJsonOutput('${cell.id}')" title="JSON Î≥µÏÇ¨">üìã</button>
                        </div>
                        <textarea class="xml-output-textarea" id="xml-content-${cell.id}" placeholder="JSON Ï∂úÎ†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..." oninput="updateJsonContent('${cell.id}'); autoResizeTextarea(this)"></textarea>
                    </div>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
                setTimeout(() => {
                    // ÎèôÏ†ÅÏúºÎ°ú job type ÏòµÏÖò ÏÉùÏÑ±
                    const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                    if (jobTypeSelect && window.jobTypes) {
                        jobTypeSelect.innerHTML = '';
                        Object.entries(window.jobTypes).forEach(([key, value]) => {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = value.name || key;
                            jobTypeSelect.appendChild(option);
                        });
                    }
                    initializeCrawlCell(cell.id, cell.content);
                    if (cell.cell_type === 'crawl_json') {
                        setTimeout(() => {
                            const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                            if (jsonTextarea && !jsonTextarea.value.trim()) {
                                generateJsonOutput(cell.id);
                            }
                        }, 100);
                    }
                }, 10);
            } else {
                // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄ
                cellDiv.innerHTML = `
                    <div class="cell-header" draggable="true" ondragstart="handleCellDragStart(event, '${cell.id}')" ondragover="handleCellDragOver(event)" ondrop="handleCellDrop(event, '${cell.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-drag-handle" style="cursor: grab; margin-right: 0.5em;" title="ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω">
                              <svg width="18" height="18" viewBox="0 0 18 18" style="vertical-align:middle"><circle cx="4" cy="5" r="1.5" fill="#888"/><circle cx="4" cy="9" r="1.5" fill="#888"/><circle cx="4" cy="13" r="1.5" fill="#888"/><circle cx="10" cy="5" r="1.5" fill="#888"/><circle cx="10" cy="9" r="1.5" fill="#888"/><circle cx="10" cy="13" r="1.5" fill="#888"/></svg>
                            </span>
                            <span class="cell-number">In [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            ${cellActionButtons}
                        </div>
                    </div>
                    <textarea class="cell-input" placeholder="Python ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeydown="handleKeyDown(event, '${cell.id}')" oninput="autoResizeTextarea(this)">${cell.content}</textarea>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
            }
            setTimeout(() => {
                const textarea = cellDiv.querySelector('.cell-input');
                if (textarea) {
                    autoResizeTextarea(textarea);
                }
                loadCellOutput(cell.id);
            }, 10);
            return cellDiv;
        }

        function autoResizeTextarea(textarea) {
            // ÎÜíÏù¥Î•º Ï¥àÍ∏∞ÌôîÌïòÏó¨ Ï†ïÌôïÌïú Ïä§ÌÅ¨Î°§ ÎÜíÏù¥ Í≥ÑÏÇ∞
            textarea.style.height = 'auto';
            
            // ÎÇ¥Ïö©Ïóê Îî∞Î•∏ ÎÜíÏù¥ Í≥ÑÏÇ∞ (ÏµúÏÜå 100px, ÎùºÏù∏Îãπ ÏïΩ 20px)
            const minHeight = 100;
            const lineHeight = 20;
            const lines = textarea.value.split('\n').length;
            const calculatedHeight = Math.max(minHeight, lines * lineHeight);
            
            // ÎÜíÏù¥ ÏÑ§Ï†ï
            textarea.style.height = calculatedHeight + 'px';
            
            // Ïä§ÌÅ¨Î°§Î∞îÍ∞Ä ÏÉùÍ∏∞ÏßÄ ÏïäÎèÑÎ°ù Ï∂îÍ∞Ä Ï°∞Ï†ï
            if (textarea.scrollHeight > calculatedHeight) {
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }

        // ÏÖÄ output Ï†ÄÏû• Ìï®Ïàò
        function saveCellOutput(cellId, output) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell) {
                // output ÌûàÏä§ÌÜ†Î¶¨ Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî
                if (!cell.output_history) {
                    cell.output_history = [];
                }
                
                // ÏÉàÎ°úÏö¥ outputÏúºÎ°ú ÎçÆÏñ¥Ïì∞Í∏∞ (Ïù¥Ï†Ñ ÌûàÏä§ÌÜ†Î¶¨ Ï†úÍ±∞)
                cell.output_history = [{
                    timestamp: new Date().toISOString(),
                    output: output,
                    execution_count: cell.execution_count || 1
                }];
                
                // ÌååÏùºÏóê Ï†ÄÏû•
                saveNotebookToFile();
            }
        }

        // ÏÖÄ output Î°úÎìú Ìï®Ïàò
        function loadCellOutput(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell && cell.output_history && cell.output_history.length > 0) {
                const outputDiv = document.getElementById(`output-${cellId}`);
                if (outputDiv) {
                    outputDiv.style.display = 'block';
                    
                    // Í∏∞Ï°¥ output Ï†úÍ±∞
                    outputDiv.innerHTML = '';
                    
                    // Í∞ÄÏû• ÏµúÍ∑º outputÎßå ÌëúÏãú (ÎçÆÏñ¥Ïì∞Í∏∞ Î∞©Ïãù)
                    const latestEntry = cell.output_history[cell.output_history.length - 1];
                    const outputEntryDiv = document.createElement('div');
                    outputEntryDiv.className = 'cell-output-new';
                    outputEntryDiv.textContent = latestEntry.output;
                    outputEntryDiv.setAttribute('data-timestamp', latestEntry.timestamp);
                    outputEntryDiv.setAttribute('data-execution-count', latestEntry.execution_count);
                    outputDiv.appendChild(outputEntryDiv);
                }
            }
        }

        function handleKeyDown(event, cellId) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                runCell(cellId);
            } else if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                addCellAfter(cellId);
            } else if (event.key === 's' && event.ctrlKey) {
                event.preventDefault();
                saveNotebookToFile();
            }
        }

        // ÏÖÄ Ïã§Ìñâ ÌÅê Ï≤òÎ¶¨ Ìï®Ïàò
        function processCellQueue() {
            if (isExecuting) {
                return;
            }
            
            if (cellExecutionQueue.length === 0) {
                return;
            }
            
            isExecuting = true;
            const nextCell = cellExecutionQueue.shift();
            currentExecutingCell = nextCell;
            
            // Ïã§Ï†ú ÏÖÄ Ïã§Ìñâ
            executeCell(nextCell);
        }

        // Ïã§Ï†ú ÏÖÄ Ïã§Ìñâ Ìï®Ïàò
        function executeCell(cellId) {
            if (!activeFile) {
                alert('Ïã§ÌñâÌï† ÌååÏùºÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            // ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
            const fileName = activeFile.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                alert('Python ÌååÏùº(.py), Jupyter ÎÖ∏Ìä∏Î∂Å(.ipynb), NPN(.npn) ÌååÏùºÎßå ÏΩîÎìúÎ•º Ïã§ÌñâÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            if (!fileKernels[activeFile]) {
                alert('Ïª§ÎÑêÏù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïª§ÎÑêÏùÑ Ï¥àÍ∏∞ÌôîÌï¥Ï£ºÏÑ∏Ïöî.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) {
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            const outputDiv = document.querySelector(`#output-${cell.id}`);
            const statusSpan = document.querySelector(`#status-${cell.id}`);
            const execSpan = document.querySelector(`#exec-${cell.id}`);

            // crawl ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            
            let code = '';
            
            if (isCrawlCell) {
                // crawl ÏÖÄÏùò Í≤ΩÏö∞ crawl_dataÏóêÏÑú ÏΩîÎìú ÏÉùÏÑ±
                if (!cell.crawl_data) {
                    alert('crawl ÏÖÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÏÖÄÏùÑ Îã§Ïãú ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                    return;
                }
                
                // name inputÏóêÏÑú job name Í∞ÄÏ†∏Ïò§Í∏∞
                const nameInput = document.getElementById(`cell-name-${cellId}`);
                const jobName = nameInput ? nameInput.value.trim() : `crawl_${cellId}`;
                
                // class_job import Î∞è job ÏÑ†Ïñ∏ ÏΩîÎìú ÏÉùÏÑ±
                code = generateCrawlCode(cell.crawl_data, jobName);
            } else {
                // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄÏùò Í≤ΩÏö∞ textareaÏóêÏÑú ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞
                const textarea = document.querySelector(`#${cellId} .cell-input`);
                code = textarea.value.trim();
                if (!code) {
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                    return;
                }
            }

            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ - Ïã§ÌñâÏ§ëÏúºÎ°ú Î≥ÄÍ≤Ω
            cell.status = 'running';
            statusSpan.textContent = 'Ïã§ÌñâÏ§ë...';
            statusSpan.className = 'cell-status running';
            outputDiv.style.display = 'block';
            
            // Í∏∞Ï°¥ output Î™®Îëê ÏßÄÏö∞Í≥† Ïã§ÌñâÏ§ë ÌëúÏãúÎßå Ï∂îÍ∞Ä
            outputDiv.innerHTML = '';
            const runningDiv = document.createElement('div');
            runningDiv.innerHTML = '<div class="spinner"></div> Ïã§ÌñâÏ§ë...';
            runningDiv.className = 'cell-output-running';
            outputDiv.appendChild(runningDiv);
            
            outputDiv.className = 'cell-output';

            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïùò Ïª§ÎÑêÏóê ÏΩîÎìú Ïã§Ìñâ ÏöîÏ≤≠
            const kernelId = fileKernels[activeFile];
            
            // crawl ÏÖÄÏùò Í≤ΩÏö∞ ÏÉùÏÑ±Îêú ÏΩîÎìúÎ•º ÏΩòÏÜîÏóê Ï∂úÎ†•
            if (isCrawlCell) {
                // ÏΩîÎìú Ïã§Ìñâ
            }
            
            fetch(`/api/kernels/${kernelId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cell.status = 'completed';
                    statusSpan.textContent = 'ÏôÑÎ£å';
                    statusSpan.className = 'cell-status completed';
                    outputDiv.className = 'cell-output success';
                    
                    // stdout/result/stderrÎ•º Í≤∞Ìï©ÌïòÏó¨ Ï∂úÎ†•
                    let output = '';
                    
                    if (data.result && data.result.stdout && data.result.stdout.trim() !== '') {
                        output += data.result.stdout;
                    }
                    // resultÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Í≥† 'None'Ïù¥ ÏïÑÎãê ÎïåÎßå Ï∂îÍ∞Ä
                    if (data.result && typeof data.result.result === 'string' && data.result.result.trim() !== '' && data.result.result !== 'None') {
                        if (output) output += '\n';
                        output += data.result.result;
                    }
                    if (data.result && data.result.stderr && data.result.stderr.trim() !== '') {
                        if (output) output += '\n';
                        output += data.result.stderr;
                    }
                    

                    
                    // Ïã§ÌñâÏ§ë ÌëúÏãú Ï†úÍ±∞
                    const runningDiv = outputDiv.querySelector('.cell-output-running');
                    if (runningDiv) {
                        runningDiv.remove();
                    }
                    
                    // ÏÉàÎ°úÏö¥ output Ï∂îÍ∞Ä (Ïù¥Ï†Ñ output Ïú†ÏßÄ)
                    if (output && output.trim() !== '') {
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = output;
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ÏÖÄ Îç∞Ïù¥ÌÑ∞Ïóê output Ï†ÄÏû•
                        saveCellOutput(cellId, output);
                    } else if (!output || output.trim() === '') {
                        // outputÏù¥ ÏóÜÏúºÎ©¥ "Ïã§Ìñâ ÏôÑÎ£å" ÌëúÏãú
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = 'Ïã§Ìñâ ÏôÑÎ£å';
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ÏÖÄ Îç∞Ïù¥ÌÑ∞Ïóê output Ï†ÄÏû•
                        saveCellOutput(cellId, 'Ïã§Ìñâ ÏôÑÎ£å');
                    }
                    
                    console.log('outputDiv ÏÑ§Ï†ï ÌõÑ ÎÇ¥Ïö©:', outputDiv.textContent);
                    execSpan.textContent = `[${data.execution_count || '?'}]`;
                } else {
                    cell.status = 'error';
                    statusSpan.textContent = 'Ïò§Î•ò';
                    statusSpan.className = 'cell-status error';
                    outputDiv.className = 'cell-output error';
                    
                    // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
                    let errorOutput = '';
                    if (data.error) {
                        errorOutput += data.error;
                    }
                    if (data.result && data.result.stderr) {
                        errorOutput += '\n' + data.result.stderr;
                    }
                    
                    outputDiv.textContent = errorOutput || 'Ïã§Ìñâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                }
            })
            .catch(error => {
                cell.status = 'error';
                statusSpan.textContent = 'Ïò§Î•ò';
                statusSpan.className = 'cell-status error';
                outputDiv.className = 'cell-output error';
                outputDiv.textContent = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                console.error('ÏÖÄ Ïã§Ìñâ Ïò§Î•ò:', error);
            })
            .finally(() => {
                // ÏÖÄ Ïã§Ìñâ ÏôÑÎ£å ÌõÑ ÌÅê ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî Î∞è Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                isExecuting = false;
                currentExecutingCell = null;
                
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
            });
        }

        // crawl ÏÖÄÏö© ÏΩîÎìú ÏÉùÏÑ± Ìï®Ïàò
        function generateCrawlCode(crawlData, jobName) {
            const { job_type, action, params } = crawlData;
            
            // Í∏∞Î≥∏ import ÏΩîÎìú
            let code = `import sys\n`;
            code += `import os\n`;
            code += `# ÌîÑÎ°úÏ†ùÌä∏ Î£®Ìä∏ Í≤ΩÎ°úÎ•º ÎèôÏ†ÅÏúºÎ°ú Ï∞æÍ∏∞\n`;
            code += `current_dir = os.getcwd()\n`;
            code += `# CLASSÎÇò MODULE Ìè¥ÎçîÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Í≤ΩÎ°ú ÏÑ§Ï†ï\n`;
            code += `if os.path.exists(os.path.join(current_dir, 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'MODULE'))\n`;
            code += `elif os.path.exists(os.path.join(current_dir, '..', 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'MODULE'))\n`;
            code += `else:\n`;
            code += `    print("CLASS/MODULE Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Í≤ΩÎ°úÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.")\n`;
            code += `    print(f"ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: {current_dir}")\n`;
            code += `from class_job import Job\n\n`;
            
            // shared_dict Ï¥àÍ∏∞Ìôî (Ïª§ÎÑêÏóêÏÑú Í≥µÏö©ÏúºÎ°ú ÏÇ¨Ïö©)
            code += `# Ïª§ÎÑê ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ÏóêÏÑú shared_dict ÏÇ¨Ïö©\n`;
            code += `if 'shared_dict' not in globals():\n`;
            code += `    globals()['shared_dict'] = {}\n`;
            code += `    print("Í≥µÏö© Îç∞Ïù¥ÌÑ∞ ÎîïÏÖîÎÑàÎ¶¨ Ï¥àÍ∏∞ÌôîÎê®")\n`;
            code += `shared_dict = globals()['shared_dict']\n\n`;
            
            // job ÏÑ†Ïñ∏ - nameÏùÄ name inputÏóêÏÑú Í∞ÄÏ†∏Ïò¥
            code += `# ${jobName} - ${job_type} ${action}\n`;
            code += `job_name = "${jobName}"\n`;
            
            // argsÎ•º JSON ÌòïÌÉúÎ°ú Íµ¨ÏÑ± (paramsÏóêÏÑú action Ï†úÍ±∞)
            let args = {
                type: job_type
            };
            
            // paramsÏóêÏÑú action ÌÇ§Î•º Ï†úÏô∏ÌïòÍ≥† Î≥µÏÇ¨
            Object.keys(params).forEach(key => {
                if (key !== 'action') {
                    args[key] = params[key];
                }
            });
            
            // job_typeÏóê Îî∞Îùº actionÏùÑ Ï†ÅÏ†àÌïú ÌååÎùºÎØ∏ÌÑ∞Î°ú Î≥ÄÌôòÌïòÍ≥† paramsÏóêÏÑú action Ï†úÍ±∞
            if (job_type === 'request') {
                args.request_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'find') {
                args.find_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'data') {
                args.convert_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'save') {
                args.save_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'load') {
                args.load_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'python') {
                args.python_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'wait') {
                args.wait_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else if (job_type === 'test') {
                args.test_type = action;
                delete args.action; // action ÌÇ§ Ï†úÍ±∞
            } else {
                // do ÌÉÄÏûÖÏùò Í≤ΩÏö∞ action Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                args.action = action;
            }
            
            code += `# job args Íµ¨ÏÑ±\n`;
            code += `job_args = ${JSON.stringify(args, null, 4)}\n`;
            
            // Job Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Ïã§Ìñâ
            code += `\n# Job Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Ïã§Ìñâ\n`;
            code += `try:\n`;
            code += `    job = Job(job_name, job_args, shared_dict)\n`;
            code += `    result = job.run()\n`;
            code += `    print(f"Job '{job_name}' Ïã§Ìñâ Í≤∞Í≥º: {result}")\n`;
            code += `    # job Í≤∞Í≥ºÎ•º shared_dictÏóê job nameÏùÑ ÌÇ§Î°ú Ï†ÄÏû•\n`;
            code += `    shared_dict[job_name] = result\n`;
            code += `    print(f"Job Í≤∞Í≥ºÍ∞Ä shared_dict['{job_name}']Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.")\n`;
            code += `    if hasattr(result, 'data') and result.data is not None:\n`;
            code += `        print(f"Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞: {result.data}")\n`;
            code += `    if hasattr(result, 'message') and result.message:\n`;
            code += `        print(f"Î©îÏãúÏßÄ: {result.message}")\n`;
            code += `except Exception as e:\n`;
            code += `    print(f"Job Ïã§Ìñâ Ï§ë Ïò§Î•ò Î∞úÏÉù: {str(e)}")\n`;
            code += `    import traceback\n`;
            code += `    traceback.print_exc()\n`;
            code += `\n`;
            code += `print("Job Ïã§Ìñâ ÏôÑÎ£å")\n`;
            
            return code;
        }

        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ÏÇ≠Ï†úÌï† ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }

            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò ÏÖÄÏùÄ Ïú†ÏßÄÌï¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }

            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;

            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            
            // ÏÖÄ Î≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateCellNumbers();
        }

        function updateCellNumbers() {
            cells.forEach((cell, index) => {
                const numberSpan = document.querySelector(`#${cell.id} .cell-number`);
                if (numberSpan) {
                    numberSpan.textContent = `In [${index + 1}]:`;
                }
            });
        }

        function runAllCells() {
            cells.forEach(cell => {
                if (cell.content.trim()) {
                    setTimeout(() => runCell(cell.id), 100);
                }
            });
        }

        function clearAllOutputs() {
            cells.forEach(cell => {
                const outputDiv = document.querySelector(`#output-${cell.id}`);
                if (outputDiv) {
                    outputDiv.style.display = 'none';
                    outputDiv.textContent = '';
                }
                const statusSpan = document.querySelector(`#status-${cell.id}`);
                if (statusSpan) {
                    statusSpan.textContent = 'ÎåÄÍ∏∞Ï§ë';
                    statusSpan.className = 'cell-status';
                }
                const execSpan = document.querySelector(`#exec-${cell.id}`);
                if (execSpan) {
                    execSpan.textContent = '';
                }
            });
        }

        function clearAllCells() {
            if (!confirm('Î™®Îì† ÏÖÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            cells = [];
            document.getElementById('notebookCells').innerHTML = '';
            cellCounter = 0;
            addCell();
        }

        function checkKernelStatus() {
            // Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ ÌôúÏÑ±Ìôî
            console.log('checkKernelStatus Ìò∏Ï∂úÎê®');
            
            console.log('checkKernelStatus Ìò∏Ï∂úÎê® - Ïä§ÌÉù:', new Error().stack);
            
            if (!activeFile || !fileKernels[activeFile]) {
                const statusElement = document.getElementById('kernelStatusText');
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (statusElement) {
                    statusElement.textContent = 'Ïª§ÎÑê ÏóÜÏùå';
                }
                if (displayElement) {
                    displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±';
                    displayElement.style.color = '#a0aec0';
                }
                return;
            }

            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            console.log(`ÌååÏùºÎ≥Ñ Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏: ${activeFile} -> ${kernelIdStr}`);
            
            fetch(`/api/kernels/${kernelIdStr}/status`)
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (data.success) {
                        let statusText = '';
                        let displayText = '';
                        let statusColor = '#a0aec0';
                        
                        if (data.status === 'idle' || data.status === 'ready') {
                            statusText = 'Ï§ÄÎπÑÎê®';
                            displayText = 'Ïª§ÎÑê ÏÉÅÌÉú: ÌôúÏÑ±';
                            statusColor = '#68d391';
                        } else if (data.status === 'busy') {
                            statusText = 'Ïã§ÌñâÏ§ë';
                            displayText = 'Ïª§ÎÑê ÏÉÅÌÉú: Ïã§ÌñâÏ§ë';
                            statusColor = '#f6ad55';
                        } else {
                            statusText = data.status;
                            displayText = `Ïª§ÎÑê ÏÉÅÌÉú: ${data.status}`;
                            statusColor = '#fc8181';
                        }
                        
                        if (statusElement) {
                            statusElement.textContent = statusText;
                        }
                        if (displayElement) {
                            displayElement.textContent = displayText;
                            displayElement.style.color = statusColor;
                        }
                    } else {
                        if (statusElement) {
                            statusElement.textContent = 'Ïò§Î•ò';
                        }
                        if (displayElement) {
                            displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: Ïò§Î•ò';
                            displayElement.style.color = '#fc8181';
                        }
                    }
                })
                .catch(error => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (statusElement) {
                        statusElement.textContent = 'Ïó∞Í≤∞ Ïã§Ìå®';
                    }
                    if (displayElement) {
                        displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: Ïó∞Í≤∞ Ïã§Ìå®';
                        displayElement.style.color = '#fc8181';
                    }
                    console.error('Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®:', error);
                });
        }

        function saveNotebookToFile() {
            console.log('=== saveNotebookToFile Ìò∏Ï∂úÎê® ===');
            
            if (!activeFile) {
                console.log('activeFileÏù¥ ÏóÜÏùå');
                alert('Ï†ÄÏû•Ìï† ÌååÏùºÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            console.log('activeFile:', activeFile);
            console.log('fileCells Ï†ÑÏ≤¥:', fileCells);
            console.log('fileCells[activeFile]:', fileCells[activeFile]);
            
            // ÌòÑÏû¨ ÎÖ∏Ìä∏Î∂ÅÏùò Î™®Îì† ÏÖÄ ÎÇ¥Ïö©ÏùÑ ÏàòÏßë
            const cells = fileCells[activeFile] || [];
            
            // ÎîîÎ≤ÑÍπÖ: Ï†ÄÏû• ÏãúÏûë Ïãú ÏÉÅÌÉú ÌôïÏù∏
            console.log('=== Ï†ÄÏû• ÏãúÏûë ===');
            console.log('activeFile:', activeFile);
            console.log('fileCells:', fileCells);
            console.log('cells Î∞∞Ïó¥:', cells);
            console.log('cells Í∏∏Ïù¥:', cells.length);
            console.log('cells ÌÉÄÏûÖ:', typeof cells);
            console.log('cellsÍ∞Ä Î∞∞Ïó¥Ïù∏Í∞Ä?', Array.isArray(cells));
            
            if (!Array.isArray(cells) || cells.length === 0) {
                console.log('ÏÖÄÏù¥ ÏóÜÍ±∞ÎÇò Î∞∞Ïó¥Ïù¥ ÏïÑÎãò');
                alert('Ï†ÄÏû•Ìï† ÏÖÄÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const notebookContent = [];
            
            cells.forEach(cell => {
                console.log('=== ÏÖÄ Ï≤òÎ¶¨ ÏãúÏûë ===', cell);
                let content = '';
                
                // crawl ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                console.log(`ÏÖÄ ${cell.id} ÌÉÄÏûÖ ÌôïÏù∏:`, {
                    cell_type: cell.cell_type,
                    is_crawl: isCrawlCell,
                    cell_id: cell.id
                });
                
                if (isCrawlCell) {
                    // crawl ÏÖÄÏùò Í≤ΩÏö∞ JSON Î™®Îìú ÎòêÎäî combobox UI Î™®Îìú ÌôïÏù∏
                    const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked; // ÌÜ†Í∏Ä Ïä§ÏúÑÏπò ÏÉÅÌÉúÎ°ú ÌåêÎã®
                    const cellType = isJsonMode ? 'crawl_json' : 'crawl_ui';
                    
                    console.log(`Crawl ÏÖÄ ${cell.id} Ï†ÄÏû• Î™®Îìú ÌôïÏù∏:`, {
                        cell_type: cell.cell_type,
                        has_json_textarea: !!jsonTextarea,
                        has_xml_toggle: !!xmlToggle,
                        toggle_checked: xmlToggle?.checked,
                        is_json_mode: isJsonMode
                    });
                    
                    if (isJsonMode) {
                        // JSON Î™®Îìú: xml-content textareaÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                        content = jsonTextarea.value;
                        console.log(`Crawl ÏÖÄ ${cell.id} JSON Î™®ÎìúÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò¥:`, content.substring(0, 100) + '...');
                    } else {
                        // Combobox UI Î™®Îìú: ÌòÑÏû¨ ÏÑ§Ï†ïÎêú Í∞íÎì§ÏùÑ JSONÏúºÎ°ú Î≥ÄÌôò
                        let crawlData = null;
                        
                        // 1. crawl_dataÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö©
                        if (cell.crawl_data) {
                            crawlData = cell.crawl_data;
                            console.log(`Crawl ÏÖÄ ${cell.id} crawl_data ÏÇ¨Ïö©:`, crawlData);
                        } else {
                            // 2. UI ÏöîÏÜåÏóêÏÑú Í∞íÏùÑ Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÎèÑ
                            const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                            const actionSelect = document.querySelector(`#${cell.id} .crawl-action`);
                            
                            console.log(`Crawl ÏÖÄ ${cell.id} UI ÏöîÏÜå Ï∞æÍ∏∞:`, {
                                jobTypeSelect: !!jobTypeSelect,
                                actionSelect: !!actionSelect,
                                jobTypeValue: jobTypeSelect?.value,
                                actionValue: actionSelect?.value
                            });
                            
                            if (jobTypeSelect && actionSelect) {
                                crawlData = {
                                    job_type: jobTypeSelect.value || 'do',
                                    action: actionSelect.value || '',
                                    params: {}
                                };
                                
                                // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ ÏàòÏßë
                                const paramInputs = document.querySelectorAll(`#${cell.id} input[name], #${cell.id} select[name]`);
                                console.log(`Crawl ÏÖÄ ${cell.id} ÌååÎùºÎØ∏ÌÑ∞ ÏûÖÎ†• ÌïÑÎìú:`, paramInputs.length);
                                
                                paramInputs.forEach(input => {
                                    if (input.name && input.value) {
                                        crawlData.params[input.name] = input.value;
                                        console.log(`ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä: ${input.name} = ${input.value}`);
                                    }
                                });
                                
                                // focus ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
                                const focusInput = document.querySelector(`#${cell.id} input[name="focus"]`);
                                const currentCheckbox = document.querySelector(`#${cell.id} #current-checkbox-${cell.id}`);
                                
                                if (focusInput && currentCheckbox) {
                                    const isCurrent = currentCheckbox.checked;
                                    const focusValue = focusInput.value;
                                    
                                    if (isCurrent) {
                                        crawlData.params.focus = 'current';
                                        console.log(`Focus ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä: current`);
                                    } else if (focusValue) {
                                        crawlData.params.focus = { xpath: focusValue };
                                        console.log(`Focus ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä: xpath = ${focusValue}`);
                                    }
                                }
                                
                                console.log(`Crawl ÏÖÄ ${cell.id} UI Î™®ÎìúÏóêÏÑú ÏÉùÏÑ±Îêú Îç∞Ïù¥ÌÑ∞:`, crawlData);
                            }
                        }
                        
                        if (crawlData) {
                            content = JSON.stringify(crawlData, null, 2);
                            console.log(`Crawl ÏÖÄ ${cell.id} ÏµúÏ¢Ö JSON ÏÉùÏÑ±:`, content);
                        } else {
                            // 3. Î™®Îì† Î∞©Î≤ïÏù¥ Ïã§Ìå®ÌïòÎ©¥ Í∏∞Ï°¥ content ÏÇ¨Ïö©
                            content = cell.content || '';
                            console.log(`Crawl ÏÖÄ ${cell.id} Î™®Îì† Î∞©Î≤ï Ïã§Ìå®, Í∏∞Ï°¥ content ÏÇ¨Ïö©:`, content.substring(0, 100) + '...');
                        }
                    }
                } else {
                    // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄ: cell-input textareaÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content;
                }
                
                // contentÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                if (typeof content !== 'string') {
                    content = String(content);
                }
                
                // ÎîîÎ≤ÑÍπÖ: Í∞Å ÏÖÄÏùò Ï≤òÎ¶¨ Í≥ºÏ†ï Î°úÍ∑∏
                console.log(`ÏÖÄ ${cell.id} Ï≤òÎ¶¨:`, {
                    cell_type: cell.cell_type,
                    is_crawl: isCrawlCell,
                    content_length: content.length,
                    content_preview: content.substring(0, 100) + '...',
                    has_json_textarea: !!document.getElementById(`xml-content-${cell.id}`),
                    json_textarea_display: document.getElementById(`xml-content-${cell.id}`)?.style.display
                });
                
                if (content.trim() !== '') {
                    if (isCrawlCell) {
                        console.log(`Crawl ÏÖÄ ${cell.id} JSON Î∂ÑÌï† ÏãúÏûë:`, content);
                        function splitJsonObjects(jsonStr) {
                            const objects = [];
                            let current = '';
                            let braceCount = 0;
                            let inString = false;
                            let escapeNext = false;
                            for (let i = 0; i < jsonStr.length; i++) {
                                const char = jsonStr[i];
                                if (escapeNext) { current += char; escapeNext = false; continue; }
                                if (char === '\\') { escapeNext = true; current += char; continue; }
                                if (char === '"' && !escapeNext) { inString = !inString; }
                                if (!inString) {
                                    if (char === '{') { if (braceCount === 0) { current = char; } else { current += char; } braceCount++; }
                                    else if (char === '}') { current += char; braceCount--; if (braceCount === 0) { const trimmed = current.trim(); if (trimmed) { objects.push(trimmed); } current = ''; } }
                                    else { if (braceCount > 0) { current += char; } }
                                } else { current += char; }
                            }
                            return objects;
                        }
                        const jsonObjects = splitJsonObjects(content);
                        console.log(`Crawl ÏÖÄ ${cell.id} JSON Î∂ÑÌï† Í≤∞Í≥º:`, {
                            original_length: content.length,
                            split_count: jsonObjects.length,
                            objects: jsonObjects.map((obj, idx) => ({ index: idx, length: obj.length, preview: obj.substring(0, 50) + '...' }))
                        });
                        
                        // JSON Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
                        const xmlToggle2 = document.getElementById(`xml-toggle-${cell.id}`);
                        const isJsonMode2 = xmlToggle2 && xmlToggle2.checked; // ÌÜ†Í∏Ä Ïä§ÏúÑÏπò ÏÉÅÌÉúÎ°ú ÌåêÎã®
                        const cellType = isJsonMode2 ? 'crawl_json' : 'crawl_ui';
                        
                        if (jsonObjects.length > 1) {
                            jsonObjects.forEach((jsonStr, index) => {
                                try {
                                    JSON.parse(jsonStr);
                                    const cellData = { 
                                        cell_type: cellType, 
                                        content: jsonStr, 
                                        metadata: { name: cell.name || '' }, // ÏÖÄ Ïù¥Î¶Ñ Ï†ÄÏû•
                                        output_history: cell.output_history || []
                                    };
                                    notebookContent.push(cellData);
                                    console.log(`Crawl ÏÖÄ ${cell.id} Î∂ÑÌï† ${index + 1} Ï∂îÍ∞ÄÎê® (ÌÉÄÏûÖ: ${cellType}, name: ${cell.name}, output_history: ${cell.output_history ? cell.output_history.length : 0}Í∞ú)`);
                                } catch (parseError) { 
                                    console.error(`Crawl ÏÖÄ ${cell.id} Î∂ÑÌï† ${index + 1} ÌååÏã± Ïã§Ìå®:`, parseError);
                                }
                            });
                        } else {
                            const cellData = { 
                                cell_type: cellType, 
                                content: content, 
                                metadata: { name: cell.name || '' }, // ÏÖÄ Ïù¥Î¶Ñ Ï†ÄÏû•
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            console.log(`Crawl ÏÖÄ ${cell.id} Îã®Ïùº Í∞ùÏ≤¥Î°ú Ï∂îÍ∞ÄÎê® (ÌÉÄÏûÖ: ${cellType}, name: ${cell.name}, output_history: ${cell.output_history ? cell.output_history.length : 0}Í∞ú)`);
                        }
                                            } else {
                            // output_historyÎèÑ Ìï®Íªò Ï†ÄÏû•
                            const cellData = { 
                                cell_type: 'code', 
                                content: content, 
                                metadata: {},
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            console.log(`ÏΩîÎìú ÏÖÄ ${cell.id} Ï∂îÍ∞ÄÎê® (output_history: ${cell.output_history ? cell.output_history.length : 0}Í∞ú)`);
                        }
                } else {
                    console.log(`ÏÖÄ ${cell.id} Îπà ÎÇ¥Ïö©ÏúºÎ°ú Í±¥ÎÑàÎúÄ`);
                }
            });
            // ÎîîÎ≤ÑÍπÖ: Î∂ÑÌï†Îêú notebookContent Ï∂úÎ†•
            console.log('notebookContent:', notebookContent);

            if (notebookContent.length === 0) {
                alert('Ï†ÄÏû•Ìï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // ÌååÏùº ÌôïÏû•ÏûêÏóê Îî∞Îùº Ï†ÄÏû• ÌòïÏãù Í≤∞Ï†ï
            const fileName = activeFile.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();
            console.log('ÌååÏùº ÌôïÏû•Ïûê ÌôïÏù∏:', { fileName, fileExtension, activeFile });
            let contentToSave = '';
            if (fileExtension === 'ipynb') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        execution_count: null, 
                        metadata: item.metadata, 
                        outputs: item.output_history ? item.output_history.map(entry => ({
                            output_type: "stream",
                            name: "stdout",
                            text: entry.output
                        })) : [], 
                        source: item.content
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else if (fileExtension === 'npn') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        metadata: item.metadata, 
                        source: item.content,
                        output_history: item.output_history || []
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else {
                contentToSave = notebookContent.map(item => item.content).join('\n\n');
            }
            // ÎîîÎ≤ÑÍπÖ: Ï†ÄÏû• ÏßÅÏ†Ñ contentToSave Ï∂úÎ†•
            console.log('contentToSave:', contentToSave);

            // ÌååÏùº Ï†ÄÏû• API Ìò∏Ï∂ú
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ path: activeFile, content: contentToSave })
            })
            .then(response => response.json())
            .then(data => {
                // ÎîîÎ≤ÑÍπÖ: Ï†ÄÏû• API ÏùëÎãµ Ï∂úÎ†•
                console.log('save API response:', data);
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ÎÖ∏Ìä∏Î∂ÅÏù¥ "${fileName}"Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // Ï†ÄÏû• ÌõÑ ÏûêÎèô reload Ï†úÍ±∞
                    // checkFileUpdatedAndReload(activeFile, contentToSave);
                    
                } else {
                    alert(data.message || 'ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('ÌååÏùº Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function initializeKernel() {
            if (!activeFile) {
                alert('Ï¥àÍ∏∞ÌôîÌï† ÌååÏùºÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }

            // ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
            const fileName = activeFile.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                alert('Python ÌååÏùº(.py), Jupyter ÎÖ∏Ìä∏Î∂Å(.ipynb), NPN(.npn) ÌååÏùºÎßå Ïª§ÎÑêÏùÑ Ï¥àÍ∏∞ÌôîÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }

            if (!confirm('Ïª§ÎÑêÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? Í∏∞Ï°¥ Ïª§ÎÑêÏù¥ ÏûàÏúºÎ©¥ Ï¢ÖÎ£å ÌõÑ ÏÉà Ïª§ÎÑêÏù¥ ÏÉùÏÑ±Îê©ÎãàÎã§. Î™®Îì† Î≥ÄÏàòÏôÄ Ïã§Ìñâ Í∏∞Î°ùÏù¥ ÏßÄÏõåÏßëÎãàÎã§.')) {
                return;
            }

            const oldKernelId = fileKernels[activeFile];
            // 1. Í∏∞Ï°¥ Ïª§ÎÑêÏù¥ ÏûàÏúºÎ©¥ Ï¢ÖÎ£å
            const shutdownOldKernel = oldKernelId ? fetch(`/api/kernels/${oldKernelId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            }).then(r => r.json()) : Promise.resolve({ success: true });

            // 2. ÏÉà Ïª§ÎÑê ÏÉùÏÑ±
            shutdownOldKernel.then(() => {
                fetch('/api/kernels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) // Îπà JSON Í∞ùÏ≤¥ Ï∂îÍ∞Ä
                })
                .then(response => {
                    console.log('Ïª§ÎÑê Ï¥àÍ∏∞Ìôî ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Ïª§ÎÑê Ï¥àÍ∏∞Ìôî ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data);
                    if (data.success) {
                        fileKernels[activeFile] = data.kernel_id;
                        
                        // ÏÑúÎ≤ÑÏóê ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†ÄÏû•
                        fetch('/api/kernels/file-mapping', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                file_path: activeFile,
                                kernel_id: data.kernel_id
                            })
                        })
                        .then(response => response.json())
                        .then(mappingData => {
                            if (mappingData.success) {
                                console.log('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†ÄÏû• ÏÑ±Í≥µ:', mappingData.message);
                            } else {
                                console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†ÄÏû• Ïã§Ìå®:', mappingData.error);
                            }
                        })
                        .catch(error => {
                            console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†ÄÏû• Ïò§Î•ò:', error);
                        });
                        
                        updateKernelInfo();
                        
                        // Ïª§ÎÑê ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                        const displayElement = document.getElementById('kernelStatusDisplay');
                        if (displayElement) {
                            displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÌôúÏÑ±';
                            displayElement.style.color = '#68d391';
                        }
                        

                        
                        // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                        const successDiv = document.createElement('div');
                        successDiv.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #22543d;
                            color: #9ae6b4;
                            padding: 1rem;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            z-index: 1000;
                            animation: slideIn 0.3s ease;
                        `;
                        successDiv.textContent = 'ÏÉà Ïª§ÎÑêÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.';
                        document.body.appendChild(successDiv);
                        setTimeout(() => {
                            successDiv.style.animation = 'slideOut 0.3s ease';
                            setTimeout(() => {
                                if (successDiv.parentNode) {
                                    successDiv.parentNode.removeChild(successDiv);
                                }
                            }, 300);
                        }, 3000);
                        // Î™®Îì† ÏÖÄÏùò Ï∂úÎ†• ÏßÄÏö∞Í∏∞
                        clearAllOutputs();
                    } else {
                        alert(data.error || data.message || 'Ïª§ÎÑê ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                })
                .catch(error => {
                    console.error('Ïª§ÎÑê ÏÉùÏÑ± Ïã§Ìå®:', error);
                    alert(`Ïª§ÎÑê ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
                });
            });
        }

        function shutdownKernel() {
            if (!activeFile || !fileKernels[activeFile]) {
                alert('Ï¢ÖÎ£åÌï† Ïª§ÎÑêÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            if (!confirm('Ïª§ÎÑêÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† Î≥ÄÏàòÏôÄ Ïã§Ìñâ Í∏∞Î°ùÏù¥ ÏßÄÏõåÏßëÎãàÎã§.')) {
                return;
            }

            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            fetch(`/api/kernels/${kernelIdStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = 'Ïª§ÎÑêÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.';
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);

                    // Î™®Îì† ÏÖÄÏùò Ï∂úÎ†• ÏßÄÏö∞Í∏∞
                    clearAllOutputs();
                    
                    // Ïª§ÎÑê ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    if (displayElement) {
                        displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±';
                        displayElement.style.color = '#a0aec0';
                    }
                    
                    // ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞
                    fetch('/api/kernels/file-mapping', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file_path: activeFile
                        })
                    })
                    .then(response => response.json())
                    .then(mappingData => {
                        if (mappingData.success) {
                            console.log('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ ÏÑ±Í≥µ:', mappingData.message);
                        } else {
                            console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ Ïã§Ìå®:', mappingData.error);
                        }
                    })
                    .catch(error => {
                        console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ Ïò§Î•ò:', error);
                    });
                    
                    // Ïª§ÎÑê ID Ï†úÍ±∞
                    delete fileKernels[activeFile];
                } else {
                    alert(data.message || 'Ïª§ÎÑê Ï¢ÖÎ£åÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Ïª§ÎÑê Ï¢ÖÎ£å Ïã§Ìå®:', error);
                alert('Ïª§ÎÑê Ï¢ÖÎ£åÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function showContextMenu(event, filePath) {
            event.preventDefault();
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥Ïóê ÌååÏùº Í≤ΩÎ°ú Ï†ÄÏû•
            contextMenu.setAttribute('data-file-path', filePath);
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        function openFile() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            const file = fileTreeData.find(f => f.path === filePath);
            if (file) {
                selectFile(file);
            }
            hideContextMenu();
        }

        function refreshFileTree() {
            loadFileTree();
        }

        function filterFiles(searchTerm) {
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const fileName = item.querySelector('.file-name').textContent.toLowerCase();
                if (fileName.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'block'; // ÌëúÏãú
                } else {
                    item.style.display = 'none'; // Ïà®ÍπÄ
                }
            });
        }

        function createNewFile() {
            const fileName = prompt('ÏÉà ÌååÏùº Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: example.npn):');
            if (!fileName) return;

            // .npn ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏
            const isNpnFile = fileName.toLowerCase().endsWith('.npn');
            
            let initialContent = '';
            if (isNpnFile) {
                // .npn ÌååÏùºÏö© ÌÖúÌîåÎ¶ø - Í∏∞Î≥∏Í∞íÏù¥ Ìè¨Ìï®Îêú crawl ÏÖÄ
                const crawlData = {
                    "job_type": "do",
                    "action": "click",
                    "params": {
                        "focus": "{\"xpath\": \"//button[@id='login']\"}",
                        "speed": 1.0
                    }
                };
                
                // Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
                const crawlDataWithDefaults = addDefaultParams(crawlData);
                
                initialContent = JSON.stringify({
                    "cells": [
                        {
                            "cell_type": "crawl_ui",
                            "metadata": {},
                            "source": JSON.stringify(crawlDataWithDefaults, null, 2)
                        }
                    ],
                    "metadata": {
                        "kernelspec": {
                            "display_name": "Python 3",
                            "language": "python",
                            "name": "python3"
                        },
                        "language_info": {
                            "codemirror_mode": {
                                "name": "ipython",
                                "version": 3
                            },
                            "file_extension": ".py",
                            "mimetype": "text/x-python",
                            "name": "python",
                            "nbconvert_exporter": "python",
                            "pygments_lexer": "ipython3",
                            "version": "3.8.0"
                        }
                    },
                    "nbformat": 4,
                    "nbformat_minor": 4
                }, null, 2);
            }

            fetch('/api/files/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: fileName,
                    content: initialContent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFileTree();
                } else {
                    alert(data.message || 'ÌååÏùº ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('ÌååÏùº ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert('ÌååÏùº ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function uploadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadFileTree();
                    } else {
                        alert(data.message || 'ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                })
                .catch(error => {
                    console.error('ÌååÏùº ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                    alert('ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                });
            };
            input.click();
        }

        function renameFile() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            const file = fileTreeData.find(f => f.path === filePath);
            if (!file) return;

            const newName = prompt('ÏÉà Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', file.name);
            if (!newName || newName === file.name) return;

            fetch('/api/files/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    old_path: filePath,
                    new_name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFileTree();
                } else {
                    alert(data.message || 'ÌååÏùº Ïù¥Î¶Ñ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('ÌååÏùº Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
                alert('ÌååÏùº Ïù¥Î¶Ñ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function deleteFile() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            const file = fileTreeData.find(f => f.path === filePath);
            if (!file) return;

            if (!confirm(`Ï†ïÎßêÎ°ú "${file.name}"ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }

            fetch('/api/files/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    path: filePath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFileTree();
                } else {
                    alert(data.message || 'ÌååÏùº ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('ÌååÏùº ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert('ÌååÏùº ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function copyFilePath() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            navigator.clipboard.writeText(filePath).then(() => {
                alert('ÌååÏùº Í≤ΩÎ°úÍ∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
            });
        }

        function switchSidebarTab(panelId) {
            console.log('ÌÉ≠ Ï†ÑÌôò ÏãúÎèÑ:', panelId);
            
            // Î™®Îì† ÌÉ≠Í≥º Ìå®ÎÑê ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
                console.log('ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî:', tab);
            });
            
            document.querySelectorAll('.sidebar-panel').forEach(panel => {
                panel.classList.remove('active');
                console.log('Ìå®ÎÑê ÎπÑÌôúÏÑ±Ìôî:', panel.id);
            });
            
            // ÌÅ¥Î¶≠Îêú ÌÉ≠ ÌôúÏÑ±Ìôî (Ï≤´ Î≤àÏß∏ ÌÉ≠ÏùÄ fileTreePanel, Îëê Î≤àÏß∏ ÌÉ≠ÏùÄ kernelPanel)
            const tabIndex = panelId === 'fileTreePanel' ? 0 : 1;
            const clickedTab = document.querySelectorAll('.sidebar-tab')[tabIndex];
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('ÌÉ≠ ÌôúÏÑ±Ìôî:', panelId);
            }
            
            // Ìï¥Îãπ Ìå®ÎÑê ÌôúÏÑ±Ìôî
            const targetPanel = document.getElementById(panelId);
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Ìå®ÎÑê ÌôúÏÑ±Ìôî:', panelId);
                
                // Ïª§ÎÑê Ìå®ÎÑêÏù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                if (panelId === 'kernelPanel') {
                    updateKernelInfo();
                    // checkKernelStatus(); // Ï†úÍ±∞
                }
            }
        }

        function updateKernelInfo() {
            // ÌòÑÏû¨ ÌôúÏÑ± ÌååÏùºÏùò Ïª§ÎÑê Ï†ïÎ≥¥ ÌëúÏãú
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                document.getElementById('currentKernelInfo').textContent = 
                    `${activeFile.split('/').pop()} (${kernelIdStr})`;
                
                // Ïª§ÎÑê ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÌôúÏÑ±';
                    displayElement.style.color = '#68d391';
                }
                
                // Ïª§ÎÑê Îß§ÎãàÏ†Ä Ìå®ÎÑêÏùò ÏÉÅÌÉú ÌÖçÏä§Ìä∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                const statusTextElement = document.getElementById('kernelStatusText');
                if (statusTextElement) {
                    statusTextElement.textContent = 'Ï§ÄÎπÑÎê®';
                }
                
                // Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                updateKernelTimeDisplay(kernelIdStr);
            } else {
                document.getElementById('currentKernelInfo').textContent = 'ÏóÜÏùå';
                
                // Ïª§ÎÑê ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±';
                    displayElement.style.color = '#a0aec0';
                }
                
                // ÏãúÍ∞ÑÏ†úÌïú ÌëúÏãú Ï¥àÍ∏∞Ìôî
                const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                if (timeDisplayElement) {
                    timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: --:--:--';
                }
            }
            
            // Ïó¥Î¶∞ ÌååÏùº Î™©Î°ù ÌëúÏãú
            const openFilesList = document.getElementById('openFilesList');
            if (openFiles.length > 0) {
                openFilesList.innerHTML = openFiles.map(path => 
                    `<div style="margin-bottom: 0.3rem; ${path === activeFile ? 'color: #63b3ed;' : ''}">${path.split('/').pop()}</div>`
                ).join('');
            } else {
                openFilesList.innerHTML = 'ÏóÜÏùå';
            }
            
            // Î™®Îì† Ïª§ÎÑê Î™©Î°ù ÌëúÏãú
            const allKernelsList = document.getElementById('allKernelsList');
            const kernelEntries = Object.entries(fileKernels);
            if (kernelEntries.length > 0) {
                allKernelsList.innerHTML = kernelEntries.map(([filePath, kernelId]) => {
                    const fileName = filePath.split('/').pop();
                    const isActive = filePath === activeFile;
                    const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                    return `
                        <div style="margin-bottom: 0.5rem; padding: 0.3rem; background: ${isActive ? '#2c5282' : '#4a5568'}; border-radius: 4px; border-left: 3px solid ${isActive ? '#63b3ed' : '#718096'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="${isActive ? 'color: #63b3ed;' : ''}">${fileName}</span>
                                <button onclick="shutdownKernelForFile('${filePath}')" 
                                        style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.7rem; cursor: pointer;">
                                    Ï¢ÖÎ£å
                                </button>
                            </div>
                            <div style="font-size: 0.7rem; color: #a0aec0; margin-top: 0.2rem;">
                                Ïª§ÎÑê ID: ${kernelIdStr}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                allKernelsList.innerHTML = 'ÏóÜÏùå';
            }
        }

        function cleanupInactiveKernels() {
            if (!confirm('12ÏãúÍ∞Ñ Ïù¥ÏÉÅ ÎπÑÌôúÏÑ±Ïù∏ Ïª§ÎÑêÎì§ÏùÑ Ï†ïÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            fetch('/api/kernels/cleanup-inactive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = data.message;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateKernelInfo();
                } else {
                    alert(data.error || 'ÎπÑÌôúÏÑ± Ïª§ÎÑê Ï†ïÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('ÎπÑÌôúÏÑ± Ïª§ÎÑê Ï†ïÎ¶¨ Ïã§Ìå®:', error);
                alert('ÎπÑÌôúÏÑ± Ïª§ÎÑê Ï†ïÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function cleanupAllKernels() {
            if (!confirm('Î™®Îì† Ïª§ÎÑêÏùÑ Ï†ïÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) {
                return;
            }

            fetch('/api/kernels/cleanup-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = data.message;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);

                    // Î™®Îì† Ïª§ÎÑê ID Ï†úÍ±∞
                    fileKernels = {};
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateKernelInfo();
                    
                    // ÌòÑÏû¨ ÌôúÏÑ± ÌååÏùºÏùò Ïª§ÎÑê Ï†ïÎ≥¥ÎèÑ Ï¥àÍ∏∞Ìôî
                    if (activeFile) {
                        document.getElementById('currentKernelInfo').textContent = 'ÏóÜÏùå';
                        document.getElementById('kernelStatusText').textContent = 'Ïª§ÎÑê ÏóÜÏùå';
                        
                        // Ïª§ÎÑê ÏÉÅÌÉú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                        const displayElement = document.getElementById('kernelStatusDisplay');
                        if (displayElement) {
                            displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±';
                            displayElement.style.color = '#a0aec0';
                        }
                    }
                } else {
                    alert(data.error || 'Î™®Îì† Ïª§ÎÑê Ï†ïÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Î™®Îì† Ïª§ÎÑê Ï†ïÎ¶¨ Ïã§Ìå®:', error);
                alert('Î™®Îì† Ïª§ÎÑê Ï†ïÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        // Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Í¥ÄÎ†® Ìï®ÏàòÎì§
        let kernelTimeInterval = null;

        function updateKernelTimeDisplay(kernelId) {
            // ÏÑúÎ≤ÑÏóêÏÑú Ìïú Î≤àÎßå ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            fetch(`/api/kernels/${kernelId}/remaining-time`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.remaining_time) {
                        const remaining = data.remaining_time;
                        const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                        
                        if (remaining.expired) {
                            timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ÎßåÎ£åÎê®';
                            timeDisplayElement.style.background = '#e53e3e';
                            timeDisplayElement.style.color = '#ffffff';
                        } else {
                            const hours = remaining.remaining_hours;
                            const minutes = remaining.remaining_minutes;
                            const seconds = remaining.remaining_seconds_only;
                            
                            timeDisplayElement.textContent = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            // ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e'; // Îπ®Í∞ÑÏÉâ
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e'; // Ï£ºÌô©ÏÉâ
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748'; // Í∏∞Î≥∏ÏÉâ
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: Ïò§Î•ò';
                    timeDisplayElement.style.background = '#e53e3e';
                    timeDisplayElement.style.color = '#ffffff';
                });
        }

        function startKernelTimeUpdate() {
            // Í∏∞Ï°¥ Ïù∏ÌÑ∞Î≤å Ï†ïÎ¶¨
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
            }
            
            // Î®ºÏ†Ä ÏÑúÎ≤ÑÏóêÏÑú ÌòÑÏû¨ ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥Î•º Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                updateKernelTimeDisplay(kernelIdStr);
            }
            
            // Í∑∏ ÌõÑÏóêÎäî ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú 1Ï¥àÏî© Ï§ÑÏù¥Í∏∞
            kernelTimeInterval = setInterval(() => {
                if (activeFile && fileKernels[activeFile]) {
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    const currentText = timeDisplayElement.textContent;
                    
                    if (currentText.includes(':')) {
                        const timeParts = currentText.split(':');
                        
                        if (timeParts.length >= 3) {
                            // ÏãúÍ∞Ñ ÌååÌä∏Í∞Ä 4Í∞úÏù∏ Í≤ΩÏö∞: ['ÎÇ®ÏùÄ ÏãúÍ∞Ñ', ' 11', '58', '42']
                            // ÏãúÍ∞Ñ ÌååÌä∏Í∞Ä 3Í∞úÏù∏ Í≤ΩÏö∞: ['11', '58', '42']
                            let hours, minutes, seconds;
                            
                            if (timeParts.length === 4) {
                                // 4Í∞ú ÌååÌä∏Ïù∏ Í≤ΩÏö∞: ['ÎÇ®ÏùÄ ÏãúÍ∞Ñ', ' 11', '58', '42']
                                hours = parseInt(timeParts[1].trim());
                                minutes = parseInt(timeParts[2]);
                                seconds = parseInt(timeParts[3]);
                            } else {
                                // 3Í∞ú ÌååÌä∏Ïù∏ Í≤ΩÏö∞: ['11', '58', '42']
                                hours = parseInt(timeParts[0].replace('ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ', ''));
                                minutes = parseInt(timeParts[1]);
                                seconds = parseInt(timeParts[2]);
                            }
                            
                            // NaN Ï≤¥ÌÅ¨
                            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                                const kernelId = fileKernels[activeFile];
                                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                                updateKernelTimeDisplay(kernelIdStr);
                                return;
                            }
                            
                            seconds--;
                            if (seconds < 0) {
                                seconds = 59;
                                minutes--;
                                if (minutes < 0) {
                                    minutes = 59;
                                    hours--;
                                    if (hours < 0) {
                                        // ÏãúÍ∞Ñ ÎßåÎ£å
                                        timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ÎßåÎ£åÎê®';
                                        timeDisplayElement.style.background = '#e53e3e';
                                        timeDisplayElement.style.color = '#ffffff';
                                        return;
                                    }
                                }
                            }
                            
                            const newText = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            timeDisplayElement.textContent = newText;
                            
                            // ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748';
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                }
            }, 1000);
        }

        function stopKernelTimeUpdate() {
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
                kernelTimeInterval = null;
            }
        }

        function extendKernelTimeout() {
            if (!activeFile || !fileKernels[activeFile]) {
                alert('ÌôúÏÑ± Ïª§ÎÑêÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            fetch(`/api/kernels/${kernelIdStr}/extend-timeout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    additional_hours: 12
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = 'Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïúÏù¥ 12ÏãúÍ∞Ñ Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§.';
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû• ÌõÑ ÏÑúÎ≤ÑÏóêÏÑú ÏÉàÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞
                    updateKernelTimeDisplay(kernelIdStr);
                } else {
                    alert(data.error || 'Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû• Ïã§Ìå®:', error);
                alert('Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ - Ï†úÍ±∞
        // setInterval(checkKernelStatus, 10000);

        // crawl ÏÖÄ Ï¥àÍ∏∞Ìôî
        function initializeCrawlCell(cellId, content) {
            try {
                let crawlData;
                
                // contentÍ∞Ä Ïù¥ÎØ∏ Í∞ùÏ≤¥Ïù∏ÏßÄ ÌôïÏù∏
                if (typeof content === 'object' && content !== null) {
                    // Ïù¥ÎØ∏ Í∞ùÏ≤¥ÎùºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                    crawlData = content;
                } else {
                    // contentÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                    let contentStr = content;
                    if (typeof content !== 'string') {
                        contentStr = String(content);
                    }
                    
                    // Îπà Î¨∏ÏûêÏó¥Ïù¥Í±∞ÎÇò "[object Object]"Ïù∏ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                    if (!contentStr || contentStr === '[object Object]' || contentStr.trim() === '') {
                        crawlData = { job_type: 'do', action: 'click', params: {} };
                    } else {
                        crawlData = JSON.parse(contentStr);
                    }
                }
                
                // Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
                crawlData = addDefaultParams(crawlData);
                
                const cell = fileCells[activeFile].find(c => c.id === cellId);
                if (cell) {
                    cell.crawl_data = crawlData;
                }
                
                // Job Type ÏÑ§Ï†ï
                const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
                if (jobTypeSelect) {
                    jobTypeSelect.value = crawlData.job_type || 'do';
                    updateCrawlActions(cellId, crawlData.job_type || 'do');
                    
                    // Action ÏÑ§Ï†ï (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                    setTimeout(() => {
                        const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                        if (actionSelect && crawlData.action) {
                            actionSelect.value = crawlData.action;
                            renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                            
                            // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ Î≥µÏõê (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                            setTimeout(() => {
                                if (crawlData.params) {
                                    Object.keys(crawlData.params).forEach(paramName => {
                                        if (paramName === 'focus') {
                                            // focus ÌååÎùºÎØ∏ÌÑ∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨
                                            const focusData = crawlData.params[paramName];
                                            if (typeof focusData === 'object') {
                                                const focusType = Object.keys(focusData)[0];
                                                const focusValue = focusData[focusType];
                                                
                                                const focusTypeSelect = document.querySelector(`#${cellId} select[name="focus_type"]`);
                                                const focusXpathInput = document.querySelector(`#${cellId} input[name="focus_xpath"]`);
                                                
                                                if (focusTypeSelect && focusXpathInput) {
                                                    // focus ÌÉÄÏûÖ ÏÑ§Ï†ï
                                                    focusTypeSelect.value = focusType;
                                                    // xpath Í∞í Î≥µÏõê
                                                    focusXpathInput.value = focusValue;
                                                    console.log(`Focus ÌååÎùºÎØ∏ÌÑ∞ Î≥µÏõê: ${focusType} = ${focusValue}`);
                                                }
                                            }
                                        } else {
                                            const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                            if (paramInput) {
                                                paramInput.value = crawlData.params[paramName];
                                            }
                                        }
                                    });
                                }
                                
                                // XML Ï∂úÎ†•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎã§Î©¥ Ï¥àÍ∏∞ XML ÏÉùÏÑ±
                                const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
                                if (xmlToggle && xmlToggle.checked) {
                                    generateJsonOutput(cellId);
                                    
                                    // JSON textarea ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï
                                    setTimeout(() => {
                                        const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                                        if (jsonTextarea) {
                                            autoResizeTextarea(jsonTextarea);
                                        }
                                    }, 100);
                                }
                            }, 50);
                        }
                    }, 50);
                }
            } catch (e) {
                console.error('Crawl ÏÖÄ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', e);
            }
        }

        // crawl ÏÖÄ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCrawlCell(cellId, field, value) {
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (!cell) return;
            
            if (!cell.crawl_data) {
                cell.crawl_data = { job_type: 'do', action: 'click', params: {} };
            }
            
            if (field === 'job_type') {
                cell.crawl_data.job_type = value;
                cell.crawl_data.action = '';
                cell.crawl_data.params = {};
                updateCrawlActions(cellId, value);
            } else if (field === 'action') {
                cell.crawl_data.action = value;
                renderCrawlParams(cellId, cell.crawl_data.job_type, value);
                
                // actionÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
                cell.crawl_data = addDefaultParams(cell.crawl_data);
            } else if (field.startsWith('param_')) {
                const paramName = field.replace('param_', '');
                cell.crawl_data.params[paramName] = value;
                
                // ÎèôÏ†Å ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨ (key_count, arg_count Î≥ÄÍ≤Ω Ïãú)
                if (paramName === 'key_count' && cell.crawl_data.job_type === 'data' && cell.crawl_data.action === 'key_to_list') {
                    handleKeyCountChange(cellId, value);
                } else if (paramName === 'arg_count' && cell.crawl_data.job_type === 'python' && cell.crawl_data.action === 'file') {
                    handleArgCountChange(cellId, value);
                }
            }
            
            // ÏÖÄ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            cell.content = JSON.stringify(cell.crawl_data, null, 2);
            
            // JSON Ï∂úÎ†•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎã§Î©¥ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            if (xmlToggle && xmlToggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // crawl Ïï°ÏÖò ÏóÖÎç∞Ïù¥Ìä∏ - Î™®Îì† ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
        function updateCrawlActions(cellId, jobType) {
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            if (!actionSelect) return;
            
            actionSelect.innerHTML = '<option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            // Ïï°ÏÖò ÎùºÎ≤® ÎèôÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            const actionLabel = document.getElementById(`action-label-${cellId}`);
            if (actionLabel) {
                const labelMap = {
                    'do': 'Action:',
                    'find': 'Find Type:',
                    'request': 'Request Type:',
                    'data': 'Convert Type:',
                    'save': 'Save Type:',
                    'load': 'Load Type:',
                    'python': 'Python Type:',
                    'wait': 'Wait Type:',
                    'test': 'Test Type:'
                };
                actionLabel.textContent = labelMap[jobType] || 'Action:';
            }
            
            // job_typesÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ïï°ÏÖò Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                
                // jobTypeDataÏóêÏÑú _typesÎÇò actionsÎ°ú ÎÅùÎÇòÎäî ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú Ï∞æÍ∏∞
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    // job ÌÉÄÏûÖÏóê ÎßûÎäî Ï†ïÌôïÌïú Ïï°ÏÖò ÌÉÄÏûÖ ÌÇ§ Ï∞æÍ∏∞
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // Í∏∞Î≥∏Í∞í
                    }
                    
                    const actions = Object.keys(jobTypeData[actionType]);
                    
                    actions.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        // JOB_TYPESÏóêÏÑú nameÏùÑ Í∞ÄÏ†∏Ïò§Í±∞ÎÇò Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                        const actionData = jobTypeData[actionType][action];
                        const displayName = actionData && actionData.name ? actionData.name : action.charAt(0).toUpperCase() + action.slice(1);
                        option.textContent = displayName;
                        actionSelect.appendChild(option);
                    });
                }
            }
            
            // ÌååÎùºÎØ∏ÌÑ∞ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (paramsDiv) {
                paramsDiv.innerHTML = '';
            }
        }

        // crawl ÌååÎùºÎØ∏ÌÑ∞ Î†åÎçîÎßÅ
        function renderCrawlParams(cellId, jobType, action) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            paramsDiv.innerHTML = '';
            
            const params = getCrawlParams(jobType, action);
            params.forEach(param => {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                
                let input;
                if (param.name === 'focus') {
                    // focus ÏΩ§Î≥¥Î∞ïÏä§ (xpath, selector, current)
                    const focusTypeSelect = document.createElement('select');
                    focusTypeSelect.name = 'focus_type';
                    ['xpath', 'selector', 'current'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        focusTypeSelect.appendChild(option);
                    });
                    
                    // xpath ÏûÖÎ†•ÎûÄ (Ìï≠ÏÉÅ Î≥¥ÏûÑ)
                    const focusXpathInput = document.createElement('input');
                    focusXpathInput.name = 'focus_xpath';
                    focusXpathInput.type = 'text';
                    focusXpathInput.placeholder = 'xpath Í∞í (Ïòà: //button[@id="login"])';
                    focusXpathInput.style.marginLeft = '0.5em';
                    
                    // current ÏÑ†ÌÉù Ïãú xpath ÏûÖÎ†•ÎûÄ Ïà®ÍπÄ
                    focusTypeSelect.onchange = (e) => {
                        if (e.target.value === 'current') {
                            focusXpathInput.style.display = 'none';
                        } else {
                            focusXpathInput.style.display = '';
                        }
                    };
                    
                    paramField.appendChild(label);
                    paramField.appendChild(focusTypeSelect);
                    paramField.appendChild(focusXpathInput);
                    paramsDiv.appendChild(paramField);
                    return;
                }
                if (param.type === 'select') {
                    input = document.createElement('select');
                    input.name = param.name;
                    param.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                } else {
                    input = document.createElement('input');
                    input.name = param.name;
                    input.type = param.type || 'text';
                    input.placeholder = param.placeholder || '';
                }
                input.onchange = (e) => {
                    updateCrawlCell(cellId, `param_${param.name}`, e.target.value);
                    if (param.name === 'key_count' && jobType === 'data' && action === 'key_to_list') {
                        handleKeyCountChange(cellId, e.target.value);
                    } else if (param.name === 'arg_count' && jobType === 'python' && action === 'file') {
                        handleArgCountChange(cellId, e.target.value);
                    }
                };
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            });
        }
        
        // key_count Î≥ÄÍ≤Ω Ïãú ÎèôÏ†Å ÌÇ§ ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
        function handleKeyCountChange(cellId, keyCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // Í∏∞Ï°¥ key_ ÌïÑÎìúÎì§ Ï†úÍ±∞
            const existingKeyFields = paramsDiv.querySelectorAll('.dynamic-key-field');
            existingKeyFields.forEach(field => field.remove());
            
            // ÏÉàÎ°úÏö¥ key_ ÌïÑÎìúÎì§ ÏÉùÏÑ±
            for (let i = 0; i < parseInt(keyCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-key-field';
                
                const label = document.createElement('label');
                label.textContent = `Key ${i}`;
                
                const input = document.createElement('input');
                input.name = `key_${i}`;
                input.type = 'text';
                input.placeholder = `data_key_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_key_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }
        
        // arg_count Î≥ÄÍ≤Ω Ïãú ÎèôÏ†Å from_ ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
        function handleArgCountChange(cellId, argCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // Í∏∞Ï°¥ from_ ÌïÑÎìúÎì§ Ï†úÍ±∞
            const existingFromFields = paramsDiv.querySelectorAll('.dynamic-from-field');
            existingFromFields.forEach(field => field.remove());
            
            // ÏÉàÎ°úÏö¥ from_ ÌïÑÎìúÎì§ ÏÉùÏÑ±
            for (let i = 0; i < parseInt(argCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-from-field';
                
                const label = document.createElement('label');
                label.textContent = `From ${i}`;
                
                const input = document.createElement('input');
                input.name = `from_${i}`;
                input.type = 'text';
                input.placeholder = `data_source_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_from_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }

        // ÌååÎùºÎØ∏ÌÑ∞ ÌÉÄÏûÖ Í≤∞Ï†ï Ìï®Ïàò
        function getParamType(param) {
            const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'key_count', 'arg_count', 'time'];
            const selectParams = ['find_range', 'print_result'];
            
            if (selectParams.includes(param)) {
                return 'select';
            } else if (numberParams.includes(param)) {
                return 'number';
            } else {
                return 'text';
            }
        }

        // ÌååÎùºÎØ∏ÌÑ∞ ÏòµÏÖò ÏÉùÏÑ± Ìï®Ïàò
        function getParamOptions(param) {
            if (param === 'find_range') {
                return [
                    { value: 'self', label: 'Self' },
                    { value: 'all', label: 'All' },
                    { value: 'contain', label: 'Contain' },
                    { value: 'first', label: 'First' },
                    { value: 'last', label: 'Last' },
                    { value: 'next', label: 'Next' },
                    { value: 'parent', label: 'Parent' },
                    { value: 'children', label: 'Children' },
                    { value: 'siblings', label: 'Siblings' }
                ];
            } else if (param === 'print_result') {
                return [
                    { value: 'true', label: 'True' },
                    { value: 'false', label: 'False' }
                ];
            }
            return undefined;
        }

        // ÌååÎùºÎØ∏ÌÑ∞ placeholder ÏÉùÏÑ± Ìï®Ïàò
        function getParamPlaceholder(param) {
            const placeholders = {
                'focus': '{"xpath": "//button[@id=\'login\']"}',
                'speed': '1.0',
                'text': 'ÏûÖÎ†•Ìï† ÌÖçÏä§Ìä∏',
                'sleep': '1',
                'max_time': '10',
                'speed_variation': '0.1',
                'value': 'true',
                'find_item': 'main-content',
                'find_attribute': 'data-id',
                'url': 'https://example.com',
                'data': '{"username": "user", "password": "pass"}',
                'wait_time': '2',
                'from': 'extracted_data',
                'to': 'result_data',
                'href_arg': 'https://',
                'text_arg': '\\n',
                'key_count': '3',
                'name': 'result.xlsx',
                'encoding': 'utf-8',
                'script_path': 'process_data.py',
                'arg_count': '2',
                'time': '5',
                'print_result': 'true',
                'filename': 'screenshot.png'
            };
            return placeholders[param] || param;
        }

        // crawl ÌååÎùºÎØ∏ÌÑ∞ Ï†ïÏùò - Î™®Îì† ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
        function getCrawlParams(jobType, action) {
            // JOB_TYPESÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                
                // jobTypeDataÏóêÏÑú _typesÎÇò actionsÎ°ú ÎÅùÎÇòÎäî ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú Ï∞æÍ∏∞
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    // job ÌÉÄÏûÖÏóê ÎßûÎäî Ï†ïÌôïÌïú Ïï°ÏÖò ÌÉÄÏûÖ ÌÇ§ Ï∞æÍ∏∞
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // Í∏∞Î≥∏Í∞í
                    }
                    
                    if (jobTypeData[actionType] && jobTypeData[actionType][action]) {
                        const actionData = jobTypeData[actionType][action];
                        return actionData.params.map(param => ({
                            name: param,
                            label: param.charAt(0).toUpperCase() + param.slice(1).replace('_', ' '),
                            type: getParamType(param),
                            placeholder: getParamPlaceholder(param),
                            options: getParamOptions(param)
                        }));
                    }
                }
            }
            
            // Í∏∞Î≥∏Í∞í (JOB_TYPESÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Îß§Ïπ≠ÎêòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
            const params = {
                'save': {
                    'excel': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'excel' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.xlsx' }
                    ],
                    'csv': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'csv' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'txt' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'mysql' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'load': {
                    'excel': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'excel' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.xlsx' }
                    ],
                    'csv': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'csv' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'txt' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'mysql' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'python': {
                    'file': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'file' },
                        { name: 'script_path', label: 'Script Path', type: 'text', placeholder: 'process_data.py' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' },
                        { name: 'arg_count', label: 'Arg Count', type: 'number', placeholder: '2' }
                    ],
                    'code': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'code' },
                        { name: 'code', label: 'Code', type: 'text', placeholder: 'print(\'Hello World\')' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' }
                    ]
                },
                'wait': {
                    'fixed_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'fixed_time' },
                        { name: 'time', label: 'Time', type: 'number', placeholder: '2.5' }
                    ],
                    'load_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'load_time' }
                    ]
                },
                'test': {
                    'variable': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'variable' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_var' },
                        { name: 'value', label: 'Value', type: 'text', placeholder: 'Hello World' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'list': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'list' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_list' },
                        { name: 'items', label: 'Items', type: 'text', placeholder: 'apple,banana,orange' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'dict': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'dict' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_dict' },
                        { name: 'key_value_pairs', label: 'Key Value Pairs', type: 'text', placeholder: 'name:John,age:25,city:Seoul' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ]
                }
            };
            
            return params[jobType]?.[action] || [];
        }

        // crawl ÏÖÄ Ï∂îÍ∞Ä Ìï®Ïàò
        function addCrawlCell(cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const crawlData = {
                job_type: 'do',
                action: 'click',
                params: {
                    focus: '{"xpath": "//button[@id=\'login\']"}',
                    speed: 1.0
                }
            };
            const crawlDataWithDefaults = addDefaultParams(crawlData);
            const cell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: JSON.stringify(crawlDataWithDefaults, null, 2),
                cell_type: 'crawl_ui',
                crawl_data: crawlDataWithDefaults,
                name: `Crawl_${cells.length + 1}`
            });
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, cell);
                } else {
                    cells.push(cell);
                }
            } else {
                cells.push(cell);
            }
            renderNotebookCells();
            setTimeout(() => {
                const newCell = document.getElementById(cell.id);
                if (newCell) {
                    newCell.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
            return cell;
        }

        // JSON Ï∂úÎ†• ÌÜ†Í∏Ä Ìï®Ïàò
        function toggleJsonOutput(cellId) {
            const jsonSection = document.getElementById(`xml-output-${cellId}`);
            const controlsSection = document.getElementById(`crawl-controls-${cellId}`);
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            
            if (toggle.checked) {
                // JSON Ï∂úÎ†• ÌôúÏÑ±Ìôî: combobox UI Ïà®Í∏∞Í≥† JSON Ï∂úÎ†• ÌëúÏãú
                controlsSection.style.display = 'none';
                jsonSection.style.display = 'block';
                
                // JSON textarea ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï
                setTimeout(() => {
                    const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                    if (jsonTextarea) {
                        // Ïù¥ÎØ∏ ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞ÏßÄ ÏïäÏùå
                        if (!jsonTextarea.value.trim()) {
                            generateJsonOutput(cellId);
                        }
                        autoResizeTextarea(jsonTextarea);
                    }
                }, 100);
            } else {
                // JSON Ï∂úÎ†• ÎπÑÌôúÏÑ±Ìôî: JSON Ï∂úÎ†• Ïà®Í∏∞Í≥† combobox UI ÌëúÏãú
                jsonSection.style.display = 'none';
                controlsSection.style.display = 'block';
            }
        }

        // JSON Ï∂úÎ†• ÏÉùÏÑ± Ìï®Ïàò
        function generateJsonOutput(cellId) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;

            try {
                // crawl ÏÖÄÏùò ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¥
                let crawlData;
                
                // crawl_dataÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö© (UIÏóêÏÑú Î≥ÄÍ≤ΩÎêú Îç∞Ïù¥ÌÑ∞)
                if (cell.crawl_data) {
                    crawlData = cell.crawl_data;
                } else {
                    // crawl_dataÍ∞Ä ÏóÜÏúºÎ©¥ contentÎ•º ÌååÏã±
                    let contentStr = cell.content;
                    
                    // contentÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                    if (typeof contentStr !== 'string') {
                        contentStr = String(contentStr);
                    }
                    
                    if (contentStr) {
                        crawlData = JSON.parse(contentStr);
                    } else {
                        crawlData = { job_type: 'do', action: '', params: {} };
                    }
                }

                // JSON Ï∂úÎ†• ÏòÅÏó≠Ïóê ÌëúÏãú (Í∏∞Î≥∏Í∞í Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÍ≥† Í∑∏ÎåÄÎ°ú ÌëúÏãú)
                const jsonContent = JSON.stringify(crawlData, null, 2);
                
                // JSON Ï∂úÎ†• ÏòÅÏó≠Ïóê ÌëúÏãú
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    // Ïù¥ÎØ∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞ÏßÄ ÏïäÏùå
                    if (!jsonTextarea.value.trim()) {
                        jsonTextarea.value = jsonContent;
                    }
                    autoResizeTextarea(jsonTextarea);
                }
            } catch (error) {
                console.error('JSON ÏÉùÏÑ± Ïò§Î•ò:', error);
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    jsonTextarea.value = `// JSON ÏÉùÏÑ± Ïò§Î•ò: ${error.message}`;
                }
            }
        }

        // ÌååÎùºÎØ∏ÌÑ∞Ïóê Í∏∞Î≥∏Í∞í Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
        function addDefaultParams(crawlData) {
            const jobType = crawlData.job_type || 'do';
            const action = crawlData.action || '';
            
            // Í∏∞Î≥∏ ÌååÎùºÎØ∏ÌÑ∞ Ï†ïÏùò
            const defaultParams = {
                'do': {
                    'click': { focus: '{"xpath": "//button[@id=\'login\']"}', speed: 1.0 },
                    'text': { focus: '{"xpath": "//input[@name=\'username\']"}', text: 'ÏûÖÎ†•Ìï† ÌÖçÏä§Ìä∏', speed: 1.0 },
                    'clear': { focus: '{"xpath": "//input[@name=\'username\']"}', speed: 1.0 },
                    'enter': {},
                    'pagedown': {},
                    'radio': { focus: '{"xpath": "//input[@type=\'radio\']"}', value: 'true' },
                    'scroll': { sleep: 1, max_time: 10, speed_variation: 0.1 },
                    'scroll_to_element': { focus: '{"xpath": "//div[@class=\'content\']"}', sleep: 1, speed: 0.5, speed_variation: 0.1, max_time: 10 }
                },
                'find': {
                    'id': { find_item: 'main-content', find_range: 'first' },
                    'class': { find_item: 'title', find_range: 'first' },
                    'name': { find_item: 'div', find_range: 'first' },
                    'text': { find_item: 'Î°úÍ∑∏Ïù∏', find_range: 'first' },
                    'attribute': { find_attribute: 'data-id', find_item: '123', find_range: 'first' }
                },
                'data': {
                    'to_html': { from: 'extracted_data', to: 'html_data' },
                    'to_xpath': { from: 'extracted_data', to: 'xpath_data' },
                    'to_dataframe': { from: 'extracted_data', to: 'df_data' },
                    'get_href': { from: 'link_data', to: 'href_data', href_arg: 'https://' },
                    'get_hrefs': { from: 'links_data', to: 'hrefs_data', href_arg: 'https://' },
                    'get_text_all': { from: 'html_data', to: 'text_data', text_arg: '\\n' },
                    'get_texts_all': { from: 'html_data', to: 'texts_data', text_arg: '\\n' },
                    'get_text_all_tagonly': { from: 'html_data', to: 'tag_text_data', text_arg: '\\n' },
                    'get_text_all_without_script': { from: 'html_data', to: 'clean_text_data', text_arg: '\\n' },
                    'key_to_list': { to: 'combined_list', key_count: 3 }
                },
                'save': {
                    'excel': { save_type: 'excel', to: 'result_data', name: 'result.xlsx' },
                    'csv': { save_type: 'csv', to: 'result_data', name: 'result.csv', encoding: 'utf-8' },
                    'txt': { save_type: 'txt', to: 'result_data', name: 'result.txt', encoding: 'utf-8' },
                    'mysql': { save_type: 'mysql', to: 'result_data', name: 'crawl_results' },
                    'elasticsearch': { save_type: 'elasticsearch', to: 'result_data', name: 'crawl_index' }
                },
                'load': {
                    'excel': { load_type: 'excel', from: 'loaded_data', name: 'data.xlsx' },
                    'csv': { load_type: 'csv', from: 'loaded_data', name: 'data.csv', encoding: 'utf-8' },
                    'txt': { load_type: 'txt', from: 'loaded_data', name: 'data.txt', encoding: 'utf-8' },
                    'mysql': { load_type: 'mysql', from: 'loaded_data', name: 'crawl_results' },
                    'elasticsearch': { load_type: 'elasticsearch', from: 'loaded_data', name: 'crawl_index' }
                },
                'python': {
                    'file': { python_type: 'file', script_path: 'process_data.py', to: 'result', arg_count: 2 },
                    'code': { python_type: 'code', code: 'print(\'Hello World\')', to: 'result' }
                },
                'wait': {
                    'fixed_time': { wait_type: 'fixed_time', time: 2.5 },
                    'load_time': { wait_type: 'load_time' }
                },
                'request': {
                    'get': { url: 'https://example.com' },
                    'post': { url: 'https://api.example.com', data: '{"username": "user", "password": "pass"}' },
                    'selenium': { url: 'https://example.com', wait_time: 2 }
                },
                'test': {
                    'variable': { test_type: 'variable', name: 'my_var', value: 'Hello World', print_result: 'true' },
                    'list': { test_type: 'list', name: 'my_list', items: 'apple,banana,orange', print_result: 'true' },
                    'dict': { test_type: 'dict', name: 'my_dict', key_value_pairs: 'name:John,age:25,city:Seoul', print_result: 'true' }
                }
            };

            // ÌòÑÏû¨ job_typeÍ≥º actionÏóê ÎåÄÌïú Í∏∞Î≥∏ ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const defaults = defaultParams[jobType]?.[action] || {};
            
            // Í∏∞Ï°¥ ÌååÎùºÎØ∏ÌÑ∞ÏôÄ Í∏∞Î≥∏Í∞í Î≥ëÌï©
            const mergedParams = { ...defaults, ...crawlData.params };
            
            return {
                ...crawlData,
                params: mergedParams
            };
        }

        // JSON ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (ÏàòÏ†ï Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        function updateJsonContent(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            try {
                // JSONÏùÑ ÌååÏã±ÌïòÏó¨ crawl Îç∞Ïù¥ÌÑ∞Î°ú Î≥ÄÌôò
                const jsonContent = jsonTextarea.value.trim();
                
                // Îπà ÎÇ¥Ïö©Ïù¥Î©¥ Î¨¥Ïãú
                if (!jsonContent) {
                    return;
                }
                
                const crawlData = JSON.parse(jsonContent);
                
                // ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                const cells = fileCells[activeFile] || [];
                const cell = cells.find(c => c.id === cellId);
                if (cell) {
                    cell.content = JSON.stringify(crawlData, null, 2);
                    cell.crawl_data = crawlData;
                    
                    // crawl ÏÖÄ UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateCrawlCellFromJson(cellId, crawlData);
                }
            } catch (error) {
                console.error('JSON ÌååÏã± Ïò§Î•ò:', error);
                // Ïò§Î•òÍ∞Ä ÏûàÏñ¥ÎèÑ ÏÇ¨Ïö©ÏûêÍ∞Ä Í≥ÑÏÜç Ìé∏ÏßëÌï† Ïàò ÏûàÎèÑÎ°ù Ìï®
                // Ïò§Î•ò Î©îÏãúÏßÄÎ•º textareaÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            }
        }

        // JSONÏóêÏÑú ÌååÏã±Îêú Îç∞Ïù¥ÌÑ∞Î°ú crawl ÏÖÄ UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateCrawlCellFromJson(cellId, crawlData) {
            // job_type ÏóÖÎç∞Ïù¥Ìä∏
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            if (jobTypeSelect && crawlData.job_type) {
                jobTypeSelect.value = crawlData.job_type;
                // job_typeÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ action ÏòµÏÖòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                updateCrawlActions(cellId, crawlData.job_type);
            }
            
            // action ÏóÖÎç∞Ïù¥Ìä∏ (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
            setTimeout(() => {
                const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                if (actionSelect && crawlData.action) {
                    actionSelect.value = crawlData.action;
                    // actionÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ ÌååÎùºÎØ∏ÌÑ∞ ÌïÑÎìúÎì§ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                    
                    // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ Î≥µÏõê (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                    setTimeout(() => {
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                if (paramInput) {
                                    paramInput.value = crawlData.params[paramName];
                                }
                            });
                        }
                    }, 50);
                }
            }, 50);
        }

        // JSON Ï∂úÎ†• Î≥µÏÇ¨ Ìï®Ïàò
        function copyJsonOutput(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            jsonTextarea.select();
            jsonTextarea.setSelectionRange(0, 99999); // Î™®Î∞îÏùºÏùÑ ÏúÑÌïú ÏÑ§Ï†ï

            try {
                document.execCommand('copy');
                
                // Î≥µÏÇ¨ ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                const copyBtn = document.querySelector(`#xml-output-${cellId} .xml-copy-btn`);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úì Î≥µÏÇ¨Îê®';
                copyBtn.style.background = '#48bb78';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
                alert('JSON Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // crawl ÏÖÄ Ïã§Ìñâ Ïãú JSON Ï∂úÎ†•ÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏
        function runCrawlCell(cellId) {
            // Í∏∞Ï°¥ Ïã§Ìñâ Î°úÏßÅ...
            
            // JSON Ï∂úÎ†•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎã§Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            if (toggle && toggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏ Î∞è reload Ìï®Ïàò
        function checkFileUpdatedAndReload(filePath, expectedContent, retryCount = 0) {
            const maxRetries = 10; // ÏµúÎåÄ 10Î≤à ÏãúÎèÑ
            const retryDelay = 200; // 200ms Í∞ÑÍ≤©
            
            fetch(`/api/files/content?path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ÌååÏùº ÎÇ¥Ïö©Ïù¥ ÏòàÏÉÅÌïú ÎÇ¥Ïö©Í≥º ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏
                        if (data.content === expectedContent) {
                            console.log('ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏Îê®, reload ÏãúÏûë');
                            // ÌååÏùºÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏúºÎØÄÎ°ú reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        } else if (retryCount < maxRetries) {
                            // ÏïÑÏßÅ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏßÄ ÏïäÏïòÏúºÎØÄÎ°ú Îã§Ïãú ÏãúÎèÑ
                            console.log(`ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÎåÄÍ∏∞ Ï§ë... (${retryCount + 1}/${maxRetries})`);
                            setTimeout(() => {
                                checkFileUpdatedAndReload(filePath, expectedContent, retryCount + 1);
                            }, retryDelay);
                        } else {
                            console.log('ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏ Ïã§Ìå®, ÏàòÎèô reload');
                            // ÏµúÎåÄ ÏãúÎèÑ ÌöüÏàòÎ•º Ï¥àÍ≥ºÌñàÏúºÎØÄÎ°ú Í∞ïÏ†ú reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        }
                    } else {
                        console.error('ÌååÏùº ÎÇ¥Ïö© ÌôïÏù∏ Ïã§Ìå®:', data.message);
                        // ÌôïÏù∏ Ïã§Ìå® Ïãú Í∞ïÏ†ú reload
                        const fileName = filePath.split('/').pop();
                        const file = { path: filePath, name: fileName };
                        selectFile(file);
                    }
                })
                .catch(error => {
                    console.error('ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏ Ï§ë Ïò§Î•ò:', error);
                    // Ïò§Î•ò Î∞úÏÉù Ïãú Í∞ïÏ†ú reload
                    const fileName = filePath.split('/').pop();
                    const file = { path: filePath, name: fileName };
                    selectFile(file);
                });
        }

        function renderNotebookCells() {
            syncCellContentsToMemory();
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ÏÖÄ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCellName(cellId, name) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (cell) {
                cell.name = name;
                // ÏÖÄ Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ ÏûêÎèô Ï†ÄÏû•
                setTimeout(() => saveNotebookToFile(), 500);
            }
        }

        // crawl ÏÖÄÏóê ÏûêÎèô Î≤àÌò∏ Î∂ÄÏó¨ÌïòÎäî Ìï®Ïàò
        function renumberCrawlCells() {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cells = fileCells[activeFile];
            cells.forEach((cell, index) => {
                if ((cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') && (!cell.name || cell.name === '')) {
                    cell.name = `Crawl_${index + 1}`;
                }
            });
            
            renderNotebookCells();
            saveNotebook();
        }

        function runCell(cellId) {
            // Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù∏ ÏÖÄÏù¥Î©¥ ÌÅêÏóê Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
            if (currentExecutingCell === cellId) {
                console.log(`ÏÖÄ ${cellId}Îäî Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§.`);
                return;
            }
            
            // Ïù¥ÎØ∏ ÌÅêÏóê ÏûàÎäî ÏÖÄÏù¥Î©¥ Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
            if (cellExecutionQueue.includes(cellId)) {
                console.log(`ÏÖÄ ${cellId}Îäî Ïù¥ÎØ∏ ÌÅêÏóê ÏûàÏäµÎãàÎã§.`);
                return;
            }
            
            // ÌÅêÏóê ÏÖÄ Ï∂îÍ∞Ä
            cellExecutionQueue.push(cellId);
            console.log(`ÏÖÄ ${cellId}Í∞Ä ÌÅêÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§. ÌòÑÏû¨ ÌÅê:`, cellExecutionQueue);
            
            // ÎåÄÍ∏∞Ï§ë ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            const statusSpan = document.querySelector(`#status-${cellId}`);
            if (statusSpan) {
                statusSpan.textContent = 'ÎåÄÍ∏∞Ï§ë';
                statusSpan.className = 'cell-status waiting';
            }
            
            // ÌÅê Ï≤òÎ¶¨ ÏãúÏûë
            processCellQueue();
        }

        // focus ÌååÎùºÎØ∏ÌÑ∞Î•º Ïò¨Î∞îÎ•∏ Íµ¨Ï°∞Î°ú Ï†ÄÏû•
        function updateFocusParam(cellId, focusType, focusValue) {
            let value;
            if (focusType === 'current') {
                value = 'current';
            } else {
                value = {};
                value[focusType] = focusValue;
            }
            updateCrawlCell(cellId, 'param_focus', value);
        }

        // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Î≥¥Ïó¨Ï£ºÍ∏∞
        function showImageModal(file) {
            // Í∏∞Ï°¥ Î™®Îã¨Ïù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <h3>${file.name}</h3>
                        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
                    </div>
                    <div class="image-modal-body">
                        <img src="/api/files/image?path=${encodeURIComponent(file.path)}" alt="${file.name}" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            });
        }

        // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Îã´Í∏∞
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // 1. Cell ÌÅ¥ÎûòÏä§ Ï†ïÏùò
        class Cell {
            constructor({id, content = '', output = '', status = '', cell_type = 'code', crawl_data = null, name = '', output_history = []}) {
                this.id = id;
                this.content = content;
                this.output = output;
                this.status = status;
                this.cell_type = cell_type;
                this.crawl_data = crawl_data;
                this.name = name;
                this.output_history = output_history;
            }

            setContent(content) {
                this.content = content;
            }
            setOutput(output) {
                this.output = output;
            }
            setStatus(status) {
                this.status = status;
            }
            setName(name) {
                this.name = name;
            }
            setCrawlData(crawl_data) {
                this.crawl_data = crawl_data;
            }
            addOutputHistory(entry) {
                this.output_history.push(entry);
            }
        }

        // ... Í∏∞Ï°¥ ÏΩîÎìú ...
        // fileCells = { filePath: [Cell, ...] } ÌòïÌÉúÎ°ú ÏÇ¨Ïö©
        // addCell, createCellElement, renderNotebookCells, deleteCell Îì±ÏóêÏÑú Cell Ïù∏Ïä§ÌÑ¥Ïä§ ÏÇ¨Ïö©

        // ÏòàÏãú: addCell Ìï®Ïàò Î¶¨Ìå©ÌÜ†ÎßÅ
        function addCell(content = '', cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: content,
                cell_type: 'code'
            });
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, newCell);
                } else {
                    cells.push(newCell);
                }
            } else {
                cells.push(newCell);
            }
            renderNotebookCells();
            setTimeout(() => {
                const textarea = document.getElementById(newCell.id)?.querySelector('.cell-input');
                if (textarea) textarea.focus();
            }, 50);
            return newCell;
        }

        function addCellAfter(cellId) {
            syncCellContentsToMemory();
            return addCell('', cellId);
        }

        function addCrawlCell(cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const crawlData = {
                job_type: 'do',
                action: 'click',
                params: {
                    focus: '{"xpath": "//button[@id=\'login\']"}',
                    speed: 1.0
                }
            };
            const crawlDataWithDefaults = addDefaultParams(crawlData);
            const cell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: JSON.stringify(crawlDataWithDefaults, null, 2),
                cell_type: 'crawl_ui',
                crawl_data: crawlDataWithDefaults,
                name: `Crawl_${cells.length + 1}`
            });
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, cell);
                } else {
                    cells.push(cell);
                }
            } else {
                cells.push(cell);
            }
            renderNotebookCells();
            setTimeout(() => {
                const newCell = document.getElementById(cell.id);
                if (newCell) {
                    newCell.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
            return cell;
        }

        function renderNotebookCells() {
            syncCellContentsToMemory();
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ÏòàÏãú: deleteCell Ìï®Ïàò Î¶¨Ìå©ÌÜ†ÎßÅ
        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ÏÇ≠Ï†úÌï† ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò ÏÖÄÏùÄ Ïú†ÏßÄÌï¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;
            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            updateCellNumbers();
        }

        // ÏòàÏãú: createCellElement Ìï®ÏàòÏóêÏÑú cell Ïù∏Ïä§ÌÑ¥Ïä§ ÏÇ¨Ïö©
        // ... Í∏∞Ï°¥ createCellElement Ìï®Ïàò ÎÇ¥ÏóêÏÑú cell.content, cell.status Îì± Ï†ëÍ∑º Î∞©ÏãùÏùÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ ...

        // fileCellsÏóê ÏÖÄÏùÑ Ï∂îÍ∞Ä/Î°úÎìúÌï† ÎïåÎèÑ Cell Ïù∏Ïä§ÌÑ¥Ïä§Î°ú Î≥ÄÌôò
        // Ïòà: ÌååÏùº Î°úÎìú Ïãú
        // fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));

        // ... Í∏∞Ï°¥ ÏΩîÎìú ...

        // ÏÖÄ Ï∂îÍ∞Ä/Î†åÎçîÎßÅ Ï†Ñ textarea Í∞í ÎèôÍ∏∞Ìôî Ìï®Ïàò
        function syncCellContentsToMemory() {
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach(cell => {
                const textarea = document.getElementById(cell.id)?.querySelector('.cell-input');
                if (textarea) {
                    cell.setContent(textarea.value);
                }
            });
        }

        // ÏÖÄ Î≥µÏÇ¨, Ïù¥Îèô Ìï®Ïàò Ï∂îÍ∞Ä
        function copyCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;
            const cell = cells[cellIndex];
            // ÍπäÏùÄ Î≥µÏÇ¨
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: cell.content,
                cell_type: cell.cell_type,
                crawl_data: cell.crawl_data ? JSON.parse(JSON.stringify(cell.crawl_data)) : null,
                name: cell.name ? cell.name + '_Î≥µÏÇ¨' : '',
                output_history: []
            });
            cells.splice(cellIndex + 1, 0, newCell);
            renderNotebookCells();
        }
        function moveCellUp(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex <= 0) return;
            const temp = cells[cellIndex];
            cells[cellIndex] = cells[cellIndex - 1];
            cells[cellIndex - 1] = temp;
            renderNotebookCells();
        }
        function moveCellDown(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex === -1 || cellIndex === cells.length - 1) return;
            const temp = cells[cellIndex];
            cells[cellIndex] = cells[cellIndex + 1];
            cells[cellIndex + 1] = temp;
            renderNotebookCells();
        }



        // ÌÉ≠Î≥Ñ ÌÅ¨Í∏∞ Ï†ÄÏû•ÏÜå
        let tabSizes = {
            'np': 280,
            'view': 320
        };
        
        // Ï†ÄÏû•Îêú ÌÉ≠ ÌÅ¨Í∏∞ Î∂àÎü¨Ïò§Í∏∞
        function loadTabSizes() {
            const savedSizes = localStorage.getItem('rightPanelTabSizes');
            if (savedSizes) {
                tabSizes = { ...tabSizes, ...JSON.parse(savedSizes) };
            }
        }
        
        // ÌÉ≠ ÌÅ¨Í∏∞ Ï†ÄÏû•ÌïòÍ∏∞
        function saveTabSizes() {
            localStorage.setItem('rightPanelTabSizes', JSON.stringify(tabSizes));
        }
        
        // Ïö∞Ï∏° Ìå®ÎÑê ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function switchRightTab(tabName) {
            const rightPanel = document.getElementById('rightPanel');
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`${tabName}Panel`);
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïù¥ ÌÅ¥Î¶≠Îêú Í≤ΩÏö∞ (Ìå®ÎÑê Ï∂ïÏÜå/ÌôïÏû• ÌÜ†Í∏Ä)
            if (selectedTab && selectedTab.classList.contains('active')) {
                if (rightPanel.classList.contains('collapsed')) {
                    // Ï∂ïÏÜåÎêú ÏÉÅÌÉúÏóêÏÑú ÌôïÏû•
                    rightPanel.classList.remove('collapsed');
                    const tabSize = tabSizes[tabName] || 280;
                    rightPanel.style.width = tabSize + 'px';
                } else {
                    // ÌôïÏû•Îêú ÏÉÅÌÉúÏóêÏÑú Ï∂ïÏÜå
                    rightPanel.classList.add('collapsed');
                    rightPanel.style.width = '40px';
                }
                return;
            }
            
            // Îã§Î•∏ ÌÉ≠ÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.right-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.right-panel-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
                
                // Ìå®ÎÑêÏù¥ Ï∂ïÏÜåÎêòÏñ¥ ÏûàÏßÄ ÏïäÏúºÎ©¥ ÌÉ≠Ïóê ÎßûÎäî ÌÅ¨Í∏∞Î°ú Ï°∞Ï†ï
                if (!rightPanel.classList.contains('collapsed')) {
                    const tabSize = tabSizes[tabName] || 280;
                    rightPanel.style.width = tabSize + 'px';
                }
                
                // view ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ HTML Î∑∞Ïñ¥ ÏûêÎèô Î°úÎìú
                if (tabName === 'view') {
                    loadHTMLViewer();
                }
            }
        }

        // HTML Î∑∞Ïñ¥ ÏûêÎèô Î°úÎìú Ìï®Ïàò
        function loadHTMLViewer() {
            const container = document.getElementById('htmlViewerContainer');
            
            if (container && container.innerHTML.trim() === '') {
                // HTML Î∑∞Ïñ¥ Î°úÎìú
                fetch('/templates/component/html_viewer/html_viewer.html')
                    .then(response => response.text())
                    .then(html => {
                        container.innerHTML = html;
                        
                        // JavaScript ÌååÏùº Î°úÎìú
                        const script = document.createElement('script');
                        script.src = '/templates/component/html_viewer/html_viewer.js';
                        document.head.appendChild(script);
                    })
                    .catch(error => {
                        console.error('HTML Î∑∞Ïñ¥ Î°úÎìú Ïã§Ìå®:', error);
                    });
            }
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Í¥ÄÎ†® Î≥ÄÏàò
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à ÏãúÏûë
        function startResize(e) {
            isResizing = true;
            startX = e.clientX;
            const rightPanel = document.getElementById('rightPanel');
            startWidth = rightPanel.offsetWidth;
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ï§ë
        function resize(e) {
            if (!isResizing) return;
            
            const deltaX = startX - e.clientX;
            const newWidth = startWidth + deltaX;
            
            // ÏµúÏÜå/ÏµúÎåÄ ÌÅ¨Í∏∞ Ï†úÌïú
            if (newWidth >= 200 && newWidth <= 600) {
                const rightPanel = document.getElementById('rightPanel');
                rightPanel.style.width = newWidth + 'px';
            }
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ï¢ÖÎ£å
        function stopResize() {
            if (!isResizing) return;
            
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïùò ÌÅ¨Í∏∞ Ï†ÄÏû•
            const activeTab = document.querySelector('.right-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const rightPanel = document.getElementById('rightPanel');
                tabSizes[tabName] = rightPanel.offsetWidth;
                saveTabSizes();
            }
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ìï®Ïàò Ï∂îÍ∞Ä
        let draggedCellId = null;
        function handleCellDragStart(event, cellId) {
            draggedCellId = cellId;
            event.dataTransfer.effectAllowed = 'move';
            // Îπà ÏÖÄ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
            const dragImg = document.createElement('div');
            dragImg.style.width = '350px';
            dragImg.style.height = '60px';
            dragImg.style.background = 'rgba(180,180,180,0.25)';
            dragImg.style.border = '2px dashed #aaa';
            dragImg.style.borderRadius = '8px';
            dragImg.style.display = 'flex';
            dragImg.style.alignItems = 'center';
            dragImg.style.justifyContent = 'center';
            dragImg.style.fontSize = '1.1em';
            dragImg.style.color = '#888';
            dragImg.innerText = 'ÏÖÄ Ïù¥Îèô';
            document.body.appendChild(dragImg);
            event.dataTransfer.setDragImage(dragImg, 120, 30);
            setTimeout(() => document.body.removeChild(dragImg), 0);
        }
        function handleCellDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        function handleCellDrop(event, targetCellId) {
            event.preventDefault();
            if (!draggedCellId || draggedCellId === targetCellId) return;
            const cells = fileCells[activeFile];
            const fromIdx = cells.findIndex(c => c.id === draggedCellId);
            const toIdx = cells.findIndex(c => c.id === targetCellId);
            if (fromIdx === -1 || toIdx === -1) return;
            // ÏÖÄ ÏàúÏÑú Î≥ÄÍ≤Ω
            const [movedCell] = cells.splice(fromIdx, 1);
            cells.splice(toIdx, 0, movedCell);
            renderNotebookCells();
            draggedCellId = null;
        }

        // Î©îÎâ¥ ÎìúÎ°≠Îã§Ïö¥ ÎèôÏûë Ïä§ÌÅ¨Î¶ΩÌä∏
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
          item.addEventListener('mouseenter', function() {
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) dropdown.style.display = 'block';
          });
          item.addEventListener('mouseleave', function() {
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) dropdown.style.display = 'none';
          });
          item.addEventListener('click', function(e) {
            // ÌÅ¥Î¶≠ Ïãú ÌÜ†Í∏Ä
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) {
              dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
              e.stopPropagation();
            }
          });
        });
        document.body.addEventListener('click', function() {
          document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
        });
    </script>

    <style>
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .image-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .image-modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .image-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            color: #333;
        }

        .image-modal-body {
            padding: 20px;
            text-align: center;
            background: white;
        }

        /* Footer Ïä§ÌÉÄÏùº */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-top: 1px solid #4a5568;
            z-index: 1000;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-left, .footer-right {
            font-size: 0.9rem;
        }

        /* Ïã§ÏãúÍ∞Ñ Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÌÉ≠ Ïä§ÌÉÄÏùº */
        .screenshot-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px 0 0 8px;
            padding: 1rem;
            cursor: pointer;
            z-index: 2000;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }

        .screenshot-tab:hover {
            background: #4a5568;
        }

        .screenshot-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1a202c;
            color: #e2e8f0;
            z-index: 1999;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .screenshot-panel.open {
            right: 0;
        }

        .screenshot-header {
            background: #2d3748;
            padding: 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .screenshot-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .screenshot-close {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-close:hover {
            color: #f56565;
        }

        .screenshot-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .screenshot-info {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .screenshot-image-container {
            background: #2d3748;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .screenshot-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            border: 1px solid #4a5568;
        }

        .screenshot-status {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #2d3748;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</body>
</html>