<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramita AI</title>
    <link rel="stylesheet" href="/templates/notebook.css?v=3.2">
    <link rel="stylesheet" href="/templates/component/chat/chat.css">
</head>
<body>
    <div class="header" style="display:flex;align-items:center;justify-content:center;position:relative;">
        <div class="header-menu" style="position:absolute;left:2rem;top:0;bottom:0;display:flex;align-items:center;">
            <nav class="jupyter-menubar" style="background:transparent;border:none;box-shadow:none;padding:0;">
                <ul class="menu-list" style="display:flex;gap:1.2rem;list-style:none;margin:0;padding:0;height:38px;align-items:center;">
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>File</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">New Notebook</li>
                            <li class="dropdown-item">Open...</li>
                            <li class="dropdown-item">Save</li>
                            <li class="dropdown-item">Save As...</li>
                            <li class="dropdown-item">Download</li>
                            <li class="dropdown-item">Rename</li>
                            <li class="dropdown-item">Close</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Edit</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Undo</li>
                            <li class="dropdown-item">Redo</li>
                            <li class="dropdown-item">Cut Cell</li>
                            <li class="dropdown-item">Copy Cell</li>
                            <li class="dropdown-item">Paste Cell Below</li>
                            <li class="dropdown-item">Delete Cell</li>
                            <li class="dropdown-item">Select All</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>View</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Toggle Toolbar</li>
                            <li class="dropdown-item">Toggle Line Numbers</li>
                            <li class="dropdown-item">Expand All</li>
                            <li class="dropdown-item">Collapse All</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Insert</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Insert Cell Above</li>
                            <li class="dropdown-item">Insert Cell Below</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Cell</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Run Cell</li>
                            <li class="dropdown-item">Run All</li>
                            <li class="dropdown-item">Run Above</li>
                            <li class="dropdown-item">Run Below</li>
                            <li class="dropdown-item">Cell Type: Code</li>
                            <li class="dropdown-item">Cell Type: Markdown</li>
                            <li class="dropdown-item">Cell Type: Raw</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Kernel</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Restart</li>
                            <li class="dropdown-item">Interrupt</li>
                            <li class="dropdown-item">Reconnect</li>
                            <li class="dropdown-item">Shutdown</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Help</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Keyboard Shortcuts</li>
                            <li class="dropdown-item">About</li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <h1 style="flex:1;text-align:center;margin:0;font-size:1.8rem;font-weight:400;">Paramita AI</h1>
        <div class="nav-links" style="position:absolute;right:2rem;top:0;bottom:0;display:flex;align-items:center;gap:1rem;">
            <a href="/" class="nav-link">í™ˆ</a>
            <a href="/worker" class="nav-link">Worker</a>
            <a href="/jobs" class="nav-link">Jobs</a>
            <a href="/kernel" class="nav-link">ì»¤ë„</a>
        </div>
    </div>

    <!-- íŒŒì¼ë³„ íƒ­ ë°” -->
    <div class="file-tabs" id="fileTabs">
        <div class="file-tabs-container"></div>
    </div>

    <div class="notebook-layout-wrapper" style="display: flex; flex-direction: row; height: calc(100vh - 70px - 28px); min-height:0; width: 100vw;">
      <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” (íƒ­ êµ¬ì¡°) -->
      <div class="file-browser-sidebar">
        <div class="sidebar-tabs">
          <div class="sidebar-tab active" onclick="switchSidebarTab('fileTreePanel')" title="íŒŒì¼ íƒìƒ‰ê¸°">ğŸ“</div>
          <div class="sidebar-tab" onclick="switchSidebarTab('kernelPanel')" title="ì»¤ë„">ğŸ§ </div>
          <div class="sidebar-tab" onclick="switchSidebarTab('chatHistoryPanel')" title="ì±„íŒ… íˆìŠ¤í† ë¦¬">ğŸ’¬</div>
        </div>
        <div class="sidebar-content">
          <div id="fileTreePanel" class="sidebar-panel active">
            {% include 'component/file_browser/file_browser.html' %}
          </div>
          <div id="kernelPanel" class="sidebar-panel">
            {% include 'component/kernel_manager/kernel_manager.html' %}
          </div>
          <div id="chatHistoryPanel" class="sidebar-panel">
            {% include 'component/chat/chat_history.html' %}
          </div>
        </div>
      </div>
      <!-- ë…¸íŠ¸ë¶ ë©”ì¸ ì˜ì—­ -->
      <div class="notebook-main" style="flex: 1 1 0; overflow-y: auto; height: 100%;">
        <div class="notebook-cells-area">
          <div id="notebookCells"></div>
          <div style="height: 200px; padding: 20px; text-align: center; color: #a0aec0; font-size: 0.9rem;">
            <div style="margin-top: 50px;">
              <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“</div>
              <div>ë…¸íŠ¸ë¶ ë</div>
              <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">ë” ë§ì€ ì…€ì„ ì¶”ê°€í•˜ë ¤ë©´ ìœ„ì˜ â• ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”</div>
            </div>
          </div>
        </div>
      </div>
      <!-- ìš°ì¸¡ íŒ¨ë„ -->
      <div class="right-panel" id="rightPanel" style="height: calc(100vh - 70px - 28px); position: sticky; top: 0;">
        <div class="right-panel-resize-handle" id="rightPanelResizeHandle"></div>
        
        <!-- ìš°ì¸¡ íŒ¨ë„ íƒ­ êµ¬ì¡° -->
        <div class="right-panel-tabs">
          <div class="right-tab active" onclick="switchRightTab('np')" data-tab="np" title="NP íŒ¨ë„ (í´ë¦­í•˜ì—¬ ì ‘ê¸°/í¼ì¹˜ê¸°)">
            <span class="tab-icon"></span>
            <span class="tab-label">note</span>
          </div>
          <div class="right-tab" onclick="switchRightTab('view')" data-tab="view" title="HTML ë·°ì–´ (í´ë¦­í•˜ì—¬ ì ‘ê¸°/í¼ì¹˜ê¸°)">
            <span class="tab-icon"></span>
            <span class="tab-label">view</span>
          </div>
          <div class="right-tab" onclick="switchRightTab('chat')" data-tab="chat" title="AI ì±„íŒ… (í´ë¦­í•˜ì—¬ ì ‘ê¸°/í¼ì¹˜ê¸°)">
            <span class="tab-icon"></span>
            <span class="tab-label">chat</span>
          </div>
        </div>
        
        <!-- NP íŒ¨ë„ (ê¸°ì¡´ ê¸°ëŠ¥) -->
        <div class="right-panel-content active" id="npPanel">
        <div class="panel-section">
          <div class="panel-title">íŒŒì¼ ì •ë³´</div>
          <span id="currentFileName"></span>
          <div id="currentKernelInfo" style="margin-top: 0.5rem; font-size: 0.55rem; color: #a0aec0;">ì»¤ë„: ì—†ìŒ</div>
        </div>
        <div class="panel-section">
          <div class="panel-title">ì»¤ë„ ì œì–´</div>
          <div class="panel-btns">
            <button class="btn btn-primary" onclick="manageKernel('initialize')"><span class="icon">ğŸ”„</span><span class="label">ì»¤ë„ ì´ˆê¸°í™”</span></button>
            <button class="btn btn-success" onclick="extendKernelTimeout()"><span class="icon">â°</span><span class="label">12ì‹œê°„ ì—°ì¥</span></button>
            <button class="btn btn-danger" onclick="manageKernel('shutdown')"><span class="icon">â¹ï¸</span><span class="label">ì»¤ë„ ì¢…ë£Œ</span></button>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-title">ë…¸íŠ¸ë¶</div>
          <div class="panel-btns">
            <button class="btn btn-secondary" onclick="saveNotebookToFile()"><span class="icon">ğŸ’¾</span><span class="label">ë…¸íŠ¸ë¶ ì €ì¥</span></button>
            <button class="btn btn-primary" onclick="saveAsPython()"><span class="icon">ğŸ</span><span class="label">Python ë³€í™˜ ì €ì¥</span></button>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-title">ìƒíƒœ</div>
          <span id="kernelStatusDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.6rem; background: #4a5568; border-radius: 4px; color: #000000;">ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±</span>
          <span id="kernelTimeDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.6rem; background: #2d3748; border-radius: 4px; color: #ffffff; display:block; margin-top:0.5rem;">ë‚¨ì€ ì‹œê°„: --:--:--</span>
          </div>
        </div>
        
        <!-- view íŒ¨ë„ (HTML ë·°ì–´) -->
        <div class="right-panel-content" id="viewPanel">
          <div id="htmlViewerContainer" style="height: 100%; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;"></div>
        </div>
        
        <!-- chat íŒ¨ë„ (AI ì±„íŒ…) -->
        <div class="right-panel-content" id="chatPanel">
          {% include 'component/chat/chat_interface.html' %}
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span>ğŸ““ Paramita AI v1.0</span>
            </div>
            <div class="footer-right">
                <span id="footer-status">copyright paramita ai</span>
            </div>
        </div>
    </footer>

    <!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
    <div class="context-menu" id="contextMenu" style="display: none;">
        <div class="context-menu-item" onclick="openFile()">ì—´ê¸°</div>
        <div class="context-menu-item" onclick="renameFile()">ì´ë¦„ ë³€ê²½</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="copyFilePath()">ê²½ë¡œ ë³µì‚¬</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteFile()" style="color: #dc3545;">ì‚­ì œ</div>
    </div>

    <script src="templates/component/screenshot_monitor/screenshot_monitor.js"></script>

    <script>
        let currentFile = null;
        let fileTreeData = [];
        let selectedFileItem = null;
        let cellCounter = 0;
        let cells = [];
        let openFiles = [];
        let fileCells = {}; // { filePath: [cell, ...] }
        let fileKernels = {}; // { filePath: kernelId }
        let activeFile = null;
        // Flaskì—ì„œ ì „ë‹¬ë°›ì€ JOB_TYPESì™€ FOCUS_TYPES (ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •)
        window.jobTypes = JSON.parse('{{ job_types|tojson|safe }}');
        window.focusTypes = JSON.parse('{{ focus_types|tojson|safe }}');
        
        // ë””ë²„ê¹…: ë¡œë“œëœ ë°ì´í„° í™•ì¸
        console.log(`ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ window.jobTypes:`, window.jobTypes);
        console.log(`ğŸ¯ ì‚¬ìš© ê°€ëŠ¥í•œ job types:`, Object.keys(window.jobTypes || {}));
        console.log(`ğŸ¯ focus types:`, window.focusTypes);
        
        // ì„±ëŠ¥ ìµœì í™”: job type ì˜µì…˜ì„ í•œ ë²ˆë§Œ ìƒì„±í•˜ê³  ì¬ì‚¬ìš©
        let cachedJobTypeOptions = null;
        function getJobTypeOptions() {
            if (cachedJobTypeOptions) return cachedJobTypeOptions.cloneNode(true);
            
            const fragment = document.createDocumentFragment();
            Object.entries(window.jobTypes || {}).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value.name || key;
                fragment.appendChild(option);
            });
            cachedJobTypeOptions = fragment;
            return fragment.cloneNode(true);
        }
        

        
        // í˜¸í™˜ì„±ì„ ìœ„í•œ ë¡œì»¬ ë³€ìˆ˜ë„ ìœ ì§€
        let jobTypes = window.jobTypes;
        let focusTypes = window.focusTypes;

        // ì½œë°± ì‹œìŠ¤í…œ
        const CALLBACK = {
            notebook: []
        };
        
        // CALLBACK_dict ì‹œìŠ¤í…œ - ëª¨ë“  ì½œë°±ë“¤ì„ ê´€ë¦¬
        const CALLBACK_dict = {
            update: [] // ì»¤ë„ ID ì—…ë°ì´íŠ¸ ê´€ë ¨ ì½œë°±ë“¤
        };
        
        function executeCallbacks(key) {
            if (CALLBACK[key] && Array.isArray(CALLBACK[key])) {
                CALLBACK[key].forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('ì½œë°± ì‹¤í–‰ ì˜¤ë¥˜:', error);
                    }
                });
            }
        }
        
        // CALLBACK_dict ì‹¤í–‰ í•¨ìˆ˜
        function executeCallbackDict(key) {
            if (CALLBACK_dict[key] && Array.isArray(CALLBACK_dict[key])) {
                CALLBACK_dict[key].forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('CALLBACK_dict ì‹¤í–‰ ì˜¤ë¥˜:', error);
                    }
                });
            }
        }
        
        // ì»¤ë„ ê´€ë¦¬ ì •ê·œí™”ëœ í•¨ìˆ˜
        function manageKernel(action) {
            if (action === 'initialize') {
                // kernel_managerì˜ initializeKernel í•¨ìˆ˜ í˜¸ì¶œ
                if (typeof window.initializeKernel === 'function') {
                    window.initializeKernel();
                }
            } else if (action === 'shutdown') {
                // kernel_managerì˜ shutdownKernel í•¨ìˆ˜ í˜¸ì¶œ
                if (typeof window.shutdownKernel === 'function') {
                    window.shutdownKernel();
                }
            }
            
            // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸
            setTimeout(() => {
                if (typeof executeCallbackDict === 'function') {
                    executeCallbackDict('update');
                }
            }, 100);
        }
        
        // íƒ­ ê´€ë ¨ ì»¤ë„ ID ì—…ë°ì´íŠ¸ ì •ê·œí™”ëœ í•¨ìˆ˜
        function updateKernelIdForTab() {
            // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸
            if (typeof executeCallbackDict === 'function') {
                executeCallbackDict('update');
            }
        }
        
        // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸ ì½œë°± ë“±ë¡
        function registerHTMLViewerUpdateCallback() {
            const updateCallback = function() {
                if (window.setKernelId && activeFile && fileKernels[activeFile]) {
                    const kernelId = fileKernels[activeFile];
                    const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                    window.setKernelId(kernelIdStr);
                } else if (window.setKernelId) {
                    window.setKernelId(null);
                }
            };
            
            // ê¸°ì¡´ update ì½œë°±ë“¤ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            CALLBACK_dict.update = CALLBACK_dict.update.filter(cb => cb !== updateCallback);
            // ìƒˆë¡œìš´ ì½œë°± ì¶”ê°€
            CALLBACK_dict.update.push(updateCallback);
        }
        
        // ì»¤ë„ ê´€ë¦¬ì í‘œì‹œ í•¨ìˆ˜
        function showKernelManager() {
            const kernelPanel = document.getElementById('kernelPanel');
            if (kernelPanel) {
                // ëª¨ë‹¬ í˜•íƒœë¡œ í‘œì‹œ
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                content.innerHTML = kernelPanel.innerHTML;
                
                // ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'âœ•';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #666;
                `;
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            }
        }
        


        // ì…€ ì‹¤í–‰ í ì‹œìŠ¤í…œ
        let cellExecutionQueue = []; // ì‹¤í–‰ ëŒ€ê¸° ì¤‘ì¸ ì…€ë“¤
        let isExecuting = false; // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
        let currentExecutingCell = null; // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì…€ ID

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        // ë…¸íŠ¸ë¶ ì½œë°± í•¨ìˆ˜ë¥¼ ë¨¼ì € ì„ ì–¸
        window.setNotebookCallback = function() {
            // console.log('[ë…¸íŠ¸ë¶] setNotebookCallback í˜¸ì¶œë¨');
            setFileBrowserCallback(function(file, content) {
                // console.log('[ë…¸íŠ¸ë¶] íŒŒì¼ ë‚´ìš© ë°›ìŒ:', file.name);
                // console.log('[ë…¸íŠ¸ë¶] íŒŒì¼ ê²½ë¡œ:', file.path);
                // console.log('[ë…¸íŠ¸ë¶] ë‚´ìš© ê¸¸ì´:', content ? content.length : 0);
                
                // íŒŒì¼ ë‚´ìš©ì„ ì…€ë¡œ ë³€í™˜
                let cells = [];
                if (content) {
                    if (file.name.endsWith('.ipynb') || file.name.endsWith('.npn')) {
                        try {
                            const notebook = JSON.parse(content);
                            // console.log('[ë…¸íŠ¸ë¶] íŒŒì‹±ëœ ë…¸íŠ¸ë¶:', notebook);
                            if (notebook.cells && Array.isArray(notebook.cells)) {
                                // console.log('[ë…¸íŠ¸ë¶] ì…€ ê°œìˆ˜:', notebook.cells.length);
                                notebook.cells.forEach((cell, index) => {
                                    let cellContent = '';
                                    if (cell.cell_type === 'code') {
                                        cellContent = Array.isArray(cell.source) ? cell.source.join('') : cell.source;
                                    } else {
                                        cellContent = Array.isArray(cell.source) ? cell.source.join('') : cell.source;
                                    }
                                    // console.log(`[ë…¸íŠ¸ë¶] ì…€ ${index + 1} íƒ€ì…:`, cell.cell_type, 'ë‚´ìš©:', cellContent.slice(0, 50));
                                    cells.push({ ...cell, content: cellContent });
                                });
                            }
                        } catch (e) {
                            console.error('[ë…¸íŠ¸ë¶] JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                            cells.push({ content: content });
                        }
                    } else {
                        cells.push({ content: content });
                    }
                }
                
                // console.log('[ë…¸íŠ¸ë¶] ë³€í™˜ëœ ì…€ ê°œìˆ˜:', cells.length);
                
                // íŒŒì¼ì„ openFiles ë°°ì—´ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                if (!openFiles.includes(file.path)) {
                    openFiles.push(file.path);
                }
                
                // ì…€ ë Œë”ë§
                if (!fileCells) fileCells = {};
                
                // ë¹ˆ íŒŒì¼ì¸ ê²½ìš° í™•ì¥ìì— ë”°ë¼ ê¸°ë³¸ ì…€ ì¶”ê°€
                if (cells.length === 0) {
                    const fileName = file.name.toLowerCase();
                    
                    // .npn íŒŒì¼ì¸ ê²½ìš° í¬ë¡¤ë§ ì…€ ë°ì´í„° ìƒì„±
                    if (fileName.endsWith('.npn')) {
                        console.log(`ğŸ•·ï¸ ë¹ˆ .npn íŒŒì¼ì´ë¯€ë¡œ í¬ë¡¤ë§ ì…€ ë°ì´í„° ì¶”ê°€: ${fileName}`);
                        const crawlData = {
                            job_type: 'do',
                            action: 'click',
                            params: {
                                focus: { xpath: "//button[@id='login']" },
                                speed: 1.0
                            }
                        };
                        const crawlDataWithDefaults = addDefaultParams(crawlData);
                        cells.push({
                            content: JSON.stringify(crawlDataWithDefaults, null, 2),
                            cell_type: 'crawl_ui',
                            crawl_data: crawlDataWithDefaults,
                            name: 'Crawl_1'
                        });
                    } 
                    // .py, .ipynb íŒŒì¼ì¸ ê²½ìš° ë¹ˆ ì½”ë“œ ì…€ ì¶”ê°€
                    else if (fileName.endsWith('.py') || fileName.endsWith('.ipynb')) {
                        console.log(`ğŸ ë¹ˆ Python íŒŒì¼ì´ë¯€ë¡œ ì½”ë“œ ì…€ ë°ì´í„° ì¶”ê°€: ${fileName}`);
                        cells.push({
                            content: '',
                            cell_type: 'code'
                        });
                    }
                    // ê¸°íƒ€ íŒŒì¼ë„ ë¹ˆ ì½”ë“œ ì…€ ì¶”ê°€ (ê¸°ë³¸ê°’)
                    else {
                        console.log(`ğŸ“ ë¹ˆ íŒŒì¼ì´ë¯€ë¡œ ê¸°ë³¸ ì½”ë“œ ì…€ ë°ì´í„° ì¶”ê°€: ${fileName}`);
                        cells.push({
                            content: '',
                            cell_type: 'code'
                        });
                    }
                }
                
                // ì…€ë“¤ì„ Cell ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€í™˜
                fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));
                activeFile = file.path;
                // console.log('[ë…¸íŠ¸ë¶] activeFile ì„¤ì •:', activeFile);
                // console.log('[ë…¸íŠ¸ë¶] openFiles:', openFiles);
                
                // íŒŒì¼ íƒ­ ë Œë”ë§
                renderFileTabs();
                
                // ì»¤ë„ ì •ë³´ ì—…ë°ì´íŠ¸
                if (typeof updateKernelInfo === 'function') {
                    updateKernelInfo();
                }
                
                // ì»¤ë„ ìƒíƒœ í™•ì¸
                checkKernelStatus();
                
                // ì»¤ë„ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                if (fileKernels[file.path]) {
                    if (typeof startKernelTimeUpdate === 'function') {
                        startKernelTimeUpdate();
                    }
                } else {
                    // ì»¤ë„ì´ ì—†ëŠ” ê²½ìš° ì‹œê°„ í‘œì‹œ ì´ˆê¸°í™”
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    if (timeDisplayElement) {
                        timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: --:--:--';
                    }
                    // ê¸°ì¡´ ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
                    if (typeof stopKernelTimeUpdate === 'function') {
                        stopKernelTimeUpdate();
                    }
                }
                
                // console.log('[ë…¸íŠ¸ë¶] renderNotebookCells í•¨ìˆ˜ ì¡´ì¬:', typeof renderNotebookCells);
                
                if (renderNotebookCells) {
                    // console.log('[ë…¸íŠ¸ë¶] renderNotebookCells í˜¸ì¶œ');
                    renderNotebookCells();
                } else {
                    console.error('[ë…¸íŠ¸ë¶] renderNotebookCells í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
                }
            });
        };

        document.addEventListener('DOMContentLoaded', function() {
            // console.log('[ë…¸íŠ¸ë¶] DOM ë¡œë“œ ì™„ë£Œ');
            
            // íƒ­ í¬ê¸° ë¡œë“œ
            loadTabSizes();
            
            // íŒŒì¼ ë¸Œë¼ìš°ì €ëŠ” ë³„ë„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¡œë“œë¨
            // console.log('[ë…¸íŠ¸ë¶] íŒŒì¼ ë¸Œë¼ìš°ì € ì»´í¬ë„ŒíŠ¸ ë¡œë“œ ëŒ€ê¸° ì¤‘...');
            setupEventListeners();
            
            // ìƒˆë¡œê³ ì¹¨ ì‹œ ì»¤ë„ ìƒíƒœ ë³µì›
            restoreKernelState();
            
            // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ê¸°ë³¸ ì…€ ì¶”ê°€
            if (!activeFile) {
                addCell(); // ì²« ë²ˆì§¸ ì…€ ì¶”ê°€
            }
            
            // í™œì„± íŒŒì¼ì´ ìˆìœ¼ë©´ ì‹œê°„ì œí•œ ì—…ë°ì´íŠ¸ ì‹œì‘
            if (activeFile) {
                startKernelTimeUpdate();
            }
            
            // í˜„ì¬ í™œì„± íƒ­ì˜ í¬ê¸° ì ìš©
            const activeTab = document.querySelector('.right-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const tabSize = tabSizes[tabName] || 280;
                const rightPanel = document.getElementById('rightPanel');
                rightPanel.style.width = tabSize + 'px';
            }
            
            // checkKernelStatus(); // ì„¸ì…˜ ì»¤ë„ ìƒíƒœ í™•ì¸ ì œê±°
        });
        
        // Job Types ë¡œë“œ
        async function loadJobTypes() {
            try {
                const response = await fetch('/api/job_types');
                const data = await response.json();
                jobTypes = data.job_types;
                focusTypes = data.focus_types;
        
            } catch (error) {
                console.error('Failed to load job types:', error);
            }
        }

        // ê¸°ì¡´ íŒŒì¼ ë¸Œë¼ìš°ì € í•¨ìˆ˜ë“¤...
        function setupEventListeners() {
            // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // ESC í‚¤ë¡œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });

            // ì „ì—­ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì œì–´ (ê¸°ë³¸ ë¸Œë¼ìš°ì € ë‹¨ì¶•í‚¤ ì°¨ë‹¨)
            document.addEventListener('keydown', function(e) {
                const isCtrlCmd = e.ctrlKey || e.metaKey;
                const isShift = e.shiftKey;
                const key = (e.key || '').toLowerCase();
                
                // ìš°ë¦¬ê°€ í—ˆìš©í•˜ëŠ” ë‹¨ì¶•í‚¤ ëª©ë¡
                const allowedShortcuts = [
                    'escape',           // ESC
                    'f5',              // ìƒˆë¡œê³ ì¹¨
                    'f12',             // ê°œë°œì ë„êµ¬
                ];
                
                const allowedCtrlShortcuts = [
                    'c',               // ë³µì‚¬
                    'v',               // ë¶™ì—¬ë„£ê¸°  
                    'x',               // ì˜ë¼ë‚´ê¸°
                    'z',               // ì‹¤í–‰ì·¨ì†Œ
                    'y',               // ë‹¤ì‹œì‹¤í–‰
                    'a',               // ì „ì²´ì„ íƒ
                    'f',               // ì°¾ê¸° (ìš°ë¦¬ ìš©ë„ë¡œ ì¬ì •ì˜ ê°€ëŠ¥)
                    'r',               // ìƒˆë¡œê³ ì¹¨ (viewer ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì¬ì •ì˜)
                    'f5',              // Ctrl+F5 ê°•ë ¥ ìƒˆë¡œê³ ì¹¨
                ];
                
                // ê¸°ë³¸ ë¸Œë¼ìš°ì € ë‹¨ì¶•í‚¤ ì°¨ë‹¨
                if (isCtrlCmd) {
                    // Ctrl+F5ëŠ” íŠ¹ë³„ ì²˜ë¦¬ (ê°•ë ¥ ìƒˆë¡œê³ ì¹¨ í—ˆìš©)
                    if (key === 'f5') {
                        console.log('í—ˆìš©ëœ ë‹¨ì¶•í‚¤: Ctrl+F5 - ê°•ë ¥ ìƒˆë¡œê³ ì¹¨');
                        return true; // ê¸°ë³¸ ë™ì‘ í—ˆìš©
                    }
                    
                    if (!allowedCtrlShortcuts.includes(key)) {
                        e.preventDefault();
                        console.log(`ì°¨ë‹¨ëœ ë‹¨ì¶•í‚¤: Ctrl+${key.toUpperCase()}`);
                        return false;
                    }
                } else {
                    // Ctrl ì—†ëŠ” ë‹¨ì¶•í‚¤ ì°¨ë‹¨ (Fí‚¤ ë“± í—ˆìš©ëœ ê²ƒ ì œì™¸)
                    if (key.startsWith('f') && key.length > 1) {
                        // F1-F12 í‚¤ëŠ” í—ˆìš©ëœ ê²ƒë§Œ
                        if (!allowedShortcuts.includes(key)) {
                            e.preventDefault();
                            console.log(`ì°¨ë‹¨ëœ ë‹¨ì¶•í‚¤: ${key.toUpperCase()}`);
                            return false;
                        }
                    }
                }
                
                // ìš°ë¦¬ë§Œì˜ ì»¤ìŠ¤í…€ ë‹¨ì¶•í‚¤ ì²˜ë¦¬
                if (isCtrlCmd && key === 'enter') {
                    e.preventDefault();
                    // í˜„ì¬ í™œì„± ì…€ ì‹¤í–‰
                    console.log('ì»¤ìŠ¤í…€ ë‹¨ì¶•í‚¤: Ctrl+Enter - ì…€ ì‹¤í–‰');
                    return false;
                }
                
                if (isCtrlCmd && isShift && key === 'enter') {
                    e.preventDefault();
                    // ì…€ ì‹¤í–‰ í›„ ìƒˆ ì…€ ì¶”ê°€
                    console.log('ì»¤ìŠ¤í…€ ë‹¨ì¶•í‚¤: Ctrl+Shift+Enter - ì…€ ì‹¤í–‰ í›„ ìƒˆ ì…€');
                    return false;
                }
                
                if (isCtrlCmd && key === 's') {
                    e.preventDefault();
                    // íŒŒì¼ ì €ì¥
                    saveNotebookToFile();
                    console.log('ì»¤ìŠ¤í…€ ë‹¨ì¶•í‚¤: Ctrl+S - íŒŒì¼ ì €ì¥');
                    return false;
                }
                
                if (isCtrlCmd && key === 'r') {
                    e.preventDefault();
                    // Viewer ìƒˆë¡œê³ ì¹¨
                    refreshViewer();
                    console.log('ì»¤ìŠ¤í…€ ë‹¨ì¶•í‚¤: Ctrl+R - Viewer ìƒˆë¡œê³ ì¹¨');
                    return false;
                }
            });
            
            // Viewer ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
            function refreshViewer() {
                const viewerFrame = document.getElementById('rightPanel');
                if (viewerFrame) {
                    // í˜„ì¬ viewerì— í‘œì‹œëœ ë‚´ìš©ì„ ìƒˆë¡œê³ ì¹¨
                    const iframe = viewerFrame.querySelector('iframe');
                    if (iframe) {
                        // iframeì´ ìˆëŠ” ê²½ìš° ìƒˆë¡œê³ ì¹¨
                        iframe.src = iframe.src;
                        console.log('Viewer iframe ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                    } else {
                        // iframeì´ ì—†ëŠ” ê²½ìš° HTML ë‚´ìš© ìƒˆë¡œê³ ì¹¨
                        const htmlContent = viewerFrame.innerHTML;
                        viewerFrame.innerHTML = '';
                        setTimeout(() => {
                            viewerFrame.innerHTML = htmlContent;
                            console.log('Viewer HTML ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                        }, 100);
                    }
                } else {
                    console.log('Viewerê°€ ì—†ì–´ì„œ ìƒˆë¡œê³ ì¹¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            }
            
            // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì´ë²¤íŠ¸
            const resizeHandle = document.getElementById('rightPanelResizeHandle');
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', startResize);
            }

        }

        // ì„œë²„ì—ì„œ í™œì„± ì»¤ë„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function restoreKernelState() {
            
            // ì„œë²„ì—ì„œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ë³µì› (ì‚¬ìš©ìë³„)
            fetch('/api/kernels/file-mappings')
                .then(response => response.json())
                .then(data => {
                    
                    if (data.success && data.mappings) {
                        
                        // ì„œë²„ì˜ ë§¤í•‘ ì •ë³´ë¥¼ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¡œ ë³µì›
                        fileKernels = data.mappings;
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateKernelInfo();
                        
                        // ì»¤ë„ ìƒíƒœ í™•ì¸
                        checkKernelStatus();
                        
                        // ê° íŒŒì¼ì˜ ì»¤ë„ ìƒíƒœ í™•ì¸
                        Object.keys(fileKernels).forEach(filePath => {
                            const kernelId = fileKernels[filePath];
                        });
                    } else {
                    }
                })
                .catch(error => {
                });
        }

        // íŒŒì¼ ë¸Œë¼ìš°ì € ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ file_browser.htmlì—ì„œ ì²˜ë¦¬ë¨

        // íŒŒì¼ ì„ íƒì€ íŒŒì¼ ë¸Œë¼ìš°ì € ì½œë°±ì—ì„œ ì²˜ë¦¬ë¨

        // íŒŒì¼ë³„ ê¸°ì¡´ ì»¤ë„ í™•ì¸ ë° ì—°ê²° (ìƒˆ ì»¤ë„ ìƒì„± ì—†ìŒ)
        let kernelCheckInProgress = new Set(); // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
        
        function checkKernelForFile(filePath) {
            
            // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
            if (kernelCheckInProgress.has(filePath)) {
                return;
            }
            
            // íŒŒì¼ íƒ€ì… ì²´í¬
            const fileName = filePath.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                return;
            }
            
            // ì§„í–‰ ì¤‘ í‘œì‹œ
            kernelCheckInProgress.add(filePath);
            
            // ê¸°ì¡´ ì»¤ë„ì´ ìˆëŠ”ì§€ í™•ì¸ë§Œ (ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ)
            checkAndConnectExistingKernel(filePath).then(hasExistingKernel => {
                
                if (hasExistingKernel) {
                } else {
                }
                
                // ì§„í–‰ ì¤‘ í‘œì‹œ ì œê±°
                kernelCheckInProgress.delete(filePath);
            });
        }
        
        // ê¸°ì¡´ ì»¤ë„ í™•ì¸ ë° ì—°ê²°
        function checkAndConnectExistingKernel(filePath) {
            return new Promise((resolve) => {
                
                // ì„œë²„ì—ì„œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ í™•ì¸ (ì‚¬ìš©ìë³„)
                fetch(`/api/kernels/file-mapping?file_path=${encodeURIComponent(filePath)}`)
                    .then(response => response.json())
                    .then(data => {
                        
                        if (data.success && data.kernel_id) {
                            
                            // ì»¤ë„ ìƒíƒœ í™•ì¸
                            fetch(`/api/kernels/${data.kernel_id}/status`)
                                .then(statusResponse => statusResponse.json())
                                .then(statusData => {
                                    
                                    if (statusData.success && statusData.status.status !== 'shutdown') {
                                        // í™œì„± ì»¤ë„ì´ë©´ ì—°ê²°
                                        fileKernels[filePath] = data.kernel_id;
                                        updateKernelInfo();
                                        
                                        // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸
                                        updateKernelIdForTab();
                                        
                                        resolve(true);
                                    } else {
                                        resolve(false);
                                    }
                                })
                                .catch(error => {
                                    resolve(false);
                                });
                        } else {
                            resolve(false);
                        }
                    })
                    .catch(error => {
                        resolve(false);
                    });
            });
        }

        function renderFileTabs() {
            const fileTabs = document.getElementById('fileTabs');
            const fileTabsContainer = fileTabs.querySelector('.file-tabs-container');
            fileTabsContainer.innerHTML = '';
            openFiles.forEach(path => {
                const tab = document.createElement('div');
                tab.className = 'file-tab' + (activeFile === path ? ' active' : '');
                
                // íŒŒì¼ëª… í‘œì‹œ
                const fileName = path.split('/').pop();
                const hasKernel = fileKernels[path];
                const kernelIcon = hasKernel ? 'ğŸ§ ' : 'âšª';
                tab.innerHTML = `<span>${kernelIcon} ${fileName}</span>`;
                
                tab.onclick = () => setActiveFileTab(path);
                // ë‹«ê¸° ë²„íŠ¼
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeFileTab(path);
                };
                tab.appendChild(closeBtn);
                fileTabsContainer.appendChild(tab);
            });
        }

        function setActiveFileTab(path) {
            activeFile = path;
            renderFileTabs();
            renderNotebookCells();
            // íŒŒì¼ëª… ë° ì €ì¥ ë²„íŠ¼ í‘œì‹œ
            var currentFileInfoElem = document.getElementById('currentFileInfo');
            if (currentFileInfoElem) {
                currentFileInfoElem.style.display = 'flex';
            }
            const fileName = path.split('/').pop();
            
            const hasKernel = fileKernels[path];
            const kernelId = hasKernel ? fileKernels[path] : 'ì—†ìŒ';
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            document.getElementById('currentFileName').textContent = fileName;
            
            // ì»¤ë„ ì´ˆê¸°í™” ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const initButton = document.querySelector('#currentFileInfo .btn-primary');
            if (initButton) {
                initButton.innerHTML = hasKernel ? 'ğŸ”„ ì»¤ë„ ì¬ì‹œì‘' : 'ğŸ”„ ì»¤ë„ ì´ˆê¸°í™”';
            }
            
            // ì…€ì´ ì—†ìœ¼ë©´ í™•ì¥ìì— ë”°ë¼ ì ì ˆí•œ ê¸°ë³¸ ì…€ ì¶”ê°€
            if (!fileCells[path] || fileCells[path].length === 0) {
                const fileName = path.split('/').pop().toLowerCase();
                
                // .npn íŒŒì¼ì¸ ê²½ìš° í¬ë¡¤ë§ ì…€ ì¶”ê°€
                if (fileName.endsWith('.npn')) {
                    console.log(`ğŸ•·ï¸ .npn íŒŒì¼ì´ë¯€ë¡œ í¬ë¡¤ë§ ì…€ ì¶”ê°€: ${fileName}`);
                    addCrawlCell();
                } 
                // .py, .ipynb íŒŒì¼ì¸ ê²½ìš° ì½”ë“œ ì…€ ì¶”ê°€
                else if (fileName.endsWith('.py') || fileName.endsWith('.ipynb')) {
                    console.log(`ğŸ Python íŒŒì¼ì´ë¯€ë¡œ ì½”ë“œ ì…€ ì¶”ê°€: ${fileName}`);
                    addCell();
                }
                // ê¸°íƒ€ íŒŒì¼ë„ ì½”ë“œ ì…€ ì¶”ê°€ (ê¸°ë³¸ê°’)
                else {
                    console.log(`ğŸ“ ê¸°ë³¸ ì½”ë“œ ì…€ ì¶”ê°€: ${fileName}`);
                    addCell();
                }
            }
            
            // ì»¤ë„ ì •ë³´ ì—…ë°ì´íŠ¸ ë° ì‹œê°„ì œí•œ ì—…ë°ì´íŠ¸ ì‹œì‘
            if (typeof updateKernelInfo === 'function') {
                updateKernelInfo();
            }
            
            // ì»¤ë„ ìƒíƒœ í™•ì¸
            checkKernelStatus();
            
            // ì»¤ë„ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
            if (fileKernels[path]) {
                if (typeof stopKernelTimeUpdate === 'function') {
                    stopKernelTimeUpdate();
                }
                if (typeof startKernelTimeUpdate === 'function') {
                    startKernelTimeUpdate();
                }
            } else {
                // ì»¤ë„ì´ ì—†ëŠ” ê²½ìš° ì‹œê°„ í‘œì‹œ ì´ˆê¸°í™”
                const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                if (timeDisplayElement) {
                    timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: --:--:--';
                }
                // ê¸°ì¡´ ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
                if (typeof stopKernelTimeUpdate === 'function') {
                    stopKernelTimeUpdate();
                }
            }
            
            // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸
            updateKernelIdForTab();
            
            // ë…¸íŠ¸ë¶ íƒ­ ë³€ê²½ ì½œë°± ì‹¤í–‰
            executeCallbacks('notebook');
        }

        function closeFileTab(path) {
            const idx = openFiles.indexOf(path);
            if (idx !== -1) {
                openFiles.splice(idx, 1);
                delete fileCells[path];
                
                // í•´ë‹¹ íŒŒì¼ì˜ ì»¤ë„ ì¢…ë£Œ
                if (fileKernels[path]) {
                    shutdownKernelForFile(path);
                }
                delete fileKernels[path];
                
                // íƒ­ ë‹«ì€ í›„ ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
                if (openFiles.length > 0) {
                    setActiveFileTab(openFiles[Math.max(0, idx - 1)]);
                } else {
                    activeFile = null;
                    renderFileTabs();
                    document.getElementById('notebookCells').innerHTML = '';
                    document.getElementById('currentFileInfo').style.display = 'none';
                }
                
                // ë…¸íŠ¸ë¶ íƒ­ ë³€ê²½ ì½œë°± ì‹¤í–‰
                executeCallbacks('notebook');
                
                // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸
                updateKernelIdForTab();
            }
        }

        // íŒŒì¼ë³„ ì»¤ë„ ì¢…ë£Œ
        function shutdownKernelForFile(filePath) {
            const kernelId = fileKernels[filePath];
            if (!kernelId) return;
            
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            if (!confirm(`"${filePath.split('/').pop()}" íŒŒì¼ì˜ ì»¤ë„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            fetch(`/api/kernels/${kernelIdStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ì»¤ë„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: ${filePath.split('/').pop()}`;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ì„œë²„ì—ì„œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±°
                    fetch('/api/kernels/file-mapping', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file_path: filePath
                        })
                    })
                    .then(response => response.json())
                    .then(mappingData => {
                        if (!mappingData.success) {
                            console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì‹¤íŒ¨:', mappingData.error);
                        }
                    })
                    .catch(error => {
                        console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì˜¤ë¥˜:', error);
                    });
                    
                    // ì»¤ë„ ID ì œê±°
                    delete fileKernels[filePath];
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateKernelInfo();
                    
                    // ë§Œì•½ ì¢…ë£Œëœ ì»¤ë„ì´ í˜„ì¬ í™œì„± íŒŒì¼ì˜ ì»¤ë„ì´ì—ˆë‹¤ë©´
                    if (filePath === activeFile) {
                        document.getElementById('currentKernelInfo').textContent = 'ì—†ìŒ';
                        document.getElementById('kernelStatusText').textContent = 'ì»¤ë„ ì—†ìŒ';
                    }
                    
                    // HTML ë·°ì–´ ì»¤ë„ ID ì—…ë°ì´íŠ¸
                    updateKernelIdForTab();
                } else {
                    alert(data.message || 'ì»¤ë„ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì»¤ë„ ì¢…ë£Œ ì˜¤ë¥˜:', error);
                alert('ì»¤ë„ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function renderNotebookCells() {
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            
            // ëª¨ë“  ì…€ì˜ textarea í¬ê¸° ìë™ ì¡°ì •
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ì…€ ì¶”ê°€ í•¨ìˆ˜ (íŒŒì¼ë³„)
        function addCell(content = '', cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: content,
                cell_type: 'code'
            });
            
            let insertIndex;
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, newCell);
                    insertIndex = currentIndex + 1;
                } else {
                    cells.push(newCell);
                    insertIndex = cells.length - 1;
                }
            } else {
                cells.push(newCell);
                insertIndex = cells.length - 1;
            }
            
            // ì„±ëŠ¥ ìµœì í™”: ë§¨ ëì— ì¶”ê°€í•˜ëŠ” ê²½ìš°ë§Œ ë‹¨ì¼ ì…€ ì¶”ê°€
            if (insertIndex === cells.length - 1) {
                addSingleCellToDOM(newCell, insertIndex);
            } else {
                renderNotebookCells();
            }
            
            // í¬ì»¤ìŠ¤ ì„¤ì • (ìµœì í™”)
            requestAnimationFrame(() => {
                const textarea = document.getElementById(newCell.id)?.querySelector('.cell-input');
                if (textarea) textarea.focus();
            });
            
            return newCell;
        }

        function addCellAfter(cellId) {
            syncCellContentsToMemory();
            return addCell('', cellId);
        }

        function addCrawlCell(cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const crawlData = {
                job_type: 'do',
                action: 'click',
                params: {
                    focus: { xpath: "//button[@id='login']" },
                    speed: 1.0
                }
            };
            const crawlDataWithDefaults = addDefaultParams(crawlData);
            const cell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: JSON.stringify(crawlDataWithDefaults, null, 2),
                cell_type: 'crawl_ui',
                crawl_data: crawlDataWithDefaults,
                name: `Crawl_${cells.length + 1}`
            });
            
            let insertIndex;
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, cell);
                    insertIndex = currentIndex + 1;
                } else {
                    cells.push(cell);
                    insertIndex = cells.length - 1;
                }
            } else {
                cells.push(cell);
                insertIndex = cells.length - 1;
            }
            
            // ì„±ëŠ¥ ìµœì í™”: ë§¨ ëì— ì¶”ê°€í•˜ëŠ” ê²½ìš°ë§Œ ë‹¨ì¼ ì…€ ì¶”ê°€, ë‚˜ë¨¸ì§€ëŠ” ì „ì²´ ë Œë”ë§
            if (insertIndex === cells.length - 1) {
                // ë§¨ ëì— ì¶”ê°€í•˜ëŠ” ê²½ìš°: ìµœì í™”ëœ ë‹¨ì¼ ì…€ ì¶”ê°€
                addSingleCellToDOM(cell, insertIndex);
            } else {
                // ì¤‘ê°„ì— ì‚½ì…í•˜ëŠ” ê²½ìš°: ì „ì²´ ë Œë”ë§ (ë²ˆí˜¸ì™€ ìˆœì„œ ì •í™•ì„± ë³´ì¥)
                renderNotebookCells();
            }
            
            // ì¦‰ì‹œ ìŠ¤í¬ë¡¤ (requestAnimationFrame ì‚¬ìš©)
            requestAnimationFrame(() => {
                const newCell = document.getElementById(cell.id);
                if (newCell) {
                    newCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
            
            return cell;
        }
        
        // ì„±ëŠ¥ ìµœì í™”: ë‹¨ì¼ ì…€ë§Œ DOMì— ì¶”ê°€
        function addSingleCellToDOM(cell, index) {
            const notebookCells = document.getElementById('notebookCells');
            if (!notebookCells) return;
            
            // ìƒˆ ì…€ ìš”ì†Œ ìƒì„± (createCellElementëŠ” ëª¨ë“  ì´ˆê¸°í™” ë¡œì§ì„ í¬í•¨)
            const cellDiv = createCellElement(cell, index);
            
            // ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ì‚½ì…
            const existingCells = notebookCells.children;
            if (index < existingCells.length) {
                notebookCells.insertBefore(cellDiv, existingCells[index]);
            } else {
                notebookCells.appendChild(cellDiv);
            }
            
            // ì´í›„ ì…€ë“¤ì˜ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (í•„ìš”í•œ ê²½ìš°ë§Œ)
            if (index < existingCells.length - 1) {
                updateCellNumbers();
            }
            
            // âš ï¸ ì¤‘ìš”: crawl ì…€ ì´ˆê¸°í™” ë° ìë™ ì €ì¥
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            if (isCrawlCell) {
                // crawl ì…€ ì´ˆê¸°í™” (ë¹„ë™ê¸°)
                setTimeout(() => {
                    initializeCrawlCellOptimized(cell.id, cell.content, false);
                    // ìë™ ì €ì¥ (500ms í›„)
                    setTimeout(() => saveNotebookToFile(), 500);
                }, 50);
            } else {
                // ì¼ë°˜ ì…€ë„ ìë™ ì €ì¥
                setTimeout(() => saveNotebookToFile(), 500);
            }
        }
        
        // ì…€ ë²ˆí˜¸ë§Œ ì—…ë°ì´íŠ¸ (ê°€ë²¼ìš´ ì‘ì—…)
        function updateCellNumbers() {
            const cells = fileCells[activeFile] || [];
            cells.forEach((cell, idx) => {
                const cellNumberSpan = document.querySelector(`#${cell.id} .cell-number`);
                if (cellNumberSpan) {
                    const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                    cellNumberSpan.textContent = isCrawlCell ? `Crawl [${idx + 1}]:` : `In [${idx + 1}]:`;
                }
            });
        }

        // ì…€ ìƒì„± í•¨ìˆ˜ (íŒŒì¼ë³„)
        function createCellElement(cell, idx) {
            const cellDiv = document.createElement('div');
            cellDiv.className = 'cell';
            cellDiv.id = cell.id;
            
            // í˜„ì¬ íŒŒì¼ì˜ ì…€ ê°œìˆ˜ í™•ì¸
            const currentCells = fileCells[activeFile] || [];
            const isOnlyCell = currentCells.length === 1;
            const isFirstCell = idx === 0;
            const isLastCell = idx === currentCells.length - 1;
            
            // crawl íƒ€ì… ì…€ì¸ì§€ í™•ì¸
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            const isJsonMode = cell.cell_type === 'crawl_json';
            
            // ì…€ í—¤ë” ë²„íŠ¼(ì‹¤í–‰, ì¶”ê°€, ì‚­ì œ, ìœ„/ì•„ë˜ ì´ë™, ë³µì‚¬)
            let cellActionButtons = `
                <button class="cell-btn run" onclick="runCell('${cell.id}')" title="ì‹¤í–‰">â–¶ï¸</button>
                <button class="cell-btn add" onclick="addCell('', '${cell.id}')" title="ì…€ ì¶”ê°€">â•</button>
                ${isOnlyCell ? '' : `<button class="cell-btn delete" onclick="deleteCell('${cell.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>`}
                <button class="cell-btn copy" onclick="copyCell('${cell.id}')" title="ë³µì‚¬">ğŸ“‹</button>
                ${!isFirstCell ? `<button class="cell-btn up" onclick="moveCellUp('${cell.id}')" title="ìœ„ë¡œ ì´ë™">â¬†ï¸</button>` : ''}
                ${!isLastCell ? `<button class="cell-btn down" onclick="moveCellDown('${cell.id}')" title="ì•„ë˜ë¡œ ì´ë™">â¬‡ï¸</button>` : ''}
                ${activeFile && activeFile.toLowerCase().endsWith('.npn') ? `<button class="cell-btn add" onclick="addCrawlCell('${cell.id}')" title="ìˆ˜ì§‘ ì¶”ê°€">ğŸ•·ï¸</button>` : ''}
            `;
            
            if (isCrawlCell) {
                cellDiv.innerHTML = `
                    <div class="cell-header" draggable="true" ondragstart="handleCellDragStart(event, '${cell.id}')" ondragover="handleCellDragOver(event)" ondrop="handleCellDrop(event, '${cell.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-drag-handle" style="cursor: grab; margin-right: 0.5em;" title="ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½">
                              <svg width="18" height="18" viewBox="0 0 18 18" style="vertical-align:middle"><circle cx="4" cy="5" r="1.5" fill="#888"/><circle cx="4" cy="9" r="1.5" fill="#888"/><circle cx="4" cy="13" r="1.5" fill="#888"/><circle cx="10" cy="5" r="1.5" fill="#888"/><circle cx="10" cy="9" r="1.5" fill="#888"/><circle cx="10" cy="13" r="1.5" fill="#888"/></svg>
                            </span>
                            <span class="cell-number">Crawl [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            <div class="cell-name-input">
                                <input type="text" id="cell-name-${cell.id}" placeholder="ì…€ ì´ë¦„" value="${cell.name || ''}" onchange="updateCellName('${cell.id}', this.value)" style="width: 120px; padding: 0.3rem 0.5rem; font-size: 0.8rem; border: 1px solid #718096; border-radius: 4px; background: #4a5568; color: #e2e8f0;">
                            </div>
                            <div class="xml-toggle">
                                <label class="switch">
                                    <input type="checkbox" id="xml-toggle-${cell.id}" onchange="toggleJsonOutput('${cell.id}')" ${isJsonMode ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <span class="xml-label">JSON</span>
                            </div>
                            ${cellActionButtons}
                        </div>
                    </div>
                    <div class="crawl-cell-content" id="crawl-controls-${cell.id}" ${isJsonMode ? 'style=\"display: none;\"' : ''}>
                        <div class="crawl-row">
                            <label>Job Type:</label>
                            <select class="crawl-job-type" onchange="updateCrawlCell('${cell.id}', 'job_type', this.value)"></select>
                        </div>
                        <div class="crawl-row">
                            <label id="action-label-${cell.id}">Action:</label>
                            <select class="crawl-action" onchange="updateCrawlCell('${cell.id}', 'action', this.value)"></select>
                        </div>

                        <div class="crawl-params" id="crawl-params-${cell.id}"></div>
                    </div>
                    <div class="xml-output-section" id="xml-output-${cell.id}" ${isJsonMode ? '' : 'style=\"display: none;\"'}>
                        <div class="xml-header">
                            <h4>JSON ì¶œë ¥</h4>
                            <button class="xml-copy-btn" onclick="copyJsonOutput('${cell.id}')" title="JSON ë³µì‚¬">ğŸ“‹</button>
                        </div>
                        <textarea class="xml-output-textarea" id="xml-content-${cell.id}" placeholder="JSON ì¶œë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..." oninput="updateJsonContent('${cell.id}'); autoResizeTextarea(this)"></textarea>
                    </div>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
                // ì„±ëŠ¥ ìµœì í™”: ì¦‰ì‹œ ì‹¤í–‰ (setTimeout ì œê±°)
                const jobTypeSelect = cellDiv.querySelector('.crawl-job-type');
                if (jobTypeSelect && window.jobTypes) {
                    jobTypeSelect.appendChild(getJobTypeOptions());
                }
                initializeCrawlCellOptimized(cell.id, cell.content, cell.cell_type === 'crawl_json');
            } else {
                // ì¼ë°˜ ì½”ë“œ ì…€
                cellDiv.innerHTML = `
                    <div class="cell-header" draggable="true" ondragstart="handleCellDragStart(event, '${cell.id}')" ondragover="handleCellDragOver(event)" ondrop="handleCellDrop(event, '${cell.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-drag-handle" style="cursor: grab; margin-right: 0.5em;" title="ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½">
                              <svg width="18" height="18" viewBox="0 0 18 18" style="vertical-align:middle"><circle cx="4" cy="5" r="1.5" fill="#888"/><circle cx="4" cy="9" r="1.5" fill="#888"/><circle cx="4" cy="13" r="1.5" fill="#888"/><circle cx="10" cy="5" r="1.5" fill="#888"/><circle cx="10" cy="9" r="1.5" fill="#888"/><circle cx="10" cy="13" r="1.5" fill="#888"/></svg>
                            </span>
                            <span class="cell-number">In [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            ${cellActionButtons}
                        </div>
                    </div>
                    <textarea class="cell-input" placeholder="Python ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKeyDown(event, '${cell.id}')" oninput="autoResizeTextarea(this)">${cell.content}</textarea>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
            }
            setTimeout(() => {
                const textarea = cellDiv.querySelector('.cell-input');
                if (textarea) {
                    autoResizeTextarea(textarea);
                }
                loadCellOutput(cell.id);
            }, 10);
            return cellDiv;
        }

        function autoResizeTextarea(textarea) {
            // ë†’ì´ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ ì •í™•í•œ ìŠ¤í¬ë¡¤ ë†’ì´ ê³„ì‚°
            textarea.style.height = 'auto';
            
            // ë‚´ìš©ì— ë”°ë¥¸ ë†’ì´ ê³„ì‚° (ìµœì†Œ 100px, ë¼ì¸ë‹¹ ì•½ 20px)
            const minHeight = 100;
            const lineHeight = 20;
            const lines = textarea.value.split('\n').length;
            const calculatedHeight = Math.max(minHeight, lines * lineHeight);
            
            // ë†’ì´ ì„¤ì •
            textarea.style.height = calculatedHeight + 'px';
            
            // ìŠ¤í¬ë¡¤ë°”ê°€ ìƒê¸°ì§€ ì•Šë„ë¡ ì¶”ê°€ ì¡°ì •
            if (textarea.scrollHeight > calculatedHeight) {
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }

        // ì…€ output ì €ì¥ í•¨ìˆ˜
        function saveCellOutput(cellId, output) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell) {
                // output íˆìŠ¤í† ë¦¬ ë°°ì—´ ì´ˆê¸°í™”
                if (!cell.output_history) {
                    cell.output_history = [];
                }
                
                // ìƒˆë¡œìš´ outputìœ¼ë¡œ ë®ì–´ì“°ê¸° (ì´ì „ íˆìŠ¤í† ë¦¬ ì œê±°)
                cell.output_history = [{
                    timestamp: new Date().toISOString(),
                    output: output,
                    execution_count: cell.execution_count || 1
                }];
                
                // íŒŒì¼ì— ì €ì¥
                saveNotebookToFile();
            }
        }

        // ì…€ output ë¡œë“œ í•¨ìˆ˜
        function loadCellOutput(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell && cell.output_history && cell.output_history.length > 0) {
                const outputDiv = document.getElementById(`output-${cellId}`);
                if (outputDiv) {
                    outputDiv.style.display = 'block';
                    
                    // ê¸°ì¡´ output ì œê±°
                    outputDiv.innerHTML = '';
                    
                    // ê°€ì¥ ìµœê·¼ outputë§Œ í‘œì‹œ (ë®ì–´ì“°ê¸° ë°©ì‹)
                    const latestEntry = cell.output_history[cell.output_history.length - 1];
                    const outputEntryDiv = document.createElement('div');
                    outputEntryDiv.className = 'cell-output-new';
                    outputEntryDiv.textContent = latestEntry.output;
                    outputEntryDiv.setAttribute('data-timestamp', latestEntry.timestamp);
                    outputEntryDiv.setAttribute('data-execution-count', latestEntry.execution_count);
                    outputDiv.appendChild(outputEntryDiv);
                }
            }
        }

        function handleKeyDown(event, cellId) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                runCell(cellId);
            } else if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                addCellAfter(cellId);
            } else if (event.key === 's' && event.ctrlKey) {
                event.preventDefault();
                saveNotebookToFile();
            }
        }

        // ì…€ ì‹¤í–‰ í ì²˜ë¦¬ í•¨ìˆ˜
        function processCellQueue() {
            if (isExecuting) {
                return;
            }
            
            if (cellExecutionQueue.length === 0) {
                return;
            }
            
            isExecuting = true;
            const nextCell = cellExecutionQueue.shift();
            currentExecutingCell = nextCell;
            
            // ì‹¤ì œ ì…€ ì‹¤í–‰
            executeCell(nextCell);
        }

        // ì‹¤ì œ ì…€ ì‹¤í–‰ í•¨ìˆ˜
        function executeCell(cellId) {
            if (!activeFile) {
                alert('ì‹¤í–‰í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            // íŒŒì¼ íƒ€ì… ì²´í¬
            const fileName = activeFile.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                alert('Python íŒŒì¼(.py), Jupyter ë…¸íŠ¸ë¶(.ipynb), NPN(.npn) íŒŒì¼ë§Œ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            if (!fileKernels[activeFile]) {
                alert('ì»¤ë„ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì»¤ë„ì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) {
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            const outputDiv = document.querySelector(`#output-${cell.id}`);
            const statusSpan = document.querySelector(`#status-${cell.id}`);
            const execSpan = document.querySelector(`#exec-${cell.id}`);

            // crawl ì…€ì¸ì§€ í™•ì¸
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            
            let code = '';
            
            if (isCrawlCell) {
                // crawl ì…€ì˜ ê²½ìš° crawl_dataì—ì„œ ì½”ë“œ ìƒì„±
                if (!cell.crawl_data) {
                    alert('crawl ì…€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì…€ì„ ë‹¤ì‹œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                    return;
                }
                
                // name inputì—ì„œ job name ê°€ì ¸ì˜¤ê¸°
                const nameInput = document.getElementById(`cell-name-${cellId}`);
                const jobName = nameInput ? nameInput.value.trim() : `crawl_${cellId}`;
                
                // class_job import ë° job ì„ ì–¸ ì½”ë“œ ìƒì„±
                code = generateCrawlCode(cell.crawl_data, jobName);
            } else {
                // ì¼ë°˜ ì½”ë“œ ì…€ì˜ ê²½ìš° textareaì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
                const textarea = document.querySelector(`#${cellId} .cell-input`);
                code = textarea.value.trim();
                if (!code) {
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                    return;
                }
            }

            // ìƒíƒœ ì—…ë°ì´íŠ¸ - ì‹¤í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½
            cell.status = 'running';
            statusSpan.textContent = 'ì‹¤í–‰ì¤‘...';
            statusSpan.className = 'cell-status running';
            outputDiv.style.display = 'block';
            
            // ê¸°ì¡´ output ëª¨ë‘ ì§€ìš°ê³  ì‹¤í–‰ì¤‘ í‘œì‹œë§Œ ì¶”ê°€
            outputDiv.innerHTML = '';
            const runningDiv = document.createElement('div');
            runningDiv.innerHTML = '<div class="spinner"></div> ì‹¤í–‰ì¤‘...';
            runningDiv.className = 'cell-output-running';
            outputDiv.appendChild(runningDiv);
            
            outputDiv.className = 'cell-output';

            // í˜„ì¬ í™œì„± íƒ­ì˜ ì»¤ë„ì— ì½”ë“œ ì‹¤í–‰ ìš”ì²­
            const kernelId = fileKernels[activeFile];
            
            // crawl ì…€ì˜ ê²½ìš° ìƒì„±ëœ ì½”ë“œë¥¼ ì½˜ì†”ì— ì¶œë ¥
            if (isCrawlCell) {
                // ì½”ë“œ ì‹¤í–‰
            }
            
            fetch(`/api/kernels/${kernelId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cell.status = 'completed';
                    statusSpan.textContent = 'ì™„ë£Œ';
                    statusSpan.className = 'cell-status completed';
                    outputDiv.className = 'cell-output success';
                    
                    // stdout/result/stderrë¥¼ ê²°í•©í•˜ì—¬ ì¶œë ¥
                    let output = '';
                    
                    console.log('=== ë””ë²„ê¹…: ë°±ì—”ë“œ ì‘ë‹µ ===');
                    console.log('data:', data);
                    console.log('data.result:', data.result);
                    console.log('data.result.stdout:', data.result?.stdout);
                    console.log('data.result.stderr:', data.result?.stderr);
                    
                    if (data.result && data.result.stdout && data.result.stdout.trim() !== '') {
                        output += data.result.stdout;
                        console.log('stdout ì¶”ê°€ë¨:', data.result.stdout);
                    }
                    // resultê°€ ë¬¸ìì—´ì´ê³  'None'ì´ ì•„ë‹ ë•Œë§Œ ì¶”ê°€
                    if (data.result && typeof data.result.result === 'string' && data.result.result.trim() !== '' && data.result.result !== 'None') {
                        if (output) output += '\n';
                        output += data.result.result;
                        console.log('result ì¶”ê°€ë¨:', data.result.result);
                    }
                    if (data.result && data.result.stderr && data.result.stderr.trim() !== '') {
                        if (output) output += '\n';
                        output += data.result.stderr;
                        console.log('stderr ì¶”ê°€ë¨:', data.result.stderr);
                    }
                    
                    console.log('ìµœì¢… output:', output);
                    

                    
                    // ì‹¤í–‰ì¤‘ í‘œì‹œ ì œê±°
                    const runningDiv = outputDiv.querySelector('.cell-output-running');
                    if (runningDiv) {
                        runningDiv.remove();
                    }
                    
                    // ìƒˆë¡œìš´ output ì¶”ê°€ (ì´ì „ output ìœ ì§€)
                    if (output && output.trim() !== '') {
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = output;
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ì…€ ë°ì´í„°ì— output ì €ì¥
                        saveCellOutput(cellId, output);
                    } else if (!output || output.trim() === '') {
                        // outputì´ ì—†ìœ¼ë©´ "ì‹¤í–‰ ì™„ë£Œ" í‘œì‹œ
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = 'ì‹¤í–‰ ì™„ë£Œ';
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ì…€ ë°ì´í„°ì— output ì €ì¥
                        saveCellOutput(cellId, 'ì‹¤í–‰ ì™„ë£Œ');
                    }
                    

                    execSpan.textContent = `[${data.execution_count || '?'}]`;
                } else {
                    cell.status = 'error';
                    statusSpan.textContent = 'ì˜¤ë¥˜';
                    statusSpan.className = 'cell-status error';
                    outputDiv.className = 'cell-output error';
                    
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    let errorOutput = '';
                    if (data.error) {
                        errorOutput += data.error;
                    }
                    if (data.result && data.result.error) {
                        if (errorOutput) errorOutput += '\n';
                        errorOutput += data.result.error;
                    }
                    if (data.result && data.result.stderr) {
                        if (errorOutput) errorOutput += '\n';
                        errorOutput += data.result.stderr;
                    }
                    
                    // ìƒˆë¡œìš´ output ì¶”ê°€ (ì´ì „ output ìœ ì§€)
                    const newOutputDiv = document.createElement('div');
                    newOutputDiv.className = 'cell-output-new error';
                    newOutputDiv.textContent = errorOutput || 'ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    outputDiv.appendChild(newOutputDiv);
                    
                    // ì…€ ë°ì´í„°ì— error output ì €ì¥
                    saveCellOutput(cellId, errorOutput || 'ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                cell.status = 'error';
                statusSpan.textContent = 'ì˜¤ë¥˜';
                statusSpan.className = 'cell-status error';
                outputDiv.className = 'cell-output error';
                outputDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                console.error('ì…€ ì‹¤í–‰ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                // ì…€ ì‹¤í–‰ ì™„ë£Œ í›„ í ìƒíƒœ ì´ˆê¸°í™” ë° ë‹¤ìŒ ì…€ ì²˜ë¦¬
                isExecuting = false;
                currentExecutingCell = null;
                
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
            });
        }

        // crawl ì…€ìš© ì½”ë“œ ìƒì„± í•¨ìˆ˜
        function generateCrawlCode(crawlData, jobName) {
            // ê¸°ë³¸ import ì½”ë“œ
            let code = `import sys\n`;
            code += `import os\n`;
            code += `# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê¸°\n`;
            code += `current_dir = os.getcwd()\n`;
            code += `# CLASSë‚˜ MODULE í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ê²½ë¡œ ì„¤ì •\n`;
            code += `if os.path.exists(os.path.join(current_dir, 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'MODULE'))\n`;
            code += `elif os.path.exists(os.path.join(current_dir, '..', 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'MODULE'))\n`;
            code += `else:\n`;
            code += `    print("CLASS/MODULE í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")\n`;
            code += `    print(f"í˜„ì¬ ë””ë ‰í† ë¦¬: {current_dir}")\n`;
            code += `from class_job import Job\n\n`;
            
            // shared_dict ì´ˆê¸°í™” (ì»¤ë„ì—ì„œ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©)
            code += `# ì»¤ë„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ shared_dict ì‚¬ìš©\n`;
            code += `if 'shared_dict' not in globals():\n`;
            code += `    globals()['shared_dict'] = {}\n`;
            code += `    print("ê³µìš© ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ì´ˆê¸°í™”ë¨")\n`;
            code += `shared_dict = globals()['shared_dict']\n\n`;
            
            // notebook êµ¬ì¡°ë¥¼ class_job.py êµ¬ì¡°ë¡œ ë³€í™˜
            const args = convertToClassJobFormat(crawlData);
            
            // job ì„ ì–¸
            code += `# ${jobName} - ${crawlData.job_type} ${crawlData.action}\n`;
            code += `job_name = "${jobName}"\n`;
            code += `print("ğŸ” Original crawl_data:", ${JSON.stringify(crawlData, null, 4)})\n`;
            code += `print("ğŸ” Converted args:", ${JSON.stringify(args, null, 4)})\n`;
            code += `job_args = ${JSON.stringify(args, null, 4)}\n\n`;
            
            // Job ê°ì²´ ìƒì„± ë° ì‹¤í–‰
            code += `# Job ê°ì²´ ìƒì„± ë° ì‹¤í–‰\n`;
            code += `try:\n`;
            code += `    job = Job(job_name, job_args, shared_dict)\n`;
            code += `    result = job.run()\n`;
            code += `    print(f"Job '{job_name}' ì‹¤í–‰ ê²°ê³¼: {result}")\n`;
            code += `    # job ê²°ê³¼ë¥¼ shared_dictì— job nameì„ í‚¤ë¡œ ì €ì¥\n`;
            code += `    shared_dict[job_name] = result\n`;
            code += `    print(f"Job ê²°ê³¼ê°€ shared_dict['{job_name}']ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")\n`;
            code += `    if hasattr(result, 'data') and result.data is not None:\n`;
            code += `        print(f"ê²°ê³¼ ë°ì´í„°: {result.data}")\n`;
            code += `    if hasattr(result, 'message') and result.message:\n`;
            code += `        print(f"ë©”ì‹œì§€: {result.message}")\n`;
            code += `except Exception as e:\n`;
            code += `    print(f"Job ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")\n`;
            code += `    import traceback\n`;
            code += `    traceback.print_exc()\n`;
            code += `\n`;
            code += `print("Job ì‹¤í–‰ ì™„ë£Œ")\n`;
            
            return code;
        }

        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ì‚­ì œí•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ì…€ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;

            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            
            // ì…€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            updateCellNumbers();
        }

        function updateCellNumbers() {
            cells.forEach((cell, index) => {
                const numberSpan = document.querySelector(`#${cell.id} .cell-number`);
                if (numberSpan) {
                    numberSpan.textContent = `In [${index + 1}]:`;
                }
            });
        }

        function runAllCells() {
            cells.forEach(cell => {
                if (cell.content.trim()) {
                    setTimeout(() => runCell(cell.id), 100);
                }
            });
        }

        function clearAllOutputs() {
            cells.forEach(cell => {
                const outputDiv = document.querySelector(`#output-${cell.id}`);
                if (outputDiv) {
                    outputDiv.style.display = 'none';
                    outputDiv.textContent = '';
                }
                const statusSpan = document.querySelector(`#status-${cell.id}`);
                if (statusSpan) {
                    statusSpan.textContent = 'ëŒ€ê¸°ì¤‘';
                    statusSpan.className = 'cell-status';
                }
                const execSpan = document.querySelector(`#exec-${cell.id}`);
                if (execSpan) {
                    execSpan.textContent = '';
                }
            });
        }

        function clearAllCells() {
            if (!confirm('ëª¨ë“  ì…€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            cells = [];
            document.getElementById('notebookCells').innerHTML = '';
            cellCounter = 0;
            addCell();
        }

        function checkKernelStatus() {
            // ì»¤ë„ ìƒíƒœ í™•ì¸ í™œì„±í™”
            
            if (!activeFile || !fileKernels[activeFile]) {
                const statusElement = document.getElementById('kernelStatusText');
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (statusElement) {
                    statusElement.textContent = 'ì»¤ë„ ì—†ìŒ';
                }
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                    displayElement.style.color = '#a0aec0';
                }
                return;
            }

            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);

            
            fetch(`/api/kernels/${kernelIdStr}/status`)
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (data.success) {
                        let statusText = '';
                        let displayText = '';
                        let statusColor = '#a0aec0';
                        
                        // statusê°€ ê°ì²´ì¸ ê²½ìš° status ì†ì„±ì— ì ‘ê·¼
                        const status = data.status && typeof data.status === 'object' ? data.status.status : data.status;
                        
                        if (status === 'idle' || status === 'ready') {
                            statusText = 'ì¤€ë¹„ë¨';
                            displayText = 'ì»¤ë„ ìƒíƒœ: í™œì„±';
                            statusColor = '#68d391';
                        } else if (status === 'busy') {
                            statusText = 'ì‹¤í–‰ì¤‘';
                            displayText = 'ì»¤ë„ ìƒíƒœ: ì‹¤í–‰ì¤‘';
                            statusColor = '#f6ad55';
                        } else {
                            statusText = status || 'ì•Œ ìˆ˜ ì—†ìŒ';
                            displayText = `ì»¤ë„ ìƒíƒœ: ${status || 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                            statusColor = '#fc8181';
                        }
                        
                        if (statusElement) {
                            statusElement.textContent = statusText;
                        }
                        if (displayElement) {
                            displayElement.textContent = displayText;
                            displayElement.style.color = statusColor;
                        }
                    } else {
                        if (statusElement) {
                            statusElement.textContent = 'ì˜¤ë¥˜';
                        }
                        if (displayElement) {
                            displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ì˜¤ë¥˜';
                            displayElement.style.color = '#fc8181';
                        }
                    }
                })
                .catch(error => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (statusElement) {
                        statusElement.textContent = 'ì—°ê²° ì‹¤íŒ¨';
                    }
                    if (displayElement) {
                        displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨';
                        displayElement.style.color = '#fc8181';
                    }
                    console.error('ì»¤ë„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                });
        }

        function saveNotebookToFile() {
            if (!activeFile) {
                alert('ì €ì¥í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì €ì¥í•˜ê¸° ì „ì— ëª¨ë“  input ê°’ë“¤ì„ ë©”ëª¨ë¦¬ì— ë™ê¸°í™”
            syncCellContentsToMemory();

            // í˜„ì¬ ë…¸íŠ¸ë¶ì˜ ëª¨ë“  ì…€ ë‚´ìš©ì„ ìˆ˜ì§‘
            const cells = fileCells[activeFile] || [];
            
            if (!Array.isArray(cells) || cells.length === 0) {
                alert('ì €ì¥í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const notebookContent = [];
            
            cells.forEach(cell => {
                let content = '';
                
                // crawl ì…€ì¸ì§€ í™•ì¸
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                if (isCrawlCell) {
                    // crawl ì…€ì˜ ê²½ìš° JSON ëª¨ë“œ ë˜ëŠ” combobox UI ëª¨ë“œ í™•ì¸
                    const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked; // í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœë¡œ íŒë‹¨
                    const cellType = isJsonMode ? 'crawl_json' : 'crawl_ui';
                    
                    if (isJsonMode) {
                        // JSON ëª¨ë“œ: xml-content textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                        content = jsonTextarea.value;
                    } else {
                        // Combobox UI ëª¨ë“œ: í˜„ì¬ ì„¤ì •ëœ ê°’ë“¤ì„ JSONìœ¼ë¡œ ë³€í™˜
                        let crawlData = null;
                        
                        // 1. crawl_dataê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                        if (cell.crawl_data) {
                            crawlData = cell.crawl_data;
                        } else {
                            // 2. UI ìš”ì†Œì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                            const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                            const actionSelect = document.querySelector(`#${cell.id} .crawl-action`);
                            
                            if (jobTypeSelect && actionSelect) {
                                crawlData = {
                                    job_type: jobTypeSelect.value || 'do',
                                    action: actionSelect.value || '',
                                    params: {}
                                };
                                
                                // íŒŒë¼ë¯¸í„° ê°’ë“¤ ìˆ˜ì§‘ (focus ì œì™¸, ë³„ë„ ì²˜ë¦¬ - saveNotebook)
                                const paramInputs = document.querySelectorAll(`#crawl-params-${cell.id} input[name], #crawl-params-${cell.id} select[name]`);
                                
                                paramInputs.forEach(input => {
                                    // focus ê´€ë ¨ í•„ë“œëŠ” ë³„ë„ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œì™¸
                                    if (input.name && !input.name.includes('focus') && input.value) {
                                        // ìˆ«ì íƒ€ì… íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                                        const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'time', 'key_count', 'arg_count'];
                                        if (numberParams.includes(input.name)) {
                                            const numValue = parseFloat(input.value);
                                            if (!isNaN(numValue)) {
                                                crawlData.params[input.name] = numValue;
                                            }
                                        } else {
                                            crawlData.params[input.name] = input.value;
                                        }
                                    }
                                });
                                
                                // focus íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ì˜¬ë°”ë¥¸ DOM êµ¬ì¡° ì‚¬ìš© - saveNotebook)
                                const focusTypeSelect = document.querySelector(`#crawl-params-${cell.id} select[name="focus_type"]`);
                                const focusXpathInput = document.querySelector(`#crawl-params-${cell.id} input[name="focus_xpath"]`);
                                
                                if (focusTypeSelect && focusXpathInput) {
                                    const focusType = focusTypeSelect.value;
                                    const focusValue = focusXpathInput.value;
                                    
                                    if (focusType === 'current') {
                                        crawlData.params.focus = 'current';
                                    } else if (focusValue) {
                                        crawlData.params.focus = { [focusType]: focusValue };
                                    } else if (focusType && focusType !== 'current') {
                                        crawlData.params.focus = { [focusType]: "" };
                                    }
                                }
                            }
                        }
                        
                        if (crawlData) {
                            // ì €ì¥ ì‹œ focus íŒŒë¼ë¯¸í„° ë³€í™˜
                            if (crawlData.params && crawlData.params.focus && typeof crawlData.params.focus === 'string') {
                                try {
                                    crawlData.params.focus = JSON.parse(crawlData.params.focus);
                                } catch(e) {
                                    // íŒŒì‹± ì‹¤íŒ¨ì‹œ ê·¸ëŒ€ë¡œ ìœ ì§€
                                }
                            }
                            content = JSON.stringify(crawlData, null, 2);
                        } else {
                            // 3. ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•˜ë©´ ê¸°ì¡´ content ì‚¬ìš©
                            content = cell.content || '';
                        }
                    }
                } else {
                    // ì¼ë°˜ ì½”ë“œ ì…€: cell-input textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content;
                }
                
                // contentê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                if (typeof content !== 'string') {
                    content = String(content);
                }
                
                if (content.trim() !== '') {
                    if (isCrawlCell) {
                        function splitJsonObjects(jsonStr) {
                            const objects = [];
                            let current = '';
                            let braceCount = 0;
                            let inString = false;
                            let escapeNext = false;
                            for (let i = 0; i < jsonStr.length; i++) {
                                const char = jsonStr[i];
                                if (escapeNext) { current += char; escapeNext = false; continue; }
                                if (char === '\\') { escapeNext = true; current += char; continue; }
                                if (char === '"' && !escapeNext) { inString = !inString; }
                                if (!inString) {
                                    if (char === '{') { if (braceCount === 0) { current = char; } else { current += char; } braceCount++; }
                                    else if (char === '}') { current += char; braceCount--; if (braceCount === 0) { const trimmed = current.trim(); if (trimmed) { objects.push(trimmed); } current = ''; } }
                                    else { if (braceCount > 0) { current += char; } }
                                } else { current += char; }
                            }
                            return objects;
                        }
                        const jsonObjects = splitJsonObjects(content);
                        
                        // JSON ëª¨ë“œì¸ì§€ í™•ì¸
                        const xmlToggle2 = document.getElementById(`xml-toggle-${cell.id}`);
                        const isJsonMode2 = xmlToggle2 && xmlToggle2.checked; // í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœë¡œ íŒë‹¨
                        const cellType = isJsonMode2 ? 'crawl_json' : 'crawl_ui';
                        
                        if (jsonObjects.length > 1) {
                            jsonObjects.forEach((jsonStr, index) => {
                                try {
                                    JSON.parse(jsonStr);
                                    const cellData = { 
                                        cell_type: cellType, 
                                        content: jsonStr, 
                                        metadata: { name: cell.name || '' }, // ì…€ ì´ë¦„ ì €ì¥
                                        output_history: cell.output_history || []
                                    };
                                    notebookContent.push(cellData);
    
                                } catch (parseError) { 
                                    console.error(`Crawl ì…€ ${cell.id} ë¶„í•  ${index + 1} íŒŒì‹± ì‹¤íŒ¨:`, parseError);
                                }
                            });
                        } else {
                            const cellData = { 
                                cell_type: cellType, 
                                content: content, 
                                metadata: { name: cell.name || '' }, // ì…€ ì´ë¦„ ì €ì¥
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            // console.log(`Crawl ì…€ ${cell.id} ë‹¨ì¼ ê°ì²´ë¡œ ì¶”ê°€ë¨ (íƒ€ì…: ${cellType}, name: ${cell.name}, output_history: ${cell.output_history ? cell.output_history.length : 0}ê°œ)`);
                        }
                                            } else {
                            // output_historyë„ í•¨ê»˜ ì €ì¥
                            const cellData = { 
                                cell_type: 'code', 
                                content: content, 
                                metadata: { name: cell.name || '' }, // ì…€ ì´ë¦„ ì €ì¥
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            // console.log(`ì½”ë“œ ì…€ ${cell.id} ì¶”ê°€ë¨ (output_history: ${cell.output_history ? cell.output_history.length : 0}ê°œ)`);
                        }
                } else {
                    
                }
            });
            // ë””ë²„ê¹…: ë¶„í• ëœ notebookContent ì¶œë ¥


            if (notebookContent.length === 0) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì €ì¥ í˜•ì‹ ê²°ì •
            const fileName = activeFile.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();

            let contentToSave = '';
            if (fileExtension === 'ipynb') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        execution_count: null, 
                        metadata: item.metadata, 
                        outputs: item.output_history ? item.output_history.map(entry => ({
                            output_type: "stream",
                            name: "stdout",
                            text: entry.output
                        })) : [], 
                        source: item.content
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else if (fileExtension === 'npn') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        metadata: item.metadata, 
                        source: item.content,
                        output_history: item.output_history || []
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else {
                contentToSave = notebookContent.map(item => item.content).join('\n\n');
            }
            // ë””ë²„ê¹…: ì €ì¥ ì§ì „ contentToSave ì¶œë ¥


            // íŒŒì¼ ì €ì¥ API í˜¸ì¶œ
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ path: activeFile, content: contentToSave })
            })
            .then(response => response.json())
            .then(data => {
                // ë””ë²„ê¹…: ì €ì¥ API ì‘ë‹µ ì¶œë ¥
    
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ë…¸íŠ¸ë¶ì´ "${fileName}"ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ì €ì¥ í›„ ìë™ reload ì œê±°
                    // checkFileUpdatedAndReload(activeFile, contentToSave);
                    
                } else {
                    alert(data.message || 'íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // Python ë³€í™˜ ì €ì¥ í•¨ìˆ˜
        function saveAsPython() {
            if (!activeFile) {
                alert('ì €ì¥í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // í˜„ì¬ ë…¸íŠ¸ë¶ì˜ ëª¨ë“  ì…€ ë‚´ìš©ì„ ìˆ˜ì§‘
            const cells = fileCells[activeFile] || [];
            
            if (!Array.isArray(cells) || cells.length === 0) {
                alert('ì €ì¥í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // Python ì½”ë“œë¡œ ë³€í™˜
            let pythonCode = '';
            
            // shared_dict ì´ˆê¸°í™” ì¶”ê°€
            pythonCode += '# -*- coding: utf-8 -*-\n';
            pythonCode += '# Paramita AIì—ì„œ ë³€í™˜ëœ Python ì½”ë“œ\n\n';
            pythonCode += '# ê²½ë¡œ ì„¤ì • ë° class_job import\n';
            pythonCode += 'import os\n';
            pythonCode += 'import sys\n';
            pythonCode += 'current_dir = os.getcwd()\n';
            pythonCode += 'if os.path.exists(os.path.join(current_dir, \'CLASS\')):\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'CLASS\'))\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'MODULE\'))\n';
            pythonCode += 'elif os.path.exists(os.path.join(current_dir, \'..\', \'CLASS\')):\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'..\', \'CLASS\'))\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'..\', \'MODULE\'))\n';
            pythonCode += 'else:\n';
            pythonCode += '    print("CLASS/MODULE í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")\n';
            pythonCode += '    print(f"í˜„ì¬ ë””ë ‰í† ë¦¬: {current_dir}")\n';
            pythonCode += 'from class_job import Job\n\n';
            pythonCode += '# shared_dict ì´ˆê¸°í™”\n';
            pythonCode += 'if \'shared_dict\' not in globals():\n';
            pythonCode += '    globals()[\'shared_dict\'] = {}\n';
            pythonCode += '    print("ê³µìš© ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ì´ˆê¸°í™”ë¨")\n';
            pythonCode += 'shared_dict = globals()[\'shared_dict\']\n\n';
            
            cells.forEach((cell, index) => {
                let content = '';
                
                // crawl ì…€ì¸ì§€ í™•ì¸
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                if (isCrawlCell) {
                    // crawl ì…€ì˜ ê²½ìš° JSON ëª¨ë“œ ë˜ëŠ” combobox UI ëª¨ë“œ í™•ì¸
                    const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked;
                    
                    if (isJsonMode) {
                        // JSON ëª¨ë“œ: xml-content textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                        content = jsonTextarea.value;
                    } else {
                        // Combobox UI ëª¨ë“œ: í˜„ì¬ ì„¤ì •ëœ ê°’ë“¤ì„ JSONìœ¼ë¡œ ë³€í™˜
                        let crawlData = null;
                        
                        if (cell.crawl_data) {
                            crawlData = cell.crawl_data;
                        } else {
                            // UI ìš”ì†Œì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                            const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                            const actionSelect = document.querySelector(`#${cell.id} .crawl-action`);
                            
                            if (jobTypeSelect && actionSelect) {
                                crawlData = {
                                    job_type: jobTypeSelect.value || 'do',
                                    action: actionSelect.value || '',
                                    params: {}
                                };
                                
                                // íŒŒë¼ë¯¸í„° ê°’ë“¤ ìˆ˜ì§‘ (focus ì œì™¸, ë³„ë„ ì²˜ë¦¬ - saveAsPython)
                                const paramInputs = document.querySelectorAll(`#crawl-params-${cell.id} input[name], #crawl-params-${cell.id} select[name]`);
                                
                                paramInputs.forEach(input => {
                                    // focus ê´€ë ¨ í•„ë“œëŠ” ë³„ë„ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œì™¸
                                    if (input.name && !input.name.includes('focus') && input.value) {
                                        // ìˆ«ì íƒ€ì… íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                                        const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'time', 'key_count', 'arg_count'];
                                        if (numberParams.includes(input.name)) {
                                            const numValue = parseFloat(input.value);
                                            if (!isNaN(numValue)) {
                                                crawlData.params[input.name] = numValue;
                                            }
                                        } else {
                                            crawlData.params[input.name] = input.value;
                                        }
                                    }
                                });
                                
                                // focus íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ì˜¬ë°”ë¥¸ DOM êµ¬ì¡° ì‚¬ìš© - saveAsPython)
                                const focusTypeSelect = document.querySelector(`#crawl-params-${cell.id} select[name="focus_type"]`);
                                const focusXpathInput = document.querySelector(`#crawl-params-${cell.id} input[name="focus_xpath"]`);
                                
                                if (focusTypeSelect && focusXpathInput) {
                                    const focusType = focusTypeSelect.value;
                                    const focusValue = focusXpathInput.value;
                                    
                                    if (focusType === 'current') {
                                        crawlData.params.focus = 'current';
                                    } else if (focusValue) {
                                        crawlData.params.focus = { [focusType]: focusValue };
                                    } else if (focusType && focusType !== 'current') {
                                        crawlData.params.focus = { [focusType]: "" };
                                    }
                                }
                            }
                        }
                        
                        if (crawlData) {
                            // ì €ì¥ ì‹œ focus íŒŒë¼ë¯¸í„° ë³€í™˜
                            if (crawlData.params && crawlData.params.focus && typeof crawlData.params.focus === 'string') {
                                try {
                                    crawlData.params.focus = JSON.parse(crawlData.params.focus);
                                } catch(e) {
                                    // íŒŒì‹± ì‹¤íŒ¨ì‹œ ê·¸ëŒ€ë¡œ ìœ ì§€
                                }
                            }
                            content = JSON.stringify(crawlData, null, 2);
                        } else {
                            content = cell.content || '';
                        }
                    }
                    
                    // crawl ì…€ì„ Python ì½”ë“œë¡œ ë³€í™˜
                    if (content.trim() !== '') {
                        try {
                            const crawlData = JSON.parse(content);
                            pythonCode += `# ì…€ ${index + 1}${cell.name ? ` - ${cell.name}` : ''}\n`;
                            pythonCode += `print("=== ì…€ ${index + 1}${cell.name ? ` - ${cell.name}` : ''} ì‹¤í–‰ ===\\n")\n\n`;
                            
                            // job_name ìƒì„± (ì…€ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
                            const jobName = cell.name || `job_${index + 1}`;
                            
                            // notebook êµ¬ì¡°ë¥¼ class_job.py êµ¬ì¡°ë¡œ ë³€í™˜
                            const args = convertToClassJobFormat(crawlData);
                            
                            // Job ê°ì²´ ìƒì„± ë° ì‹¤í–‰ ì½”ë“œ ìƒì„±
                            pythonCode += `# ${jobName} - ${crawlData.job_type} ${crawlData.action}\n`;
                            pythonCode += `job_name = "${jobName}"\n`;
                            pythonCode += `job_args = ${JSON.stringify(args, null, 4)}\n\n`;
                            pythonCode += `# Job ê°ì²´ ìƒì„± ë° ì‹¤í–‰\n`;
                            pythonCode += `try:\n`;
                            pythonCode += `    job = Job(job_name, job_args, shared_dict)\n`;
                            pythonCode += `    result = job.run()\n`;
                            pythonCode += `    print(f"Job '{job_name}' ì‹¤í–‰ ê²°ê³¼: {result}")\n`;
                            pythonCode += `    # job ê²°ê³¼ë¥¼ shared_dictì— job nameì„ í‚¤ë¡œ ì €ì¥\n`;
                            pythonCode += `    shared_dict[job_name] = result\n`;
                            pythonCode += `    print(f"Job ê²°ê³¼ê°€ shared_dict['{job_name}']ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")\n`;
                            pythonCode += `    if hasattr(result, 'data') and result.data is not None:\n`;
                            pythonCode += `        print(f"ê²°ê³¼ ë°ì´í„°: {result.data}")\n`;
                            pythonCode += `    if hasattr(result, 'message') and result.message:\n`;
                            pythonCode += `        print(f"ë©”ì‹œì§€: {result.message}")\n`;
                            pythonCode += `except Exception as e:\n`;
                            pythonCode += `    print(f"Job ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")\n`;
                            pythonCode += `    import traceback\n`;
                            pythonCode += `    traceback.print_exc()\n`;
                            pythonCode += `\n`;
                            pythonCode += `print("Job ì‹¤í–‰ ì™„ë£Œ")\n\n`;
                            
                        } catch (parseError) {
                            console.error(`Crawl ì…€ ${cell.id} JSON íŒŒì‹± ì‹¤íŒ¨:`, parseError);
                            pythonCode += `# ì…€ ${index + 1} - íŒŒì‹± ì‹¤íŒ¨\n`;
                            pythonCode += `print("ì…€ ${index + 1} íŒŒì‹± ì‹¤íŒ¨")\n\n`;
                        }
                    }
                    
                } else {
                    // ì¼ë°˜ ì½”ë“œ ì…€: cell-input textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content;
                    
                    if (content.trim() !== '') {
                        pythonCode += `# ì…€ ${index + 1}${cell.name ? ` - ${cell.name}` : ''}\n`;
                        pythonCode += `print("=== ì…€ ${index + 1}${cell.name ? ` - ${cell.name}` : ''} ì‹¤í–‰ ===\\n")\n\n`;
                        pythonCode += content + '\n\n';
                    }
                }
            });
            
            if (pythonCode.trim() === '') {
                alert('ë³€í™˜í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Python íŒŒì¼ëª… ìƒì„±
            const fileName = activeFile.split('/').pop();
            const baseName = fileName.split('.')[0];
            const pythonFileName = baseName + '.py';
            const pythonFilePath = activeFile.replace(fileName, pythonFileName);

            // Python íŒŒì¼ ì €ì¥ API í˜¸ì¶œ
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ path: pythonFilePath, content: pythonCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `Python ì½”ë“œê°€ "${pythonFileName}"ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                } else {
                    alert(data.message || 'Python íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Python íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('Python íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì»¤ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ kernel_manager.htmlì—ì„œ ì²˜ë¦¬ë¨

        // ì»¤ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ kernel_manager.htmlì—ì„œ ì²˜ë¦¬ë¨

        // íŒŒì¼ ë¸Œë¼ìš°ì € ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ file_browser.htmlì—ì„œ ì²˜ë¦¬ë¨

        function switchSidebarTab(panelId) {
            console.log('íƒ­ ì „í™˜ ì‹œë„:', panelId);
            
            // í˜„ì¬ í™œì„± íƒ­ í™•ì¸
            const currentActiveTab = document.querySelector('.sidebar-tab.active');
            const currentActivePanel = document.querySelector('.sidebar-panel.active');
            
            // í´ë¦­ëœ íƒ­ ì¸ë±ìŠ¤
            const clickedTabIndex = panelId === 'fileTreePanel' ? 0 : 1;
            const clickedTab = document.querySelectorAll('.sidebar-tab')[clickedTabIndex];
            
            // ê°™ì€ íƒ­ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš° (í† ê¸€)
            if (currentActivePanel && currentActivePanel.id === panelId) {
                console.log('ê°™ì€ íƒ­ í´ë¦­ - íŒ¨ë„ í† ê¸€');
                
                // íŒ¨ë„ì´ ì ‘í˜€ìˆëŠ”ì§€ í™•ì¸
                const sidebar = document.querySelector('.file-browser-sidebar');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // ì ‘íŒ ìƒíƒœì—ì„œ í¼ì¹˜ê¸°
                    sidebar.classList.remove('collapsed');
                    console.log('íŒ¨ë„ í¼ì¹¨');
                } else {
                    // í¼ì³ì§„ ìƒíƒœì—ì„œ ì ‘ê¸°
                    sidebar.classList.add('collapsed');
                    console.log('íŒ¨ë„ ì ‘ìŒ');
                }
                return;
            }
            
            // ë‹¤ë¥¸ íƒ­ì„ í´ë¦­í•œ ê²½ìš° (ê¸°ì¡´ ë¡œì§)
            console.log('ë‹¤ë¥¸ íƒ­ í´ë¦­ - íƒ­ ì „í™˜');
            
            // íŒ¨ë„ì´ ì ‘í˜€ìˆë‹¤ë©´ í¼ì¹˜ê¸°
            const sidebar = document.querySelector('.file-browser-sidebar');
            sidebar.classList.remove('collapsed');
            
            // ëª¨ë“  íƒ­ê³¼ íŒ¨ë„ ë¹„í™œì„±í™”
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
                console.log('íƒ­ ë¹„í™œì„±í™”:', tab);
            });
            
            document.querySelectorAll('.sidebar-panel').forEach(panel => {
                panel.classList.remove('active');
                console.log('íŒ¨ë„ ë¹„í™œì„±í™”:', panel.id);
            });
            
            // í´ë¦­ëœ íƒ­ í™œì„±í™”
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('íƒ­ í™œì„±í™”:', panelId);
            }
            
            // í•´ë‹¹ íŒ¨ë„ í™œì„±í™”
            const targetPanel = document.getElementById(panelId);
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('íŒ¨ë„ í™œì„±í™”:', panelId);
                
                // ì»¤ë„ íŒ¨ë„ì´ í™œì„±í™”ë˜ë©´ ì •ë³´ ì—…ë°ì´íŠ¸
                if (panelId === 'kernelPanel') {
                    updateKernelInfo();
                }
            }
        }

        // ì»¤ë„ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ kernel_manager.htmlì—ì„œ ì²˜ë¦¬ë¨

        // ì»¤ë„ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateKernelInfo() {
            // í˜„ì¬ í™œì„± íŒŒì¼ì˜ ì»¤ë„ ì •ë³´ í‘œì‹œ
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                const fileName = activeFile.split('/').pop();
                
                document.getElementById('currentKernelInfo').textContent = 
                    `ì»¤ë„: ${kernelIdStr} | íŒŒì¼: ${fileName}`;
            } else {
                document.getElementById('currentKernelInfo').textContent = 'ì»¤ë„: ì—†ìŒ';
            }
        }

        // ì»¤ë„ ì‹œê°„ì œí•œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        let kernelTimeInterval = null;

        function updateKernelTimeDisplay(kernelId) {
            // ì„œë²„ì—ì„œ í•œ ë²ˆë§Œ ì‹œê°„ì œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            fetch(`/api/kernels/${kernelId}/remaining-time`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.remaining_time) {
                        const remaining = data.remaining_time;
                        const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                        
                        if (remaining.expired) {
                            timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: ë§Œë£Œë¨';
                            timeDisplayElement.style.background = '#e53e3e';
                            timeDisplayElement.style.color = '#ffffff';
                        } else {
                            const hours = remaining.remaining_hours;
                            const minutes = remaining.remaining_minutes;
                            const seconds = remaining.remaining_seconds_only;
                            
                            timeDisplayElement.textContent = `ë‚¨ì€ ì‹œê°„: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            // ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e'; // ë¹¨ê°„ìƒ‰
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e'; // ì£¼í™©ìƒ‰
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748'; // ê¸°ë³¸ìƒ‰
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('ì»¤ë„ ì‹œê°„ì œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: ì˜¤ë¥˜';
                    timeDisplayElement.style.background = '#e53e3e';
                    timeDisplayElement.style.color = '#ffffff';
                });
        }

        function startKernelTimeUpdate() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
            }
            
            // ë¨¼ì € ì„œë²„ì—ì„œ í˜„ì¬ ì‹œê°„ì œí•œ ì •ë³´ë¥¼ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸°
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                updateKernelTimeDisplay(kernelIdStr);
            }
            
            // ê·¸ í›„ì—ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ 1ì´ˆì”© ì¤„ì´ê¸°
            kernelTimeInterval = setInterval(() => {
                if (activeFile && fileKernels[activeFile]) {
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    const currentText = timeDisplayElement.textContent;
                    
                    if (currentText.includes(':')) {
                        const timeParts = currentText.split(':');
                        
                        if (timeParts.length >= 3) {
                            // ì‹œê°„ íŒŒíŠ¸ê°€ 4ê°œì¸ ê²½ìš°: ['ë‚¨ì€ ì‹œê°„', ' 11', '58', '42']
                            // ì‹œê°„ íŒŒíŠ¸ê°€ 3ê°œì¸ ê²½ìš°: ['11', '58', '42']
                            let hours, minutes, seconds;
                            
                            if (timeParts.length === 4) {
                                // 4ê°œ íŒŒíŠ¸ì¸ ê²½ìš°: ['ë‚¨ì€ ì‹œê°„', ' 11', '58', '42']
                                hours = parseInt(timeParts[1].trim());
                                minutes = parseInt(timeParts[2]);
                                seconds = parseInt(timeParts[3]);
                            } else {
                                // 3ê°œ íŒŒíŠ¸ì¸ ê²½ìš°: ['11', '58', '42']
                                hours = parseInt(timeParts[0].replace('ë‚¨ì€ ì‹œê°„: ', ''));
                                minutes = parseInt(timeParts[1]);
                                seconds = parseInt(timeParts[2]);
                            }
                            
                            // NaN ì²´í¬
                            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                                const kernelId = fileKernels[activeFile];
                                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                                updateKernelTimeDisplay(kernelIdStr);
                                return;
                            }
                            
                            seconds--;
                            if (seconds < 0) {
                                seconds = 59;
                                minutes--;
                                if (minutes < 0) {
                                    minutes = 59;
                                    hours--;
                                    if (hours < 0) {
                                        // ì‹œê°„ ë§Œë£Œ
                                        timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: ë§Œë£Œë¨';
                                        timeDisplayElement.style.background = '#e53e3e';
                                        timeDisplayElement.style.color = '#ffffff';
                                        return;
                                    }
                                }
                            }
                            
                            const newText = `ë‚¨ì€ ì‹œê°„: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            timeDisplayElement.textContent = newText;
                            
                            // ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748';
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                }
            }, 1000);
        }

        function stopKernelTimeUpdate() {
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
                kernelTimeInterval = null;
            }
        }

        function extendKernelTimeout() {
            if (!activeFile || !fileKernels[activeFile]) {
                alert('í™œì„± ì»¤ë„ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            fetch(`/api/kernels/${kernelIdStr}/extend-timeout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    additional_hours: 12
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = 'ì»¤ë„ ì‹œê°„ì œí•œì´ 12ì‹œê°„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ì‹œê°„ì œí•œ ì—°ì¥ í›„ ì„œë²„ì—ì„œ ìƒˆë¡œ ê°€ì ¸ì˜¤ê¸°
                    updateKernelTimeDisplay(kernelIdStr);
                } else {
                    alert(data.error || 'ì»¤ë„ ì‹œê°„ì œí•œ ì—°ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì»¤ë„ ì‹œê°„ì œí•œ ì—°ì¥ ì‹¤íŒ¨:', error);
                alert('ì»¤ë„ ì‹œê°„ì œí•œ ì—°ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ ì»¤ë„ ìƒíƒœ í™•ì¸
        setInterval(checkKernelStatus, 10000);

        // ì„±ëŠ¥ ìµœì í™”ëœ crawl ì…€ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeCrawlCellOptimized(cellId, content, isJsonMode) {
            try {
                let crawlData;
                
                // content íŒŒì‹± (ê¸°ì¡´ê³¼ ë™ì¼)
                if (typeof content === 'object' && content !== null) {
                    crawlData = content;
                } else {
                    let contentStr = content;
                    if (typeof content !== 'string') {
                        contentStr = String(content);
                    }
                    
                    if (!contentStr || contentStr === '[object Object]' || contentStr.trim() === '') {
                        crawlData = { job_type: 'do', action: 'click', params: {} };
                    } else {
                        crawlData = JSON.parse(contentStr);
                    }
                }
                
                // ê¸°ë³¸ê°’ ì¶”ê°€
                crawlData = addDefaultParams(crawlData);
                
                const cell = fileCells[activeFile].find(c => c.id === cellId);
                if (cell) {
                    cell.crawl_data = crawlData;
                }
                
                // UI ì¦‰ì‹œ ì„¤ì • (setTimeout ì œê±°)
                const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
                if (jobTypeSelect) {
                    jobTypeSelect.value = crawlData.job_type || 'do';
                    updateCrawlActionsOptimized(cellId, crawlData.job_type || 'do');
                    
                    // Action ì„¤ì •
                    const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                    if (actionSelect && crawlData.action) {
                        actionSelect.value = crawlData.action;
                        renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                        
                        // íŒŒë¼ë¯¸í„° ê°’ë“¤ ë³µì›
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                if (paramName === 'focus') {
                                    // focus íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                                    const focusData = crawlData.params[paramName];
                                    const focusTypeSelect = document.querySelector(`#${cellId} select[name="focus_type"]`);
                                    const focusXpathInput = document.querySelector(`#${cellId} input[name="focus_xpath"]`);
                                    
                                    if (focusTypeSelect && focusXpathInput) {
                                        if (focusData === 'current') {
                                            focusTypeSelect.value = 'current';
                                            focusXpathInput.style.display = 'none';
                                            focusXpathInput.value = '';
                                        } else if (typeof focusData === 'object') {
                                            const focusType = Object.keys(focusData)[0];
                                            const focusValue = focusData[focusType];
                                            
                                            focusTypeSelect.value = focusType;
                                            focusXpathInput.value = focusValue;
                                            focusXpathInput.style.display = '';
                                        }
                                    }
                                } else {
                                    const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                    if (paramInput) {
                                        paramInput.value = crawlData.params[paramName];
                                    }
                                }
                            });
                        }
                    }
                }
                
                // JSON ëª¨ë“œì¸ ê²½ìš° JSON ìƒì„± (ë¹„ë™ê¸°)
                if (isJsonMode) {
                    requestAnimationFrame(() => {
                        const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                        if (jsonTextarea && !jsonTextarea.value.trim()) {
                            generateJsonOutput(cellId);
                        }
                    });
                }
                
            } catch (e) {
                console.error('Crawl ì…€ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
            }
        }

        // ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ (í˜¸í™˜ì„±)
        function initializeCrawlCell(cellId, content) {
            try {
                let crawlData;
                
                // contentê°€ ì´ë¯¸ ê°ì²´ì¸ì§€ í™•ì¸
                if (typeof content === 'object' && content !== null) {
                    // ì´ë¯¸ ê°ì²´ë¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    crawlData = content;
                } else {
                    // contentê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                    let contentStr = content;
                    if (typeof content !== 'string') {
                        contentStr = String(content);
                    }
                    
                    // ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ "[object Object]"ì¸ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                    if (!contentStr || contentStr === '[object Object]' || contentStr.trim() === '') {
                        crawlData = { job_type: 'do', action: 'click', params: {} };
                    } else {
                        crawlData = JSON.parse(contentStr);
                    }
                }
                
                // ê¸°ë³¸ê°’ ì¶”ê°€
                crawlData = addDefaultParams(crawlData);
                
                const cell = fileCells[activeFile].find(c => c.id === cellId);
                if (cell) {
                    cell.crawl_data = crawlData;
                }
                
                // Job Type ì„¤ì •
                const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
                if (jobTypeSelect) {
                    jobTypeSelect.value = crawlData.job_type || 'do';
                    

                    
                    updateCrawlActions(cellId, crawlData.job_type || 'do');
                    
                    // Action ì„¤ì • (ì•½ê°„ì˜ ì§€ì—° í›„)
                    setTimeout(() => {
                        const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                        if (actionSelect && crawlData.action) {
                            actionSelect.value = crawlData.action;
                            

                            
                            renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                            
                            // íŒŒë¼ë¯¸í„° ê°’ë“¤ ë³µì› (ì•½ê°„ì˜ ì§€ì—° í›„)
                            setTimeout(() => {
                                if (crawlData.params) {
                                    Object.keys(crawlData.params).forEach(paramName => {
                                        if (paramName === 'focus') {
                                            // focus íŒŒë¼ë¯¸í„° íŠ¹ë³„ ì²˜ë¦¬
                                            const focusData = crawlData.params[paramName];
                                            const focusTypeSelect = document.querySelector(`#${cellId} select[name="focus_type"]`);
                                            const focusXpathInput = document.querySelector(`#${cellId} input[name="focus_xpath"]`);
                                            
                                            if (focusTypeSelect && focusXpathInput) {
                                                if (focusData === 'current') {
                                                    // 'current' íƒ€ì… ì²˜ë¦¬
                                                    focusTypeSelect.value = 'current';
                                                    focusXpathInput.style.display = 'none';
                                                    focusXpathInput.value = '';
                                                } else if (typeof focusData === 'object') {
                                                    // ê°ì²´ íƒ€ì… ì²˜ë¦¬ (xpath, selector ë“±)
                                                    const focusType = Object.keys(focusData)[0];
                                                    const focusValue = focusData[focusType];
                                                    
                                                    focusTypeSelect.value = focusType;
                                                    focusXpathInput.value = focusValue;
                                                    focusXpathInput.style.display = '';
                                                }
                                            }
                                        } else {
                                            const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                            if (paramInput) {
                                                paramInput.value = crawlData.params[paramName];
                                            }
                                        }
                                    });
                                }
                                
                                // XML ì¶œë ¥ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì´ˆê¸° XML ìƒì„±
                                const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
                                if (xmlToggle && xmlToggle.checked) {
                                    generateJsonOutput(cellId);
                                    
                                    // JSON textarea í¬ê¸° ìë™ ì¡°ì •
                                    setTimeout(() => {
                                        const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                                        if (jsonTextarea) {
                                            autoResizeTextarea(jsonTextarea);
                                        }
                                    }, 100);
                                }
                            }, 50);
                        }
                    }, 50);
                }
            } catch (e) {
                console.error('Crawl ì…€ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
            }
        }

        // crawl ì…€ ì—…ë°ì´íŠ¸
        function updateCrawlCell(cellId, field, value) {
            console.log(`ğŸ”„ updateCrawlCell í˜¸ì¶œë¨: cellId=${cellId}, field=${field}, value=${value}`);
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (!cell) {
                console.error(`âŒ ì…€ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${cellId}`);
                return;
            }
            
            console.log(`âœ… ì…€ ì°¾ìŒ:`, cell);
            
            if (!cell.crawl_data) {
                cell.crawl_data = { job_type: 'do', action: 'click', params: {} };
            }
            
            if (field === 'job_type') {
                cell.crawl_data.job_type = value;
                cell.crawl_data.action = '';
                cell.crawl_data.params = {};
                updateCrawlActions(cellId, value);
            } else if (field === 'action') {
                cell.crawl_data.action = value;
                renderCrawlParams(cellId, cell.crawl_data.job_type, value);
                
                // actionì´ ë³€ê²½ë˜ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
                cell.crawl_data = addDefaultParams(cell.crawl_data);

            } else if (field.startsWith('param_')) {
                const paramName = field.replace('param_', '');
                cell.crawl_data.params[paramName] = value;
                
                // ë™ì  íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (key_count, arg_count ë³€ê²½ ì‹œ)
                if (paramName === 'key_count' && cell.crawl_data.job_type === 'data' && cell.crawl_data.action === 'key_to_list') {
                    handleKeyCountChange(cellId, value);
                } else if (paramName === 'arg_count' && cell.crawl_data.job_type === 'python' && cell.crawl_data.action === 'file') {
                    handleArgCountChange(cellId, value);
                }
            }
            
            // ì…€ ë‚´ìš© ì—…ë°ì´íŠ¸
            cell.content = JSON.stringify(cell.crawl_data, null, 2);
            
            // JSON ì¶œë ¥ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ìë™ ì—…ë°ì´íŠ¸
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            if (xmlToggle && xmlToggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // ì„±ëŠ¥ ìµœì í™”ëœ ì•¡ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCrawlActionsOptimized(cellId, jobType) {
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            if (!actionSelect) return;
            
            actionSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            // ì•¡ì…˜ ë¼ë²¨ ì—…ë°ì´íŠ¸
            const actionLabel = document.getElementById(`action-label-${cellId}`);
            if (actionLabel) {
                const labelMap = {
                    'do': 'Action:', 'find': 'Find Type:', 'request': 'Request Type:',
                    'data': 'Convert Type:', 'save': 'Save Type:', 'load': 'Load Type:',
                    'python': 'Python Type:', 'wait': 'Wait Type:', 'test': 'Test Type:'
                };
                actionLabel.textContent = labelMap[jobType] || 'Action:';
            }
            
            // ë¹ ë¥¸ ì•¡ì…˜ ì˜µì…˜ ìƒì„±
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    const actionTypeMap = {
                        'do': 'actions', 'find': 'find_types', 'request': 'request_types',
                        'data': 'convert_types', 'save': 'save_types', 'load': 'load_types',
                        'python': 'python_types', 'wait': 'wait_types', 'test': 'test_types'
                    };
                    
                    const actionType = actionTypeMap[jobType] || actionTypeKeys[0];
                    const actions = Object.keys(jobTypeData[actionType]);
                    
                    // DocumentFragment ì‚¬ìš©ìœ¼ë¡œ DOM ì¡°ì‘ ìµœì†Œí™”
                    const fragment = document.createDocumentFragment();
                    actions.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        const actionData = jobTypeData[actionType][action];
                        option.textContent = actionData?.name || action.charAt(0).toUpperCase() + action.slice(1);
                        fragment.appendChild(option);
                    });
                    actionSelect.appendChild(fragment);
                }
            }
            
            // íŒŒë¼ë¯¸í„° ì˜ì—­ ì´ˆê¸°í™”
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (paramsDiv) paramsDiv.innerHTML = '';
        }

        // ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ (í˜¸í™˜ì„±)
        function updateCrawlActions(cellId, jobType) {
            console.log(`ğŸ”§ updateCrawlActions í˜¸ì¶œë¨: cellId=${cellId}, jobType=${jobType}`);
            
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            if (!actionSelect) {
                console.error(`âŒ action select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: #${cellId} .crawl-action`);
                return;
            }
            
            console.log(`âœ… action select ìš”ì†Œ ì°¾ìŒ:`, actionSelect);
            actionSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            // ì•¡ì…˜ ë¼ë²¨ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            const actionLabel = document.getElementById(`action-label-${cellId}`);
            if (actionLabel) {
                const labelMap = {
                    'do': 'Action:',
                    'find': 'Find Type:',
                    'request': 'Request Type:',
                    'data': 'Convert Type:',
                    'save': 'Save Type:',
                    'load': 'Load Type:',
                    'python': 'Python Type:',
                    'wait': 'Wait Type:',
                    'test': 'Test Type:'
                };
                actionLabel.textContent = labelMap[jobType] || 'Action:';
                console.log(`ğŸ·ï¸ ì•¡ì…˜ ë¼ë²¨ ì—…ë°ì´íŠ¸: ${actionLabel.textContent}`);
            }
            
            // window.jobTypesì—ì„œ ë™ì ìœ¼ë¡œ ì•¡ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ë°©ì‹)
            console.log(`ğŸ—‚ï¸ window.jobTypes í™•ì¸:`, window.jobTypes ? 'ìˆìŒ' : 'ì—†ìŒ');
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                console.log(`ğŸ“‹ jobTypeData:`, jobTypeData);
                
                // jobTypeDataì—ì„œ _typesë‚˜ actionsë¡œ ëë‚˜ëŠ” í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê¸°
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                console.log(`ğŸ”‘ actionTypeKeys:`, actionTypeKeys);
                
                if (actionTypeKeys.length > 0) {
                    // job íƒ€ì…ì— ë§ëŠ” ì •í™•í•œ ì•¡ì…˜ íƒ€ì… í‚¤ ì°¾ê¸°
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // ê¸°ë³¸ê°’
                    }
                    
                    console.log(`ğŸ¯ ì„ íƒëœ actionType: ${actionType}`);
                    const actions = Object.keys(jobTypeData[actionType]);
                    console.log(`ğŸ“Œ actions:`, actions);
                    
                    actions.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        // JOB_TYPESì—ì„œ nameì„ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
                        const actionData = jobTypeData[actionType][action];
                        const displayName = actionData && actionData.name ? actionData.name : action.charAt(0).toUpperCase() + action.slice(1);
                        option.textContent = displayName;
                        actionSelect.appendChild(option);
                        console.log(`  â• ì•¡ì…˜ ì˜µì…˜ ì¶”ê°€: ${action} (${displayName})`);
                    });
                    
                    console.log(`âœ… ì´ ${actions.length}ê°œì˜ ì•¡ì…˜ ì˜µì…˜ ì¶”ê°€ë¨`);
                    
                } else {
                    console.warn(`âš ï¸ actionTypeKeysê°€ ë¹„ì–´ìˆìŒ`);
                }
            } else {
                console.error(`âŒ window.jobTypes ë˜ëŠ” jobType '${jobType}' ë°ì´í„°ê°€ ì—†ìŒ`);
                console.log(`  - window.jobTypes:`, window.jobTypes);
                if (window.jobTypes) {
                    console.log(`  - ì‚¬ìš© ê°€ëŠ¥í•œ jobTypes:`, Object.keys(window.jobTypes));
                }
            }
            
            // íŒŒë¼ë¯¸í„° ì˜ì—­ ì´ˆê¸°í™”
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (paramsDiv) {
                paramsDiv.innerHTML = '';
            }
        }

        // crawl íŒŒë¼ë¯¸í„° ë Œë”ë§
        function renderCrawlParams(cellId, jobType, action) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            paramsDiv.innerHTML = '';
            
            const params = getCrawlParams(jobType, action);
            params.forEach(param => {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                
                let input;
                if (param.name === 'focus') {
                    // focus ì½¤ë³´ë°•ìŠ¤ (xpath, selector, current)
                    const focusTypeSelect = document.createElement('select');
                    focusTypeSelect.name = 'focus_type';
                    ['xpath', 'selector', 'current'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        focusTypeSelect.appendChild(option);
                    });
                    
                    // xpath ì…ë ¥ë€ (í•­ìƒ ë³´ì„)
                    const focusXpathInput = document.createElement('input');
                    focusXpathInput.name = 'focus_xpath';
                    focusXpathInput.type = 'text';
                    focusXpathInput.placeholder = 'xpath ê°’ (ì˜ˆ: //button[@id="login"])';
                    focusXpathInput.style.marginLeft = '0.5em';
                    
                    // focus íƒ€ì… ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ë™ê¸°í™”
                    focusTypeSelect.onchange = (e) => {
                        if (e.target.value === 'current') {
                            focusXpathInput.style.display = 'none';
                        } else {
                            focusXpathInput.style.display = '';
                        }
                        // ğŸ”„ focus ë°ì´í„° ì—…ë°ì´íŠ¸
                        updateFocusParameter(cellId);
                    };
                    
                    // focus xpath ê°’ ë³€ê²½ ì‹œ ë°ì´í„° ë™ê¸°í™”
                    focusXpathInput.onchange = (e) => {
                        // ğŸ”„ focus ë°ì´í„° ì—…ë°ì´íŠ¸
                        updateFocusParameter(cellId);
                    };
                    
                    paramField.appendChild(label);
                    paramField.appendChild(focusTypeSelect);
                    paramField.appendChild(focusXpathInput);
                    paramsDiv.appendChild(paramField);
                    return;
                }
                if (param.type === 'select') {
                    input = document.createElement('select');
                    input.name = param.name;
                    param.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                } else {
                    input = document.createElement('input');
                    input.name = param.name;
                    input.type = param.type || 'text';
                    input.placeholder = param.placeholder || '';
                }
                input.onchange = (e) => {
                    updateCrawlCell(cellId, `param_${param.name}`, e.target.value);
                    if (param.name === 'key_count' && jobType === 'data' && action === 'key_to_list') {
                        handleKeyCountChange(cellId, e.target.value);
                    } else if (param.name === 'arg_count' && jobType === 'python' && action === 'file') {
                        handleArgCountChange(cellId, e.target.value);
                    }
                };
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            });
                }
        
        // focus íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateFocusParameter(cellId) {
            const focusTypeSelect = document.querySelector(`#crawl-params-${cellId} select[name="focus_type"]`);
            const focusXpathInput = document.querySelector(`#crawl-params-${cellId} input[name="focus_xpath"]`);
            
            if (!focusTypeSelect || !focusXpathInput) return;
            
            const focusType = focusTypeSelect.value;
            const focusValue = focusXpathInput.value;
            
            let focusData;
            if (focusType === 'current') {
                focusData = 'current';
            } else {
                focusData = { [focusType]: focusValue || "" };
            }
            
            // updateCrawlCellì„ í†µí•´ focus íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
            updateCrawlCell(cellId, 'param_focus', focusData);
        }

        // key_count ë³€ê²½ ì‹œ ë™ì  í‚¤ ì…ë ¥ í•„ë“œ ìƒì„±
        function handleKeyCountChange(cellId, keyCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // ê¸°ì¡´ key_ í•„ë“œë“¤ ì œê±°
            const existingKeyFields = paramsDiv.querySelectorAll('.dynamic-key-field');
            existingKeyFields.forEach(field => field.remove());
            
            // ìƒˆë¡œìš´ key_ í•„ë“œë“¤ ìƒì„±
            for (let i = 0; i < parseInt(keyCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-key-field';
                
                const label = document.createElement('label');
                label.textContent = `Key ${i}`;
                
                const input = document.createElement('input');
                input.name = `key_${i}`;
                input.type = 'text';
                input.placeholder = `data_key_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_key_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }
        
        // arg_count ë³€ê²½ ì‹œ ë™ì  from_ ì…ë ¥ í•„ë“œ ìƒì„±
        function handleArgCountChange(cellId, argCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // ê¸°ì¡´ from_ í•„ë“œë“¤ ì œê±°
            const existingFromFields = paramsDiv.querySelectorAll('.dynamic-from-field');
            existingFromFields.forEach(field => field.remove());
            
            // ìƒˆë¡œìš´ from_ í•„ë“œë“¤ ìƒì„±
            for (let i = 0; i < parseInt(argCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-from-field';
                
                const label = document.createElement('label');
                label.textContent = `From ${i}`;
                
                const input = document.createElement('input');
                input.name = `from_${i}`;
                input.type = 'text';
                input.placeholder = `data_source_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_from_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }

        // íŒŒë¼ë¯¸í„° íƒ€ì… ê²°ì • í•¨ìˆ˜
        function getParamType(param) {
            const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'key_count', 'arg_count', 'time'];
            const selectParams = ['find_range', 'print_result'];
            
            if (selectParams.includes(param)) {
                return 'select';
            } else if (numberParams.includes(param)) {
                return 'number';
            } else {
                return 'text';
            }
        }

        // íŒŒë¼ë¯¸í„° ì˜µì…˜ ìƒì„± í•¨ìˆ˜
        function getParamOptions(param) {
            if (param === 'find_range') {
                return [
                    { value: 'self', label: 'Self' },
                    { value: 'all', label: 'All' },
                    { value: 'contain', label: 'Contain' },
                    { value: 'first', label: 'First' },
                    { value: 'last', label: 'Last' },
                    { value: 'next', label: 'Next' },
                    { value: 'parent', label: 'Parent' },
                    { value: 'children', label: 'Children' },
                    { value: 'siblings', label: 'Siblings' }
                ];
            } else if (param === 'print_result') {
                return [
                    { value: 'true', label: 'True' },
                    { value: 'false', label: 'False' }
                ];
            }
            return undefined;
        }

        // íŒŒë¼ë¯¸í„° placeholder ìƒì„± í•¨ìˆ˜
        function getParamPlaceholder(param) {
            const placeholders = {
                'focus': '{"xpath": "//button[@id=\'login\']"}',
                'speed': '1.0',
                'text': 'ì…ë ¥í•  í…ìŠ¤íŠ¸',
                'sleep': '1',
                'max_time': '10',
                'speed_variation': '0.1',
                'value': 'True',
                'find_item': 'main-content',
                'find_attribute': 'data-id',
                'url': 'https://example.com',
                'data': '{"username": "user", "password": "pass"}',
                'wait_time': '2',
                'from': 'extracted_data',
                'to': 'result_data',
                'href_arg': 'https://',
                'text_arg': '\\n',
                'key_count': '3',
                'name': 'result.xlsx',
                'encoding': 'utf-8',
                'script_path': 'process_data.py',
                'arg_count': '2',
                'time': '5',
                'print_result': 'True',
                'filename': 'screenshot.png'
            };
            return placeholders[param] || param;
        }

        // crawl íŒŒë¼ë¯¸í„° ì •ì˜ - ëª¨ë“  í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±
        function getCrawlParams(jobType, action) {
            // JOB_TYPESì—ì„œ ë™ì ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ë°©ì‹ ë³µì›)
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                
                // jobTypeDataì—ì„œ _typesë‚˜ actionsë¡œ ëë‚˜ëŠ” í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê¸°
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    // job íƒ€ì…ì— ë§ëŠ” ì •í™•í•œ ì•¡ì…˜ íƒ€ì… í‚¤ ì°¾ê¸°
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // ê¸°ë³¸ê°’
                    }
                    
                    if (jobTypeData[actionType] && jobTypeData[actionType][action]) {
                        const actionData = jobTypeData[actionType][action];
                        return actionData.params.map(param => ({
                            name: param,
                            label: param.charAt(0).toUpperCase() + param.slice(1).replace('_', ' '),
                            type: getParamType(param),
                            placeholder: getParamPlaceholder(param),
                            options: getParamOptions(param)
                        }));
                    }
                }
            }
            
            // ê¸°ë³¸ê°’ (JOB_TYPESê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ê²½ìš°)
            const params = {
                'save': {
                    'excel': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'excel' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.xlsx' }
                    ],
                    'csv': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'csv' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'txt' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'mysql' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'load': {
                    'excel': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'excel' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.xlsx' }
                    ],
                    'csv': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'csv' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'txt' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'mysql' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'python': {
                    'file': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'file' },
                        { name: 'script_path', label: 'Script Path', type: 'text', placeholder: 'process_data.py' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' },
                        { name: 'arg_count', label: 'Arg Count', type: 'number', placeholder: '2' }
                    ],
                    'code': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'code' },
                        { name: 'code', label: 'Code', type: 'text', placeholder: 'print(\'Hello World\')' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' }
                    ]
                },
                'wait': {
                    'fixed_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'fixed_time' },
                        { name: 'time', label: 'Time', type: 'number', placeholder: '2.5' }
                    ],
                    'load_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'load_time' }
                    ]
                },
                'test': {
                    'variable': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'variable' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_var' },
                        { name: 'value', label: 'Value', type: 'text', placeholder: 'Hello World' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'list': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'list' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_list' },
                        { name: 'items', label: 'Items', type: 'text', placeholder: 'apple,banana,orange' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'dict': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'dict' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_dict' },
                        { name: 'key_value_pairs', label: 'Key Value Pairs', type: 'text', placeholder: 'name:John,age:25,city:Seoul' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ]
                }
            };
            
            return params[jobType]?.[action] || [];
        }



        // JSON ì¶œë ¥ í† ê¸€ í•¨ìˆ˜ (ê°„ì†Œí™”ë¨)
        function toggleJsonOutput(cellId) {
            console.log('ğŸš€ toggleJsonOutput í˜¸ì¶œë¨, cellId:', cellId);
            const jsonSection = document.getElementById(`xml-output-${cellId}`);
            const controlsSection = document.getElementById(`crawl-controls-${cellId}`);
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            
            // í•´ë‹¹ ì…€ ì°¾ê¸°
            const cell = fileCells[activeFile]?.find(c => c.id === cellId);
            if (!cell) {
                console.error('ì…€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', cellId);
                return;
            }
            
            if (toggle.checked) {
                console.log('ğŸ“¦ JSON ëª¨ë“œë¡œ ì „í™˜ ì¤‘...');
                
                // ğŸ”„ UI â†’ JSON: í˜„ì¬ UI ìƒíƒœë¥¼ ì¦‰ì‹œ ìˆ˜ì§‘í•˜ì—¬ JSONìœ¼ë¡œ ë³€í™˜
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    // í˜„ì¬ UI ìƒíƒœë¥¼ ë™ê¸°í™”
                    syncCrawlCellData(cellId);
                    
                    // ë™ê¸°í™”ëœ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ í‘œì‹œ
                    if (cell.crawl_data) {
                        jsonTextarea.value = JSON.stringify(cell.crawl_data, null, 2);
                        console.log('âœ… JSON ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    } else if (!jsonTextarea.value.trim()) {
                        // crawl_dataê°€ ì—†ê³  JSONë„ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„±
                        generateJsonOutput(cellId);
                    }
                    
                    autoResizeTextarea(jsonTextarea);
                }
                
                // UI ìš”ì†Œ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
                controlsSection.style.display = 'none';
                jsonSection.style.display = 'block';
                
            } else {
                console.log('ğŸ”™ UI ëª¨ë“œë¡œ ì „í™˜ ì¤‘...');
                
                // JSON â†’ UI: JSON ë‚´ìš©ì„ UIë¡œ ë°˜ì˜
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea && jsonTextarea.value.trim()) {
                    try {
                        const crawlData = JSON.parse(jsonTextarea.value);
                        
                        // í•´ë‹¹ ì…€ì˜ crawl_data ì—…ë°ì´íŠ¸
                        cell.crawl_data = crawlData;
                        cell.content = jsonTextarea.value;
                        
                        // UIë¥¼ JSON ë°ì´í„°ì— ë§ê²Œ ì—…ë°ì´íŠ¸
                        updateCrawlCellFromJson(cellId, crawlData);
                        
                        console.log('âœ… JSON â†’ UI ë³€í™˜ ì™„ë£Œ');
                    } catch (e) {
                        console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', e);
                    }
                }
                
                // UI ìš”ì†Œ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
                jsonSection.style.display = 'none';
                controlsSection.style.display = 'block';
            }
        }

        // JSON ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡)
        function updateJsonContent(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            try {
                // JSONì„ íŒŒì‹±í•˜ì—¬ crawl ë°ì´í„°ë¡œ ë³€í™˜
                const jsonContent = jsonTextarea.value.trim();
                
                // ë¹ˆ ë‚´ìš©ì´ë©´ ë¬´ì‹œ
                if (!jsonContent) {
                    return;
                }
                
                const crawlData = JSON.parse(jsonContent);
                
                // ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
                const cells = fileCells[activeFile] || [];
                const cell = cells.find(c => c.id === cellId);
                if (cell) {
                    cell.content = JSON.stringify(crawlData, null, 2);
                    cell.crawl_data = crawlData;
                    
                    // crawl ì…€ UI ì—…ë°ì´íŠ¸
                    updateCrawlCellFromJson(cellId, crawlData);
                }
            } catch (error) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì‚¬ìš©ìê°€ ê³„ì† í¸ì§‘í•  ìˆ˜ ìˆë„ë¡ í•¨
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ textareaì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }
        }

        // JSONì—ì„œ íŒŒì‹±ëœ ë°ì´í„°ë¡œ crawl ì…€ UI ì—…ë°ì´íŠ¸
        function updateCrawlCellFromJson(cellId, crawlData) {
            // job_type ì—…ë°ì´íŠ¸
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            if (jobTypeSelect && crawlData.job_type) {
                jobTypeSelect.value = crawlData.job_type;
                // job_typeì´ ë³€ê²½ë˜ë©´ action ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
                updateCrawlActions(cellId, crawlData.job_type);
            }
            
            // action ì—…ë°ì´íŠ¸ (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                if (actionSelect && crawlData.action) {
                    actionSelect.value = crawlData.action;
                    // actionì´ ë³€ê²½ë˜ë©´ íŒŒë¼ë¯¸í„° í•„ë“œë“¤ë„ ì—…ë°ì´íŠ¸
                    renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                    
                    // íŒŒë¼ë¯¸í„° ê°’ë“¤ ë³µì› (ì•½ê°„ì˜ ì§€ì—° í›„)
                    setTimeout(() => {
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                if (paramInput) {
                                    paramInput.value = crawlData.params[paramName];
                                }
                            });
                        }
                    }, 50);
                }
            }, 50);
        }

        // JSON ì¶œë ¥ ìƒì„± í•¨ìˆ˜
        function generateJsonOutput(cellId) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;

            try {
                // crawl ì…€ì˜ í˜„ì¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
                let crawlData;
                
                // crawl_dataê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš© (UIì—ì„œ ë³€ê²½ëœ ë°ì´í„°)
                if (cell.crawl_data) {
                    crawlData = cell.crawl_data;
                } else {
                    // crawl_dataê°€ ì—†ìœ¼ë©´ contentë¥¼ íŒŒì‹±
                    let contentStr = cell.content;
                    
                    // contentê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                    if (typeof contentStr !== 'string') {
                        contentStr = String(contentStr);
                    }
                    
                    if (contentStr) {
                        crawlData = JSON.parse(contentStr);
                    } else {
                        crawlData = { job_type: 'do', action: '', params: {} };
                    }
                }

                // JSON ì¶œë ¥ ì˜ì—­ì— í‘œì‹œ (ê¸°ë³¸ê°’ ì¶”ê°€í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ í‘œì‹œ)
                const jsonContent = JSON.stringify(crawlData, null, 2);
                
                // JSON ì¶œë ¥ ì˜ì—­ì— í‘œì‹œ
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    // ì´ë¯¸ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
                    if (!jsonTextarea.value.trim()) {
                        jsonTextarea.value = jsonContent;
                    }
                    autoResizeTextarea(jsonTextarea);
                }
            } catch (error) {
                console.error('JSON ìƒì„± ì˜¤ë¥˜:', error);
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    jsonTextarea.value = `// JSON ìƒì„± ì˜¤ë¥˜: ${error.message}`;
                }
            }
        }

                 // íŒŒë¼ë¯¸í„°ì— ê¸°ë³¸ê°’ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         function addDefaultParams(crawlData) {
             const jobType = crawlData.job_type || 'do';
             const action = crawlData.action || '';
             
             // ê¸°ë³¸ íŒŒë¼ë¯¸í„° ì •ì˜
             const defaultParams = {
                 'do': {
                     'click': { focus: { xpath: "//button[@id='login']" }, speed: 1.0 },
                     'text': { focus: { xpath: "//input[@name='username']" }, text: 'ì…ë ¥í•  í…ìŠ¤íŠ¸', speed: 1.0 },
                     'clear': { focus: { xpath: "//input[@name='username']" }, speed: 1.0 },
                     'enter': { focus: 'current' },
                     'pagedown': { focus: 'current' },
                     'radio': { focus: { xpath: "//input[@type='radio']" }, value: 'True' },
                     'scroll': { focus: 'current', sleep: 1, max_time: 10, speed_variation: 0.1 },
                     'scroll_to_element': { focus: { xpath: "//div[@class='content']" }, sleep: 1, speed: 0.5, speed_variation: 0.1, max_time: 10 },
                     'do_screen_shot': { focus: 'current', filename: 'screenshot.png' }
                 },
                 'find': {
                     'id': { find_item: 'main-content', find_range: 'first' },
                     'class': { find_item: 'title', find_range: 'first' },
                     'name': { find_item: 'div', find_range: 'first' },
                     'text': { find_item: 'ë¡œê·¸ì¸', find_range: 'first' },
                     'attribute': { find_attribute: 'data-id', find_item: '123', find_range: 'first' }
                 },
                 'data': {
                     'to_html': { from: 'extracted_data', to: 'html_data' },
                     'to_xpath': { from: 'extracted_data', to: 'xpath_data' },
                     'to_dataframe': { from: 'extracted_data', to: 'df_data' },
                     'get_href': { from: 'link_data', to: 'href_data', href_arg: 'https://' },
                     'get_hrefs': { from: 'links_data', to: 'hrefs_data', href_arg: 'https://' },
                     'get_text_all': { from: 'html_data', to: 'text_data', text_arg: '\\n' },
                     'get_texts_all': { from: 'html_data', to: 'texts_data', text_arg: '\\n' },
                     'get_text_all_tagonly': { from: 'html_data', to: 'tag_text_data', text_arg: '\\n' },
                     'get_text_all_without_script': { from: 'html_data', to: 'clean_text_data', text_arg: '\\n' },
                     'key_to_list': { to: 'combined_list', key_count: 3 }
                 },
                 'save': {
                     'excel': { save_type: 'excel', to: 'result_data', name: 'result.xlsx' },
                     'csv': { save_type: 'csv', to: 'result_data', name: 'result.csv', encoding: 'utf-8' },
                     'txt': { save_type: 'txt', to: 'result_data', name: 'result.txt', encoding: 'utf-8' },
                     'mysql': { save_type: 'mysql', to: 'result_data', name: 'crawl_results' },
                     'elasticsearch': { save_type: 'elasticsearch', to: 'result_data', name: 'crawl_index' }
                 },
                 'load': {
                     'excel': { load_type: 'excel', from: 'loaded_data', name: 'data.xlsx' },
                     'csv': { load_type: 'csv', from: 'loaded_data', name: 'data.csv', encoding: 'utf-8' },
                     'txt': { load_type: 'txt', from: 'loaded_data', name: 'data.txt', encoding: 'utf-8' },
                     'mysql': { load_type: 'mysql', from: 'loaded_data', name: 'crawl_results' },
                     'elasticsearch': { load_type: 'elasticsearch', from: 'loaded_data', name: 'crawl_index' }
                 },
                 'python': {
                     'file': { python_type: 'file', script_path: 'process_data.py', to: 'result', arg_count: 2 },
                     'code': { python_type: 'code', code: 'print(\'Hello World\')', to: 'result' }
                 },
                 'wait': {
                     'fixed_time': { wait_type: 'fixed_time', time: 2.5 },
                     'load_time': { wait_type: 'load_time' }
                 },
                 'request': {
                     'get': { request_type: 'get', url: 'https://example.com' },
                     'post': { request_type: 'post', url: 'https://api.example.com', data: '{"username": "user", "password": "pass"}' },
                     'selenium': { request_type: 'selenium', url: 'https://example.com', wait_time: 2 },
                     'selenium_url_change': { request_type: 'selenium_url_change', url: 'https://example.com', wait_time: 2 }
                 },
                 'test': {
                     'variable': { test_type: 'variable', name: 'my_var', value: 'Hello World', print_result: true },
                     'list': { test_type: 'list', name: 'my_list', items: 'apple,banana,orange', print_result: true },
                     'dict': { test_type: 'dict', name: 'my_dict', key_value_pairs: 'name:John,age:25,city:Seoul', print_result: true }
                 }
             };

             // í˜„ì¬ job_typeê³¼ actionì— ëŒ€í•œ ê¸°ë³¸ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
             const defaults = defaultParams[jobType]?.[action] || {};
             
             // ê¸°ì¡´ íŒŒë¼ë¯¸í„°ì™€ ê¸°ë³¸ê°’ ë³‘í•©
             const mergedParams = { ...defaults, ...crawlData.params };
             
             return {
                 ...crawlData,
                 params: mergedParams
             };
        }

        // JSON ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡)
        function updateJsonContent(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            try {
                // JSONì„ íŒŒì‹±í•˜ì—¬ crawl ë°ì´í„°ë¡œ ë³€í™˜
                const jsonContent = jsonTextarea.value.trim();
                
                // ë¹ˆ ë‚´ìš©ì´ë©´ ë¬´ì‹œ
                if (!jsonContent) {
                    return;
                }
                
                const crawlData = JSON.parse(jsonContent);
                
                // ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
                const cells = fileCells[activeFile] || [];
                const cell = cells.find(c => c.id === cellId);
                if (cell) {
                    cell.content = JSON.stringify(crawlData, null, 2);
                    cell.crawl_data = crawlData;
                    
                    // crawl ì…€ UI ì—…ë°ì´íŠ¸
                    updateCrawlCellFromJson(cellId, crawlData);
                }
            } catch (error) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì‚¬ìš©ìê°€ ê³„ì† í¸ì§‘í•  ìˆ˜ ìˆë„ë¡ í•¨
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ textareaì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }
        }

        // JSONì—ì„œ íŒŒì‹±ëœ ë°ì´í„°ë¡œ crawl ì…€ UI ì—…ë°ì´íŠ¸
        function updateCrawlCellFromJson(cellId, crawlData) {
            // job_type ì—…ë°ì´íŠ¸
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            if (jobTypeSelect && crawlData.job_type) {
                jobTypeSelect.value = crawlData.job_type;
                // job_typeì´ ë³€ê²½ë˜ë©´ action ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
                updateCrawlActions(cellId, crawlData.job_type);
            }
            
            // action ì—…ë°ì´íŠ¸ (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                if (actionSelect && crawlData.action) {
                    actionSelect.value = crawlData.action;
                    // actionì´ ë³€ê²½ë˜ë©´ íŒŒë¼ë¯¸í„° í•„ë“œë“¤ë„ ì—…ë°ì´íŠ¸
                    renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                    
                    // íŒŒë¼ë¯¸í„° ê°’ë“¤ ë³µì› (ì•½ê°„ì˜ ì§€ì—° í›„)
                    setTimeout(() => {
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                if (paramInput) {
                                    paramInput.value = crawlData.params[paramName];
                                }
                            });
                        }
                    }, 50);
                }
            }, 50);
        }

        // JSON ì¶œë ¥ í† ê¸€ í•¨ìˆ˜ (ëˆ„ë½ëœ í•¨ìˆ˜ ì¶”ê°€)
        function toggleJsonOutput(cellId) {
            const jsonSection = document.getElementById(`xml-output-${cellId}`);
            const controlsSection = document.getElementById(`crawl-controls-${cellId}`);
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            
            if (toggle.checked) {
                // JSON ì¶œë ¥ í™œì„±í™”: combobox UI ìˆ¨ê¸°ê³  JSON ì¶œë ¥ í‘œì‹œ
                controlsSection.style.display = 'none';
                jsonSection.style.display = 'block';
                
                // JSON textarea í¬ê¸° ìë™ ì¡°ì •
                setTimeout(() => {
                    const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                    if (jsonTextarea) {
                        // ì´ë¯¸ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
                        if (!jsonTextarea.value.trim()) {
                            generateJsonOutput(cellId);
                        }
                        autoResizeTextarea(jsonTextarea);
                    }
                }, 100);
            } else {
                // JSON ì¶œë ¥ ë¹„í™œì„±í™”: JSON ì¶œë ¥ ìˆ¨ê¸°ê³  combobox UI í‘œì‹œ
                jsonSection.style.display = 'none';
                controlsSection.style.display = 'block';
                
                // UI ëª¨ë“œë¡œ ëŒì•„ê°ˆ ë•Œ JSON ë°ì´í„°ë¥¼ UIì— ë°˜ì˜
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea && jsonTextarea.value.trim()) {
                    try {
                        const crawlData = JSON.parse(jsonTextarea.value);
                        console.log(`ğŸ”„ JSON â†’ UI ë³€í™˜ ì‹œì‘: ${cellId}`, crawlData);
                        
                        // ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
                        const cells = fileCells[activeFile] || [];
                        const cell = cells.find(c => c.id === cellId);
                        if (cell) {
                            cell.crawl_data = crawlData;
                            cell.content = JSON.stringify(crawlData, null, 2);
                        }
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateCrawlCellFromJson(cellId, crawlData);
                        
                        console.log('âœ… JSON â†’ UI ë³€í™˜ ì™„ë£Œ');
                    } catch (e) {
                        console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', e);
                    }
                }
            }
        }

        // JSON ì¶œë ¥ ë³µì‚¬ í•¨ìˆ˜
        function copyJsonOutput(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            jsonTextarea.select();
            jsonTextarea.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ì„ ìœ„í•œ ì„¤ì •

            try {
                document.execCommand('copy');
                
                // ë³µì‚¬ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const copyBtn = document.querySelector(`#xml-output-${cellId} .xml-copy-btn`);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                copyBtn.style.background = '#48bb78';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('JSON ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // crawl ì…€ ì‹¤í–‰ ì‹œ JSON ì¶œë ¥ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
        function runCrawlCell(cellId) {
            // ê¸°ì¡´ ì‹¤í–‰ ë¡œì§...
            
            // JSON ì¶œë ¥ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            if (toggle && toggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // íŒŒì¼ ì—…ë°ì´íŠ¸ í™•ì¸ ë° reload í•¨ìˆ˜
        function checkFileUpdatedAndReload(filePath, expectedContent, retryCount = 0) {
            const maxRetries = 10; // ìµœëŒ€ 10ë²ˆ ì‹œë„
            const retryDelay = 200; // 200ms ê°„ê²©
            
            fetch(`/api/files/content?path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // íŒŒì¼ ë‚´ìš©ì´ ì˜ˆìƒí•œ ë‚´ìš©ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                        if (data.content === expectedContent) {
                
                            // íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        } else if (retryCount < maxRetries) {
                            // ì•„ì§ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì‹œë„
            
                            setTimeout(() => {
                                checkFileUpdatedAndReload(filePath, expectedContent, retryCount + 1);
                            }, retryDelay);
                        } else {
            
                            // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìœ¼ë¯€ë¡œ ê°•ì œ reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        }
                    } else {
                        console.error('íŒŒì¼ ë‚´ìš© í™•ì¸ ì‹¤íŒ¨:', data.message);
                        // í™•ì¸ ì‹¤íŒ¨ ì‹œ ê°•ì œ reload
                        const fileName = filePath.split('/').pop();
                        const file = { path: filePath, name: fileName };
                        selectFile(file);
                    }
                })
                .catch(error => {
                    console.error('íŒŒì¼ ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°•ì œ reload
                    const fileName = filePath.split('/').pop();
                    const file = { path: filePath, name: fileName };
                    selectFile(file);
                });
        }

        function renderNotebookCells() {
            syncCellContentsToMemory();
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ì…€ ì´ë¦„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCellName(cellId, name) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (cell) {
                cell.name = name;
                // ì…€ ì´ë¦„ì´ ë³€ê²½ë˜ë©´ ìë™ ì €ì¥
                setTimeout(() => saveNotebookToFile(), 500);
            }
        }

        // crawl ì…€ì— ìë™ ë²ˆí˜¸ ë¶€ì—¬í•˜ëŠ” í•¨ìˆ˜
        function renumberCrawlCells() {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cells = fileCells[activeFile];
            cells.forEach((cell, index) => {
                if ((cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') && (!cell.name || cell.name === '')) {
                    cell.name = `Crawl_${index + 1}`;
                }
            });
            
            renderNotebookCells();
            saveNotebook();
        }

        function runCell(cellId) {
            // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì…€ì´ë©´ íì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (currentExecutingCell === cellId) {
    
                return;
            }
            
            // ì´ë¯¸ íì— ìˆëŠ” ì…€ì´ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (cellExecutionQueue.includes(cellId)) {
    
                return;
            }
            
            // íì— ì…€ ì¶”ê°€
            cellExecutionQueue.push(cellId);

            
            // ëŒ€ê¸°ì¤‘ ìƒíƒœë¡œ ë³€ê²½
            const statusSpan = document.querySelector(`#status-${cellId}`);
            if (statusSpan) {
                statusSpan.textContent = 'ëŒ€ê¸°ì¤‘';
                statusSpan.className = 'cell-status waiting';
            }
            
            // í ì²˜ë¦¬ ì‹œì‘
            processCellQueue();
        }

        // focus íŒŒë¼ë¯¸í„°ë¥¼ ì˜¬ë°”ë¥¸ êµ¬ì¡°ë¡œ ì €ì¥
        function updateFocusParam(cellId, focusType, focusValue) {
            let value;
            if (focusType === 'current') {
                value = 'current';
            } else {
                value = {};
                value[focusType] = focusValue;
            }
            updateCrawlCell(cellId, 'param_focus', value);
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë³´ì—¬ì£¼ê¸°
        function showImageModal(file) {
            // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }

            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <h3>${file.name}</h3>
                        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
                    </div>
                    <div class="image-modal-body">
                        <img src="/api/files/image?path=${encodeURIComponent(file.path)}" alt="${file.name}" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            });
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // 1. Cell í´ë˜ìŠ¤ ì •ì˜
        class Cell {
            constructor({id, content = '', output = '', status = '', cell_type = 'code', crawl_data = null, name = '', output_history = [], metadata = {}}) {
                this.id = id;
                this.content = content;
                this.output = output;
                this.status = status;
                this.cell_type = cell_type;
                this.crawl_data = crawl_data;
                // metadata.nameì„ ìš°ì„ ìœ¼ë¡œ í•˜ê³ , ì—†ìœ¼ë©´ name ì‚¬ìš©
                this.name = (metadata && metadata.name) || name || '';
                this.output_history = output_history;
            }

            setContent(content) {
                this.content = content;
            }
            setOutput(output) {
                this.output = output;
            }
            setStatus(status) {
                this.status = status;
            }
            setName(name) {
                this.name = name;
            }
            setCrawlData(crawl_data) {
                this.crawl_data = crawl_data;
            }
            addOutputHistory(entry) {
                this.output_history.push(entry);
            }
        }

        // ... ê¸°ì¡´ ì½”ë“œ ...
        // fileCells = { filePath: [Cell, ...] } í˜•íƒœë¡œ ì‚¬ìš©
        // addCell, createCellElement, renderNotebookCells, deleteCell ë“±ì—ì„œ Cell ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©

        // ì¤‘ë³µëœ í•¨ìˆ˜ ì œê±°ë¨



        function renderNotebookCells() {
            syncCellContentsToMemory();
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ì˜ˆì‹œ: deleteCell í•¨ìˆ˜ ë¦¬íŒ©í† ë§
        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ì‚­ì œí•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ì…€ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;
            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            updateCellNumbers();
        }

        // ì˜ˆì‹œ: createCellElement í•¨ìˆ˜ì—ì„œ cell ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
        // ... ê¸°ì¡´ createCellElement í•¨ìˆ˜ ë‚´ì—ì„œ cell.content, cell.status ë“± ì ‘ê·¼ ë°©ì‹ì€ ë™ì¼í•˜ê²Œ ìœ ì§€ ...

        // fileCellsì— ì…€ì„ ì¶”ê°€/ë¡œë“œí•  ë•Œë„ Cell ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€í™˜
        // ì˜ˆ: íŒŒì¼ ë¡œë“œ ì‹œ
        // fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));

        // ... ê¸°ì¡´ ì½”ë“œ ...

        // ì…€ ì¶”ê°€/ë Œë”ë§ ì „ textarea ê°’ ë° ì…€ ì´ë¦„ ë™ê¸°í™” í•¨ìˆ˜
        function syncCellContentsToMemory() {
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach(cell => {
                // textarea ë‚´ìš© ë™ê¸°í™”
                const textarea = document.getElementById(cell.id)?.querySelector('.cell-input');
                if (textarea) {
                    cell.setContent(textarea.value);
                }
                
                // ì…€ ì´ë¦„ ë™ê¸°í™”
                const nameInput = document.getElementById(`cell-name-${cell.id}`);
                if (nameInput) {
                    cell.setName(nameInput.value);
                }
            });
        }

        // ì…€ ë³µì‚¬, ì´ë™ í•¨ìˆ˜ ì¶”ê°€
        function copyCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;
            const cell = cells[cellIndex];
            // ê¹Šì€ ë³µì‚¬
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: cell.content,
                cell_type: cell.cell_type,
                crawl_data: cell.crawl_data ? JSON.parse(JSON.stringify(cell.crawl_data)) : null,
                name: cell.name ? cell.name + '_ë³µì‚¬' : '',
                output_history: []
            });
            cells.splice(cellIndex + 1, 0, newCell);
            renderNotebookCells();
        }
        function moveCellUp(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex <= 0) return;
            const temp = cells[cellIndex];
            cells[cellIndex] = cells[cellIndex - 1];
            cells[cellIndex - 1] = temp;
            renderNotebookCells();
        }
        function moveCellDown(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex === -1 || cellIndex === cells.length - 1) return;
            const temp = cells[cellIndex];
            cells[cellIndex] = cells[cellIndex + 1];
            cells[cellIndex + 1] = temp;
            renderNotebookCells();
        }



        // íƒ­ë³„ í¬ê¸° ì €ì¥ì†Œ
        let tabSizes = {
            'np': 320,
            'view': 500
        };
        
        // ì €ì¥ëœ íƒ­ í¬ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadTabSizes() {
            const savedSizes = localStorage.getItem('rightPanelTabSizes');
            if (savedSizes) {
                tabSizes = { ...tabSizes, ...JSON.parse(savedSizes) };
            }
        }
        
        // íƒ­ í¬ê¸° ì €ì¥í•˜ê¸°
        function saveTabSizes() {
            localStorage.setItem('rightPanelTabSizes', JSON.stringify(tabSizes));
        }
        
        // ìš°ì¸¡ íŒ¨ë„ íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchRightTab(tabName) {
            const rightPanel = document.getElementById('rightPanel');
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`${tabName}Panel`);
            
            // í˜„ì¬ í™œì„± íƒ­ì´ í´ë¦­ëœ ê²½ìš° (íŒ¨ë„ ì¶•ì†Œ/í™•ì¥ í† ê¸€)
            if (selectedTab && selectedTab.classList.contains('active')) {
                if (rightPanel.classList.contains('collapsed')) {
                    // ì¶•ì†Œëœ ìƒíƒœì—ì„œ í™•ì¥
                    rightPanel.classList.remove('collapsed');
                    const tabSize = tabSizes[tabName] || 280;
                    rightPanel.style.width = tabSize + 'px';
            } else {
                    // í™•ì¥ëœ ìƒíƒœì—ì„œ ì¶•ì†Œ
                    rightPanel.classList.add('collapsed');
                    rightPanel.style.width = '40px';
                }
                return;
            }
            
            // ë‹¤ë¥¸ íƒ­ì„ í´ë¦­í•œ ê²½ìš°
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.right-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.right-panel-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
                
                            // íŒ¨ë„ì´ ì¶•ì†Œë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ íƒ­ì— ë§ëŠ” í¬ê¸°ë¡œ ì¡°ì •
            if (!rightPanel.classList.contains('collapsed')) {
                const tabSize = tabSizes[tabName] || 280;
                rightPanel.style.width = tabSize + 'px';
            }
            
            // view íƒ­ì´ í™œì„±í™”ë˜ë©´ HTML ë·°ì–´ ë¡œë“œ
            if (tabName === 'view') {
                loadHTMLViewer();
            }
                

            }
        }
        
        // HTML ë·°ì–´ ë¡œë“œ í•¨ìˆ˜
        function loadHTMLViewer() {
            const container = document.getElementById('htmlViewerContainer');
            
            if (container && container.innerHTML.trim() === '') {
                // HTML ë·°ì–´ ë¡œë“œ
                fetch('/templates/component/html_viewer/html_viewer.html')
                    .then(response => response.text())
                    .then(html => {
                        container.innerHTML = html;
                        
                        // JavaScript íŒŒì¼ ë¡œë“œ
                        const script = document.createElement('script');
                        script.src = '/templates/component/html_viewer/html_viewer.js';
                        script.onload = function() {
                            // HTML ë·°ì–´ê°€ ë¡œë“œëœ í›„ ì½œë°± ë“±ë¡ ë° í˜„ì¬ ì»¤ë„ ID ì„¤ì •
                            setTimeout(() => {
                                registerHTMLViewerUpdateCallback();
                                executeCallbackDict('update');
                            }, 100);
                        };
                        document.head.appendChild(script);
                    })
                    .catch(error => {
                        console.error('HTML ë·°ì–´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    });
            }
        }
        
        // ë¦¬ì‚¬ì´ì¦ˆ ê´€ë ¨ ë³€ìˆ˜
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        
        // ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘
        function startResize(e) {
            isResizing = true;
            startX = e.clientX;
            const rightPanel = document.getElementById('rightPanel');
            startWidth = rightPanel.offsetWidth;
            
            // ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        }
        
        // ë¦¬ì‚¬ì´ì¦ˆ ì¤‘
        function resize(e) {
            if (!isResizing) return;
            
            const newWidth = window.innerWidth - e.clientX;
            
            // ìµœì†Œ í¬ê¸°ë§Œ ì œí•œ
            const clampedWidth = Math.max(200, newWidth);
            
            const rightPanel = document.getElementById('rightPanel');
            rightPanel.style.width = clampedWidth + 'px';
            
            e.preventDefault();
        }
        
        // ë¦¬ì‚¬ì´ì¦ˆ ì¢…ë£Œ
        function stopResize() {
            if (!isResizing) return;
            
            isResizing = false;
            
            // ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³µì›
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
            
            // í˜„ì¬ í™œì„± íƒ­ì˜ í¬ê¸° ì €ì¥
            const activeTab = document.querySelector('.right-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const rightPanel = document.getElementById('rightPanel');
                tabSizes[tabName] = rightPanel.offsetWidth;
                saveTabSizes();
            }
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ ì¶”ê°€
        let draggedCellId = null;
        function handleCellDragStart(event, cellId) {
            draggedCellId = cellId;
            event.dataTransfer.effectAllowed = 'move';
            // ë¹ˆ ì…€ ì´ë¯¸ì§€ ìƒì„±
            const dragImg = document.createElement('div');
            dragImg.style.width = '350px';
            dragImg.style.height = '60px';
            dragImg.style.background = 'rgba(180,180,180,0.25)';
            dragImg.style.border = '2px dashed #aaa';
            dragImg.style.borderRadius = '8px';
            dragImg.style.display = 'flex';
            dragImg.style.alignItems = 'center';
            dragImg.style.justifyContent = 'center';
            dragImg.style.fontSize = '1.1em';
            dragImg.style.color = '#888';
            dragImg.innerText = 'ì…€ ì´ë™';
            document.body.appendChild(dragImg);
            event.dataTransfer.setDragImage(dragImg, 120, 30);
            setTimeout(() => document.body.removeChild(dragImg), 0);
        }
        function handleCellDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        function handleCellDrop(event, targetCellId) {
            event.preventDefault();
            if (!draggedCellId || draggedCellId === targetCellId) return;
            const cells = fileCells[activeFile];
            const fromIdx = cells.findIndex(c => c.id === draggedCellId);
            const toIdx = cells.findIndex(c => c.id === targetCellId);
            if (fromIdx === -1 || toIdx === -1) return;
            // ì…€ ìˆœì„œ ë³€ê²½
            const [movedCell] = cells.splice(fromIdx, 1);
            cells.splice(toIdx, 0, movedCell);
            renderNotebookCells();
            draggedCellId = null;
        }

        // ë©”ë‰´ ë“œë¡­ë‹¤ìš´ ë™ì‘ ìŠ¤í¬ë¦½íŠ¸
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
          item.addEventListener('mouseenter', function() {
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) dropdown.style.display = 'block';
          });
          item.addEventListener('mouseleave', function() {
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) dropdown.style.display = 'none';
          });
          item.addEventListener('click', function(e) {
            // í´ë¦­ ì‹œ í† ê¸€
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) {
              dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
              e.stopPropagation();
            }
          });
        });
        document.body.addEventListener('click', function() {
          document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
        });

        // ===== í†µí•©ëœ crawl ì…€ ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
        
        /**
         * crawl ì…€ì˜ UIì—ì„œ í˜„ì¬ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ê¸°ì¡´ notebook êµ¬ì¡°ë¡œ ë°˜í™˜
         */
        function extractCrawlDataFromUI(cellId) {
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            
            if (!jobTypeSelect || !actionSelect) {
                console.warn(`crawl ì…€ ${cellId}ì˜ UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return null;
            }
            
            const crawlData = {
                job_type: jobTypeSelect.value || 'do',
                action: actionSelect.value || '',
                params: {}
            };
            
            // ëª¨ë“  íŒŒë¼ë¯¸í„° ì…ë ¥ ê°’ ìˆ˜ì§‘ (focus ì œì™¸, ë³„ë„ ì²˜ë¦¬)
            const paramInputs = document.querySelectorAll(`#crawl-params-${cellId} input[name], #crawl-params-${cellId} select[name]`);
            paramInputs.forEach(input => {
                // focus ê´€ë ¨ í•„ë“œëŠ” ë³„ë„ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œì™¸
                if (input.name && !input.name.includes('focus') && input.value) {
                    // ìˆ«ì íƒ€ì… íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                    const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'time', 'key_count', 'arg_count'];
                    if (numberParams.includes(input.name)) {
                        const numValue = parseFloat(input.value);
                        if (!isNaN(numValue)) {
                            crawlData.params[input.name] = numValue;
                            console.log(`ğŸ“Š ìˆ«ì íŒŒë¼ë¯¸í„° ìˆ˜ì§‘: ${input.name} = ${numValue} (${typeof numValue})`);
                        }
                    } else {
                        crawlData.params[input.name] = input.value;
                        console.log(`ğŸ“ í…ìŠ¤íŠ¸ íŒŒë¼ë¯¸í„° ìˆ˜ì§‘: ${input.name} = "${input.value}"`);
                    }
                }
            });
            
            // focus íŒŒë¼ë¯¸í„° íŠ¹ë³„ ì²˜ë¦¬ (ì‹¤ì œ DOM êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •)
            const focusTypeSelect = document.querySelector(`#crawl-params-${cellId} select[name="focus_type"]`);
            const focusXpathInput = document.querySelector(`#crawl-params-${cellId} input[name="focus_xpath"]`);
            
            if (focusTypeSelect && focusXpathInput) {
                const focusType = focusTypeSelect.value;
                const focusValue = focusXpathInput.value.trim();
                
                if (focusType === 'current') {
                    crawlData.params.focus = 'current';
                    console.log(`ğŸ¯ Focus íŒŒë¼ë¯¸í„° ìˆ˜ì§‘: 'current'`);
                } else if (focusValue) {
                    crawlData.params.focus = { [focusType]: focusValue };
                    console.log(`ğŸ¯ Focus íŒŒë¼ë¯¸í„° ìˆ˜ì§‘: ${focusType} = "${focusValue}"`);
                } else if (focusType && focusType !== 'current') {
                    // ê°’ì´ ë¹„ì–´ìˆì–´ë„ êµ¬ì¡°ëŠ” ìƒì„±
                    crawlData.params.focus = { [focusType]: "" };
                    console.log(`ğŸ¯ Focus íŒŒë¼ë¯¸í„° ìˆ˜ì§‘: ${focusType} = "" (ë¹ˆ ê°’)`);
                }
            } else {
                console.warn(`âš ï¸ Focus UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: cellId=${cellId}`);
                console.warn(`  - focusTypeSelect: ${focusTypeSelect ? 'ìˆìŒ' : 'ì—†ìŒ'}`);
                console.warn(`  - focusXpathInput: ${focusXpathInput ? 'ìˆìŒ' : 'ì—†ìŒ'}`);
            }
            
            return crawlData;
        }
        
        /**
         * crawl ì…€ì˜ í˜„ì¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í†µí•© í•¨ìˆ˜
         * ìš°ì„ ìˆœìœ„: JSON ëª¨ë“œ > UI ë°ì´í„° > crawl_data > content
         */
        function getCrawlCellData(cell) {
            const cellId = cell.id;
            
            // 1. JSON ëª¨ë“œì¸ì§€ í™•ì¸
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            const isJsonMode = xmlToggle && xmlToggle.checked;
            
            if (isJsonMode) {
                // JSON ëª¨ë“œ: textareaì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea && jsonTextarea.value.trim()) {
                    try {
                        const parsed = JSON.parse(jsonTextarea.value);
                        return { data: parsed, source: 'json_textarea' };
                    } catch (e) {
                        console.warn(`JSON ëª¨ë“œì—ì„œ íŒŒì‹± ì‹¤íŒ¨ (ì…€ ${cellId}):`, e);
                    }
                }
            }
            
            // 2. UIì—ì„œ í˜„ì¬ ê°’ ì¶”ì¶œ
            const uiData = extractCrawlDataFromUI(cellId);
            if (uiData) {
                return { data: uiData, source: 'ui' };
            }
            
            // 3. ì €ì¥ëœ crawl_data ì‚¬ìš©
            if (cell.crawl_data) {
                return { data: cell.crawl_data, source: 'crawl_data' };
            }
            
            // 4. contentì—ì„œ íŒŒì‹± ì‹œë„
            if (cell.content && typeof cell.content === 'string') {
                try {
                    const parsed = JSON.parse(cell.content);
                    return { data: parsed, source: 'content' };
                } catch (e) {
                    console.warn(`content íŒŒì‹± ì‹¤íŒ¨ (ì…€ ${cellId}):`, e);
                }
            }
            
                         // 5. ê¸°ë³¸ê°’ ë°˜í™˜
             return { 
                 data: { job_type: 'do', action: 'click', params: {} }, 
                 source: 'default' 
             };
        }
        
        /**
         * crawl ì…€ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
         */
        function syncCrawlCellData(cellId) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;
            
            const { data, source } = getCrawlCellData(cell);
            
            // ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
            cell.crawl_data = data;
            cell.content = JSON.stringify(data, null, 2);
            
            // JSON textarea ì—…ë°ì´íŠ¸ (JSON ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            const isJsonMode = xmlToggle && xmlToggle.checked;
            
            if (!isJsonMode) {
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    jsonTextarea.value = JSON.stringify(data, null, 2);
                    autoResizeTextarea(jsonTextarea);
                }
            }
            
            console.log(`ì…€ ${cellId} ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ (ì†ŒìŠ¤: ${source})`);
        }
        
        /**
         * ëª¨ë“  crawl ì…€ì˜ ë°ì´í„°ë¥¼ ë™ê¸°í™”
         */
        function syncAllCrawlCells() {
            if (!activeFile || !fileCells[activeFile]) return;
            
            fileCells[activeFile].forEach(cell => {
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                if (isCrawlCell) {
                    syncCrawlCellData(cell.id);
                }
            });
        }

        // ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ìˆ˜ì • =====
        
        /**
         * notebook êµ¬ì¡°(job_type, params)ë¥¼ class_job.py êµ¬ì¡°(type, flat)ë¡œ ë³€í™˜
         */
        function convertToClassJobFormat(crawlData) {
            console.log(`ğŸ”„ convertToClassJobFormat ì‹œì‘:`);
            console.log(`ğŸ“¥ ì…ë ¥ ë°ì´í„°:`, crawlData);
            
            if (!crawlData) {
                console.log(`âŒ crawlDataê°€ null/undefined`);
                return {};
            }
            
            // ê¸°ë³¸ êµ¬ì¡° ìƒì„± (type, action)
            const result = {
                type: crawlData.job_type || 'do',
                action: crawlData.action || ''
            };
            console.log(`ğŸ—ï¸ ê¸°ë³¸ êµ¬ì¡° ìƒì„±:`, result);
            
            // params ì•ˆì˜ ëª¨ë“  ì†ì„±ì„ flatí•˜ê²Œ resultì— ë³µì‚¬
            if (crawlData.params && typeof crawlData.params === 'object') {
                console.log(`ğŸ“‹ params ë³µì‚¬ ì‹œì‘:`, crawlData.params);
                Object.keys(crawlData.params).forEach(key => {
                    result[key] = crawlData.params[key];
                    console.log(`  âœ… ${key}: ${JSON.stringify(crawlData.params[key])}`);
                });
            } else {
                console.log(`âš ï¸ paramsê°€ ì—†ê±°ë‚˜ ê°ì²´ê°€ ì•„ë‹˜:`, crawlData.params);
            }
            
            // ğŸ”§ do íƒ€ì…ì—ì„œ focus íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì¶”ê°€ (class_job.py KeyError ë°©ì§€)
            if (result.type === 'do' && !result.hasOwnProperty('focus')) {
                // focusê°€ í•„ìš” ì—†ëŠ” actionë“¤ì— ëŒ€í•´ì„œëŠ” 'current'ë¡œ ì„¤ì •
                const noFocusActions = ['enter', 'pagedown', 'scroll'];
                if (noFocusActions.includes(result.action)) {
                    result.focus = 'current';
                } else {
                    // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¹ˆ xpath ì„¤ì •
                    result.focus = { xpath: "" };
                }
                console.log(`âš ï¸ focus íŒŒë¼ë¯¸í„° ëˆ„ë½, ê¸°ë³¸ê°’ ì¶”ê°€: ${result.action} -> ${JSON.stringify(result.focus)}`);
            } else if (result.type === 'do' && result.hasOwnProperty('focus')) {
                console.log(`âœ… focus íŒŒë¼ë¯¸í„° ì¡´ì¬: ${JSON.stringify(result.focus)}`);
            }
            
            // íŠ¹ë³„í•œ ë³€í™˜ ê·œì¹™ë“¤
            if (result.type === 'request') {
                result.request_type = result.action;
            } else if (result.type === 'find') {
                result.find_type = result.action;
            } else if (result.type === 'data') {
                result.convert_type = result.action;
            } else if (result.type === 'save') {
                result.save_type = result.action;
            } else if (result.type === 'load') {
                result.load_type = result.action;
            } else if (result.type === 'python') {
                result.python_type = result.action;
            } else if (result.type === 'wait') {
                result.wait_type = result.action;
            } else if (result.type === 'test') {
                result.test_type = result.action;
            }
            
            console.log(`ğŸ“¤ ìµœì¢… ë³€í™˜ ê²°ê³¼:`, result);
            console.log(`ğŸ”„ convertToClassJobFormat ì™„ë£Œ\n`);
            return result;
        }

        // ===== ì €ì¥ í•¨ìˆ˜ ê°œì„  =====
        
        function saveNotebookToFile() {
            if (!activeFile) {
                alert('ì €ì¥í•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë¨¼ì € ëª¨ë“  ì…€ ë°ì´í„°ë¥¼ ë™ê¸°í™”
            syncAllCrawlCells();
            syncCellContentsToMemory(); // ì¼ë°˜ ì…€ë“¤ë„ ë™ê¸°í™”
            
            const cells = fileCells[activeFile] || [];
            const notebookContent = [];
            
            cells.forEach(cell => {
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                let content = '';
                let cellType = cell.cell_type;
                
                                 if (isCrawlCell) {
                     // crawl ì…€ì˜ ê²½ìš° ë™ê¸°í™”ëœ content ì‚¬ìš©
                     content = cell.content || JSON.stringify({ job_type: 'do', action: '', params: {} }, null, 2);
                    
                    // JSON ëª¨ë“œ í™•ì¸í•˜ì—¬ íƒ€ì… ê²°ì •
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked;
                    cellType = isJsonMode ? 'crawl_json' : 'crawl_ui';
                } else {
                    // ì¼ë°˜ ì½”ë“œ ì…€
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content || '';
                    cellType = 'code';
                }
                
                if (content.trim() !== '') {
                    notebookContent.push({
                        cell_type: cellType,
                        content: content,
                        metadata: { name: cell.name || '' },
                        output_history: cell.output_history || []
                    });
                }
            });
            
            if (notebookContent.length === 0) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì €ì¥ í˜•ì‹ ê²°ì •
            const fileName = activeFile.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            let contentToSave = '';
            if (fileExtension === 'ipynb') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        execution_count: null, 
                        metadata: item.metadata, 
                        outputs: item.output_history ? item.output_history.map(entry => ({
                            output_type: "stream",
                            name: "stdout",
                            text: entry.output
                        })) : [], 
                        source: item.content
                    })),
                    metadata: { 
                        kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, 
                        language_info: { 
                            codemirror_mode: { name: "ipython", version: 3 }, 
                            file_extension: ".py", 
                            mimetype: "text/x-python", 
                            name: "python", 
                            nbconvert_exporter: "python", 
                            pygments_lexer: "ipython3", 
                            version: "3.8.0" 
                        } 
                    }, 
                    nbformat: 4, 
                    nbformat_minor: 4 
                };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else if (fileExtension === 'npn') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        metadata: item.metadata, 
                        source: item.content,
                        output_history: item.output_history || []
                    })),
                    metadata: { 
                        kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, 
                        language_info: { 
                            codemirror_mode: { name: "ipython", version: 3 }, 
                            file_extension: ".py", 
                            mimetype: "text/x-python", 
                            name: "python", 
                            nbconvert_exporter: "python", 
                            pygments_lexer: "ipython3", 
                            version: "3.8.0" 
                        } 
                    }, 
                    nbformat: 4, 
                    nbformat_minor: 4 
                };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else {
                contentToSave = notebookContent.map(item => item.content).join('\n\n');
            }
            
            // íŒŒì¼ ì €ì¥ API í˜¸ì¶œ
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: activeFile, content: contentToSave })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ë…¸íŠ¸ë¶ì´ "${fileName}"ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                } else {
                    alert(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    </script>



    <style>
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .image-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .image-modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .image-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            color: #333;
        }

        .image-modal-body {
            padding: 20px;
            text-align: center;
            background: white;
        }

        /* Footer ìŠ¤íƒ€ì¼ */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-top: 1px solid #4a5568;
            z-index: 1000;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-left, .footer-right {
            font-size: 0.9rem;
        }

        /* ì‹¤ì‹œê°„ ìŠ¤í¬ë¦°ìƒ· íƒ­ ìŠ¤íƒ€ì¼ */
        .screenshot-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px 0 0 8px;
            padding: 1rem;
            cursor: pointer;
            z-index: 2000;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }

        .screenshot-tab:hover {
            background: #4a5568;
        }

        .screenshot-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1a202c;
            color: #e2e8f0;
            z-index: 1999;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .screenshot-panel.open {
            right: 0;
        }

        .screenshot-header {
            background: #2d3748;
            padding: 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .screenshot-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .screenshot-close {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-close:hover {
            color: #f56565;
        }

        .screenshot-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .screenshot-info {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .screenshot-image-container {
            background: #2d3748;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .screenshot-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            border: 1px solid #4a5568;
        }

        .screenshot-status {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #2d3748;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
    
    <!-- ì±„íŒ… ì»´í¬ë„ŒíŠ¸ JavaScript -->
    <script src="/templates/component/chat/chat.js"></script>
</body>
</html>