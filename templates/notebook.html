<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramita AI</title>
    <link rel="stylesheet" href="/templates/notebook.css?v=3.2">
    <link rel="stylesheet" href="/templates/component/chat/chat.css">
</head>
<body>
    <div class="header" style="display:flex;align-items:center;justify-content:center;position:relative;">
        <div class="header-menu" style="position:absolute;left:2rem;top:0;bottom:0;display:flex;align-items:center;">
            <nav class="jupyter-menubar" style="background:transparent;border:none;box-shadow:none;padding:0;">
                <ul class="menu-list" style="display:flex;gap:1.2rem;list-style:none;margin:0;padding:0;height:38px;align-items:center;">
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>File</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">New Notebook</li>
                            <li class="dropdown-item">Open...</li>
                            <li class="dropdown-item">Save</li>
                            <li class="dropdown-item">Save As...</li>
                            <li class="dropdown-item">Download</li>
                            <li class="dropdown-item">Rename</li>
                            <li class="dropdown-item">Close</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Edit</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Undo</li>
                            <li class="dropdown-item">Redo</li>
                            <li class="dropdown-item">Cut Cell</li>
                            <li class="dropdown-item">Copy Cell</li>
                            <li class="dropdown-item">Paste Cell Below</li>
                            <li class="dropdown-item">Delete Cell</li>
                            <li class="dropdown-item">Select All</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>View</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Toggle Toolbar</li>
                            <li class="dropdown-item">Toggle Line Numbers</li>
                            <li class="dropdown-item">Expand All</li>
                            <li class="dropdown-item">Collapse All</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Insert</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Insert Cell Above</li>
                            <li class="dropdown-item">Insert Cell Below</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Cell</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Run Cell</li>
                            <li class="dropdown-item">Run All</li>
                            <li class="dropdown-item">Run Above</li>
                            <li class="dropdown-item">Run Below</li>
                            <li class="dropdown-item">Cell Type: Code</li>
                            <li class="dropdown-item">Cell Type: Markdown</li>
                            <li class="dropdown-item">Cell Type: Raw</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Kernel</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Restart</li>
                            <li class="dropdown-item">Interrupt</li>
                            <li class="dropdown-item">Reconnect</li>
                            <li class="dropdown-item">Shutdown</li>
                        </ul>
                    </li>
                    <li class="menu-item" style="position:relative;cursor:pointer;"><span>Help</span>
                        <ul class="dropdown" style="display:none;position:absolute;top:38px;left:0;background:#fff;border:1px solid #e0e0e0;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5rem 0;min-width:140px;z-index:200;">
                            <li class="dropdown-item">Keyboard Shortcuts</li>
                            <li class="dropdown-item">About</li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <h1 style="flex:1;text-align:center;margin:0;font-size:1.8rem;font-weight:400;">Paramita AI</h1>
        <div class="nav-links" style="position:absolute;right:2rem;top:0;bottom:0;display:flex;align-items:center;gap:1rem;">
            <a href="/" class="nav-link">Ìôà</a>
            <a href="/worker" class="nav-link">Worker</a>
            <a href="/jobs" class="nav-link">Jobs</a>
            <a href="/kernel" class="nav-link">Ïª§ÎÑê</a>
        </div>
    </div>

    <!-- ÌååÏùºÎ≥Ñ ÌÉ≠ Î∞î -->
    <div class="file-tabs" id="fileTabs">
        <div class="file-tabs-container"></div>
    </div>

    <div class="notebook-layout-wrapper" style="display: flex; flex-direction: row; height: calc(100vh - 70px - 28px); min-height:0; width: 100vw;">
      <!-- Ï¢åÏ∏° ÏÇ¨Ïù¥ÎìúÎ∞î (ÌÉ≠ Íµ¨Ï°∞) -->
      <div class="file-browser-sidebar">
        <div class="sidebar-tabs">
          <div class="sidebar-tab active" onclick="switchSidebarTab('fileTreePanel')" title="ÌååÏùº ÌÉêÏÉâÍ∏∞">üìÅ</div>
          <div class="sidebar-tab" onclick="switchSidebarTab('kernelPanel')" title="Ïª§ÎÑê">üß†</div>
          <div class="sidebar-tab" onclick="switchSidebarTab('chatHistoryPanel')" title="Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨">üí¨</div>
        </div>
        <div class="sidebar-content">
          <div id="fileTreePanel" class="sidebar-panel active">
            {% include 'component/file_browser/file_browser.html' %}
          </div>
          <div id="kernelPanel" class="sidebar-panel">
            {% include 'component/kernel_manager/kernel_manager.html' %}
          </div>
          <div id="chatHistoryPanel" class="sidebar-panel">
            {% include 'component/chat/chat_history.html' %}
          </div>
        </div>
      </div>
      <!-- ÎÖ∏Ìä∏Î∂Å Î©îÏù∏ ÏòÅÏó≠ -->
      <div class="notebook-main" style="flex: 1 1 0; overflow-y: auto; height: 100%;">
        <div class="notebook-cells-area">
          <div id="notebookCells"></div>
          <div style="height: 200px; padding: 20px; text-align: center; color: #a0aec0; font-size: 0.9rem;">
            <div style="margin-top: 50px;">
              <div style="font-size: 2rem; margin-bottom: 10px;">üìù</div>
              <div>ÎÖ∏Ìä∏Î∂Å ÎÅù</div>
              <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">Îçî ÎßéÏùÄ ÏÖÄÏùÑ Ï∂îÍ∞ÄÌïòÎ†§Î©¥ ÏúÑÏùò ‚ûï Î≤ÑÌäºÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Ïö∞Ï∏° Ìå®ÎÑê -->
      <div class="right-panel" id="rightPanel" style="height: calc(100vh - 70px - 28px); position: sticky; top: 0;">
        <div class="right-panel-resize-handle" id="rightPanelResizeHandle"></div>
        
        <!-- Ïö∞Ï∏° Ìå®ÎÑê ÌÉ≠ Íµ¨Ï°∞ -->
        <div class="right-panel-tabs">
          <div class="right-tab active" onclick="switchRightTab('np')" data-tab="np" title="NP Ìå®ÎÑê (ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)">
            <span class="tab-icon"></span>
            <span class="tab-label">note</span>
          </div>
          <div class="right-tab" onclick="switchRightTab('view')" data-tab="view" title="HTML Î∑∞Ïñ¥ (ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)">
            <span class="tab-icon"></span>
            <span class="tab-label">view</span>
          </div>
          <div class="right-tab" onclick="switchRightTab('chat')" data-tab="chat" title="AI Ï±ÑÌåÖ (ÌÅ¥Î¶≠ÌïòÏó¨ Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞)">
            <span class="tab-icon"></span>
            <span class="tab-label">chat</span>
          </div>
        </div>
        
        <!-- NP Ìå®ÎÑê (Í∏∞Ï°¥ Í∏∞Îä•) -->
        <div class="right-panel-content active" id="npPanel">
        <div class="panel-section">
          <div class="panel-title">ÌååÏùº Ï†ïÎ≥¥</div>
          <span id="currentFileName"></span>
          <div id="currentKernelInfo" style="margin-top: 0.5rem; font-size: 0.55rem; color: #a0aec0;">Ïª§ÎÑê: ÏóÜÏùå</div>
        </div>
        <div class="panel-section">
          <div class="panel-title">Ïª§ÎÑê Ï†úÏñ¥</div>
          <div class="panel-btns">
            <button class="btn btn-primary" onclick="manageKernel('initialize')"><span class="icon">üîÑ</span><span class="label">Ïª§ÎÑê Ï¥àÍ∏∞Ìôî</span></button>
            <button class="btn btn-success" onclick="extendKernelTimeout()"><span class="icon">‚è∞</span><span class="label">12ÏãúÍ∞Ñ Ïó∞Ïû•</span></button>
            <button class="btn btn-danger" onclick="manageKernel('shutdown')"><span class="icon">‚èπÔ∏è</span><span class="label">Ïª§ÎÑê Ï¢ÖÎ£å</span></button>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-title">ÎÖ∏Ìä∏Î∂Å</div>
          <div class="panel-btns">
            <button class="btn btn-secondary" onclick="saveNotebookToFile()"><span class="icon">üíæ</span><span class="label">ÎÖ∏Ìä∏Î∂Å Ï†ÄÏû•</span></button>
            <button class="btn btn-primary" onclick="saveAsPython()"><span class="icon">üêç</span><span class="label">Python Î≥ÄÌôò Ï†ÄÏû•</span></button>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-title">ÏÉÅÌÉú</div>
          <span id="kernelStatusDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.6rem; background: #4a5568; border-radius: 4px; color: #000000;">Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±</span>
          <span id="kernelTimeDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.6rem; background: #2d3748; border-radius: 4px; color: #ffffff; display:block; margin-top:0.5rem;">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: --:--:--</span>
          </div>
        </div>
        
        <!-- view Ìå®ÎÑê (HTML Î∑∞Ïñ¥) -->
        <div class="right-panel-content" id="viewPanel">
          <div id="htmlViewerContainer" style="height: 100%; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;"></div>
        </div>
        
        <!-- chat Ìå®ÎÑê (AI Ï±ÑÌåÖ) -->
        <div class="right-panel-content" id="chatPanel">
          {% include 'component/chat/chat_interface.html' %}
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span>üìì Paramita AI v1.0</span>
            </div>
            <div class="footer-right">
                <span id="footer-status">copyright paramita ai</span>
            </div>
        </div>
    </footer>

    <!-- Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ -->
    <div class="context-menu" id="contextMenu" style="display: none;">
        <div class="context-menu-item" onclick="openFile()">Ïó¥Í∏∞</div>
        <div class="context-menu-item" onclick="renameFile()">Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="copyFilePath()">Í≤ΩÎ°ú Î≥µÏÇ¨</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteFile()" style="color: #dc3545;">ÏÇ≠Ï†ú</div>
    </div>

    <script src="templates/component/screenshot_monitor/screenshot_monitor.js"></script>

    <script>
        let currentFile = null;
        let fileTreeData = [];
        let selectedFileItem = null;
        let cellCounter = 0;
        let cells = [];
        let openFiles = [];
        let fileCells = {}; // { filePath: [cell, ...] }
        let fileKernels = {}; // { filePath: kernelId }
        let activeFile = null;
        // FlaskÏóêÏÑú Ï†ÑÎã¨Î∞õÏùÄ JOB_TYPESÏôÄ FOCUS_TYPES (Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏÑ§Ï†ï)
        window.jobTypes = JSON.parse('{{ job_types|tojson|safe }}');
        window.focusTypes = JSON.parse('{{ focus_types|tojson|safe }}');
        
        // ÎîîÎ≤ÑÍπÖ: Î°úÎìúÎêú Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
        console.log(`üöÄ ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú window.jobTypes:`, window.jobTypes);
        console.log(`üéØ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú job types:`, Object.keys(window.jobTypes || {}));
        console.log(`üéØ focus types:`, window.focusTypes);
        
        // ÏÑ±Îä• ÏµúÏ†ÅÌôî: job type ÏòµÏÖòÏùÑ Ìïú Î≤àÎßå ÏÉùÏÑ±ÌïòÍ≥† Ïû¨ÏÇ¨Ïö©
        let cachedJobTypeOptions = null;
        function getJobTypeOptions() {
            if (cachedJobTypeOptions) return cachedJobTypeOptions.cloneNode(true);
            
            const fragment = document.createDocumentFragment();
            Object.entries(window.jobTypes || {}).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value.name || key;
                fragment.appendChild(option);
            });
            cachedJobTypeOptions = fragment;
            return fragment.cloneNode(true);
        }
        

        
        // Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú Î°úÏª¨ Î≥ÄÏàòÎèÑ Ïú†ÏßÄ
        let jobTypes = window.jobTypes;
        let focusTypes = window.focusTypes;

        // ÏΩúÎ∞± ÏãúÏä§ÌÖú
        const CALLBACK = {
            notebook: []
        };
        
        // CALLBACK_dict ÏãúÏä§ÌÖú - Î™®Îì† ÏΩúÎ∞±Îì§ÏùÑ Í¥ÄÎ¶¨
        const CALLBACK_dict = {
            update: [] // Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏ Í¥ÄÎ†® ÏΩúÎ∞±Îì§
        };
        
        function executeCallbacks(key) {
            if (CALLBACK[key] && Array.isArray(CALLBACK[key])) {
                CALLBACK[key].forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('ÏΩúÎ∞± Ïã§Ìñâ Ïò§Î•ò:', error);
                    }
                });
            }
        }
        
        // CALLBACK_dict Ïã§Ìñâ Ìï®Ïàò
        function executeCallbackDict(key) {
            if (CALLBACK_dict[key] && Array.isArray(CALLBACK_dict[key])) {
                CALLBACK_dict[key].forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('CALLBACK_dict Ïã§Ìñâ Ïò§Î•ò:', error);
                    }
                });
            }
        }
        
        // Ïª§ÎÑê Í¥ÄÎ¶¨ Ï†ïÍ∑úÌôîÎêú Ìï®Ïàò
        function manageKernel(action) {
            if (action === 'initialize') {
                // kernel_managerÏùò initializeKernel Ìï®Ïàò Ìò∏Ï∂ú
                if (typeof window.initializeKernel === 'function') {
                    window.initializeKernel();
                }
            } else if (action === 'shutdown') {
                // kernel_managerÏùò shutdownKernel Ìï®Ïàò Ìò∏Ï∂ú
                if (typeof window.shutdownKernel === 'function') {
                    window.shutdownKernel();
                }
            }
            
            // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏
            setTimeout(() => {
                if (typeof executeCallbackDict === 'function') {
                    executeCallbackDict('update');
                }
            }, 100);
        }
        
        // ÌÉ≠ Í¥ÄÎ†® Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏ Ï†ïÍ∑úÌôîÎêú Ìï®Ïàò
        function updateKernelIdForTab() {
            // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏
            if (typeof executeCallbackDict === 'function') {
                executeCallbackDict('update');
            }
        }
        
        // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏ ÏΩúÎ∞± Îì±Î°ù
        function registerHTMLViewerUpdateCallback() {
            const updateCallback = function() {
                if (window.setKernelId && activeFile && fileKernels[activeFile]) {
                    const kernelId = fileKernels[activeFile];
                    const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                    window.setKernelId(kernelIdStr);
                } else if (window.setKernelId) {
                    window.setKernelId(null);
                }
            };
            
            // Í∏∞Ï°¥ update ÏΩúÎ∞±Îì§ Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
            CALLBACK_dict.update = CALLBACK_dict.update.filter(cb => cb !== updateCallback);
            // ÏÉàÎ°úÏö¥ ÏΩúÎ∞± Ï∂îÍ∞Ä
            CALLBACK_dict.update.push(updateCallback);
        }
        
        // Ïª§ÎÑê Í¥ÄÎ¶¨Ïûê ÌëúÏãú Ìï®Ïàò
        function showKernelManager() {
            const kernelPanel = document.getElementById('kernelPanel');
            if (kernelPanel) {
                // Î™®Îã¨ ÌòïÌÉúÎ°ú ÌëúÏãú
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                content.innerHTML = kernelPanel.innerHTML;
                
                // Îã´Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '‚úï';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #666;
                `;
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                content.appendChild(closeBtn);
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            }
        }
        


        // ÏÖÄ Ïã§Ìñâ ÌÅê ÏãúÏä§ÌÖú
        let cellExecutionQueue = []; // Ïã§Ìñâ ÎåÄÍ∏∞ Ï§ëÏù∏ ÏÖÄÎì§
        let isExecuting = false; // ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ÏßÄ Ïó¨Î∂Ä
        let currentExecutingCell = null; // ÌòÑÏû¨ Ïã§Ìñâ Ï§ëÏù∏ ÏÖÄ ID

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        // ÎÖ∏Ìä∏Î∂Å ÏΩúÎ∞± Ìï®ÏàòÎ•º Î®ºÏ†Ä ÏÑ†Ïñ∏
        window.setNotebookCallback = function() {
            // console.log('[ÎÖ∏Ìä∏Î∂Å] setNotebookCallback Ìò∏Ï∂úÎê®');
            setFileBrowserCallback(function(file, content) {
                // console.log('[ÎÖ∏Ìä∏Î∂Å] ÌååÏùº ÎÇ¥Ïö© Î∞õÏùå:', file.name);
                // console.log('[ÎÖ∏Ìä∏Î∂Å] ÌååÏùº Í≤ΩÎ°ú:', file.path);
                // console.log('[ÎÖ∏Ìä∏Î∂Å] ÎÇ¥Ïö© Í∏∏Ïù¥:', content ? content.length : 0);
                
                // ÌååÏùº ÎÇ¥Ïö©ÏùÑ ÏÖÄÎ°ú Î≥ÄÌôò
                let cells = [];
                if (content) {
                    if (file.name.endsWith('.ipynb') || file.name.endsWith('.npn')) {
                        try {
                            const notebook = JSON.parse(content);
                            // console.log('[ÎÖ∏Ìä∏Î∂Å] ÌååÏã±Îêú ÎÖ∏Ìä∏Î∂Å:', notebook);
                            if (notebook.cells && Array.isArray(notebook.cells)) {
                                // console.log('[ÎÖ∏Ìä∏Î∂Å] ÏÖÄ Í∞úÏàò:', notebook.cells.length);
                                notebook.cells.forEach((cell, index) => {
                                    let cellContent = '';
                                    if (cell.cell_type === 'code') {
                                        cellContent = Array.isArray(cell.source) ? cell.source.join('') : cell.source;
                                    } else {
                                        cellContent = Array.isArray(cell.source) ? cell.source.join('') : cell.source;
                                    }
                                    // console.log(`[ÎÖ∏Ìä∏Î∂Å] ÏÖÄ ${index + 1} ÌÉÄÏûÖ:`, cell.cell_type, 'ÎÇ¥Ïö©:', cellContent.slice(0, 50));
                                    cells.push({ ...cell, content: cellContent });
                                });
                            }
                        } catch (e) {
                            console.error('[ÎÖ∏Ìä∏Î∂Å] JSON ÌååÏã± Ïò§Î•ò:', e);
                            cells.push({ content: content });
                        }
                    } else {
                        cells.push({ content: content });
                    }
                }
                
                // console.log('[ÎÖ∏Ìä∏Î∂Å] Î≥ÄÌôòÎêú ÏÖÄ Í∞úÏàò:', cells.length);
                
                // ÌååÏùºÏùÑ openFiles Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä (Ï§ëÎ≥µ Î∞©ÏßÄ)
                if (!openFiles.includes(file.path)) {
                    openFiles.push(file.path);
                }
                
                // ÏÖÄ Î†åÎçîÎßÅ
                if (!fileCells) fileCells = {};
                
                // Îπà ÌååÏùºÏù∏ Í≤ΩÏö∞ ÌôïÏû•ÏûêÏóê Îî∞Îùº Í∏∞Î≥∏ ÏÖÄ Ï∂îÍ∞Ä
                if (cells.length === 0) {
                    const fileName = file.name.toLowerCase();
                    
                    // .npn ÌååÏùºÏù∏ Í≤ΩÏö∞ ÌÅ¨Î°§ÎßÅ ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                    if (fileName.endsWith('.npn')) {
                        console.log(`üï∑Ô∏è Îπà .npn ÌååÏùºÏù¥ÎØÄÎ°ú ÌÅ¨Î°§ÎßÅ ÏÖÄ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä: ${fileName}`);
                        const crawlData = {
                            job_type: 'do',
                            action: 'click',
                            params: {
                                focus: { xpath: "//button[@id='login']" },
                                speed: 1.0
                            }
                        };
                        const crawlDataWithDefaults = addDefaultParams(crawlData);
                        cells.push({
                            content: JSON.stringify(crawlDataWithDefaults, null, 2),
                            cell_type: 'crawl_ui',
                            crawl_data: crawlDataWithDefaults,
                            name: 'Crawl_1'
                        });
                    } 
                    // .py, .ipynb ÌååÏùºÏù∏ Í≤ΩÏö∞ Îπà ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä
                    else if (fileName.endsWith('.py') || fileName.endsWith('.ipynb')) {
                        console.log(`üêç Îπà Python ÌååÏùºÏù¥ÎØÄÎ°ú ÏΩîÎìú ÏÖÄ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä: ${fileName}`);
                        cells.push({
                            content: '',
                            cell_type: 'code'
                        });
                    }
                    // Í∏∞ÌÉÄ ÌååÏùºÎèÑ Îπà ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä (Í∏∞Î≥∏Í∞í)
                    else {
                        console.log(`üìù Îπà ÌååÏùºÏù¥ÎØÄÎ°ú Í∏∞Î≥∏ ÏΩîÎìú ÏÖÄ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä: ${fileName}`);
                        cells.push({
                            content: '',
                            cell_type: 'code'
                        });
                    }
                }
                
                // ÏÖÄÎì§ÏùÑ Cell Ïù∏Ïä§ÌÑ¥Ïä§Î°ú Î≥ÄÌôò
                fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));
                activeFile = file.path;
                // console.log('[ÎÖ∏Ìä∏Î∂Å] activeFile ÏÑ§Ï†ï:', activeFile);
                // console.log('[ÎÖ∏Ìä∏Î∂Å] openFiles:', openFiles);
                
                // ÌååÏùº ÌÉ≠ Î†åÎçîÎßÅ
                renderFileTabs();
                
                // Ïª§ÎÑê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                if (typeof updateKernelInfo === 'function') {
                    updateKernelInfo();
                }
                
                // Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
                checkKernelStatus();
                
                // Ïª§ÎÑêÏù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
                if (fileKernels[file.path]) {
                    if (typeof startKernelTimeUpdate === 'function') {
                        startKernelTimeUpdate();
                    }
                } else {
                    // Ïª§ÎÑêÏù¥ ÏóÜÎäî Í≤ΩÏö∞ ÏãúÍ∞Ñ ÌëúÏãú Ï¥àÍ∏∞Ìôî
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    if (timeDisplayElement) {
                        timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: --:--:--';
                    }
                    // Í∏∞Ï°¥ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÏßÄ
                    if (typeof stopKernelTimeUpdate === 'function') {
                        stopKernelTimeUpdate();
                    }
                }
                
                // console.log('[ÎÖ∏Ìä∏Î∂Å] renderNotebookCells Ìï®Ïàò Ï°¥Ïû¨:', typeof renderNotebookCells);
                
                if (renderNotebookCells) {
                    // console.log('[ÎÖ∏Ìä∏Î∂Å] renderNotebookCells Ìò∏Ï∂ú');
                    renderNotebookCells();
                } else {
                    console.error('[ÎÖ∏Ìä∏Î∂Å] renderNotebookCells Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå');
                }
            });
        };

        document.addEventListener('DOMContentLoaded', function() {
            // console.log('[ÎÖ∏Ìä∏Î∂Å] DOM Î°úÎìú ÏôÑÎ£å');
            
            // ÌÉ≠ ÌÅ¨Í∏∞ Î°úÎìú
            loadTabSizes();
            
            // ÌååÏùº Î∏åÎùºÏö∞Ï†ÄÎäî Î≥ÑÎèÑ Ïª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú Î°úÎìúÎê®
            // console.log('[ÎÖ∏Ìä∏Î∂Å] ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Ïª¥Ìè¨ÎÑåÌä∏ Î°úÎìú ÎåÄÍ∏∞ Ï§ë...');
            setupEventListeners();
            
            // ÏÉàÎ°úÍ≥†Ïπ® Ïãú Ïª§ÎÑê ÏÉÅÌÉú Î≥µÏõê
            restoreKernelState();
            
            // ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÏóêÏÑú Í∏∞Î≥∏ ÏÖÄ Ï∂îÍ∞Ä
            if (!activeFile) {
                addCell(); // Ï≤´ Î≤àÏß∏ ÏÖÄ Ï∂îÍ∞Ä
            }
            
            // ÌôúÏÑ± ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ ÏãúÍ∞ÑÏ†úÌïú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            if (activeFile) {
                startKernelTimeUpdate();
            }
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïùò ÌÅ¨Í∏∞ Ï†ÅÏö©
            const activeTab = document.querySelector('.right-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const tabSize = tabSizes[tabName] || 280;
                const rightPanel = document.getElementById('rightPanel');
                rightPanel.style.width = tabSize + 'px';
            }
            
            // checkKernelStatus(); // ÏÑ∏ÏÖò Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ Ï†úÍ±∞
        });
        
        // Job Types Î°úÎìú
        async function loadJobTypes() {
            try {
                const response = await fetch('/api/job_types');
                const data = await response.json();
                jobTypes = data.job_types;
                focusTypes = data.focus_types;
        
            } catch (error) {
                console.error('Failed to load job types:', error);
            }
        }

        // Í∏∞Ï°¥ ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Ìï®ÏàòÎì§...
        function setupEventListeners() {
            // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ Ïà®Í∏∞Í∏∞
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // ESC ÌÇ§Î°ú Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ Ïà®Í∏∞Í∏∞
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });

            // Ï†ÑÏó≠ ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ Ï†úÏñ¥ (Í∏∞Î≥∏ Î∏åÎùºÏö∞Ï†Ä Îã®Ï∂ïÌÇ§ Ï∞®Îã®)
            document.addEventListener('keydown', function(e) {
                const isCtrlCmd = e.ctrlKey || e.metaKey;
                const isShift = e.shiftKey;
                const key = (e.key || '').toLowerCase();
                
                // Ïö∞Î¶¨Í∞Ä ÌóàÏö©ÌïòÎäî Îã®Ï∂ïÌÇ§ Î™©Î°ù
                const allowedShortcuts = [
                    'escape',           // ESC
                    'f5',              // ÏÉàÎ°úÍ≥†Ïπ®
                    'f12',             // Í∞úÎ∞úÏûê ÎèÑÍµ¨
                ];
                
                const allowedCtrlShortcuts = [
                    'c',               // Î≥µÏÇ¨
                    'v',               // Î∂ôÏó¨ÎÑ£Í∏∞  
                    'x',               // ÏûòÎùºÎÇ¥Í∏∞
                    'z',               // Ïã§ÌñâÏ∑®ÏÜå
                    'y',               // Îã§ÏãúÏã§Ìñâ
                    'a',               // Ï†ÑÏ≤¥ÏÑ†ÌÉù
                    'f',               // Ï∞æÍ∏∞ (Ïö∞Î¶¨ Ïö©ÎèÑÎ°ú Ïû¨Ï†ïÏùò Í∞ÄÎä•)
                    'r',               // ÏÉàÎ°úÍ≥†Ïπ® (viewer ÏÉàÎ°úÍ≥†Ïπ®ÏúºÎ°ú Ïû¨Ï†ïÏùò)
                    'f5',              // Ctrl+F5 Í∞ïÎ†• ÏÉàÎ°úÍ≥†Ïπ®
                ];
                
                // Í∏∞Î≥∏ Î∏åÎùºÏö∞Ï†Ä Îã®Ï∂ïÌÇ§ Ï∞®Îã®
                if (isCtrlCmd) {
                    // Ctrl+F5Îäî ÌäπÎ≥Ñ Ï≤òÎ¶¨ (Í∞ïÎ†• ÏÉàÎ°úÍ≥†Ïπ® ÌóàÏö©)
                    if (key === 'f5') {
                        console.log('ÌóàÏö©Îêú Îã®Ï∂ïÌÇ§: Ctrl+F5 - Í∞ïÎ†• ÏÉàÎ°úÍ≥†Ïπ®');
                        return true; // Í∏∞Î≥∏ ÎèôÏûë ÌóàÏö©
                    }
                    
                    if (!allowedCtrlShortcuts.includes(key)) {
                        e.preventDefault();
                        console.log(`Ï∞®Îã®Îêú Îã®Ï∂ïÌÇ§: Ctrl+${key.toUpperCase()}`);
                        return false;
                    }
                } else {
                    // Ctrl ÏóÜÎäî Îã®Ï∂ïÌÇ§ Ï∞®Îã® (FÌÇ§ Îì± ÌóàÏö©Îêú Í≤É Ï†úÏô∏)
                    if (key.startsWith('f') && key.length > 1) {
                        // F1-F12 ÌÇ§Îäî ÌóàÏö©Îêú Í≤ÉÎßå
                        if (!allowedShortcuts.includes(key)) {
                            e.preventDefault();
                            console.log(`Ï∞®Îã®Îêú Îã®Ï∂ïÌÇ§: ${key.toUpperCase()}`);
                            return false;
                        }
                    }
                }
                
                // Ïö∞Î¶¨ÎßåÏùò Ïª§Ïä§ÌÖÄ Îã®Ï∂ïÌÇ§ Ï≤òÎ¶¨
                if (isCtrlCmd && key === 'enter') {
                    e.preventDefault();
                    // ÌòÑÏû¨ ÌôúÏÑ± ÏÖÄ Ïã§Ìñâ
                    console.log('Ïª§Ïä§ÌÖÄ Îã®Ï∂ïÌÇ§: Ctrl+Enter - ÏÖÄ Ïã§Ìñâ');
                    return false;
                }
                
                if (isCtrlCmd && isShift && key === 'enter') {
                    e.preventDefault();
                    // ÏÖÄ Ïã§Ìñâ ÌõÑ ÏÉà ÏÖÄ Ï∂îÍ∞Ä
                    console.log('Ïª§Ïä§ÌÖÄ Îã®Ï∂ïÌÇ§: Ctrl+Shift+Enter - ÏÖÄ Ïã§Ìñâ ÌõÑ ÏÉà ÏÖÄ');
                    return false;
                }
                
                if (isCtrlCmd && key === 's') {
                    e.preventDefault();
                    // ÌååÏùº Ï†ÄÏû•
                    saveNotebookToFile();
                    console.log('Ïª§Ïä§ÌÖÄ Îã®Ï∂ïÌÇ§: Ctrl+S - ÌååÏùº Ï†ÄÏû•');
                    return false;
                }
                
                if (isCtrlCmd && key === 'r') {
                    e.preventDefault();
                    // Viewer ÏÉàÎ°úÍ≥†Ïπ®
                    refreshViewer();
                    console.log('Ïª§Ïä§ÌÖÄ Îã®Ï∂ïÌÇ§: Ctrl+R - Viewer ÏÉàÎ°úÍ≥†Ïπ®');
                    return false;
                }
            });
            
            // Viewer ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
            function refreshViewer() {
                const viewerFrame = document.getElementById('rightPanel');
                if (viewerFrame) {
                    // ÌòÑÏû¨ viewerÏóê ÌëúÏãúÎêú ÎÇ¥Ïö©ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®
                    const iframe = viewerFrame.querySelector('iframe');
                    if (iframe) {
                        // iframeÏù¥ ÏûàÎäî Í≤ΩÏö∞ ÏÉàÎ°úÍ≥†Ïπ®
                        iframe.src = iframe.src;
                        console.log('Viewer iframe ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
                    } else {
                        // iframeÏù¥ ÏóÜÎäî Í≤ΩÏö∞ HTML ÎÇ¥Ïö© ÏÉàÎ°úÍ≥†Ïπ®
                        const htmlContent = viewerFrame.innerHTML;
                        viewerFrame.innerHTML = '';
                        setTimeout(() => {
                            viewerFrame.innerHTML = htmlContent;
                            console.log('Viewer HTML ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
                        }, 100);
                    }
                } else {
                    console.log('ViewerÍ∞Ä ÏóÜÏñ¥ÏÑú ÏÉàÎ°úÍ≥†Ïπ®Ìï† Ïàò ÏóÜÏäµÎãàÎã§');
                }
            }
            
            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ Ïù¥Î≤§Ìä∏
            const resizeHandle = document.getElementById('rightPanelResizeHandle');
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', startResize);
            }

        }

        // ÏÑúÎ≤ÑÏóêÏÑú ÌôúÏÑ± Ïª§ÎÑê Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        function restoreKernelState() {
            
            // ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏôÄÏÑú Î≥µÏõê (ÏÇ¨Ïö©ÏûêÎ≥Ñ)
            fetch('/api/kernels/file-mappings')
                .then(response => response.json())
                .then(data => {
                    
                    if (data.success && data.mappings) {
                        
                        // ÏÑúÎ≤ÑÏùò Îß§Ìïë Ï†ïÎ≥¥Î•º ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉÅÌÉúÎ°ú Î≥µÏõê
                        fileKernels = data.mappings;
                        
                        // UI ÏóÖÎç∞Ïù¥Ìä∏
                        updateKernelInfo();
                        
                        // Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
                        checkKernelStatus();
                        
                        // Í∞Å ÌååÏùºÏùò Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
                        Object.keys(fileKernels).forEach(filePath => {
                            const kernelId = fileKernels[filePath];
                        });
                    } else {
                    }
                })
                .catch(error => {
                });
        }

        // ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Í¥ÄÎ†® Ìï®ÏàòÎì§ÏùÄ file_browser.htmlÏóêÏÑú Ï≤òÎ¶¨Îê®

        // ÌååÏùº ÏÑ†ÌÉùÏùÄ ÌååÏùº Î∏åÎùºÏö∞Ï†Ä ÏΩúÎ∞±ÏóêÏÑú Ï≤òÎ¶¨Îê®

        // ÌååÏùºÎ≥Ñ Í∏∞Ï°¥ Ïª§ÎÑê ÌôïÏù∏ Î∞è Ïó∞Í≤∞ (ÏÉà Ïª§ÎÑê ÏÉùÏÑ± ÏóÜÏùå)
        let kernelCheckInProgress = new Set(); // Ï§ëÎ≥µ ÏöîÏ≤≠ Î∞©ÏßÄ
        
        function checkKernelForFile(filePath) {
            
            // Ï§ëÎ≥µ ÏöîÏ≤≠ Î∞©ÏßÄ
            if (kernelCheckInProgress.has(filePath)) {
                return;
            }
            
            // ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
            const fileName = filePath.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                return;
            }
            
            // ÏßÑÌñâ Ï§ë ÌëúÏãú
            kernelCheckInProgress.add(filePath);
            
            // Í∏∞Ï°¥ Ïª§ÎÑêÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏Îßå (ÏÉàÎ°ú ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå)
            checkAndConnectExistingKernel(filePath).then(hasExistingKernel => {
                
                if (hasExistingKernel) {
                } else {
                }
                
                // ÏßÑÌñâ Ï§ë ÌëúÏãú Ï†úÍ±∞
                kernelCheckInProgress.delete(filePath);
            });
        }
        
        // Í∏∞Ï°¥ Ïª§ÎÑê ÌôïÏù∏ Î∞è Ïó∞Í≤∞
        function checkAndConnectExistingKernel(filePath) {
            return new Promise((resolve) => {
                
                // ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº-Ïª§ÎÑê Îß§Ìïë ÌôïÏù∏ (ÏÇ¨Ïö©ÏûêÎ≥Ñ)
                fetch(`/api/kernels/file-mapping?file_path=${encodeURIComponent(filePath)}`)
                    .then(response => response.json())
                    .then(data => {
                        
                        if (data.success && data.kernel_id) {
                            
                            // Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
                            fetch(`/api/kernels/${data.kernel_id}/status`)
                                .then(statusResponse => statusResponse.json())
                                .then(statusData => {
                                    
                                    if (statusData.success && statusData.status.status !== 'shutdown') {
                                        // ÌôúÏÑ± Ïª§ÎÑêÏù¥Î©¥ Ïó∞Í≤∞
                                        fileKernels[filePath] = data.kernel_id;
                                        updateKernelInfo();
                                        
                                        // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏
                                        updateKernelIdForTab();
                                        
                                        resolve(true);
                                    } else {
                                        resolve(false);
                                    }
                                })
                                .catch(error => {
                                    resolve(false);
                                });
                        } else {
                            resolve(false);
                        }
                    })
                    .catch(error => {
                        resolve(false);
                    });
            });
        }

        function renderFileTabs() {
            const fileTabs = document.getElementById('fileTabs');
            const fileTabsContainer = fileTabs.querySelector('.file-tabs-container');
            fileTabsContainer.innerHTML = '';
            openFiles.forEach(path => {
                const tab = document.createElement('div');
                tab.className = 'file-tab' + (activeFile === path ? ' active' : '');
                
                // ÌååÏùºÎ™Ö ÌëúÏãú
                const fileName = path.split('/').pop();
                const hasKernel = fileKernels[path];
                const kernelIcon = hasKernel ? 'üß†' : '‚ö™';
                tab.innerHTML = `<span>${kernelIcon} ${fileName}</span>`;
                
                tab.onclick = () => setActiveFileTab(path);
                // Îã´Í∏∞ Î≤ÑÌäº
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeFileTab(path);
                };
                tab.appendChild(closeBtn);
                fileTabsContainer.appendChild(tab);
            });
        }

        function setActiveFileTab(path) {
            activeFile = path;
            renderFileTabs();
            renderNotebookCells();
            // ÌååÏùºÎ™Ö Î∞è Ï†ÄÏû• Î≤ÑÌäº ÌëúÏãú
            var currentFileInfoElem = document.getElementById('currentFileInfo');
            if (currentFileInfoElem) {
                currentFileInfoElem.style.display = 'flex';
            }
            const fileName = path.split('/').pop();
            
            const hasKernel = fileKernels[path];
            const kernelId = hasKernel ? fileKernels[path] : 'ÏóÜÏùå';
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            document.getElementById('currentFileName').textContent = fileName;
            
            // Ïª§ÎÑê Ï¥àÍ∏∞Ìôî Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            const initButton = document.querySelector('#currentFileInfo .btn-primary');
            if (initButton) {
                initButton.innerHTML = hasKernel ? 'üîÑ Ïª§ÎÑê Ïû¨ÏãúÏûë' : 'üîÑ Ïª§ÎÑê Ï¥àÍ∏∞Ìôî';
            }
            
            // ÏÖÄÏù¥ ÏóÜÏúºÎ©¥ ÌôïÏû•ÏûêÏóê Îî∞Îùº Ï†ÅÏ†àÌïú Í∏∞Î≥∏ ÏÖÄ Ï∂îÍ∞Ä
            if (!fileCells[path] || fileCells[path].length === 0) {
                const fileName = path.split('/').pop().toLowerCase();
                
                // .npn ÌååÏùºÏù∏ Í≤ΩÏö∞ ÌÅ¨Î°§ÎßÅ ÏÖÄ Ï∂îÍ∞Ä
                if (fileName.endsWith('.npn')) {
                    console.log(`üï∑Ô∏è .npn ÌååÏùºÏù¥ÎØÄÎ°ú ÌÅ¨Î°§ÎßÅ ÏÖÄ Ï∂îÍ∞Ä: ${fileName}`);
                    addCrawlCell();
                } 
                // .py, .ipynb ÌååÏùºÏù∏ Í≤ΩÏö∞ ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä
                else if (fileName.endsWith('.py') || fileName.endsWith('.ipynb')) {
                    console.log(`üêç Python ÌååÏùºÏù¥ÎØÄÎ°ú ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä: ${fileName}`);
                    addCell();
                }
                // Í∏∞ÌÉÄ ÌååÏùºÎèÑ ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä (Í∏∞Î≥∏Í∞í)
                else {
                    console.log(`üìù Í∏∞Î≥∏ ÏΩîÎìú ÏÖÄ Ï∂îÍ∞Ä: ${fileName}`);
                    addCell();
                }
            }
            
            // Ïª§ÎÑê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÏãúÍ∞ÑÏ†úÌïú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            if (typeof updateKernelInfo === 'function') {
                updateKernelInfo();
            }
            
            // Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
            checkKernelStatus();
            
            // Ïª§ÎÑêÏù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
            if (fileKernels[path]) {
                if (typeof stopKernelTimeUpdate === 'function') {
                    stopKernelTimeUpdate();
                }
                if (typeof startKernelTimeUpdate === 'function') {
                    startKernelTimeUpdate();
                }
            } else {
                // Ïª§ÎÑêÏù¥ ÏóÜÎäî Í≤ΩÏö∞ ÏãúÍ∞Ñ ÌëúÏãú Ï¥àÍ∏∞Ìôî
                const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                if (timeDisplayElement) {
                    timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: --:--:--';
                }
                // Í∏∞Ï°¥ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ëÏßÄ
                if (typeof stopKernelTimeUpdate === 'function') {
                    stopKernelTimeUpdate();
                }
            }
            
            // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏
            updateKernelIdForTab();
            
            // ÎÖ∏Ìä∏Î∂Å ÌÉ≠ Î≥ÄÍ≤Ω ÏΩúÎ∞± Ïã§Ìñâ
            executeCallbacks('notebook');
        }

        function closeFileTab(path) {
            const idx = openFiles.indexOf(path);
            if (idx !== -1) {
                openFiles.splice(idx, 1);
                delete fileCells[path];
                
                // Ìï¥Îãπ ÌååÏùºÏùò Ïª§ÎÑê Ï¢ÖÎ£å
                if (fileKernels[path]) {
                    shutdownKernelForFile(path);
                }
                delete fileKernels[path];
                
                // ÌÉ≠ Îã´ÏùÄ ÌõÑ Îã§Î•∏ ÌÉ≠ÏúºÎ°ú Ï†ÑÌôò
                if (openFiles.length > 0) {
                    setActiveFileTab(openFiles[Math.max(0, idx - 1)]);
                } else {
                    activeFile = null;
                    renderFileTabs();
                    document.getElementById('notebookCells').innerHTML = '';
                    document.getElementById('currentFileInfo').style.display = 'none';
                }
                
                // ÎÖ∏Ìä∏Î∂Å ÌÉ≠ Î≥ÄÍ≤Ω ÏΩúÎ∞± Ïã§Ìñâ
                executeCallbacks('notebook');
                
                // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏
                updateKernelIdForTab();
            }
        }

        // ÌååÏùºÎ≥Ñ Ïª§ÎÑê Ï¢ÖÎ£å
        function shutdownKernelForFile(filePath) {
            const kernelId = fileKernels[filePath];
            if (!kernelId) return;
            
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            if (!confirm(`"${filePath.split('/').pop()}" ÌååÏùºÏùò Ïª§ÎÑêÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            fetch(`/api/kernels/${kernelIdStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `Ïª§ÎÑêÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§: ${filePath.split('/').pop()}`;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ÏÑúÎ≤ÑÏóêÏÑú ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞
                    fetch('/api/kernels/file-mapping', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file_path: filePath
                        })
                    })
                    .then(response => response.json())
                    .then(mappingData => {
                        if (!mappingData.success) {
                            console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ Ïã§Ìå®:', mappingData.error);
                        }
                    })
                    .catch(error => {
                        console.error('ÌååÏùº-Ïª§ÎÑê Îß§Ìïë Ï†úÍ±∞ Ïò§Î•ò:', error);
                    });
                    
                    // Ïª§ÎÑê ID Ï†úÍ±∞
                    delete fileKernels[filePath];
                    
                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateKernelInfo();
                    
                    // ÎßåÏïΩ Ï¢ÖÎ£åÎêú Ïª§ÎÑêÏù¥ ÌòÑÏû¨ ÌôúÏÑ± ÌååÏùºÏùò Ïª§ÎÑêÏù¥ÏóàÎã§Î©¥
                    if (filePath === activeFile) {
                        document.getElementById('currentKernelInfo').textContent = 'ÏóÜÏùå';
                        document.getElementById('kernelStatusText').textContent = 'Ïª§ÎÑê ÏóÜÏùå';
                    }
                    
                    // HTML Î∑∞Ïñ¥ Ïª§ÎÑê ID ÏóÖÎç∞Ïù¥Ìä∏
                    updateKernelIdForTab();
                } else {
                    alert(data.message || 'Ïª§ÎÑê Ï¢ÖÎ£åÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Ïª§ÎÑê Ï¢ÖÎ£å Ïò§Î•ò:', error);
                alert('Ïª§ÎÑê Ï¢ÖÎ£åÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        function renderNotebookCells() {
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            
            // Î™®Îì† ÏÖÄÏùò textarea ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ÏÖÄ Ï∂îÍ∞Ä Ìï®Ïàò (ÌååÏùºÎ≥Ñ)
        function addCell(content = '', cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: content,
                cell_type: 'code'
            });
            
            let insertIndex;
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, newCell);
                    insertIndex = currentIndex + 1;
                } else {
                    cells.push(newCell);
                    insertIndex = cells.length - 1;
                }
            } else {
                cells.push(newCell);
                insertIndex = cells.length - 1;
            }
            
            // ÏÑ±Îä• ÏµúÏ†ÅÌôî: Îß® ÎÅùÏóê Ï∂îÍ∞ÄÌïòÎäî Í≤ΩÏö∞Îßå Îã®Ïùº ÏÖÄ Ï∂îÍ∞Ä
            if (insertIndex === cells.length - 1) {
                addSingleCellToDOM(newCell, insertIndex);
            } else {
                renderNotebookCells();
            }
            
            // Ìè¨Ïª§Ïä§ ÏÑ§Ï†ï (ÏµúÏ†ÅÌôî)
            requestAnimationFrame(() => {
                const textarea = document.getElementById(newCell.id)?.querySelector('.cell-input');
                if (textarea) textarea.focus();
            });
            
            return newCell;
        }

        function addCellAfter(cellId) {
            syncCellContentsToMemory();
            return addCell('', cellId);
        }

        function addCrawlCell(cellId = null) {
            syncCellContentsToMemory();
            if (!activeFile) return;
            if (!fileCells[activeFile]) fileCells[activeFile] = [];
            const cells = fileCells[activeFile];
            const crawlData = {
                job_type: 'do',
                action: 'click',
                params: {
                    focus: { xpath: "//button[@id='login']" },
                    speed: 1.0
                }
            };
            const crawlDataWithDefaults = addDefaultParams(crawlData);
            const cell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: JSON.stringify(crawlDataWithDefaults, null, 2),
                cell_type: 'crawl_ui',
                crawl_data: crawlDataWithDefaults,
                name: `Crawl_${cells.length + 1}`
            });
            
            let insertIndex;
            if (cellId) {
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, cell);
                    insertIndex = currentIndex + 1;
                } else {
                    cells.push(cell);
                    insertIndex = cells.length - 1;
                }
            } else {
                cells.push(cell);
                insertIndex = cells.length - 1;
            }
            
            // ÏÑ±Îä• ÏµúÏ†ÅÌôî: Îß® ÎÅùÏóê Ï∂îÍ∞ÄÌïòÎäî Í≤ΩÏö∞Îßå Îã®Ïùº ÏÖÄ Ï∂îÍ∞Ä, ÎÇòÎ®∏ÏßÄÎäî Ï†ÑÏ≤¥ Î†åÎçîÎßÅ
            if (insertIndex === cells.length - 1) {
                // Îß® ÎÅùÏóê Ï∂îÍ∞ÄÌïòÎäî Í≤ΩÏö∞: ÏµúÏ†ÅÌôîÎêú Îã®Ïùº ÏÖÄ Ï∂îÍ∞Ä
                addSingleCellToDOM(cell, insertIndex);
            } else {
                // Ï§ëÍ∞ÑÏóê ÏÇΩÏûÖÌïòÎäî Í≤ΩÏö∞: Ï†ÑÏ≤¥ Î†åÎçîÎßÅ (Î≤àÌò∏ÏôÄ ÏàúÏÑú Ï†ïÌôïÏÑ± Î≥¥Ïû•)
                renderNotebookCells();
            }
            
            // Ï¶âÏãú Ïä§ÌÅ¨Î°§ (requestAnimationFrame ÏÇ¨Ïö©)
            requestAnimationFrame(() => {
                const newCell = document.getElementById(cell.id);
                if (newCell) {
                    newCell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
            
            return cell;
        }
        
        // ÏÑ±Îä• ÏµúÏ†ÅÌôî: Îã®Ïùº ÏÖÄÎßå DOMÏóê Ï∂îÍ∞Ä
        function addSingleCellToDOM(cell, index) {
            const notebookCells = document.getElementById('notebookCells');
            if (!notebookCells) return;
            
            // ÏÉà ÏÖÄ ÏöîÏÜå ÏÉùÏÑ± (createCellElementÎäî Î™®Îì† Ï¥àÍ∏∞Ìôî Î°úÏßÅÏùÑ Ìè¨Ìï®)
            const cellDiv = createCellElement(cell, index);
            
            // Ïò¨Î∞îÎ•∏ ÏúÑÏπòÏóê ÏÇΩÏûÖ
            const existingCells = notebookCells.children;
            if (index < existingCells.length) {
                notebookCells.insertBefore(cellDiv, existingCells[index]);
            } else {
                notebookCells.appendChild(cellDiv);
            }
            
            // Ïù¥ÌõÑ ÏÖÄÎì§Ïùò Î≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏ (ÌïÑÏöîÌïú Í≤ΩÏö∞Îßå)
            if (index < existingCells.length - 1) {
                updateCellNumbers();
            }
            
            // ‚ö†Ô∏è Ï§ëÏöî: crawl ÏÖÄ Ï¥àÍ∏∞Ìôî Î∞è ÏûêÎèô Ï†ÄÏû•
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            if (isCrawlCell) {
                // crawl ÏÖÄ Ï¥àÍ∏∞Ìôî (ÎπÑÎèôÍ∏∞)
                setTimeout(() => {
                    initializeCrawlCellOptimized(cell.id, cell.content, false);
                    // ÏûêÎèô Ï†ÄÏû• (500ms ÌõÑ)
                    setTimeout(() => saveNotebookToFile(), 500);
                }, 50);
            } else {
                // ÏùºÎ∞ò ÏÖÄÎèÑ ÏûêÎèô Ï†ÄÏû•
                setTimeout(() => saveNotebookToFile(), 500);
            }
        }
        
        // ÏÖÄ Î≤àÌò∏Îßå ÏóÖÎç∞Ïù¥Ìä∏ (Í∞ÄÎ≤ºÏö¥ ÏûëÏóÖ)
        function updateCellNumbers() {
            const cells = fileCells[activeFile] || [];
            cells.forEach((cell, idx) => {
                const cellNumberSpan = document.querySelector(`#${cell.id} .cell-number`);
                if (cellNumberSpan) {
                    const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                    cellNumberSpan.textContent = isCrawlCell ? `Crawl [${idx + 1}]:` : `In [${idx + 1}]:`;
                }
            });
        }

        // ÏÖÄ ÏÉùÏÑ± Ìï®Ïàò (ÌååÏùºÎ≥Ñ)
        function createCellElement(cell, idx) {
            const cellDiv = document.createElement('div');
            cellDiv.className = 'cell';
            cellDiv.id = cell.id;
            
            // ÌòÑÏû¨ ÌååÏùºÏùò ÏÖÄ Í∞úÏàò ÌôïÏù∏
            const currentCells = fileCells[activeFile] || [];
            const isOnlyCell = currentCells.length === 1;
            const isFirstCell = idx === 0;
            const isLastCell = idx === currentCells.length - 1;
            
            // crawl ÌÉÄÏûÖ ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            const isJsonMode = cell.cell_type === 'crawl_json';
            
            // ÏÖÄ Ìó§Îçî Î≤ÑÌäº(Ïã§Ìñâ, Ï∂îÍ∞Ä, ÏÇ≠Ï†ú, ÏúÑ/ÏïÑÎûò Ïù¥Îèô, Î≥µÏÇ¨)
            let cellActionButtons = `
                <button class="cell-btn run" onclick="runCell('${cell.id}')" title="Ïã§Ìñâ">‚ñ∂Ô∏è</button>
                <button class="cell-btn add" onclick="addCell('', '${cell.id}')" title="ÏÖÄ Ï∂îÍ∞Ä">‚ûï</button>
                ${isOnlyCell ? '' : `<button class="cell-btn delete" onclick="deleteCell('${cell.id}')" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>`}
                <button class="cell-btn copy" onclick="copyCell('${cell.id}')" title="Î≥µÏÇ¨">üìã</button>
                ${!isFirstCell ? `<button class="cell-btn up" onclick="moveCellUp('${cell.id}')" title="ÏúÑÎ°ú Ïù¥Îèô">‚¨ÜÔ∏è</button>` : ''}
                ${!isLastCell ? `<button class="cell-btn down" onclick="moveCellDown('${cell.id}')" title="ÏïÑÎûòÎ°ú Ïù¥Îèô">‚¨áÔ∏è</button>` : ''}
                ${activeFile && activeFile.toLowerCase().endsWith('.npn') ? `<button class="cell-btn add" onclick="addCrawlCell('${cell.id}')" title="ÏàòÏßë Ï∂îÍ∞Ä">üï∑Ô∏è</button>` : ''}
            `;
            
            if (isCrawlCell) {
                cellDiv.innerHTML = `
                    <div class="cell-header" draggable="true" ondragstart="handleCellDragStart(event, '${cell.id}')" ondragover="handleCellDragOver(event)" ondrop="handleCellDrop(event, '${cell.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-drag-handle" style="cursor: grab; margin-right: 0.5em;" title="ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω">
                              <svg width="18" height="18" viewBox="0 0 18 18" style="vertical-align:middle"><circle cx="4" cy="5" r="1.5" fill="#888"/><circle cx="4" cy="9" r="1.5" fill="#888"/><circle cx="4" cy="13" r="1.5" fill="#888"/><circle cx="10" cy="5" r="1.5" fill="#888"/><circle cx="10" cy="9" r="1.5" fill="#888"/><circle cx="10" cy="13" r="1.5" fill="#888"/></svg>
                            </span>
                            <span class="cell-number">Crawl [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            <div class="cell-name-input">
                                <input type="text" id="cell-name-${cell.id}" placeholder="ÏÖÄ Ïù¥Î¶Ñ" value="${cell.name || ''}" onchange="updateCellName('${cell.id}', this.value)" style="width: 120px; padding: 0.3rem 0.5rem; font-size: 0.8rem; border: 1px solid #718096; border-radius: 4px; background: #4a5568; color: #e2e8f0;">
                            </div>
                            <div class="xml-toggle">
                                <label class="switch">
                                    <input type="checkbox" id="xml-toggle-${cell.id}" onchange="toggleJsonOutput('${cell.id}')" ${isJsonMode ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <span class="xml-label">JSON</span>
                            </div>
                            ${cellActionButtons}
                        </div>
                    </div>
                    <div class="crawl-cell-content" id="crawl-controls-${cell.id}" ${isJsonMode ? 'style=\"display: none;\"' : ''}>
                        <div class="crawl-row">
                            <label>Job Type:</label>
                            <select class="crawl-job-type" onchange="updateCrawlCell('${cell.id}', 'job_type', this.value)"></select>
                        </div>
                        <div class="crawl-row">
                            <label id="action-label-${cell.id}">Action:</label>
                            <select class="crawl-action" onchange="updateCrawlCell('${cell.id}', 'action', this.value)"></select>
                        </div>

                        <div class="crawl-params" id="crawl-params-${cell.id}"></div>
                    </div>
                    <div class="xml-output-section" id="xml-output-${cell.id}" ${isJsonMode ? '' : 'style=\"display: none;\"'}>
                        <div class="xml-header">
                            <h4>JSON Ï∂úÎ†•</h4>
                            <button class="xml-copy-btn" onclick="copyJsonOutput('${cell.id}')" title="JSON Î≥µÏÇ¨">üìã</button>
                        </div>
                        <textarea class="xml-output-textarea" id="xml-content-${cell.id}" placeholder="JSON Ï∂úÎ†•Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§..." oninput="updateJsonContent('${cell.id}'); autoResizeTextarea(this)"></textarea>
                    </div>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
                // ÏÑ±Îä• ÏµúÏ†ÅÌôî: Ï¶âÏãú Ïã§Ìñâ (setTimeout Ï†úÍ±∞)
                const jobTypeSelect = cellDiv.querySelector('.crawl-job-type');
                if (jobTypeSelect && window.jobTypes) {
                    jobTypeSelect.appendChild(getJobTypeOptions());
                }
                initializeCrawlCellOptimized(cell.id, cell.content, cell.cell_type === 'crawl_json');
            } else {
                // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄ
                cellDiv.innerHTML = `
                    <div class="cell-header" draggable="true" ondragstart="handleCellDragStart(event, '${cell.id}')" ondragover="handleCellDragOver(event)" ondrop="handleCellDrop(event, '${cell.id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-drag-handle" style="cursor: grab; margin-right: 0.5em;" title="ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑú Î≥ÄÍ≤Ω">
                              <svg width="18" height="18" viewBox="0 0 18 18" style="vertical-align:middle"><circle cx="4" cy="5" r="1.5" fill="#888"/><circle cx="4" cy="9" r="1.5" fill="#888"/><circle cx="4" cy="13" r="1.5" fill="#888"/><circle cx="10" cy="5" r="1.5" fill="#888"/><circle cx="10" cy="9" r="1.5" fill="#888"/><circle cx="10" cy="13" r="1.5" fill="#888"/></svg>
                            </span>
                            <span class="cell-number">In [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            ${cellActionButtons}
                        </div>
                    </div>
                    <textarea class="cell-input" placeholder="Python ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeydown="handleKeyDown(event, '${cell.id}')" oninput="autoResizeTextarea(this)">${cell.content}</textarea>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
            }
            setTimeout(() => {
                const textarea = cellDiv.querySelector('.cell-input');
                if (textarea) {
                    autoResizeTextarea(textarea);
                }
                loadCellOutput(cell.id);
            }, 10);
            return cellDiv;
        }

        function autoResizeTextarea(textarea) {
            // ÎÜíÏù¥Î•º Ï¥àÍ∏∞ÌôîÌïòÏó¨ Ï†ïÌôïÌïú Ïä§ÌÅ¨Î°§ ÎÜíÏù¥ Í≥ÑÏÇ∞
            textarea.style.height = 'auto';
            
            // ÎÇ¥Ïö©Ïóê Îî∞Î•∏ ÎÜíÏù¥ Í≥ÑÏÇ∞ (ÏµúÏÜå 100px, ÎùºÏù∏Îãπ ÏïΩ 20px)
            const minHeight = 100;
            const lineHeight = 20;
            const lines = textarea.value.split('\n').length;
            const calculatedHeight = Math.max(minHeight, lines * lineHeight);
            
            // ÎÜíÏù¥ ÏÑ§Ï†ï
            textarea.style.height = calculatedHeight + 'px';
            
            // Ïä§ÌÅ¨Î°§Î∞îÍ∞Ä ÏÉùÍ∏∞ÏßÄ ÏïäÎèÑÎ°ù Ï∂îÍ∞Ä Ï°∞Ï†ï
            if (textarea.scrollHeight > calculatedHeight) {
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }

        // ÏÖÄ output Ï†ÄÏû• Ìï®Ïàò
        function saveCellOutput(cellId, output) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell) {
                // output ÌûàÏä§ÌÜ†Î¶¨ Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî
                if (!cell.output_history) {
                    cell.output_history = [];
                }
                
                // ÏÉàÎ°úÏö¥ outputÏúºÎ°ú ÎçÆÏñ¥Ïì∞Í∏∞ (Ïù¥Ï†Ñ ÌûàÏä§ÌÜ†Î¶¨ Ï†úÍ±∞)
                cell.output_history = [{
                    timestamp: new Date().toISOString(),
                    output: output,
                    execution_count: cell.execution_count || 1
                }];
                
                // ÌååÏùºÏóê Ï†ÄÏû•
                saveNotebookToFile();
            }
        }

        // ÏÖÄ output Î°úÎìú Ìï®Ïàò
        function loadCellOutput(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell && cell.output_history && cell.output_history.length > 0) {
                const outputDiv = document.getElementById(`output-${cellId}`);
                if (outputDiv) {
                    outputDiv.style.display = 'block';
                    
                    // Í∏∞Ï°¥ output Ï†úÍ±∞
                    outputDiv.innerHTML = '';
                    
                    // Í∞ÄÏû• ÏµúÍ∑º outputÎßå ÌëúÏãú (ÎçÆÏñ¥Ïì∞Í∏∞ Î∞©Ïãù)
                    const latestEntry = cell.output_history[cell.output_history.length - 1];
                    const outputEntryDiv = document.createElement('div');
                    outputEntryDiv.className = 'cell-output-new';
                    outputEntryDiv.textContent = latestEntry.output;
                    outputEntryDiv.setAttribute('data-timestamp', latestEntry.timestamp);
                    outputEntryDiv.setAttribute('data-execution-count', latestEntry.execution_count);
                    outputDiv.appendChild(outputEntryDiv);
                }
            }
        }

        function handleKeyDown(event, cellId) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                runCell(cellId);
            } else if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                addCellAfter(cellId);
            } else if (event.key === 's' && event.ctrlKey) {
                event.preventDefault();
                saveNotebookToFile();
            }
        }

        // ÏÖÄ Ïã§Ìñâ ÌÅê Ï≤òÎ¶¨ Ìï®Ïàò
        function processCellQueue() {
            if (isExecuting) {
                return;
            }
            
            if (cellExecutionQueue.length === 0) {
                return;
            }
            
            isExecuting = true;
            const nextCell = cellExecutionQueue.shift();
            currentExecutingCell = nextCell;
            
            // Ïã§Ï†ú ÏÖÄ Ïã§Ìñâ
            executeCell(nextCell);
        }

        // Ïã§Ï†ú ÏÖÄ Ïã§Ìñâ Ìï®Ïàò
        function executeCell(cellId) {
            if (!activeFile) {
                alert('Ïã§ÌñâÌï† ÌååÏùºÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            // ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
            const fileName = activeFile.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                alert('Python ÌååÏùº(.py), Jupyter ÎÖ∏Ìä∏Î∂Å(.ipynb), NPN(.npn) ÌååÏùºÎßå ÏΩîÎìúÎ•º Ïã§ÌñâÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            if (!fileKernels[activeFile]) {
                alert('Ïª§ÎÑêÏù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïª§ÎÑêÏùÑ Ï¥àÍ∏∞ÌôîÌï¥Ï£ºÏÑ∏Ïöî.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) {
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                return;
            }

            const outputDiv = document.querySelector(`#output-${cell.id}`);
            const statusSpan = document.querySelector(`#status-${cell.id}`);
            const execSpan = document.querySelector(`#exec-${cell.id}`);

            // crawl ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            
            let code = '';
            
            if (isCrawlCell) {
                // crawl ÏÖÄÏùò Í≤ΩÏö∞ crawl_dataÏóêÏÑú ÏΩîÎìú ÏÉùÏÑ±
                if (!cell.crawl_data) {
                    alert('crawl ÏÖÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÏÖÄÏùÑ Îã§Ïãú ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                    return;
                }
                
                // name inputÏóêÏÑú job name Í∞ÄÏ†∏Ïò§Í∏∞
                const nameInput = document.getElementById(`cell-name-${cellId}`);
                const jobName = nameInput ? nameInput.value.trim() : `crawl_${cellId}`;
                
                // class_job import Î∞è job ÏÑ†Ïñ∏ ÏΩîÎìú ÏÉùÏÑ±
                code = generateCrawlCode(cell.crawl_data, jobName);
            } else {
                // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄÏùò Í≤ΩÏö∞ textareaÏóêÏÑú ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞
                const textarea = document.querySelector(`#${cellId} .cell-input`);
                code = textarea.value.trim();
                if (!code) {
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                    return;
                }
            }

            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ - Ïã§ÌñâÏ§ëÏúºÎ°ú Î≥ÄÍ≤Ω
            cell.status = 'running';
            statusSpan.textContent = 'Ïã§ÌñâÏ§ë...';
            statusSpan.className = 'cell-status running';
            outputDiv.style.display = 'block';
            
            // Í∏∞Ï°¥ output Î™®Îëê ÏßÄÏö∞Í≥† Ïã§ÌñâÏ§ë ÌëúÏãúÎßå Ï∂îÍ∞Ä
            outputDiv.innerHTML = '';
            const runningDiv = document.createElement('div');
            runningDiv.innerHTML = '<div class="spinner"></div> Ïã§ÌñâÏ§ë...';
            runningDiv.className = 'cell-output-running';
            outputDiv.appendChild(runningDiv);
            
            outputDiv.className = 'cell-output';

            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïùò Ïª§ÎÑêÏóê ÏΩîÎìú Ïã§Ìñâ ÏöîÏ≤≠
            const kernelId = fileKernels[activeFile];
            
            // crawl ÏÖÄÏùò Í≤ΩÏö∞ ÏÉùÏÑ±Îêú ÏΩîÎìúÎ•º ÏΩòÏÜîÏóê Ï∂úÎ†•
            if (isCrawlCell) {
                // ÏΩîÎìú Ïã§Ìñâ
            }
            
            fetch(`/api/kernels/${kernelId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cell.status = 'completed';
                    statusSpan.textContent = 'ÏôÑÎ£å';
                    statusSpan.className = 'cell-status completed';
                    outputDiv.className = 'cell-output success';
                    
                    // stdout/result/stderrÎ•º Í≤∞Ìï©ÌïòÏó¨ Ï∂úÎ†•
                    let output = '';
                    
                    console.log('=== ÎîîÎ≤ÑÍπÖ: Î∞±ÏóîÎìú ÏùëÎãµ ===');
                    console.log('data:', data);
                    console.log('data.result:', data.result);
                    console.log('data.result.stdout:', data.result?.stdout);
                    console.log('data.result.stderr:', data.result?.stderr);
                    
                    if (data.result && data.result.stdout && data.result.stdout.trim() !== '') {
                        output += data.result.stdout;
                        console.log('stdout Ï∂îÍ∞ÄÎê®:', data.result.stdout);
                    }
                    // resultÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Í≥† 'None'Ïù¥ ÏïÑÎãê ÎïåÎßå Ï∂îÍ∞Ä
                    if (data.result && typeof data.result.result === 'string' && data.result.result.trim() !== '' && data.result.result !== 'None') {
                        if (output) output += '\n';
                        output += data.result.result;
                        console.log('result Ï∂îÍ∞ÄÎê®:', data.result.result);
                    }
                    if (data.result && data.result.stderr && data.result.stderr.trim() !== '') {
                        if (output) output += '\n';
                        output += data.result.stderr;
                        console.log('stderr Ï∂îÍ∞ÄÎê®:', data.result.stderr);
                    }
                    
                    console.log('ÏµúÏ¢Ö output:', output);
                    

                    
                    // Ïã§ÌñâÏ§ë ÌëúÏãú Ï†úÍ±∞
                    const runningDiv = outputDiv.querySelector('.cell-output-running');
                    if (runningDiv) {
                        runningDiv.remove();
                    }
                    
                    // ÏÉàÎ°úÏö¥ output Ï∂îÍ∞Ä (Ïù¥Ï†Ñ output Ïú†ÏßÄ)
                    if (output && output.trim() !== '') {
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = output;
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ÏÖÄ Îç∞Ïù¥ÌÑ∞Ïóê output Ï†ÄÏû•
                        saveCellOutput(cellId, output);
                    } else if (!output || output.trim() === '') {
                        // outputÏù¥ ÏóÜÏúºÎ©¥ "Ïã§Ìñâ ÏôÑÎ£å" ÌëúÏãú
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = 'Ïã§Ìñâ ÏôÑÎ£å';
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ÏÖÄ Îç∞Ïù¥ÌÑ∞Ïóê output Ï†ÄÏû•
                        saveCellOutput(cellId, 'Ïã§Ìñâ ÏôÑÎ£å');
                    }
                    

                    execSpan.textContent = `[${data.execution_count || '?'}]`;
                } else {
                    cell.status = 'error';
                    statusSpan.textContent = 'Ïò§Î•ò';
                    statusSpan.className = 'cell-status error';
                    outputDiv.className = 'cell-output error';
                    
                    // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
                    let errorOutput = '';
                    if (data.error) {
                        errorOutput += data.error;
                    }
                    if (data.result && data.result.error) {
                        if (errorOutput) errorOutput += '\n';
                        errorOutput += data.result.error;
                    }
                    if (data.result && data.result.stderr) {
                        if (errorOutput) errorOutput += '\n';
                        errorOutput += data.result.stderr;
                    }
                    
                    // ÏÉàÎ°úÏö¥ output Ï∂îÍ∞Ä (Ïù¥Ï†Ñ output Ïú†ÏßÄ)
                    const newOutputDiv = document.createElement('div');
                    newOutputDiv.className = 'cell-output-new error';
                    newOutputDiv.textContent = errorOutput || 'Ïã§Ìñâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                    outputDiv.appendChild(newOutputDiv);
                    
                    // ÏÖÄ Îç∞Ïù¥ÌÑ∞Ïóê error output Ï†ÄÏû•
                    saveCellOutput(cellId, errorOutput || 'Ïã§Ìñâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                cell.status = 'error';
                statusSpan.textContent = 'Ïò§Î•ò';
                statusSpan.className = 'cell-status error';
                outputDiv.className = 'cell-output error';
                outputDiv.textContent = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                console.error('ÏÖÄ Ïã§Ìñâ Ïò§Î•ò:', error);
            })
            .finally(() => {
                // ÏÖÄ Ïã§Ìñâ ÏôÑÎ£å ÌõÑ ÌÅê ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî Î∞è Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
                isExecuting = false;
                currentExecutingCell = null;
                
                processCellQueue(); // Îã§Ïùå ÏÖÄ Ï≤òÎ¶¨
            });
        }

        // crawl ÏÖÄÏö© ÏΩîÎìú ÏÉùÏÑ± Ìï®Ïàò
        function generateCrawlCode(crawlData, jobName) {
            // Í∏∞Î≥∏ import ÏΩîÎìú
            let code = `import sys\n`;
            code += `import os\n`;
            code += `# ÌîÑÎ°úÏ†ùÌä∏ Î£®Ìä∏ Í≤ΩÎ°úÎ•º ÎèôÏ†ÅÏúºÎ°ú Ï∞æÍ∏∞\n`;
            code += `current_dir = os.getcwd()\n`;
            code += `# CLASSÎÇò MODULE Ìè¥ÎçîÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Í≤ΩÎ°ú ÏÑ§Ï†ï\n`;
            code += `if os.path.exists(os.path.join(current_dir, 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'MODULE'))\n`;
            code += `elif os.path.exists(os.path.join(current_dir, '..', 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'MODULE'))\n`;
            code += `else:\n`;
            code += `    print("CLASS/MODULE Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Í≤ΩÎ°úÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.")\n`;
            code += `    print(f"ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: {current_dir}")\n`;
            code += `from class_job import Job\n\n`;
            
            // shared_dict Ï¥àÍ∏∞Ìôî (Ïª§ÎÑêÏóêÏÑú Í≥µÏö©ÏúºÎ°ú ÏÇ¨Ïö©)
            code += `# Ïª§ÎÑê ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ÏóêÏÑú shared_dict ÏÇ¨Ïö©\n`;
            code += `if 'shared_dict' not in globals():\n`;
            code += `    globals()['shared_dict'] = {}\n`;
            code += `    print("Í≥µÏö© Îç∞Ïù¥ÌÑ∞ ÎîïÏÖîÎÑàÎ¶¨ Ï¥àÍ∏∞ÌôîÎê®")\n`;
            code += `shared_dict = globals()['shared_dict']\n\n`;
            
            // notebook Íµ¨Ï°∞Î•º class_job.py Íµ¨Ï°∞Î°ú Î≥ÄÌôò
            const args = convertToClassJobFormat(crawlData);
            
            // job ÏÑ†Ïñ∏
            code += `# ${jobName} - ${crawlData.job_type} ${crawlData.action}\n`;
            code += `job_name = "${jobName}"\n`;
            code += `print("üîç Original crawl_data:", ${JSON.stringify(crawlData, null, 4)})\n`;
            code += `print("üîç Converted args:", ${JSON.stringify(args, null, 4)})\n`;
            code += `job_args = ${JSON.stringify(args, null, 4)}\n\n`;
            
            // Job Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Ïã§Ìñâ
            code += `# Job Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Ïã§Ìñâ\n`;
            code += `try:\n`;
            code += `    job = Job(job_name, job_args, shared_dict)\n`;
            code += `    result = job.run()\n`;
            code += `    print(f"Job '{job_name}' Ïã§Ìñâ Í≤∞Í≥º: {result}")\n`;
            code += `    # job Í≤∞Í≥ºÎ•º shared_dictÏóê job nameÏùÑ ÌÇ§Î°ú Ï†ÄÏû•\n`;
            code += `    shared_dict[job_name] = result\n`;
            code += `    print(f"Job Í≤∞Í≥ºÍ∞Ä shared_dict['{job_name}']Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.")\n`;
            code += `    if hasattr(result, 'data') and result.data is not None:\n`;
            code += `        print(f"Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞: {result.data}")\n`;
            code += `    if hasattr(result, 'message') and result.message:\n`;
            code += `        print(f"Î©îÏãúÏßÄ: {result.message}")\n`;
            code += `except Exception as e:\n`;
            code += `    print(f"Job Ïã§Ìñâ Ï§ë Ïò§Î•ò Î∞úÏÉù: {str(e)}")\n`;
            code += `    import traceback\n`;
            code += `    traceback.print_exc()\n`;
            code += `\n`;
            code += `print("Job Ïã§Ìñâ ÏôÑÎ£å")\n`;
            
            return code;
        }

        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ÏÇ≠Ï†úÌï† ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }

            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò ÏÖÄÏùÄ Ïú†ÏßÄÌï¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }

            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;

            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            
            // ÏÖÄ Î≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateCellNumbers();
        }

        function updateCellNumbers() {
            cells.forEach((cell, index) => {
                const numberSpan = document.querySelector(`#${cell.id} .cell-number`);
                if (numberSpan) {
                    numberSpan.textContent = `In [${index + 1}]:`;
                }
            });
        }

        function runAllCells() {
            cells.forEach(cell => {
                if (cell.content.trim()) {
                    setTimeout(() => runCell(cell.id), 100);
                }
            });
        }

        function clearAllOutputs() {
            cells.forEach(cell => {
                const outputDiv = document.querySelector(`#output-${cell.id}`);
                if (outputDiv) {
                    outputDiv.style.display = 'none';
                    outputDiv.textContent = '';
                }
                const statusSpan = document.querySelector(`#status-${cell.id}`);
                if (statusSpan) {
                    statusSpan.textContent = 'ÎåÄÍ∏∞Ï§ë';
                    statusSpan.className = 'cell-status';
                }
                const execSpan = document.querySelector(`#exec-${cell.id}`);
                if (execSpan) {
                    execSpan.textContent = '';
                }
            });
        }

        function clearAllCells() {
            if (!confirm('Î™®Îì† ÏÖÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            cells = [];
            document.getElementById('notebookCells').innerHTML = '';
            cellCounter = 0;
            addCell();
        }

        function checkKernelStatus() {
            // Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ ÌôúÏÑ±Ìôî
            
            if (!activeFile || !fileKernels[activeFile]) {
                const statusElement = document.getElementById('kernelStatusText');
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (statusElement) {
                    statusElement.textContent = 'Ïª§ÎÑê ÏóÜÏùå';
                }
                if (displayElement) {
                    displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: ÎπÑÌôúÏÑ±';
                    displayElement.style.color = '#a0aec0';
                }
                return;
            }

            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);

            
            fetch(`/api/kernels/${kernelIdStr}/status`)
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (data.success) {
                        let statusText = '';
                        let displayText = '';
                        let statusColor = '#a0aec0';
                        
                        // statusÍ∞Ä Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ status ÏÜçÏÑ±Ïóê Ï†ëÍ∑º
                        const status = data.status && typeof data.status === 'object' ? data.status.status : data.status;
                        
                        if (status === 'idle' || status === 'ready') {
                            statusText = 'Ï§ÄÎπÑÎê®';
                            displayText = 'Ïª§ÎÑê ÏÉÅÌÉú: ÌôúÏÑ±';
                            statusColor = '#68d391';
                        } else if (status === 'busy') {
                            statusText = 'Ïã§ÌñâÏ§ë';
                            displayText = 'Ïª§ÎÑê ÏÉÅÌÉú: Ïã§ÌñâÏ§ë';
                            statusColor = '#f6ad55';
                        } else {
                            statusText = status || 'Ïïå Ïàò ÏóÜÏùå';
                            displayText = `Ïª§ÎÑê ÏÉÅÌÉú: ${status || 'Ïïå Ïàò ÏóÜÏùå'}`;
                            statusColor = '#fc8181';
                        }
                        
                        if (statusElement) {
                            statusElement.textContent = statusText;
                        }
                        if (displayElement) {
                            displayElement.textContent = displayText;
                            displayElement.style.color = statusColor;
                        }
                    } else {
                        if (statusElement) {
                            statusElement.textContent = 'Ïò§Î•ò';
                        }
                        if (displayElement) {
                            displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: Ïò§Î•ò';
                            displayElement.style.color = '#fc8181';
                        }
                    }
                })
                .catch(error => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (statusElement) {
                        statusElement.textContent = 'Ïó∞Í≤∞ Ïã§Ìå®';
                    }
                    if (displayElement) {
                        displayElement.textContent = 'Ïª§ÎÑê ÏÉÅÌÉú: Ïó∞Í≤∞ Ïã§Ìå®';
                        displayElement.style.color = '#fc8181';
                    }
                    console.error('Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®:', error);
                });
        }

        function saveNotebookToFile() {
            if (!activeFile) {
                alert('Ï†ÄÏû•Ìï† ÌååÏùºÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Ï†ÄÏû•ÌïòÍ∏∞ Ï†ÑÏóê Î™®Îì† input Í∞íÎì§ÏùÑ Î©îÎ™®Î¶¨Ïóê ÎèôÍ∏∞Ìôî
            syncCellContentsToMemory();

            // ÌòÑÏû¨ ÎÖ∏Ìä∏Î∂ÅÏùò Î™®Îì† ÏÖÄ ÎÇ¥Ïö©ÏùÑ ÏàòÏßë
            const cells = fileCells[activeFile] || [];
            
            if (!Array.isArray(cells) || cells.length === 0) {
                alert('Ï†ÄÏû•Ìï† ÏÖÄÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const notebookContent = [];
            
            cells.forEach(cell => {
                let content = '';
                
                // crawl ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                if (isCrawlCell) {
                    // crawl ÏÖÄÏùò Í≤ΩÏö∞ JSON Î™®Îìú ÎòêÎäî combobox UI Î™®Îìú ÌôïÏù∏
                    const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked; // ÌÜ†Í∏Ä Ïä§ÏúÑÏπò ÏÉÅÌÉúÎ°ú ÌåêÎã®
                    const cellType = isJsonMode ? 'crawl_json' : 'crawl_ui';
                    
                    if (isJsonMode) {
                        // JSON Î™®Îìú: xml-content textareaÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                        content = jsonTextarea.value;
                    } else {
                        // Combobox UI Î™®Îìú: ÌòÑÏû¨ ÏÑ§Ï†ïÎêú Í∞íÎì§ÏùÑ JSONÏúºÎ°ú Î≥ÄÌôò
                        let crawlData = null;
                        
                        // 1. crawl_dataÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö©
                        if (cell.crawl_data) {
                            crawlData = cell.crawl_data;
                        } else {
                            // 2. UI ÏöîÏÜåÏóêÏÑú Í∞íÏùÑ Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÎèÑ
                            const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                            const actionSelect = document.querySelector(`#${cell.id} .crawl-action`);
                            
                            if (jobTypeSelect && actionSelect) {
                                crawlData = {
                                    job_type: jobTypeSelect.value || 'do',
                                    action: actionSelect.value || '',
                                    params: {}
                                };
                                
                                // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ ÏàòÏßë (focus Ï†úÏô∏, Î≥ÑÎèÑ Ï≤òÎ¶¨ - saveNotebook)
                                const paramInputs = document.querySelectorAll(`#crawl-params-${cell.id} input[name], #crawl-params-${cell.id} select[name]`);
                                
                                paramInputs.forEach(input => {
                                    // focus Í¥ÄÎ†® ÌïÑÎìúÎäî Î≥ÑÎèÑ Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ï†úÏô∏
                                    if (input.name && !input.name.includes('focus') && input.value) {
                                        // Ïà´Ïûê ÌÉÄÏûÖ ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
                                        const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'time', 'key_count', 'arg_count'];
                                        if (numberParams.includes(input.name)) {
                                            const numValue = parseFloat(input.value);
                                            if (!isNaN(numValue)) {
                                                crawlData.params[input.name] = numValue;
                                            }
                                        } else {
                                            crawlData.params[input.name] = input.value;
                                        }
                                    }
                                });
                                
                                // focus ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨ (Ïò¨Î∞îÎ•∏ DOM Íµ¨Ï°∞ ÏÇ¨Ïö© - saveNotebook)
                                const focusTypeSelect = document.querySelector(`#crawl-params-${cell.id} select[name="focus_type"]`);
                                const focusXpathInput = document.querySelector(`#crawl-params-${cell.id} input[name="focus_xpath"]`);
                                
                                if (focusTypeSelect && focusXpathInput) {
                                    const focusType = focusTypeSelect.value;
                                    const focusValue = focusXpathInput.value;
                                    
                                    if (focusType === 'current') {
                                        crawlData.params.focus = 'current';
                                    } else if (focusValue) {
                                        crawlData.params.focus = { [focusType]: focusValue };
                                    } else if (focusType && focusType !== 'current') {
                                        crawlData.params.focus = { [focusType]: "" };
                                    }
                                }
                            }
                        }
                        
                        if (crawlData) {
                            // Ï†ÄÏû• Ïãú focus ÌååÎùºÎØ∏ÌÑ∞ Î≥ÄÌôò
                            if (crawlData.params && crawlData.params.focus && typeof crawlData.params.focus === 'string') {
                                try {
                                    crawlData.params.focus = JSON.parse(crawlData.params.focus);
                                } catch(e) {
                                    // ÌååÏã± Ïã§Ìå®Ïãú Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
                                }
                            }
                            content = JSON.stringify(crawlData, null, 2);
                        } else {
                            // 3. Î™®Îì† Î∞©Î≤ïÏù¥ Ïã§Ìå®ÌïòÎ©¥ Í∏∞Ï°¥ content ÏÇ¨Ïö©
                            content = cell.content || '';
                        }
                    }
                } else {
                    // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄ: cell-input textareaÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content;
                }
                
                // contentÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                if (typeof content !== 'string') {
                    content = String(content);
                }
                
                if (content.trim() !== '') {
                    if (isCrawlCell) {
                        function splitJsonObjects(jsonStr) {
                            const objects = [];
                            let current = '';
                            let braceCount = 0;
                            let inString = false;
                            let escapeNext = false;
                            for (let i = 0; i < jsonStr.length; i++) {
                                const char = jsonStr[i];
                                if (escapeNext) { current += char; escapeNext = false; continue; }
                                if (char === '\\') { escapeNext = true; current += char; continue; }
                                if (char === '"' && !escapeNext) { inString = !inString; }
                                if (!inString) {
                                    if (char === '{') { if (braceCount === 0) { current = char; } else { current += char; } braceCount++; }
                                    else if (char === '}') { current += char; braceCount--; if (braceCount === 0) { const trimmed = current.trim(); if (trimmed) { objects.push(trimmed); } current = ''; } }
                                    else { if (braceCount > 0) { current += char; } }
                                } else { current += char; }
                            }
                            return objects;
                        }
                        const jsonObjects = splitJsonObjects(content);
                        
                        // JSON Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
                        const xmlToggle2 = document.getElementById(`xml-toggle-${cell.id}`);
                        const isJsonMode2 = xmlToggle2 && xmlToggle2.checked; // ÌÜ†Í∏Ä Ïä§ÏúÑÏπò ÏÉÅÌÉúÎ°ú ÌåêÎã®
                        const cellType = isJsonMode2 ? 'crawl_json' : 'crawl_ui';
                        
                        if (jsonObjects.length > 1) {
                            jsonObjects.forEach((jsonStr, index) => {
                                try {
                                    JSON.parse(jsonStr);
                                    const cellData = { 
                                        cell_type: cellType, 
                                        content: jsonStr, 
                                        metadata: { name: cell.name || '' }, // ÏÖÄ Ïù¥Î¶Ñ Ï†ÄÏû•
                                        output_history: cell.output_history || []
                                    };
                                    notebookContent.push(cellData);
    
                                } catch (parseError) { 
                                    console.error(`Crawl ÏÖÄ ${cell.id} Î∂ÑÌï† ${index + 1} ÌååÏã± Ïã§Ìå®:`, parseError);
                                }
                            });
                        } else {
                            const cellData = { 
                                cell_type: cellType, 
                                content: content, 
                                metadata: { name: cell.name || '' }, // ÏÖÄ Ïù¥Î¶Ñ Ï†ÄÏû•
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            // console.log(`Crawl ÏÖÄ ${cell.id} Îã®Ïùº Í∞ùÏ≤¥Î°ú Ï∂îÍ∞ÄÎê® (ÌÉÄÏûÖ: ${cellType}, name: ${cell.name}, output_history: ${cell.output_history ? cell.output_history.length : 0}Í∞ú)`);
                        }
                                            } else {
                            // output_historyÎèÑ Ìï®Íªò Ï†ÄÏû•
                            const cellData = { 
                                cell_type: 'code', 
                                content: content, 
                                metadata: { name: cell.name || '' }, // ÏÖÄ Ïù¥Î¶Ñ Ï†ÄÏû•
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            // console.log(`ÏΩîÎìú ÏÖÄ ${cell.id} Ï∂îÍ∞ÄÎê® (output_history: ${cell.output_history ? cell.output_history.length : 0}Í∞ú)`);
                        }
                } else {
                    
                }
            });
            // ÎîîÎ≤ÑÍπÖ: Î∂ÑÌï†Îêú notebookContent Ï∂úÎ†•


            if (notebookContent.length === 0) {
                alert('Ï†ÄÏû•Ìï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // ÌååÏùº ÌôïÏû•ÏûêÏóê Îî∞Îùº Ï†ÄÏû• ÌòïÏãù Í≤∞Ï†ï
            const fileName = activeFile.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();

            let contentToSave = '';
            if (fileExtension === 'ipynb') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        execution_count: null, 
                        metadata: item.metadata, 
                        outputs: item.output_history ? item.output_history.map(entry => ({
                            output_type: "stream",
                            name: "stdout",
                            text: entry.output
                        })) : [], 
                        source: item.content
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else if (fileExtension === 'npn') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        metadata: item.metadata, 
                        source: item.content,
                        output_history: item.output_history || []
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else {
                contentToSave = notebookContent.map(item => item.content).join('\n\n');
            }
            // ÎîîÎ≤ÑÍπÖ: Ï†ÄÏû• ÏßÅÏ†Ñ contentToSave Ï∂úÎ†•


            // ÌååÏùº Ï†ÄÏû• API Ìò∏Ï∂ú
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ path: activeFile, content: contentToSave })
            })
            .then(response => response.json())
            .then(data => {
                // ÎîîÎ≤ÑÍπÖ: Ï†ÄÏû• API ÏùëÎãµ Ï∂úÎ†•
    
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ÎÖ∏Ìä∏Î∂ÅÏù¥ "${fileName}"Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // Ï†ÄÏû• ÌõÑ ÏûêÎèô reload Ï†úÍ±∞
                    // checkFileUpdatedAndReload(activeFile, contentToSave);
                    
                } else {
                    alert(data.message || 'ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('ÌååÏùº Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        // Python Î≥ÄÌôò Ï†ÄÏû• Ìï®Ïàò
        function saveAsPython() {
            if (!activeFile) {
                alert('Ï†ÄÏû•Ìï† ÌååÏùºÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÌòÑÏû¨ ÎÖ∏Ìä∏Î∂ÅÏùò Î™®Îì† ÏÖÄ ÎÇ¥Ïö©ÏùÑ ÏàòÏßë
            const cells = fileCells[activeFile] || [];
            
            if (!Array.isArray(cells) || cells.length === 0) {
                alert('Ï†ÄÏû•Ìï† ÏÖÄÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // Python ÏΩîÎìúÎ°ú Î≥ÄÌôò
            let pythonCode = '';
            
            // shared_dict Ï¥àÍ∏∞Ìôî Ï∂îÍ∞Ä
            pythonCode += '# -*- coding: utf-8 -*-\n';
            pythonCode += '# Paramita AIÏóêÏÑú Î≥ÄÌôòÎêú Python ÏΩîÎìú\n\n';
            pythonCode += '# Í≤ΩÎ°ú ÏÑ§Ï†ï Î∞è class_job import\n';
            pythonCode += 'import os\n';
            pythonCode += 'import sys\n';
            pythonCode += 'current_dir = os.getcwd()\n';
            pythonCode += 'if os.path.exists(os.path.join(current_dir, \'CLASS\')):\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'CLASS\'))\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'MODULE\'))\n';
            pythonCode += 'elif os.path.exists(os.path.join(current_dir, \'..\', \'CLASS\')):\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'..\', \'CLASS\'))\n';
            pythonCode += '    sys.path.append(os.path.join(current_dir, \'..\', \'MODULE\'))\n';
            pythonCode += 'else:\n';
            pythonCode += '    print("CLASS/MODULE Ìè¥ÎçîÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Í≤ΩÎ°úÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.")\n';
            pythonCode += '    print(f"ÌòÑÏû¨ ÎîîÎ†âÌÜ†Î¶¨: {current_dir}")\n';
            pythonCode += 'from class_job import Job\n\n';
            pythonCode += '# shared_dict Ï¥àÍ∏∞Ìôî\n';
            pythonCode += 'if \'shared_dict\' not in globals():\n';
            pythonCode += '    globals()[\'shared_dict\'] = {}\n';
            pythonCode += '    print("Í≥µÏö© Îç∞Ïù¥ÌÑ∞ ÎîïÏÖîÎÑàÎ¶¨ Ï¥àÍ∏∞ÌôîÎê®")\n';
            pythonCode += 'shared_dict = globals()[\'shared_dict\']\n\n';
            
            cells.forEach((cell, index) => {
                let content = '';
                
                // crawl ÏÖÄÏù∏ÏßÄ ÌôïÏù∏
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                if (isCrawlCell) {
                    // crawl ÏÖÄÏùò Í≤ΩÏö∞ JSON Î™®Îìú ÎòêÎäî combobox UI Î™®Îìú ÌôïÏù∏
                    const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked;
                    
                    if (isJsonMode) {
                        // JSON Î™®Îìú: xml-content textareaÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                        content = jsonTextarea.value;
                    } else {
                        // Combobox UI Î™®Îìú: ÌòÑÏû¨ ÏÑ§Ï†ïÎêú Í∞íÎì§ÏùÑ JSONÏúºÎ°ú Î≥ÄÌôò
                        let crawlData = null;
                        
                        if (cell.crawl_data) {
                            crawlData = cell.crawl_data;
                        } else {
                            // UI ÏöîÏÜåÏóêÏÑú Í∞íÏùÑ Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÎèÑ
                            const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                            const actionSelect = document.querySelector(`#${cell.id} .crawl-action`);
                            
                            if (jobTypeSelect && actionSelect) {
                                crawlData = {
                                    job_type: jobTypeSelect.value || 'do',
                                    action: actionSelect.value || '',
                                    params: {}
                                };
                                
                                // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ ÏàòÏßë (focus Ï†úÏô∏, Î≥ÑÎèÑ Ï≤òÎ¶¨ - saveAsPython)
                                const paramInputs = document.querySelectorAll(`#crawl-params-${cell.id} input[name], #crawl-params-${cell.id} select[name]`);
                                
                                paramInputs.forEach(input => {
                                    // focus Í¥ÄÎ†® ÌïÑÎìúÎäî Î≥ÑÎèÑ Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ï†úÏô∏
                                    if (input.name && !input.name.includes('focus') && input.value) {
                                        // Ïà´Ïûê ÌÉÄÏûÖ ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
                                        const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'time', 'key_count', 'arg_count'];
                                        if (numberParams.includes(input.name)) {
                                            const numValue = parseFloat(input.value);
                                            if (!isNaN(numValue)) {
                                                crawlData.params[input.name] = numValue;
                                            }
                                        } else {
                                            crawlData.params[input.name] = input.value;
                                        }
                                    }
                                });
                                
                                // focus ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨ (Ïò¨Î∞îÎ•∏ DOM Íµ¨Ï°∞ ÏÇ¨Ïö© - saveAsPython)
                                const focusTypeSelect = document.querySelector(`#crawl-params-${cell.id} select[name="focus_type"]`);
                                const focusXpathInput = document.querySelector(`#crawl-params-${cell.id} input[name="focus_xpath"]`);
                                
                                if (focusTypeSelect && focusXpathInput) {
                                    const focusType = focusTypeSelect.value;
                                    const focusValue = focusXpathInput.value;
                                    
                                    if (focusType === 'current') {
                                        crawlData.params.focus = 'current';
                                    } else if (focusValue) {
                                        crawlData.params.focus = { [focusType]: focusValue };
                                    } else if (focusType && focusType !== 'current') {
                                        crawlData.params.focus = { [focusType]: "" };
                                    }
                                }
                            }
                        }
                        
                        if (crawlData) {
                            // Ï†ÄÏû• Ïãú focus ÌååÎùºÎØ∏ÌÑ∞ Î≥ÄÌôò
                            if (crawlData.params && crawlData.params.focus && typeof crawlData.params.focus === 'string') {
                                try {
                                    crawlData.params.focus = JSON.parse(crawlData.params.focus);
                                } catch(e) {
                                    // ÌååÏã± Ïã§Ìå®Ïãú Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
                                }
                            }
                            content = JSON.stringify(crawlData, null, 2);
                        } else {
                            content = cell.content || '';
                        }
                    }
                    
                    // crawl ÏÖÄÏùÑ Python ÏΩîÎìúÎ°ú Î≥ÄÌôò
                    if (content.trim() !== '') {
                        try {
                            const crawlData = JSON.parse(content);
                            pythonCode += `# ÏÖÄ ${index + 1}${cell.name ? ` - ${cell.name}` : ''}\n`;
                            pythonCode += `print("=== ÏÖÄ ${index + 1}${cell.name ? ` - ${cell.name}` : ''} Ïã§Ìñâ ===\\n")\n\n`;
                            
                            // job_name ÏÉùÏÑ± (ÏÖÄ Ïù¥Î¶ÑÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í)
                            const jobName = cell.name || `job_${index + 1}`;
                            
                            // notebook Íµ¨Ï°∞Î•º class_job.py Íµ¨Ï°∞Î°ú Î≥ÄÌôò
                            const args = convertToClassJobFormat(crawlData);
                            
                            // Job Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Ïã§Ìñâ ÏΩîÎìú ÏÉùÏÑ±
                            pythonCode += `# ${jobName} - ${crawlData.job_type} ${crawlData.action}\n`;
                            pythonCode += `job_name = "${jobName}"\n`;
                            pythonCode += `job_args = ${JSON.stringify(args, null, 4)}\n\n`;
                            pythonCode += `# Job Í∞ùÏ≤¥ ÏÉùÏÑ± Î∞è Ïã§Ìñâ\n`;
                            pythonCode += `try:\n`;
                            pythonCode += `    job = Job(job_name, job_args, shared_dict)\n`;
                            pythonCode += `    result = job.run()\n`;
                            pythonCode += `    print(f"Job '{job_name}' Ïã§Ìñâ Í≤∞Í≥º: {result}")\n`;
                            pythonCode += `    # job Í≤∞Í≥ºÎ•º shared_dictÏóê job nameÏùÑ ÌÇ§Î°ú Ï†ÄÏû•\n`;
                            pythonCode += `    shared_dict[job_name] = result\n`;
                            pythonCode += `    print(f"Job Í≤∞Í≥ºÍ∞Ä shared_dict['{job_name}']Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.")\n`;
                            pythonCode += `    if hasattr(result, 'data') and result.data is not None:\n`;
                            pythonCode += `        print(f"Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞: {result.data}")\n`;
                            pythonCode += `    if hasattr(result, 'message') and result.message:\n`;
                            pythonCode += `        print(f"Î©îÏãúÏßÄ: {result.message}")\n`;
                            pythonCode += `except Exception as e:\n`;
                            pythonCode += `    print(f"Job Ïã§Ìñâ Ï§ë Ïò§Î•ò Î∞úÏÉù: {str(e)}")\n`;
                            pythonCode += `    import traceback\n`;
                            pythonCode += `    traceback.print_exc()\n`;
                            pythonCode += `\n`;
                            pythonCode += `print("Job Ïã§Ìñâ ÏôÑÎ£å")\n\n`;
                            
                        } catch (parseError) {
                            console.error(`Crawl ÏÖÄ ${cell.id} JSON ÌååÏã± Ïã§Ìå®:`, parseError);
                            pythonCode += `# ÏÖÄ ${index + 1} - ÌååÏã± Ïã§Ìå®\n`;
                            pythonCode += `print("ÏÖÄ ${index + 1} ÌååÏã± Ïã§Ìå®")\n\n`;
                        }
                    }
                    
                } else {
                    // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄ: cell-input textareaÏóêÏÑú ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content;
                    
                    if (content.trim() !== '') {
                        pythonCode += `# ÏÖÄ ${index + 1}${cell.name ? ` - ${cell.name}` : ''}\n`;
                        pythonCode += `print("=== ÏÖÄ ${index + 1}${cell.name ? ` - ${cell.name}` : ''} Ïã§Ìñâ ===\\n")\n\n`;
                        pythonCode += content + '\n\n';
                    }
                }
            });
            
            if (pythonCode.trim() === '') {
                alert('Î≥ÄÌôòÌï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Python ÌååÏùºÎ™Ö ÏÉùÏÑ±
            const fileName = activeFile.split('/').pop();
            const baseName = fileName.split('.')[0];
            const pythonFileName = baseName + '.py';
            const pythonFilePath = activeFile.replace(fileName, pythonFileName);

            // Python ÌååÏùº Ï†ÄÏû• API Ìò∏Ï∂ú
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ path: pythonFilePath, content: pythonCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `Python ÏΩîÎìúÍ∞Ä "${pythonFileName}"Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                } else {
                    alert(data.message || 'Python ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Python ÌååÏùº Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Python ÌååÏùº Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        // Ïª§ÎÑê Í¥ÄÎ†® Ìï®ÏàòÎì§ÏùÄ kernel_manager.htmlÏóêÏÑú Ï≤òÎ¶¨Îê®

        // Ïª§ÎÑê Í¥ÄÎ†® Ìï®ÏàòÎì§ÏùÄ kernel_manager.htmlÏóêÏÑú Ï≤òÎ¶¨Îê®

        // ÌååÏùº Î∏åÎùºÏö∞Ï†Ä Í¥ÄÎ†® Ìï®ÏàòÎì§ÏùÄ file_browser.htmlÏóêÏÑú Ï≤òÎ¶¨Îê®

        function switchSidebarTab(panelId) {
            console.log('ÌÉ≠ Ï†ÑÌôò ÏãúÎèÑ:', panelId);
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠ ÌôïÏù∏
            const currentActiveTab = document.querySelector('.sidebar-tab.active');
            const currentActivePanel = document.querySelector('.sidebar-panel.active');
            
            // ÌÅ¥Î¶≠Îêú ÌÉ≠ Ïù∏Îç±Ïä§
            const clickedTabIndex = panelId === 'fileTreePanel' ? 0 : 1;
            const clickedTab = document.querySelectorAll('.sidebar-tab')[clickedTabIndex];
            
            // Í∞ôÏùÄ ÌÉ≠ÏùÑ Îã§Ïãú ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ (ÌÜ†Í∏Ä)
            if (currentActivePanel && currentActivePanel.id === panelId) {
                console.log('Í∞ôÏùÄ ÌÉ≠ ÌÅ¥Î¶≠ - Ìå®ÎÑê ÌÜ†Í∏Ä');
                
                // Ìå®ÎÑêÏù¥ Ï†ëÌòÄÏûàÎäîÏßÄ ÌôïÏù∏
                const sidebar = document.querySelector('.file-browser-sidebar');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Ï†ëÌûå ÏÉÅÌÉúÏóêÏÑú ÌéºÏπòÍ∏∞
                    sidebar.classList.remove('collapsed');
                    console.log('Ìå®ÎÑê ÌéºÏπ®');
                } else {
                    // ÌéºÏ≥êÏßÑ ÏÉÅÌÉúÏóêÏÑú Ï†ëÍ∏∞
                    sidebar.classList.add('collapsed');
                    console.log('Ìå®ÎÑê Ï†ëÏùå');
                }
                return;
            }
            
            // Îã§Î•∏ ÌÉ≠ÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ (Í∏∞Ï°¥ Î°úÏßÅ)
            console.log('Îã§Î•∏ ÌÉ≠ ÌÅ¥Î¶≠ - ÌÉ≠ Ï†ÑÌôò');
            
            // Ìå®ÎÑêÏù¥ Ï†ëÌòÄÏûàÎã§Î©¥ ÌéºÏπòÍ∏∞
            const sidebar = document.querySelector('.file-browser-sidebar');
            sidebar.classList.remove('collapsed');
            
            // Î™®Îì† ÌÉ≠Í≥º Ìå®ÎÑê ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
                console.log('ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî:', tab);
            });
            
            document.querySelectorAll('.sidebar-panel').forEach(panel => {
                panel.classList.remove('active');
                console.log('Ìå®ÎÑê ÎπÑÌôúÏÑ±Ìôî:', panel.id);
            });
            
            // ÌÅ¥Î¶≠Îêú ÌÉ≠ ÌôúÏÑ±Ìôî
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('ÌÉ≠ ÌôúÏÑ±Ìôî:', panelId);
            }
            
            // Ìï¥Îãπ Ìå®ÎÑê ÌôúÏÑ±Ìôî
            const targetPanel = document.getElementById(panelId);
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Ìå®ÎÑê ÌôúÏÑ±Ìôî:', panelId);
                
                // Ïª§ÎÑê Ìå®ÎÑêÏù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                if (panelId === 'kernelPanel') {
                    updateKernelInfo();
                }
            }
        }

        // Ïª§ÎÑê Í¥ÄÎ†® Ìï®ÏàòÎì§ÏùÄ kernel_manager.htmlÏóêÏÑú Ï≤òÎ¶¨Îê®

        // Ïª§ÎÑê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateKernelInfo() {
            // ÌòÑÏû¨ ÌôúÏÑ± ÌååÏùºÏùò Ïª§ÎÑê Ï†ïÎ≥¥ ÌëúÏãú
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                const fileName = activeFile.split('/').pop();
                
                document.getElementById('currentKernelInfo').textContent = 
                    `Ïª§ÎÑê: ${kernelIdStr} | ÌååÏùº: ${fileName}`;
            } else {
                document.getElementById('currentKernelInfo').textContent = 'Ïª§ÎÑê: ÏóÜÏùå';
            }
        }

        // Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Í¥ÄÎ†® Ìï®ÏàòÎì§
        let kernelTimeInterval = null;

        function updateKernelTimeDisplay(kernelId) {
            // ÏÑúÎ≤ÑÏóêÏÑú Ìïú Î≤àÎßå ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            fetch(`/api/kernels/${kernelId}/remaining-time`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.remaining_time) {
                        const remaining = data.remaining_time;
                        const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                        
                        if (remaining.expired) {
                            timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ÎßåÎ£åÎê®';
                            timeDisplayElement.style.background = '#e53e3e';
                            timeDisplayElement.style.color = '#ffffff';
                        } else {
                            const hours = remaining.remaining_hours;
                            const minutes = remaining.remaining_minutes;
                            const seconds = remaining.remaining_seconds_only;
                            
                            timeDisplayElement.textContent = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            // ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e'; // Îπ®Í∞ÑÏÉâ
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e'; // Ï£ºÌô©ÏÉâ
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748'; // Í∏∞Î≥∏ÏÉâ
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: Ïò§Î•ò';
                    timeDisplayElement.style.background = '#e53e3e';
                    timeDisplayElement.style.color = '#ffffff';
                });
        }

        function startKernelTimeUpdate() {
            // Í∏∞Ï°¥ Ïù∏ÌÑ∞Î≤å Ï†ïÎ¶¨
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
            }
            
            // Î®ºÏ†Ä ÏÑúÎ≤ÑÏóêÏÑú ÌòÑÏû¨ ÏãúÍ∞ÑÏ†úÌïú Ï†ïÎ≥¥Î•º Ìïú Î≤àÎßå Í∞ÄÏ†∏Ïò§Í∏∞
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                updateKernelTimeDisplay(kernelIdStr);
            }
            
            // Í∑∏ ÌõÑÏóêÎäî ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú 1Ï¥àÏî© Ï§ÑÏù¥Í∏∞
            kernelTimeInterval = setInterval(() => {
                if (activeFile && fileKernels[activeFile]) {
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    const currentText = timeDisplayElement.textContent;
                    
                    if (currentText.includes(':')) {
                        const timeParts = currentText.split(':');
                        
                        if (timeParts.length >= 3) {
                            // ÏãúÍ∞Ñ ÌååÌä∏Í∞Ä 4Í∞úÏù∏ Í≤ΩÏö∞: ['ÎÇ®ÏùÄ ÏãúÍ∞Ñ', ' 11', '58', '42']
                            // ÏãúÍ∞Ñ ÌååÌä∏Í∞Ä 3Í∞úÏù∏ Í≤ΩÏö∞: ['11', '58', '42']
                            let hours, minutes, seconds;
                            
                            if (timeParts.length === 4) {
                                // 4Í∞ú ÌååÌä∏Ïù∏ Í≤ΩÏö∞: ['ÎÇ®ÏùÄ ÏãúÍ∞Ñ', ' 11', '58', '42']
                                hours = parseInt(timeParts[1].trim());
                                minutes = parseInt(timeParts[2]);
                                seconds = parseInt(timeParts[3]);
                            } else {
                                // 3Í∞ú ÌååÌä∏Ïù∏ Í≤ΩÏö∞: ['11', '58', '42']
                                hours = parseInt(timeParts[0].replace('ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ', ''));
                                minutes = parseInt(timeParts[1]);
                                seconds = parseInt(timeParts[2]);
                            }
                            
                            // NaN Ï≤¥ÌÅ¨
                            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                                const kernelId = fileKernels[activeFile];
                                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                                updateKernelTimeDisplay(kernelIdStr);
                                return;
                            }
                            
                            seconds--;
                            if (seconds < 0) {
                                seconds = 59;
                                minutes--;
                                if (minutes < 0) {
                                    minutes = 59;
                                    hours--;
                                    if (hours < 0) {
                                        // ÏãúÍ∞Ñ ÎßåÎ£å
                                        timeDisplayElement.textContent = 'ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ÎßåÎ£åÎê®';
                                        timeDisplayElement.style.background = '#e53e3e';
                                        timeDisplayElement.style.color = '#ffffff';
                                        return;
                                    }
                                }
                            }
                            
                            const newText = `ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            timeDisplayElement.textContent = newText;
                            
                            // ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748';
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                }
            }, 1000);
        }

        function stopKernelTimeUpdate() {
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
                kernelTimeInterval = null;
            }
        }

        function extendKernelTimeout() {
            if (!activeFile || !fileKernels[activeFile]) {
                alert('ÌôúÏÑ± Ïª§ÎÑêÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            fetch(`/api/kernels/${kernelIdStr}/extend-timeout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    additional_hours: 12
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = 'Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïúÏù¥ 12ÏãúÍ∞Ñ Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§.';
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû• ÌõÑ ÏÑúÎ≤ÑÏóêÏÑú ÏÉàÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞
                    updateKernelTimeDisplay(kernelIdStr);
                } else {
                    alert(data.error || 'Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû• Ïã§Ìå®:', error);
                alert('Ïª§ÎÑê ÏãúÍ∞ÑÏ†úÌïú Ïó∞Ïû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }

        // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Ïª§ÎÑê ÏÉÅÌÉú ÌôïÏù∏
        setInterval(checkKernelStatus, 10000);

        // ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú crawl ÏÖÄ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initializeCrawlCellOptimized(cellId, content, isJsonMode) {
            try {
                let crawlData;
                
                // content ÌååÏã± (Í∏∞Ï°¥Í≥º ÎèôÏùº)
                if (typeof content === 'object' && content !== null) {
                    crawlData = content;
                } else {
                    let contentStr = content;
                    if (typeof content !== 'string') {
                        contentStr = String(content);
                    }
                    
                    if (!contentStr || contentStr === '[object Object]' || contentStr.trim() === '') {
                        crawlData = { job_type: 'do', action: 'click', params: {} };
                    } else {
                        crawlData = JSON.parse(contentStr);
                    }
                }
                
                // Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
                crawlData = addDefaultParams(crawlData);
                
                const cell = fileCells[activeFile].find(c => c.id === cellId);
                if (cell) {
                    cell.crawl_data = crawlData;
                }
                
                // UI Ï¶âÏãú ÏÑ§Ï†ï (setTimeout Ï†úÍ±∞)
                const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
                if (jobTypeSelect) {
                    jobTypeSelect.value = crawlData.job_type || 'do';
                    updateCrawlActionsOptimized(cellId, crawlData.job_type || 'do');
                    
                    // Action ÏÑ§Ï†ï
                    const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                    if (actionSelect && crawlData.action) {
                        actionSelect.value = crawlData.action;
                        renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                        
                        // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ Î≥µÏõê
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                if (paramName === 'focus') {
                                    // focus ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
                                    const focusData = crawlData.params[paramName];
                                    const focusTypeSelect = document.querySelector(`#${cellId} select[name="focus_type"]`);
                                    const focusXpathInput = document.querySelector(`#${cellId} input[name="focus_xpath"]`);
                                    
                                    if (focusTypeSelect && focusXpathInput) {
                                        if (focusData === 'current') {
                                            focusTypeSelect.value = 'current';
                                            focusXpathInput.style.display = 'none';
                                            focusXpathInput.value = '';
                                        } else if (typeof focusData === 'object') {
                                            const focusType = Object.keys(focusData)[0];
                                            const focusValue = focusData[focusType];
                                            
                                            focusTypeSelect.value = focusType;
                                            focusXpathInput.value = focusValue;
                                            focusXpathInput.style.display = '';
                                        }
                                    }
                                } else {
                                    const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                    if (paramInput) {
                                        paramInput.value = crawlData.params[paramName];
                                    }
                                }
                            });
                        }
                    }
                }
                
                // JSON Î™®ÎìúÏù∏ Í≤ΩÏö∞ JSON ÏÉùÏÑ± (ÎπÑÎèôÍ∏∞)
                if (isJsonMode) {
                    requestAnimationFrame(() => {
                        const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                        if (jsonTextarea && !jsonTextarea.value.trim()) {
                            generateJsonOutput(cellId);
                        }
                    });
                }
                
            } catch (e) {
                console.error('Crawl ÏÖÄ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', e);
            }
        }

        // Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ (Ìò∏ÌôòÏÑ±)
        function initializeCrawlCell(cellId, content) {
            try {
                let crawlData;
                
                // contentÍ∞Ä Ïù¥ÎØ∏ Í∞ùÏ≤¥Ïù∏ÏßÄ ÌôïÏù∏
                if (typeof content === 'object' && content !== null) {
                    // Ïù¥ÎØ∏ Í∞ùÏ≤¥ÎùºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                    crawlData = content;
                } else {
                    // contentÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                    let contentStr = content;
                    if (typeof content !== 'string') {
                        contentStr = String(content);
                    }
                    
                    // Îπà Î¨∏ÏûêÏó¥Ïù¥Í±∞ÎÇò "[object Object]"Ïù∏ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                    if (!contentStr || contentStr === '[object Object]' || contentStr.trim() === '') {
                        crawlData = { job_type: 'do', action: 'click', params: {} };
                    } else {
                        crawlData = JSON.parse(contentStr);
                    }
                }
                
                // Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
                crawlData = addDefaultParams(crawlData);
                
                const cell = fileCells[activeFile].find(c => c.id === cellId);
                if (cell) {
                    cell.crawl_data = crawlData;
                }
                
                // Job Type ÏÑ§Ï†ï
                const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
                if (jobTypeSelect) {
                    jobTypeSelect.value = crawlData.job_type || 'do';
                    

                    
                    updateCrawlActions(cellId, crawlData.job_type || 'do');
                    
                    // Action ÏÑ§Ï†ï (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                    setTimeout(() => {
                        const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                        if (actionSelect && crawlData.action) {
                            actionSelect.value = crawlData.action;
                            

                            
                            renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                            
                            // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ Î≥µÏõê (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                            setTimeout(() => {
                                if (crawlData.params) {
                                    Object.keys(crawlData.params).forEach(paramName => {
                                        if (paramName === 'focus') {
                                            // focus ÌååÎùºÎØ∏ÌÑ∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨
                                            const focusData = crawlData.params[paramName];
                                            const focusTypeSelect = document.querySelector(`#${cellId} select[name="focus_type"]`);
                                            const focusXpathInput = document.querySelector(`#${cellId} input[name="focus_xpath"]`);
                                            
                                            if (focusTypeSelect && focusXpathInput) {
                                                if (focusData === 'current') {
                                                    // 'current' ÌÉÄÏûÖ Ï≤òÎ¶¨
                                                    focusTypeSelect.value = 'current';
                                                    focusXpathInput.style.display = 'none';
                                                    focusXpathInput.value = '';
                                                } else if (typeof focusData === 'object') {
                                                    // Í∞ùÏ≤¥ ÌÉÄÏûÖ Ï≤òÎ¶¨ (xpath, selector Îì±)
                                                    const focusType = Object.keys(focusData)[0];
                                                    const focusValue = focusData[focusType];
                                                    
                                                    focusTypeSelect.value = focusType;
                                                    focusXpathInput.value = focusValue;
                                                    focusXpathInput.style.display = '';
                                                }
                                            }
                                        } else {
                                            const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                            if (paramInput) {
                                                paramInput.value = crawlData.params[paramName];
                                            }
                                        }
                                    });
                                }
                                
                                // XML Ï∂úÎ†•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎã§Î©¥ Ï¥àÍ∏∞ XML ÏÉùÏÑ±
                                const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
                                if (xmlToggle && xmlToggle.checked) {
                                    generateJsonOutput(cellId);
                                    
                                    // JSON textarea ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï
                                    setTimeout(() => {
                                        const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                                        if (jsonTextarea) {
                                            autoResizeTextarea(jsonTextarea);
                                        }
                                    }, 100);
                                }
                            }, 50);
                        }
                    }, 50);
                }
            } catch (e) {
                console.error('Crawl ÏÖÄ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', e);
            }
        }

        // crawl ÏÖÄ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCrawlCell(cellId, field, value) {
            console.log(`üîÑ updateCrawlCell Ìò∏Ï∂úÎê®: cellId=${cellId}, field=${field}, value=${value}`);
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (!cell) {
                console.error(`‚ùå ÏÖÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${cellId}`);
                return;
            }
            
            console.log(`‚úÖ ÏÖÄ Ï∞æÏùå:`, cell);
            
            if (!cell.crawl_data) {
                cell.crawl_data = { job_type: 'do', action: 'click', params: {} };
            }
            
            if (field === 'job_type') {
                cell.crawl_data.job_type = value;
                cell.crawl_data.action = '';
                cell.crawl_data.params = {};
                updateCrawlActions(cellId, value);
            } else if (field === 'action') {
                cell.crawl_data.action = value;
                renderCrawlParams(cellId, cell.crawl_data.job_type, value);
                
                // actionÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
                cell.crawl_data = addDefaultParams(cell.crawl_data);

            } else if (field.startsWith('param_')) {
                const paramName = field.replace('param_', '');
                cell.crawl_data.params[paramName] = value;
                
                // ÎèôÏ†Å ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨ (key_count, arg_count Î≥ÄÍ≤Ω Ïãú)
                if (paramName === 'key_count' && cell.crawl_data.job_type === 'data' && cell.crawl_data.action === 'key_to_list') {
                    handleKeyCountChange(cellId, value);
                } else if (paramName === 'arg_count' && cell.crawl_data.job_type === 'python' && cell.crawl_data.action === 'file') {
                    handleArgCountChange(cellId, value);
                }
            }
            
            // ÏÖÄ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            cell.content = JSON.stringify(cell.crawl_data, null, 2);
            
            // JSON Ï∂úÎ†•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎã§Î©¥ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            if (xmlToggle && xmlToggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // ÏÑ±Îä• ÏµúÏ†ÅÌôîÎêú Ïï°ÏÖò ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCrawlActionsOptimized(cellId, jobType) {
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            if (!actionSelect) return;
            
            actionSelect.innerHTML = '<option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            // Ïï°ÏÖò ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
            const actionLabel = document.getElementById(`action-label-${cellId}`);
            if (actionLabel) {
                const labelMap = {
                    'do': 'Action:', 'find': 'Find Type:', 'request': 'Request Type:',
                    'data': 'Convert Type:', 'save': 'Save Type:', 'load': 'Load Type:',
                    'python': 'Python Type:', 'wait': 'Wait Type:', 'test': 'Test Type:'
                };
                actionLabel.textContent = labelMap[jobType] || 'Action:';
            }
            
            // Îπ†Î•∏ Ïï°ÏÖò ÏòµÏÖò ÏÉùÏÑ±
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    const actionTypeMap = {
                        'do': 'actions', 'find': 'find_types', 'request': 'request_types',
                        'data': 'convert_types', 'save': 'save_types', 'load': 'load_types',
                        'python': 'python_types', 'wait': 'wait_types', 'test': 'test_types'
                    };
                    
                    const actionType = actionTypeMap[jobType] || actionTypeKeys[0];
                    const actions = Object.keys(jobTypeData[actionType]);
                    
                    // DocumentFragment ÏÇ¨Ïö©ÏúºÎ°ú DOM Ï°∞Ïûë ÏµúÏÜåÌôî
                    const fragment = document.createDocumentFragment();
                    actions.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        const actionData = jobTypeData[actionType][action];
                        option.textContent = actionData?.name || action.charAt(0).toUpperCase() + action.slice(1);
                        fragment.appendChild(option);
                    });
                    actionSelect.appendChild(fragment);
                }
            }
            
            // ÌååÎùºÎØ∏ÌÑ∞ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (paramsDiv) paramsDiv.innerHTML = '';
        }

        // Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ (Ìò∏ÌôòÏÑ±)
        function updateCrawlActions(cellId, jobType) {
            console.log(`üîß updateCrawlActions Ìò∏Ï∂úÎê®: cellId=${cellId}, jobType=${jobType}`);
            
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            if (!actionSelect) {
                console.error(`‚ùå action select ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: #${cellId} .crawl-action`);
                return;
            }
            
            console.log(`‚úÖ action select ÏöîÏÜå Ï∞æÏùå:`, actionSelect);
            actionSelect.innerHTML = '<option value="">ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            // Ïï°ÏÖò ÎùºÎ≤® ÎèôÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            const actionLabel = document.getElementById(`action-label-${cellId}`);
            if (actionLabel) {
                const labelMap = {
                    'do': 'Action:',
                    'find': 'Find Type:',
                    'request': 'Request Type:',
                    'data': 'Convert Type:',
                    'save': 'Save Type:',
                    'load': 'Load Type:',
                    'python': 'Python Type:',
                    'wait': 'Wait Type:',
                    'test': 'Test Type:'
                };
                actionLabel.textContent = labelMap[jobType] || 'Action:';
                console.log(`üè∑Ô∏è Ïï°ÏÖò ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏: ${actionLabel.textContent}`);
            }
            
            // window.jobTypesÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ïï°ÏÖò Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ (Í∏∞Ï°¥ Î∞©Ïãù)
            console.log(`üóÇÔ∏è window.jobTypes ÌôïÏù∏:`, window.jobTypes ? 'ÏûàÏùå' : 'ÏóÜÏùå');
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                console.log(`üìã jobTypeData:`, jobTypeData);
                
                // jobTypeDataÏóêÏÑú _typesÎÇò actionsÎ°ú ÎÅùÎÇòÎäî ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú Ï∞æÍ∏∞
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                console.log(`üîë actionTypeKeys:`, actionTypeKeys);
                
                if (actionTypeKeys.length > 0) {
                    // job ÌÉÄÏûÖÏóê ÎßûÎäî Ï†ïÌôïÌïú Ïï°ÏÖò ÌÉÄÏûÖ ÌÇ§ Ï∞æÍ∏∞
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // Í∏∞Î≥∏Í∞í
                    }
                    
                    console.log(`üéØ ÏÑ†ÌÉùÎêú actionType: ${actionType}`);
                    const actions = Object.keys(jobTypeData[actionType]);
                    console.log(`üìå actions:`, actions);
                    
                    actions.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        // JOB_TYPESÏóêÏÑú nameÏùÑ Í∞ÄÏ†∏Ïò§Í±∞ÎÇò Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                        const actionData = jobTypeData[actionType][action];
                        const displayName = actionData && actionData.name ? actionData.name : action.charAt(0).toUpperCase() + action.slice(1);
                        option.textContent = displayName;
                        actionSelect.appendChild(option);
                        console.log(`  ‚ûï Ïï°ÏÖò ÏòµÏÖò Ï∂îÍ∞Ä: ${action} (${displayName})`);
                    });
                    
                    console.log(`‚úÖ Ï¥ù ${actions.length}Í∞úÏùò Ïï°ÏÖò ÏòµÏÖò Ï∂îÍ∞ÄÎê®`);
                    
                } else {
                    console.warn(`‚ö†Ô∏è actionTypeKeysÍ∞Ä ÎπÑÏñ¥ÏûàÏùå`);
                }
            } else {
                console.error(`‚ùå window.jobTypes ÎòêÎäî jobType '${jobType}' Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùå`);
                console.log(`  - window.jobTypes:`, window.jobTypes);
                if (window.jobTypes) {
                    console.log(`  - ÏÇ¨Ïö© Í∞ÄÎä•Ìïú jobTypes:`, Object.keys(window.jobTypes));
                }
            }
            
            // ÌååÎùºÎØ∏ÌÑ∞ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (paramsDiv) {
                paramsDiv.innerHTML = '';
            }
        }

        // crawl ÌååÎùºÎØ∏ÌÑ∞ Î†åÎçîÎßÅ
        function renderCrawlParams(cellId, jobType, action) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            paramsDiv.innerHTML = '';
            
            const params = getCrawlParams(jobType, action);
            params.forEach(param => {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                
                let input;
                if (param.name === 'focus') {
                    // focus ÏΩ§Î≥¥Î∞ïÏä§ (xpath, selector, current)
                    const focusTypeSelect = document.createElement('select');
                    focusTypeSelect.name = 'focus_type';
                    ['xpath', 'selector', 'current'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        focusTypeSelect.appendChild(option);
                    });
                    
                    // xpath ÏûÖÎ†•ÎûÄ (Ìï≠ÏÉÅ Î≥¥ÏûÑ)
                    const focusXpathInput = document.createElement('input');
                    focusXpathInput.name = 'focus_xpath';
                    focusXpathInput.type = 'text';
                    focusXpathInput.placeholder = 'xpath Í∞í (Ïòà: //button[@id="login"])';
                    focusXpathInput.style.marginLeft = '0.5em';
                    
                    // focus ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ïãú UI ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
                    focusTypeSelect.onchange = (e) => {
                        if (e.target.value === 'current') {
                            focusXpathInput.style.display = 'none';
                        } else {
                            focusXpathInput.style.display = '';
                        }
                        // üîÑ focus Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        updateFocusParameter(cellId);
                    };
                    
                    // focus xpath Í∞í Î≥ÄÍ≤Ω Ïãú Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
                    focusXpathInput.onchange = (e) => {
                        // üîÑ focus Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        updateFocusParameter(cellId);
                    };
                    
                    paramField.appendChild(label);
                    paramField.appendChild(focusTypeSelect);
                    paramField.appendChild(focusXpathInput);
                    paramsDiv.appendChild(paramField);
                    return;
                }
                if (param.type === 'select') {
                    input = document.createElement('select');
                    input.name = param.name;
                    param.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                } else {
                    input = document.createElement('input');
                    input.name = param.name;
                    input.type = param.type || 'text';
                    input.placeholder = param.placeholder || '';
                }
                input.onchange = (e) => {
                    updateCrawlCell(cellId, `param_${param.name}`, e.target.value);
                    if (param.name === 'key_count' && jobType === 'data' && action === 'key_to_list') {
                        handleKeyCountChange(cellId, e.target.value);
                    } else if (param.name === 'arg_count' && jobType === 'python' && action === 'file') {
                        handleArgCountChange(cellId, e.target.value);
                    }
                };
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            });
                }
        
        // focus ÌååÎùºÎØ∏ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateFocusParameter(cellId) {
            const focusTypeSelect = document.querySelector(`#crawl-params-${cellId} select[name="focus_type"]`);
            const focusXpathInput = document.querySelector(`#crawl-params-${cellId} input[name="focus_xpath"]`);
            
            if (!focusTypeSelect || !focusXpathInput) return;
            
            const focusType = focusTypeSelect.value;
            const focusValue = focusXpathInput.value;
            
            let focusData;
            if (focusType === 'current') {
                focusData = 'current';
            } else {
                focusData = { [focusType]: focusValue || "" };
            }
            
            // updateCrawlCellÏùÑ ÌÜµÌï¥ focus ÌååÎùºÎØ∏ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            updateCrawlCell(cellId, 'param_focus', focusData);
        }

        // key_count Î≥ÄÍ≤Ω Ïãú ÎèôÏ†Å ÌÇ§ ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
        function handleKeyCountChange(cellId, keyCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // Í∏∞Ï°¥ key_ ÌïÑÎìúÎì§ Ï†úÍ±∞
            const existingKeyFields = paramsDiv.querySelectorAll('.dynamic-key-field');
            existingKeyFields.forEach(field => field.remove());
            
            // ÏÉàÎ°úÏö¥ key_ ÌïÑÎìúÎì§ ÏÉùÏÑ±
            for (let i = 0; i < parseInt(keyCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-key-field';
                
                const label = document.createElement('label');
                label.textContent = `Key ${i}`;
                
                const input = document.createElement('input');
                input.name = `key_${i}`;
                input.type = 'text';
                input.placeholder = `data_key_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_key_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }
        
        // arg_count Î≥ÄÍ≤Ω Ïãú ÎèôÏ†Å from_ ÏûÖÎ†• ÌïÑÎìú ÏÉùÏÑ±
        function handleArgCountChange(cellId, argCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // Í∏∞Ï°¥ from_ ÌïÑÎìúÎì§ Ï†úÍ±∞
            const existingFromFields = paramsDiv.querySelectorAll('.dynamic-from-field');
            existingFromFields.forEach(field => field.remove());
            
            // ÏÉàÎ°úÏö¥ from_ ÌïÑÎìúÎì§ ÏÉùÏÑ±
            for (let i = 0; i < parseInt(argCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-from-field';
                
                const label = document.createElement('label');
                label.textContent = `From ${i}`;
                
                const input = document.createElement('input');
                input.name = `from_${i}`;
                input.type = 'text';
                input.placeholder = `data_source_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_from_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }

        // ÌååÎùºÎØ∏ÌÑ∞ ÌÉÄÏûÖ Í≤∞Ï†ï Ìï®Ïàò
        function getParamType(param) {
            const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'key_count', 'arg_count', 'time'];
            const selectParams = ['find_range', 'print_result'];
            
            if (selectParams.includes(param)) {
                return 'select';
            } else if (numberParams.includes(param)) {
                return 'number';
            } else {
                return 'text';
            }
        }

        // ÌååÎùºÎØ∏ÌÑ∞ ÏòµÏÖò ÏÉùÏÑ± Ìï®Ïàò
        function getParamOptions(param) {
            if (param === 'find_range') {
                return [
                    { value: 'self', label: 'Self' },
                    { value: 'all', label: 'All' },
                    { value: 'contain', label: 'Contain' },
                    { value: 'first', label: 'First' },
                    { value: 'last', label: 'Last' },
                    { value: 'next', label: 'Next' },
                    { value: 'parent', label: 'Parent' },
                    { value: 'children', label: 'Children' },
                    { value: 'siblings', label: 'Siblings' }
                ];
            } else if (param === 'print_result') {
                return [
                    { value: 'true', label: 'True' },
                    { value: 'false', label: 'False' }
                ];
            }
            return undefined;
        }

        // ÌååÎùºÎØ∏ÌÑ∞ placeholder ÏÉùÏÑ± Ìï®Ïàò
        function getParamPlaceholder(param) {
            const placeholders = {
                'focus': '{"xpath": "//button[@id=\'login\']"}',
                'speed': '1.0',
                'text': 'ÏûÖÎ†•Ìï† ÌÖçÏä§Ìä∏',
                'sleep': '1',
                'max_time': '10',
                'speed_variation': '0.1',
                'value': 'True',
                'find_item': 'main-content',
                'find_attribute': 'data-id',
                'url': 'https://example.com',
                'data': '{"username": "user", "password": "pass"}',
                'wait_time': '2',
                'from': 'extracted_data',
                'to': 'result_data',
                'href_arg': 'https://',
                'text_arg': '\\n',
                'key_count': '3',
                'name': 'result.xlsx',
                'encoding': 'utf-8',
                'script_path': 'process_data.py',
                'arg_count': '2',
                'time': '5',
                'print_result': 'True',
                'filename': 'screenshot.png'
            };
            return placeholders[param] || param;
        }

        // crawl ÌååÎùºÎØ∏ÌÑ∞ Ï†ïÏùò - Î™®Îì† ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
        function getCrawlParams(jobType, action) {
            // JOB_TYPESÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Í∏∞Ï°¥ Î∞©Ïãù Î≥µÏõê)
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                
                // jobTypeDataÏóêÏÑú _typesÎÇò actionsÎ°ú ÎÅùÎÇòÎäî ÌÇ§Î•º ÎèôÏ†ÅÏúºÎ°ú Ï∞æÍ∏∞
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    // job ÌÉÄÏûÖÏóê ÎßûÎäî Ï†ïÌôïÌïú Ïï°ÏÖò ÌÉÄÏûÖ ÌÇ§ Ï∞æÍ∏∞
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // Í∏∞Î≥∏Í∞í
                    }
                    
                    if (jobTypeData[actionType] && jobTypeData[actionType][action]) {
                        const actionData = jobTypeData[actionType][action];
                        return actionData.params.map(param => ({
                            name: param,
                            label: param.charAt(0).toUpperCase() + param.slice(1).replace('_', ' '),
                            type: getParamType(param),
                            placeholder: getParamPlaceholder(param),
                            options: getParamOptions(param)
                        }));
                    }
                }
            }
            
            // Í∏∞Î≥∏Í∞í (JOB_TYPESÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Îß§Ïπ≠ÎêòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
            const params = {
                'save': {
                    'excel': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'excel' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.xlsx' }
                    ],
                    'csv': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'csv' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'txt' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'mysql' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'load': {
                    'excel': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'excel' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.xlsx' }
                    ],
                    'csv': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'csv' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'txt' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'mysql' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'python': {
                    'file': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'file' },
                        { name: 'script_path', label: 'Script Path', type: 'text', placeholder: 'process_data.py' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' },
                        { name: 'arg_count', label: 'Arg Count', type: 'number', placeholder: '2' }
                    ],
                    'code': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'code' },
                        { name: 'code', label: 'Code', type: 'text', placeholder: 'print(\'Hello World\')' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' }
                    ]
                },
                'wait': {
                    'fixed_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'fixed_time' },
                        { name: 'time', label: 'Time', type: 'number', placeholder: '2.5' }
                    ],
                    'load_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'load_time' }
                    ]
                },
                'test': {
                    'variable': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'variable' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_var' },
                        { name: 'value', label: 'Value', type: 'text', placeholder: 'Hello World' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'list': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'list' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_list' },
                        { name: 'items', label: 'Items', type: 'text', placeholder: 'apple,banana,orange' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'dict': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'dict' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_dict' },
                        { name: 'key_value_pairs', label: 'Key Value Pairs', type: 'text', placeholder: 'name:John,age:25,city:Seoul' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ]
                }
            };
            
            return params[jobType]?.[action] || [];
        }



        // JSON Ï∂úÎ†• ÌÜ†Í∏Ä Ìï®Ïàò (Í∞ÑÏÜåÌôîÎê®)
        function toggleJsonOutput(cellId) {
            console.log('üöÄ toggleJsonOutput Ìò∏Ï∂úÎê®, cellId:', cellId);
            const jsonSection = document.getElementById(`xml-output-${cellId}`);
            const controlsSection = document.getElementById(`crawl-controls-${cellId}`);
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            
            // Ìï¥Îãπ ÏÖÄ Ï∞æÍ∏∞
            const cell = fileCells[activeFile]?.find(c => c.id === cellId);
            if (!cell) {
                console.error('ÏÖÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', cellId);
                return;
            }
            
            if (toggle.checked) {
                console.log('üì¶ JSON Î™®ÎìúÎ°ú Ï†ÑÌôò Ï§ë...');
                
                // üîÑ UI ‚Üí JSON: ÌòÑÏû¨ UI ÏÉÅÌÉúÎ•º Ï¶âÏãú ÏàòÏßëÌïòÏó¨ JSONÏúºÎ°ú Î≥ÄÌôò
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    // ÌòÑÏû¨ UI ÏÉÅÌÉúÎ•º ÎèôÍ∏∞Ìôî
                    syncCrawlCellData(cellId);
                    
                    // ÎèôÍ∏∞ÌôîÎêú Îç∞Ïù¥ÌÑ∞Î•º JSONÏúºÎ°ú ÌëúÏãú
                    if (cell.crawl_data) {
                        jsonTextarea.value = JSON.stringify(cell.crawl_data, null, 2);
                        console.log('‚úÖ JSON ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                    } else if (!jsonTextarea.value.trim()) {
                        // crawl_dataÍ∞Ä ÏóÜÍ≥† JSONÎèÑ ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÉùÏÑ±
                        generateJsonOutput(cellId);
                    }
                    
                    autoResizeTextarea(jsonTextarea);
                }
                
                // UI ÏöîÏÜå ÌëúÏãú/Ïà®ÍπÄ Ï≤òÎ¶¨
                controlsSection.style.display = 'none';
                jsonSection.style.display = 'block';
                
            } else {
                console.log('üîô UI Î™®ÎìúÎ°ú Ï†ÑÌôò Ï§ë...');
                
                // JSON ‚Üí UI: JSON ÎÇ¥Ïö©ÏùÑ UIÎ°ú Î∞òÏòÅ
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea && jsonTextarea.value.trim()) {
                    try {
                        const crawlData = JSON.parse(jsonTextarea.value);
                        
                        // Ìï¥Îãπ ÏÖÄÏùò crawl_data ÏóÖÎç∞Ïù¥Ìä∏
                        cell.crawl_data = crawlData;
                        cell.content = jsonTextarea.value;
                        
                        // UIÎ•º JSON Îç∞Ïù¥ÌÑ∞Ïóê ÎßûÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
                        updateCrawlCellFromJson(cellId, crawlData);
                        
                        console.log('‚úÖ JSON ‚Üí UI Î≥ÄÌôò ÏôÑÎ£å');
                    } catch (e) {
                        console.error('‚ùå JSON ÌååÏã± Ïã§Ìå®:', e);
                    }
                }
                
                // UI ÏöîÏÜå ÌëúÏãú/Ïà®ÍπÄ Ï≤òÎ¶¨
                jsonSection.style.display = 'none';
                controlsSection.style.display = 'block';
            }
        }

        // JSON ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (ÏàòÏ†ï Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        function updateJsonContent(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            try {
                // JSONÏùÑ ÌååÏã±ÌïòÏó¨ crawl Îç∞Ïù¥ÌÑ∞Î°ú Î≥ÄÌôò
                const jsonContent = jsonTextarea.value.trim();
                
                // Îπà ÎÇ¥Ïö©Ïù¥Î©¥ Î¨¥Ïãú
                if (!jsonContent) {
                    return;
                }
                
                const crawlData = JSON.parse(jsonContent);
                
                // ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                const cells = fileCells[activeFile] || [];
                const cell = cells.find(c => c.id === cellId);
                if (cell) {
                    cell.content = JSON.stringify(crawlData, null, 2);
                    cell.crawl_data = crawlData;
                    
                    // crawl ÏÖÄ UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateCrawlCellFromJson(cellId, crawlData);
                }
            } catch (error) {
                console.error('JSON ÌååÏã± Ïò§Î•ò:', error);
                // Ïò§Î•òÍ∞Ä ÏûàÏñ¥ÎèÑ ÏÇ¨Ïö©ÏûêÍ∞Ä Í≥ÑÏÜç Ìé∏ÏßëÌï† Ïàò ÏûàÎèÑÎ°ù Ìï®
                // Ïò§Î•ò Î©îÏãúÏßÄÎ•º textareaÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            }
        }

        // JSONÏóêÏÑú ÌååÏã±Îêú Îç∞Ïù¥ÌÑ∞Î°ú crawl ÏÖÄ UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateCrawlCellFromJson(cellId, crawlData) {
            // job_type ÏóÖÎç∞Ïù¥Ìä∏
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            if (jobTypeSelect && crawlData.job_type) {
                jobTypeSelect.value = crawlData.job_type;
                // job_typeÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ action ÏòµÏÖòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                updateCrawlActions(cellId, crawlData.job_type);
            }
            
            // action ÏóÖÎç∞Ïù¥Ìä∏ (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
            setTimeout(() => {
                const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                if (actionSelect && crawlData.action) {
                    actionSelect.value = crawlData.action;
                    // actionÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ ÌååÎùºÎØ∏ÌÑ∞ ÌïÑÎìúÎì§ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                    
                    // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ Î≥µÏõê (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                    setTimeout(() => {
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                if (paramInput) {
                                    paramInput.value = crawlData.params[paramName];
                                }
                            });
                        }
                    }, 50);
                }
            }, 50);
        }

        // JSON Ï∂úÎ†• ÏÉùÏÑ± Ìï®Ïàò
        function generateJsonOutput(cellId) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;

            try {
                // crawl ÏÖÄÏùò ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¥
                let crawlData;
                
                // crawl_dataÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö© (UIÏóêÏÑú Î≥ÄÍ≤ΩÎêú Îç∞Ïù¥ÌÑ∞)
                if (cell.crawl_data) {
                    crawlData = cell.crawl_data;
                } else {
                    // crawl_dataÍ∞Ä ÏóÜÏúºÎ©¥ contentÎ•º ÌååÏã±
                    let contentStr = cell.content;
                    
                    // contentÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôò
                    if (typeof contentStr !== 'string') {
                        contentStr = String(contentStr);
                    }
                    
                    if (contentStr) {
                        crawlData = JSON.parse(contentStr);
                    } else {
                        crawlData = { job_type: 'do', action: '', params: {} };
                    }
                }

                // JSON Ï∂úÎ†• ÏòÅÏó≠Ïóê ÌëúÏãú (Í∏∞Î≥∏Í∞í Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÍ≥† Í∑∏ÎåÄÎ°ú ÌëúÏãú)
                const jsonContent = JSON.stringify(crawlData, null, 2);
                
                // JSON Ï∂úÎ†• ÏòÅÏó≠Ïóê ÌëúÏãú
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    // Ïù¥ÎØ∏ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞ÏßÄ ÏïäÏùå
                    if (!jsonTextarea.value.trim()) {
                        jsonTextarea.value = jsonContent;
                    }
                    autoResizeTextarea(jsonTextarea);
                }
            } catch (error) {
                console.error('JSON ÏÉùÏÑ± Ïò§Î•ò:', error);
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    jsonTextarea.value = `// JSON ÏÉùÏÑ± Ïò§Î•ò: ${error.message}`;
                }
            }
        }

                 // ÌååÎùºÎØ∏ÌÑ∞Ïóê Í∏∞Î≥∏Í∞í Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
         function addDefaultParams(crawlData) {
             const jobType = crawlData.job_type || 'do';
             const action = crawlData.action || '';
             
             // Í∏∞Î≥∏ ÌååÎùºÎØ∏ÌÑ∞ Ï†ïÏùò
             const defaultParams = {
                 'do': {
                     'click': { focus: { xpath: "//button[@id='login']" }, speed: 1.0 },
                     'text': { focus: { xpath: "//input[@name='username']" }, text: 'ÏûÖÎ†•Ìï† ÌÖçÏä§Ìä∏', speed: 1.0 },
                     'clear': { focus: { xpath: "//input[@name='username']" }, speed: 1.0 },
                     'enter': { focus: 'current' },
                     'pagedown': { focus: 'current' },
                     'radio': { focus: { xpath: "//input[@type='radio']" }, value: 'True' },
                     'scroll': { focus: 'current', sleep: 1, max_time: 10, speed_variation: 0.1 },
                     'scroll_to_element': { focus: { xpath: "//div[@class='content']" }, sleep: 1, speed: 0.5, speed_variation: 0.1, max_time: 10 },
                     'do_screen_shot': { focus: 'current', filename: 'screenshot.png' }
                 },
                 'find': {
                     'id': { find_item: 'main-content', find_range: 'first' },
                     'class': { find_item: 'title', find_range: 'first' },
                     'name': { find_item: 'div', find_range: 'first' },
                     'text': { find_item: 'Î°úÍ∑∏Ïù∏', find_range: 'first' },
                     'attribute': { find_attribute: 'data-id', find_item: '123', find_range: 'first' }
                 },
                 'data': {
                     'to_html': { from: 'extracted_data', to: 'html_data' },
                     'to_xpath': { from: 'extracted_data', to: 'xpath_data' },
                     'to_dataframe': { from: 'extracted_data', to: 'df_data' },
                     'get_href': { from: 'link_data', to: 'href_data', href_arg: 'https://' },
                     'get_hrefs': { from: 'links_data', to: 'hrefs_data', href_arg: 'https://' },
                     'get_text_all': { from: 'html_data', to: 'text_data', text_arg: '\\n' },
                     'get_texts_all': { from: 'html_data', to: 'texts_data', text_arg: '\\n' },
                     'get_text_all_tagonly': { from: 'html_data', to: 'tag_text_data', text_arg: '\\n' },
                     'get_text_all_without_script': { from: 'html_data', to: 'clean_text_data', text_arg: '\\n' },
                     'key_to_list': { to: 'combined_list', key_count: 3 }
                 },
                 'save': {
                     'excel': { save_type: 'excel', to: 'result_data', name: 'result.xlsx' },
                     'csv': { save_type: 'csv', to: 'result_data', name: 'result.csv', encoding: 'utf-8' },
                     'txt': { save_type: 'txt', to: 'result_data', name: 'result.txt', encoding: 'utf-8' },
                     'mysql': { save_type: 'mysql', to: 'result_data', name: 'crawl_results' },
                     'elasticsearch': { save_type: 'elasticsearch', to: 'result_data', name: 'crawl_index' }
                 },
                 'load': {
                     'excel': { load_type: 'excel', from: 'loaded_data', name: 'data.xlsx' },
                     'csv': { load_type: 'csv', from: 'loaded_data', name: 'data.csv', encoding: 'utf-8' },
                     'txt': { load_type: 'txt', from: 'loaded_data', name: 'data.txt', encoding: 'utf-8' },
                     'mysql': { load_type: 'mysql', from: 'loaded_data', name: 'crawl_results' },
                     'elasticsearch': { load_type: 'elasticsearch', from: 'loaded_data', name: 'crawl_index' }
                 },
                 'python': {
                     'file': { python_type: 'file', script_path: 'process_data.py', to: 'result', arg_count: 2 },
                     'code': { python_type: 'code', code: 'print(\'Hello World\')', to: 'result' }
                 },
                 'wait': {
                     'fixed_time': { wait_type: 'fixed_time', time: 2.5 },
                     'load_time': { wait_type: 'load_time' }
                 },
                 'request': {
                     'get': { request_type: 'get', url: 'https://example.com' },
                     'post': { request_type: 'post', url: 'https://api.example.com', data: '{"username": "user", "password": "pass"}' },
                     'selenium': { request_type: 'selenium', url: 'https://example.com', wait_time: 2 },
                     'selenium_url_change': { request_type: 'selenium_url_change', url: 'https://example.com', wait_time: 2 }
                 },
                 'test': {
                     'variable': { test_type: 'variable', name: 'my_var', value: 'Hello World', print_result: true },
                     'list': { test_type: 'list', name: 'my_list', items: 'apple,banana,orange', print_result: true },
                     'dict': { test_type: 'dict', name: 'my_dict', key_value_pairs: 'name:John,age:25,city:Seoul', print_result: true }
                 }
             };

             // ÌòÑÏû¨ job_typeÍ≥º actionÏóê ÎåÄÌïú Í∏∞Î≥∏ ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
             const defaults = defaultParams[jobType]?.[action] || {};
             
             // Í∏∞Ï°¥ ÌååÎùºÎØ∏ÌÑ∞ÏôÄ Í∏∞Î≥∏Í∞í Î≥ëÌï©
             const mergedParams = { ...defaults, ...crawlData.params };
             
             return {
                 ...crawlData,
                 params: mergedParams
             };
        }

        // JSON ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (ÏàòÏ†ï Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        function updateJsonContent(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            try {
                // JSONÏùÑ ÌååÏã±ÌïòÏó¨ crawl Îç∞Ïù¥ÌÑ∞Î°ú Î≥ÄÌôò
                const jsonContent = jsonTextarea.value.trim();
                
                // Îπà ÎÇ¥Ïö©Ïù¥Î©¥ Î¨¥Ïãú
                if (!jsonContent) {
                    return;
                }
                
                const crawlData = JSON.parse(jsonContent);
                
                // ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                const cells = fileCells[activeFile] || [];
                const cell = cells.find(c => c.id === cellId);
                if (cell) {
                    cell.content = JSON.stringify(crawlData, null, 2);
                    cell.crawl_data = crawlData;
                    
                    // crawl ÏÖÄ UI ÏóÖÎç∞Ïù¥Ìä∏
                    updateCrawlCellFromJson(cellId, crawlData);
                }
            } catch (error) {
                console.error('JSON ÌååÏã± Ïò§Î•ò:', error);
                // Ïò§Î•òÍ∞Ä ÏûàÏñ¥ÎèÑ ÏÇ¨Ïö©ÏûêÍ∞Ä Í≥ÑÏÜç Ìé∏ÏßëÌï† Ïàò ÏûàÎèÑÎ°ù Ìï®
                // Ïò§Î•ò Î©îÏãúÏßÄÎ•º textareaÏóê ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            }
        }

        // JSONÏóêÏÑú ÌååÏã±Îêú Îç∞Ïù¥ÌÑ∞Î°ú crawl ÏÖÄ UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateCrawlCellFromJson(cellId, crawlData) {
            // job_type ÏóÖÎç∞Ïù¥Ìä∏
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            if (jobTypeSelect && crawlData.job_type) {
                jobTypeSelect.value = crawlData.job_type;
                // job_typeÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ action ÏòµÏÖòÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                updateCrawlActions(cellId, crawlData.job_type);
            }
            
            // action ÏóÖÎç∞Ïù¥Ìä∏ (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
            setTimeout(() => {
                const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                if (actionSelect && crawlData.action) {
                    actionSelect.value = crawlData.action;
                    // actionÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ ÌååÎùºÎØ∏ÌÑ∞ ÌïÑÎìúÎì§ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                    
                    // ÌååÎùºÎØ∏ÌÑ∞ Í∞íÎì§ Î≥µÏõê (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ)
                    setTimeout(() => {
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                if (paramInput) {
                                    paramInput.value = crawlData.params[paramName];
                                }
                            });
                        }
                    }, 50);
                }
            }, 50);
        }

        // JSON Ï∂úÎ†• ÌÜ†Í∏Ä Ìï®Ïàò (ÎàÑÎùΩÎêú Ìï®Ïàò Ï∂îÍ∞Ä)
        function toggleJsonOutput(cellId) {
            const jsonSection = document.getElementById(`xml-output-${cellId}`);
            const controlsSection = document.getElementById(`crawl-controls-${cellId}`);
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            
            if (toggle.checked) {
                // JSON Ï∂úÎ†• ÌôúÏÑ±Ìôî: combobox UI Ïà®Í∏∞Í≥† JSON Ï∂úÎ†• ÌëúÏãú
                controlsSection.style.display = 'none';
                jsonSection.style.display = 'block';
                
                // JSON textarea ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï
                setTimeout(() => {
                    const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                    if (jsonTextarea) {
                        // Ïù¥ÎØ∏ ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞ÏßÄ ÏïäÏùå
                        if (!jsonTextarea.value.trim()) {
                            generateJsonOutput(cellId);
                        }
                        autoResizeTextarea(jsonTextarea);
                    }
                }, 100);
            } else {
                // JSON Ï∂úÎ†• ÎπÑÌôúÏÑ±Ìôî: JSON Ï∂úÎ†• Ïà®Í∏∞Í≥† combobox UI ÌëúÏãú
                jsonSection.style.display = 'none';
                controlsSection.style.display = 'block';
                
                // UI Î™®ÎìúÎ°ú ÎèåÏïÑÍ∞à Îïå JSON Îç∞Ïù¥ÌÑ∞Î•º UIÏóê Î∞òÏòÅ
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea && jsonTextarea.value.trim()) {
                    try {
                        const crawlData = JSON.parse(jsonTextarea.value);
                        console.log(`üîÑ JSON ‚Üí UI Î≥ÄÌôò ÏãúÏûë: ${cellId}`, crawlData);
                        
                        // ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        const cells = fileCells[activeFile] || [];
                        const cell = cells.find(c => c.id === cellId);
                        if (cell) {
                            cell.crawl_data = crawlData;
                            cell.content = JSON.stringify(crawlData, null, 2);
                        }
                        
                        // UI ÏóÖÎç∞Ïù¥Ìä∏
                        updateCrawlCellFromJson(cellId, crawlData);
                        
                        console.log('‚úÖ JSON ‚Üí UI Î≥ÄÌôò ÏôÑÎ£å');
                    } catch (e) {
                        console.error('‚ùå JSON ÌååÏã± Ïã§Ìå®:', e);
                    }
                }
            }
        }

        // JSON Ï∂úÎ†• Î≥µÏÇ¨ Ìï®Ïàò
        function copyJsonOutput(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            jsonTextarea.select();
            jsonTextarea.setSelectionRange(0, 99999); // Î™®Î∞îÏùºÏùÑ ÏúÑÌïú ÏÑ§Ï†ï

            try {
                document.execCommand('copy');
                
                // Î≥µÏÇ¨ ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                const copyBtn = document.querySelector(`#xml-output-${cellId} .xml-copy-btn`);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úì Î≥µÏÇ¨Îê®';
                copyBtn.style.background = '#48bb78';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
                alert('JSON Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // crawl ÏÖÄ Ïã§Ìñâ Ïãú JSON Ï∂úÎ†•ÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏
        function runCrawlCell(cellId) {
            // Í∏∞Ï°¥ Ïã§Ìñâ Î°úÏßÅ...
            
            // JSON Ï∂úÎ†•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎã§Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            if (toggle && toggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏ Î∞è reload Ìï®Ïàò
        function checkFileUpdatedAndReload(filePath, expectedContent, retryCount = 0) {
            const maxRetries = 10; // ÏµúÎåÄ 10Î≤à ÏãúÎèÑ
            const retryDelay = 200; // 200ms Í∞ÑÍ≤©
            
            fetch(`/api/files/content?path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ÌååÏùº ÎÇ¥Ïö©Ïù¥ ÏòàÏÉÅÌïú ÎÇ¥Ïö©Í≥º ÏùºÏπòÌïòÎäîÏßÄ ÌôïÏù∏
                        if (data.content === expectedContent) {
                
                            // ÌååÏùºÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏúºÎØÄÎ°ú reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        } else if (retryCount < maxRetries) {
                            // ÏïÑÏßÅ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏßÄ ÏïäÏïòÏúºÎØÄÎ°ú Îã§Ïãú ÏãúÎèÑ
            
                            setTimeout(() => {
                                checkFileUpdatedAndReload(filePath, expectedContent, retryCount + 1);
                            }, retryDelay);
                        } else {
            
                            // ÏµúÎåÄ ÏãúÎèÑ ÌöüÏàòÎ•º Ï¥àÍ≥ºÌñàÏúºÎØÄÎ°ú Í∞ïÏ†ú reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        }
                    } else {
                        console.error('ÌååÏùº ÎÇ¥Ïö© ÌôïÏù∏ Ïã§Ìå®:', data.message);
                        // ÌôïÏù∏ Ïã§Ìå® Ïãú Í∞ïÏ†ú reload
                        const fileName = filePath.split('/').pop();
                        const file = { path: filePath, name: fileName };
                        selectFile(file);
                    }
                })
                .catch(error => {
                    console.error('ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏ Ï§ë Ïò§Î•ò:', error);
                    // Ïò§Î•ò Î∞úÏÉù Ïãú Í∞ïÏ†ú reload
                    const fileName = filePath.split('/').pop();
                    const file = { path: filePath, name: fileName };
                    selectFile(file);
                });
        }

        function renderNotebookCells() {
            syncCellContentsToMemory();
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ÏÖÄ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateCellName(cellId, name) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (cell) {
                cell.name = name;
                // ÏÖÄ Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ ÏûêÎèô Ï†ÄÏû•
                setTimeout(() => saveNotebookToFile(), 500);
            }
        }

        // crawl ÏÖÄÏóê ÏûêÎèô Î≤àÌò∏ Î∂ÄÏó¨ÌïòÎäî Ìï®Ïàò
        function renumberCrawlCells() {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cells = fileCells[activeFile];
            cells.forEach((cell, index) => {
                if ((cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') && (!cell.name || cell.name === '')) {
                    cell.name = `Crawl_${index + 1}`;
                }
            });
            
            renderNotebookCells();
            saveNotebook();
        }

        function runCell(cellId) {
            // Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù∏ ÏÖÄÏù¥Î©¥ ÌÅêÏóê Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
            if (currentExecutingCell === cellId) {
    
                return;
            }
            
            // Ïù¥ÎØ∏ ÌÅêÏóê ÏûàÎäî ÏÖÄÏù¥Î©¥ Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå
            if (cellExecutionQueue.includes(cellId)) {
    
                return;
            }
            
            // ÌÅêÏóê ÏÖÄ Ï∂îÍ∞Ä
            cellExecutionQueue.push(cellId);

            
            // ÎåÄÍ∏∞Ï§ë ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            const statusSpan = document.querySelector(`#status-${cellId}`);
            if (statusSpan) {
                statusSpan.textContent = 'ÎåÄÍ∏∞Ï§ë';
                statusSpan.className = 'cell-status waiting';
            }
            
            // ÌÅê Ï≤òÎ¶¨ ÏãúÏûë
            processCellQueue();
        }

        // focus ÌååÎùºÎØ∏ÌÑ∞Î•º Ïò¨Î∞îÎ•∏ Íµ¨Ï°∞Î°ú Ï†ÄÏû•
        function updateFocusParam(cellId, focusType, focusValue) {
            let value;
            if (focusType === 'current') {
                value = 'current';
            } else {
                value = {};
                value[focusType] = focusValue;
            }
            updateCrawlCell(cellId, 'param_focus', value);
        }

        // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Î≥¥Ïó¨Ï£ºÍ∏∞
        function showImageModal(file) {
            // Í∏∞Ï°¥ Î™®Îã¨Ïù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <h3>${file.name}</h3>
                        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
                    </div>
                    <div class="image-modal-body">
                        <img src="/api/files/image?path=${encodeURIComponent(file.path)}" alt="${file.name}" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            });
        }

        // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Îã´Í∏∞
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }

        // 1. Cell ÌÅ¥ÎûòÏä§ Ï†ïÏùò
        class Cell {
            constructor({id, content = '', output = '', status = '', cell_type = 'code', crawl_data = null, name = '', output_history = [], metadata = {}}) {
                this.id = id;
                this.content = content;
                this.output = output;
                this.status = status;
                this.cell_type = cell_type;
                this.crawl_data = crawl_data;
                // metadata.nameÏùÑ Ïö∞ÏÑ†ÏúºÎ°ú ÌïòÍ≥†, ÏóÜÏúºÎ©¥ name ÏÇ¨Ïö©
                this.name = (metadata && metadata.name) || name || '';
                this.output_history = output_history;
            }

            setContent(content) {
                this.content = content;
            }
            setOutput(output) {
                this.output = output;
            }
            setStatus(status) {
                this.status = status;
            }
            setName(name) {
                this.name = name;
            }
            setCrawlData(crawl_data) {
                this.crawl_data = crawl_data;
            }
            addOutputHistory(entry) {
                this.output_history.push(entry);
            }
        }

        // ... Í∏∞Ï°¥ ÏΩîÎìú ...
        // fileCells = { filePath: [Cell, ...] } ÌòïÌÉúÎ°ú ÏÇ¨Ïö©
        // addCell, createCellElement, renderNotebookCells, deleteCell Îì±ÏóêÏÑú Cell Ïù∏Ïä§ÌÑ¥Ïä§ ÏÇ¨Ïö©

        // Ï§ëÎ≥µÎêú Ìï®Ïàò Ï†úÍ±∞Îê®



        function renderNotebookCells() {
            syncCellContentsToMemory();
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ÏòàÏãú: deleteCell Ìï®Ïàò Î¶¨Ìå©ÌÜ†ÎßÅ
        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ÏÇ≠Ï†úÌï† ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ÏµúÏÜå ÌïòÎÇòÏùò ÏÖÄÏùÄ Ïú†ÏßÄÌï¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;
            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            updateCellNumbers();
        }

        // ÏòàÏãú: createCellElement Ìï®ÏàòÏóêÏÑú cell Ïù∏Ïä§ÌÑ¥Ïä§ ÏÇ¨Ïö©
        // ... Í∏∞Ï°¥ createCellElement Ìï®Ïàò ÎÇ¥ÏóêÏÑú cell.content, cell.status Îì± Ï†ëÍ∑º Î∞©ÏãùÏùÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ ...

        // fileCellsÏóê ÏÖÄÏùÑ Ï∂îÍ∞Ä/Î°úÎìúÌï† ÎïåÎèÑ Cell Ïù∏Ïä§ÌÑ¥Ïä§Î°ú Î≥ÄÌôò
        // Ïòà: ÌååÏùº Î°úÎìú Ïãú
        // fileCells[file.path] = cells.map(cellObj => new Cell(cellObj));

        // ... Í∏∞Ï°¥ ÏΩîÎìú ...

        // ÏÖÄ Ï∂îÍ∞Ä/Î†åÎçîÎßÅ Ï†Ñ textarea Í∞í Î∞è ÏÖÄ Ïù¥Î¶Ñ ÎèôÍ∏∞Ìôî Ìï®Ïàò
        function syncCellContentsToMemory() {
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach(cell => {
                // textarea ÎÇ¥Ïö© ÎèôÍ∏∞Ìôî
                const textarea = document.getElementById(cell.id)?.querySelector('.cell-input');
                if (textarea) {
                    cell.setContent(textarea.value);
                }
                
                // ÏÖÄ Ïù¥Î¶Ñ ÎèôÍ∏∞Ìôî
                const nameInput = document.getElementById(`cell-name-${cell.id}`);
                if (nameInput) {
                    cell.setName(nameInput.value);
                }
            });
        }

        // ÏÖÄ Î≥µÏÇ¨, Ïù¥Îèô Ìï®Ïàò Ï∂îÍ∞Ä
        function copyCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;
            const cell = cells[cellIndex];
            // ÍπäÏùÄ Î≥µÏÇ¨
            const newCell = new Cell({
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: cell.content,
                cell_type: cell.cell_type,
                crawl_data: cell.crawl_data ? JSON.parse(JSON.stringify(cell.crawl_data)) : null,
                name: cell.name ? cell.name + '_Î≥µÏÇ¨' : '',
                output_history: []
            });
            cells.splice(cellIndex + 1, 0, newCell);
            renderNotebookCells();
        }
        function moveCellUp(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex <= 0) return;
            const temp = cells[cellIndex];
            cells[cellIndex] = cells[cellIndex - 1];
            cells[cellIndex - 1] = temp;
            renderNotebookCells();
        }
        function moveCellDown(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            const cells = fileCells[activeFile];
            const cellIndex = cells.findIndex(c => c.id === cellId);
            if (cellIndex === -1 || cellIndex === cells.length - 1) return;
            const temp = cells[cellIndex];
            cells[cellIndex] = cells[cellIndex + 1];
            cells[cellIndex + 1] = temp;
            renderNotebookCells();
        }



        // ÌÉ≠Î≥Ñ ÌÅ¨Í∏∞ Ï†ÄÏû•ÏÜå
        let tabSizes = {
            'np': 320,
            'view': 500
        };
        
        // Ï†ÄÏû•Îêú ÌÉ≠ ÌÅ¨Í∏∞ Î∂àÎü¨Ïò§Í∏∞
        function loadTabSizes() {
            const savedSizes = localStorage.getItem('rightPanelTabSizes');
            if (savedSizes) {
                tabSizes = { ...tabSizes, ...JSON.parse(savedSizes) };
            }
        }
        
        // ÌÉ≠ ÌÅ¨Í∏∞ Ï†ÄÏû•ÌïòÍ∏∞
        function saveTabSizes() {
            localStorage.setItem('rightPanelTabSizes', JSON.stringify(tabSizes));
        }
        
        // Ïö∞Ï∏° Ìå®ÎÑê ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function switchRightTab(tabName) {
            const rightPanel = document.getElementById('rightPanel');
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            const selectedContent = document.getElementById(`${tabName}Panel`);
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïù¥ ÌÅ¥Î¶≠Îêú Í≤ΩÏö∞ (Ìå®ÎÑê Ï∂ïÏÜå/ÌôïÏû• ÌÜ†Í∏Ä)
            if (selectedTab && selectedTab.classList.contains('active')) {
                if (rightPanel.classList.contains('collapsed')) {
                    // Ï∂ïÏÜåÎêú ÏÉÅÌÉúÏóêÏÑú ÌôïÏû•
                    rightPanel.classList.remove('collapsed');
                    const tabSize = tabSizes[tabName] || 280;
                    rightPanel.style.width = tabSize + 'px';
            } else {
                    // ÌôïÏû•Îêú ÏÉÅÌÉúÏóêÏÑú Ï∂ïÏÜå
                    rightPanel.classList.add('collapsed');
                    rightPanel.style.width = '40px';
                }
                return;
            }
            
            // Îã§Î•∏ ÌÉ≠ÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.right-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.right-panel-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
                
                            // Ìå®ÎÑêÏù¥ Ï∂ïÏÜåÎêòÏñ¥ ÏûàÏßÄ ÏïäÏúºÎ©¥ ÌÉ≠Ïóê ÎßûÎäî ÌÅ¨Í∏∞Î°ú Ï°∞Ï†ï
            if (!rightPanel.classList.contains('collapsed')) {
                const tabSize = tabSizes[tabName] || 280;
                rightPanel.style.width = tabSize + 'px';
            }
            
            // view ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎêòÎ©¥ HTML Î∑∞Ïñ¥ Î°úÎìú
            if (tabName === 'view') {
                loadHTMLViewer();
            }
                

            }
        }
        
        // HTML Î∑∞Ïñ¥ Î°úÎìú Ìï®Ïàò
        function loadHTMLViewer() {
            const container = document.getElementById('htmlViewerContainer');
            
            if (container && container.innerHTML.trim() === '') {
                // HTML Î∑∞Ïñ¥ Î°úÎìú
                fetch('/templates/component/html_viewer/html_viewer.html')
                    .then(response => response.text())
                    .then(html => {
                        container.innerHTML = html;
                        
                        // JavaScript ÌååÏùº Î°úÎìú
                        const script = document.createElement('script');
                        script.src = '/templates/component/html_viewer/html_viewer.js';
                        script.onload = function() {
                            // HTML Î∑∞Ïñ¥Í∞Ä Î°úÎìúÎêú ÌõÑ ÏΩúÎ∞± Îì±Î°ù Î∞è ÌòÑÏû¨ Ïª§ÎÑê ID ÏÑ§Ï†ï
                            setTimeout(() => {
                                registerHTMLViewerUpdateCallback();
                                executeCallbackDict('update');
                            }, 100);
                        };
                        document.head.appendChild(script);
                    })
                    .catch(error => {
                        console.error('HTML Î∑∞Ïñ¥ Î°úÎìú Ïã§Ìå®:', error);
                    });
            }
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Í¥ÄÎ†® Î≥ÄÏàò
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à ÏãúÏûë
        function startResize(e) {
            isResizing = true;
            startX = e.clientX;
            const rightPanel = document.getElementById('rightPanel');
            startWidth = rightPanel.offsetWidth;
            
            // ÎßàÏö∞Ïä§ Ïª§ÏÑú Î≥ÄÍ≤Ω
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ï§ë
        function resize(e) {
            if (!isResizing) return;
            
            const newWidth = window.innerWidth - e.clientX;
            
            // ÏµúÏÜå ÌÅ¨Í∏∞Îßå Ï†úÌïú
            const clampedWidth = Math.max(200, newWidth);
            
            const rightPanel = document.getElementById('rightPanel');
            rightPanel.style.width = clampedWidth + 'px';
            
            e.preventDefault();
        }
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ï¢ÖÎ£å
        function stopResize() {
            if (!isResizing) return;
            
            isResizing = false;
            
            // ÎßàÏö∞Ïä§ Ïª§ÏÑú Î≥µÏõê
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
            
            // ÌòÑÏû¨ ÌôúÏÑ± ÌÉ≠Ïùò ÌÅ¨Í∏∞ Ï†ÄÏû•
            const activeTab = document.querySelector('.right-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const rightPanel = document.getElementById('rightPanel');
                tabSizes[tabName] = rightPanel.offsetWidth;
                saveTabSizes();
            }
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ìï®Ïàò Ï∂îÍ∞Ä
        let draggedCellId = null;
        function handleCellDragStart(event, cellId) {
            draggedCellId = cellId;
            event.dataTransfer.effectAllowed = 'move';
            // Îπà ÏÖÄ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
            const dragImg = document.createElement('div');
            dragImg.style.width = '350px';
            dragImg.style.height = '60px';
            dragImg.style.background = 'rgba(180,180,180,0.25)';
            dragImg.style.border = '2px dashed #aaa';
            dragImg.style.borderRadius = '8px';
            dragImg.style.display = 'flex';
            dragImg.style.alignItems = 'center';
            dragImg.style.justifyContent = 'center';
            dragImg.style.fontSize = '1.1em';
            dragImg.style.color = '#888';
            dragImg.innerText = 'ÏÖÄ Ïù¥Îèô';
            document.body.appendChild(dragImg);
            event.dataTransfer.setDragImage(dragImg, 120, 30);
            setTimeout(() => document.body.removeChild(dragImg), 0);
        }
        function handleCellDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }
        function handleCellDrop(event, targetCellId) {
            event.preventDefault();
            if (!draggedCellId || draggedCellId === targetCellId) return;
            const cells = fileCells[activeFile];
            const fromIdx = cells.findIndex(c => c.id === draggedCellId);
            const toIdx = cells.findIndex(c => c.id === targetCellId);
            if (fromIdx === -1 || toIdx === -1) return;
            // ÏÖÄ ÏàúÏÑú Î≥ÄÍ≤Ω
            const [movedCell] = cells.splice(fromIdx, 1);
            cells.splice(toIdx, 0, movedCell);
            renderNotebookCells();
            draggedCellId = null;
        }

        // Î©îÎâ¥ ÎìúÎ°≠Îã§Ïö¥ ÎèôÏûë Ïä§ÌÅ¨Î¶ΩÌä∏
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
          item.addEventListener('mouseenter', function() {
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) dropdown.style.display = 'block';
          });
          item.addEventListener('mouseleave', function() {
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) dropdown.style.display = 'none';
          });
          item.addEventListener('click', function(e) {
            // ÌÅ¥Î¶≠ Ïãú ÌÜ†Í∏Ä
            const dropdown = item.querySelector('.dropdown');
            if (dropdown) {
              dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
              e.stopPropagation();
            }
          });
        });
        document.body.addEventListener('click', function() {
          document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
        });

        // ===== ÌÜµÌï©Îêú crawl ÏÖÄ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ =====
        
        /**
         * crawl ÏÖÄÏùò UIÏóêÏÑú ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÏ∂úÌïòÏó¨ Í∏∞Ï°¥ notebook Íµ¨Ï°∞Î°ú Î∞òÌôò
         */
        function extractCrawlDataFromUI(cellId) {
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            
            if (!jobTypeSelect || !actionSelect) {
                console.warn(`crawl ÏÖÄ ${cellId}Ïùò UI ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                return null;
            }
            
            const crawlData = {
                job_type: jobTypeSelect.value || 'do',
                action: actionSelect.value || '',
                params: {}
            };
            
            // Î™®Îì† ÌååÎùºÎØ∏ÌÑ∞ ÏûÖÎ†• Í∞í ÏàòÏßë (focus Ï†úÏô∏, Î≥ÑÎèÑ Ï≤òÎ¶¨)
            const paramInputs = document.querySelectorAll(`#crawl-params-${cellId} input[name], #crawl-params-${cellId} select[name]`);
            paramInputs.forEach(input => {
                // focus Í¥ÄÎ†® ÌïÑÎìúÎäî Î≥ÑÎèÑ Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ï†úÏô∏
                if (input.name && !input.name.includes('focus') && input.value) {
                    // Ïà´Ïûê ÌÉÄÏûÖ ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
                    const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'time', 'key_count', 'arg_count'];
                    if (numberParams.includes(input.name)) {
                        const numValue = parseFloat(input.value);
                        if (!isNaN(numValue)) {
                            crawlData.params[input.name] = numValue;
                            console.log(`üìä Ïà´Ïûê ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë: ${input.name} = ${numValue} (${typeof numValue})`);
                        }
                    } else {
                        crawlData.params[input.name] = input.value;
                        console.log(`üìù ÌÖçÏä§Ìä∏ ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë: ${input.name} = "${input.value}"`);
                    }
                }
            });
            
            // focus ÌååÎùºÎØ∏ÌÑ∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨ (Ïã§Ï†ú DOM Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏàòÏ†ï)
            const focusTypeSelect = document.querySelector(`#crawl-params-${cellId} select[name="focus_type"]`);
            const focusXpathInput = document.querySelector(`#crawl-params-${cellId} input[name="focus_xpath"]`);
            
            if (focusTypeSelect && focusXpathInput) {
                const focusType = focusTypeSelect.value;
                const focusValue = focusXpathInput.value.trim();
                
                if (focusType === 'current') {
                    crawlData.params.focus = 'current';
                    console.log(`üéØ Focus ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë: 'current'`);
                } else if (focusValue) {
                    crawlData.params.focus = { [focusType]: focusValue };
                    console.log(`üéØ Focus ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë: ${focusType} = "${focusValue}"`);
                } else if (focusType && focusType !== 'current') {
                    // Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏñ¥ÎèÑ Íµ¨Ï°∞Îäî ÏÉùÏÑ±
                    crawlData.params.focus = { [focusType]: "" };
                    console.log(`üéØ Focus ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë: ${focusType} = "" (Îπà Í∞í)`);
                }
            } else {
                console.warn(`‚ö†Ô∏è Focus UI ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: cellId=${cellId}`);
                console.warn(`  - focusTypeSelect: ${focusTypeSelect ? 'ÏûàÏùå' : 'ÏóÜÏùå'}`);
                console.warn(`  - focusXpathInput: ${focusXpathInput ? 'ÏûàÏùå' : 'ÏóÜÏùå'}`);
            }
            
            return crawlData;
        }
        
        /**
         * crawl ÏÖÄÏùò ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî ÌÜµÌï© Ìï®Ïàò
         * Ïö∞ÏÑ†ÏàúÏúÑ: JSON Î™®Îìú > UI Îç∞Ïù¥ÌÑ∞ > crawl_data > content
         */
        function getCrawlCellData(cell) {
            const cellId = cell.id;
            
            // 1. JSON Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            const isJsonMode = xmlToggle && xmlToggle.checked;
            
            if (isJsonMode) {
                // JSON Î™®Îìú: textareaÏóêÏÑú ÏßÅÏ†ë Í∞ÄÏ†∏Ïò§Í∏∞
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea && jsonTextarea.value.trim()) {
                    try {
                        const parsed = JSON.parse(jsonTextarea.value);
                        return { data: parsed, source: 'json_textarea' };
                    } catch (e) {
                        console.warn(`JSON Î™®ÎìúÏóêÏÑú ÌååÏã± Ïã§Ìå® (ÏÖÄ ${cellId}):`, e);
                    }
                }
            }
            
            // 2. UIÏóêÏÑú ÌòÑÏû¨ Í∞í Ï∂îÏ∂ú
            const uiData = extractCrawlDataFromUI(cellId);
            if (uiData) {
                return { data: uiData, source: 'ui' };
            }
            
            // 3. Ï†ÄÏû•Îêú crawl_data ÏÇ¨Ïö©
            if (cell.crawl_data) {
                return { data: cell.crawl_data, source: 'crawl_data' };
            }
            
            // 4. contentÏóêÏÑú ÌååÏã± ÏãúÎèÑ
            if (cell.content && typeof cell.content === 'string') {
                try {
                    const parsed = JSON.parse(cell.content);
                    return { data: parsed, source: 'content' };
                } catch (e) {
                    console.warn(`content ÌååÏã± Ïã§Ìå® (ÏÖÄ ${cellId}):`, e);
                }
            }
            
                         // 5. Í∏∞Î≥∏Í∞í Î∞òÌôò
             return { 
                 data: { job_type: 'do', action: 'click', params: {} }, 
                 source: 'default' 
             };
        }
        
        /**
         * crawl ÏÖÄÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÎèôÍ∏∞ÌôîÌïòÎäî Ìï®Ïàò
         */
        function syncCrawlCellData(cellId) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;
            
            const { data, source } = getCrawlCellData(cell);
            
            // ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            cell.crawl_data = data;
            cell.content = JSON.stringify(data, null, 2);
            
            // JSON textarea ÏóÖÎç∞Ïù¥Ìä∏ (JSON Î™®ÎìúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå)
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            const isJsonMode = xmlToggle && xmlToggle.checked;
            
            if (!isJsonMode) {
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    jsonTextarea.value = JSON.stringify(data, null, 2);
                    autoResizeTextarea(jsonTextarea);
                }
            }
            
            console.log(`ÏÖÄ ${cellId} Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å (ÏÜåÏä§: ${source})`);
        }
        
        /**
         * Î™®Îì† crawl ÏÖÄÏùò Îç∞Ïù¥ÌÑ∞Î•º ÎèôÍ∏∞Ìôî
         */
        function syncAllCrawlCells() {
            if (!activeFile || !fileCells[activeFile]) return;
            
            fileCells[activeFile].forEach(cell => {
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                if (isCrawlCell) {
                    syncCrawlCellData(cell.id);
                }
            });
        }

        // ===== Í∏∞Ï°¥ Ìï®ÏàòÎì§ ÏàòÏ†ï =====
        
        /**
         * notebook Íµ¨Ï°∞(job_type, params)Î•º class_job.py Íµ¨Ï°∞(type, flat)Î°ú Î≥ÄÌôò
         */
        function convertToClassJobFormat(crawlData) {
            console.log(`üîÑ convertToClassJobFormat ÏãúÏûë:`);
            console.log(`üì• ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞:`, crawlData);
            
            if (!crawlData) {
                console.log(`‚ùå crawlDataÍ∞Ä null/undefined`);
                return {};
            }
            
            // Í∏∞Î≥∏ Íµ¨Ï°∞ ÏÉùÏÑ± (type, action)
            const result = {
                type: crawlData.job_type || 'do',
                action: crawlData.action || ''
            };
            console.log(`üèóÔ∏è Í∏∞Î≥∏ Íµ¨Ï°∞ ÏÉùÏÑ±:`, result);
            
            // params ÏïàÏùò Î™®Îì† ÏÜçÏÑ±ÏùÑ flatÌïòÍ≤å resultÏóê Î≥µÏÇ¨
            if (crawlData.params && typeof crawlData.params === 'object') {
                console.log(`üìã params Î≥µÏÇ¨ ÏãúÏûë:`, crawlData.params);
                Object.keys(crawlData.params).forEach(key => {
                    result[key] = crawlData.params[key];
                    console.log(`  ‚úÖ ${key}: ${JSON.stringify(crawlData.params[key])}`);
                });
            } else {
                console.log(`‚ö†Ô∏è paramsÍ∞Ä ÏóÜÍ±∞ÎÇò Í∞ùÏ≤¥Í∞Ä ÏïÑÎãò:`, crawlData.params);
            }
            
            // üîß do ÌÉÄÏûÖÏóêÏÑú focus ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä (class_job.py KeyError Î∞©ÏßÄ)
            if (result.type === 'do' && !result.hasOwnProperty('focus')) {
                // focusÍ∞Ä ÌïÑÏöî ÏóÜÎäî actionÎì§Ïóê ÎåÄÌï¥ÏÑúÎäî 'current'Î°ú ÏÑ§Ï†ï
                const noFocusActions = ['enter', 'pagedown', 'scroll'];
                if (noFocusActions.includes(result.action)) {
                    result.focus = 'current';
                } else {
                    // Í∏∞Î≥∏Í∞íÏúºÎ°ú Îπà xpath ÏÑ§Ï†ï
                    result.focus = { xpath: "" };
                }
                console.log(`‚ö†Ô∏è focus ÌååÎùºÎØ∏ÌÑ∞ ÎàÑÎùΩ, Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä: ${result.action} -> ${JSON.stringify(result.focus)}`);
            } else if (result.type === 'do' && result.hasOwnProperty('focus')) {
                console.log(`‚úÖ focus ÌååÎùºÎØ∏ÌÑ∞ Ï°¥Ïû¨: ${JSON.stringify(result.focus)}`);
            }
            
            // ÌäπÎ≥ÑÌïú Î≥ÄÌôò Í∑úÏπôÎì§
            if (result.type === 'request') {
                result.request_type = result.action;
            } else if (result.type === 'find') {
                result.find_type = result.action;
            } else if (result.type === 'data') {
                result.convert_type = result.action;
            } else if (result.type === 'save') {
                result.save_type = result.action;
            } else if (result.type === 'load') {
                result.load_type = result.action;
            } else if (result.type === 'python') {
                result.python_type = result.action;
            } else if (result.type === 'wait') {
                result.wait_type = result.action;
            } else if (result.type === 'test') {
                result.test_type = result.action;
            }
            
            console.log(`üì§ ÏµúÏ¢Ö Î≥ÄÌôò Í≤∞Í≥º:`, result);
            console.log(`üîÑ convertToClassJobFormat ÏôÑÎ£å\n`);
            return result;
        }

        // ===== Ï†ÄÏû• Ìï®Ïàò Í∞úÏÑ† =====
        
        function saveNotebookToFile() {
            if (!activeFile) {
                alert('Ï†ÄÏû•Ìï† ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            // Î®ºÏ†Ä Î™®Îì† ÏÖÄ Îç∞Ïù¥ÌÑ∞Î•º ÎèôÍ∏∞Ìôî
            syncAllCrawlCells();
            syncCellContentsToMemory(); // ÏùºÎ∞ò ÏÖÄÎì§ÎèÑ ÎèôÍ∏∞Ìôî
            
            const cells = fileCells[activeFile] || [];
            const notebookContent = [];
            
            cells.forEach(cell => {
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                let content = '';
                let cellType = cell.cell_type;
                
                                 if (isCrawlCell) {
                     // crawl ÏÖÄÏùò Í≤ΩÏö∞ ÎèôÍ∏∞ÌôîÎêú content ÏÇ¨Ïö©
                     content = cell.content || JSON.stringify({ job_type: 'do', action: '', params: {} }, null, 2);
                    
                    // JSON Î™®Îìú ÌôïÏù∏ÌïòÏó¨ ÌÉÄÏûÖ Í≤∞Ï†ï
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked;
                    cellType = isJsonMode ? 'crawl_json' : 'crawl_ui';
                } else {
                    // ÏùºÎ∞ò ÏΩîÎìú ÏÖÄ
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content || '';
                    cellType = 'code';
                }
                
                if (content.trim() !== '') {
                    notebookContent.push({
                        cell_type: cellType,
                        content: content,
                        metadata: { name: cell.name || '' },
                        output_history: cell.output_history || []
                    });
                }
            });
            
            if (notebookContent.length === 0) {
                alert('Ï†ÄÏû•Ìï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌååÏùº ÌôïÏû•ÏûêÏóê Îî∞Îùº Ï†ÄÏû• ÌòïÏãù Í≤∞Ï†ï
            const fileName = activeFile.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();
            
            let contentToSave = '';
            if (fileExtension === 'ipynb') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        execution_count: null, 
                        metadata: item.metadata, 
                        outputs: item.output_history ? item.output_history.map(entry => ({
                            output_type: "stream",
                            name: "stdout",
                            text: entry.output
                        })) : [], 
                        source: item.content
                    })),
                    metadata: { 
                        kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, 
                        language_info: { 
                            codemirror_mode: { name: "ipython", version: 3 }, 
                            file_extension: ".py", 
                            mimetype: "text/x-python", 
                            name: "python", 
                            nbconvert_exporter: "python", 
                            pygments_lexer: "ipython3", 
                            version: "3.8.0" 
                        } 
                    }, 
                    nbformat: 4, 
                    nbformat_minor: 4 
                };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else if (fileExtension === 'npn') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        metadata: item.metadata, 
                        source: item.content,
                        output_history: item.output_history || []
                    })),
                    metadata: { 
                        kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, 
                        language_info: { 
                            codemirror_mode: { name: "ipython", version: 3 }, 
                            file_extension: ".py", 
                            mimetype: "text/x-python", 
                            name: "python", 
                            nbconvert_exporter: "python", 
                            pygments_lexer: "ipython3", 
                            version: "3.8.0" 
                        } 
                    }, 
                    nbformat: 4, 
                    nbformat_minor: 4 
                };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else {
                contentToSave = notebookContent.map(item => item.content).join('\n\n');
            }
            
            // ÌååÏùº Ï†ÄÏû• API Ìò∏Ï∂ú
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: activeFile, content: contentToSave })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ÎÖ∏Ìä∏Î∂ÅÏù¥ "${fileName}"Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`;
                    document.body.appendChild(successDiv);
                    
                    // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                } else {
                    alert(data.message || 'Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
        }
    </script>



    <style>
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .image-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .image-modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .image-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            color: #333;
        }

        .image-modal-body {
            padding: 20px;
            text-align: center;
            background: white;
        }

        /* Footer Ïä§ÌÉÄÏùº */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-top: 1px solid #4a5568;
            z-index: 1000;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-left, .footer-right {
            font-size: 0.9rem;
        }

        /* Ïã§ÏãúÍ∞Ñ Ïä§ÌÅ¨Î¶∞ÏÉ∑ ÌÉ≠ Ïä§ÌÉÄÏùº */
        .screenshot-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px 0 0 8px;
            padding: 1rem;
            cursor: pointer;
            z-index: 2000;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }

        .screenshot-tab:hover {
            background: #4a5568;
        }

        .screenshot-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1a202c;
            color: #e2e8f0;
            z-index: 1999;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .screenshot-panel.open {
            right: 0;
        }

        .screenshot-header {
            background: #2d3748;
            padding: 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .screenshot-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .screenshot-close {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-close:hover {
            color: #f56565;
        }

        .screenshot-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .screenshot-info {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .screenshot-image-container {
            background: #2d3748;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .screenshot-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            border: 1px solid #4a5568;
        }

        .screenshot-status {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #2d3748;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
    
    <!-- Ï±ÑÌåÖ Ïª¥Ìè¨ÎÑåÌä∏ JavaScript -->
    <script src="/templates/component/chat/chat.js"></script>
</body>
</html>