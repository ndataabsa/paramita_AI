<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NP Notebook</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/notebook.css', v='2.7') }}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fff;
            color: #222;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .header {
            background: #1a202c;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 400;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        /* ì£¼í”¼í„° ë…¸íŠ¸ë¶ ìŠ¤íƒ€ì¼ ë ˆì´ì•„ì›ƒ */
        .jupyter-layout {
            display: flex;
            height: calc(100vh - 140px);
            margin-top: 10px;
        }

        .file-browser-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            overflow: hidden;
            height: 100%;
        }

        .sidebar-tabs {
            width: 40px;
            background: #f5f6fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-tab {
            width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .sidebar-tab.active {
            color: #222;
            background: #fff;
            border-right: 3px solid #999;
        }

        .sidebar-tab:hover {
            color: #222;
            background: #fff;
        }

        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-panel {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .sidebar-panel.active {
            display: flex;
        }

        .notebook-main {
            flex: 1;
            background: #fff;
            overflow-y: auto;
            padding: 1rem;
        }

        .file-browser-header {
            background: #fff;
            padding: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .file-browser-header h3 {
            margin: 0 0 0.5rem 0;
            color: #222;
            font-size: 1rem;
        }

        .file-browser-controls {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .file-browser-controls .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        .search-box {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: #fff;
            color: #222;
        }

        .search-box::placeholder {
            color: #999;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            max-height: calc(100vh - 280px);
        }
        .file-tree {
            display: flex !important;
            flex-direction: column !important;
        }
        .file-item {
            display: block !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        .file-row {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
        }
        .file-info {
            display: flex !important;
            align-items: center !important;
            flex: 1 !important;
            min-width: 0 !important;
            overflow: hidden !important;
        }
        .file-actions {
            display: flex !important;
            align-items: center !important;
            color: #111 !important;
        }
        .file-action-btn {
            color: #111 !important;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* depthì— ë”°ë¥¸ ë“¤ì—¬ì“°ê¸° */
        .file-item[data-depth="1"] { padding-left: 2rem !important; }
        .file-item[data-depth="2"] { padding-left: 3rem !important; }
        .file-item[data-depth="3"] { padding-left: 4rem !important; }
        .file-item[data-depth="4"] { padding-left: 5rem !important; }
        
        /* ì…€ ì¶œë ¥ ìŠ¤íƒ€ì¼ */
        .cell-output-running {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            color: #856404;
        }
        
        .cell-output-new {
            background: #d4edda;
            border-left: 3px solid #28a745;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            white-space: pre-wrap;
            color: #155724;
        }
        .file-item[data-depth="5"] { padding-left: 6rem !important; }

        .file-item.selected {
            background: #f8f9fa !important;
            border-left: 3px solid #999 !important;
        }

        .file-name {
            flex: 1 !important;
            margin-left: 0 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            min-width: 0 !important;
            font-size: 0.85rem !important;
        }

        .folder-toggle {
            cursor: pointer !important;
            color: #666 !important;
            font-size: 0.8rem !important;
            margin-right: 0.3rem !important;
            user-select: none !important;
            flex-shrink: 0 !important;
        }

        .folder-children {
            display: none !important;
            flex-direction: column !important;
            width: 100% !important;
        }

        .folder-children.expanded {
            display: flex !important;
            flex-direction: column !important;
        }

        .file-icon::before {
            margin-right: 0 !important;
        }

        .folder-item .file-icon::before {
            content: "" !important;
        }

        .file-item:not(.folder-item) .file-icon::before {
            content: "" !important;
        }

        .file-action-btn {
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 0.2rem !important;
            border-radius: 3px !important;
            color: #666 !important;
            flex-shrink: 0 !important;
        }

        /* ë…¸íŠ¸ë¶ ì…€ ìŠ¤íƒ€ì¼ */
        .notebook-toolbar {
            background: #4a5568;
            border: 1px solid #718096;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ì…€ ìŠ¤íƒ€ì¼ì€ CSS íŒŒì¼ì—ì„œ ê´€ë¦¬ */

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ì…€ ìƒíƒœ ìŠ¤íƒ€ì¼ì€ CSS íŒŒì¼ì—ì„œ ê´€ë¦¬ */

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* ë¡œë”© ë° ì—ëŸ¬ ìƒíƒœ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            color: #dc3545;
            padding: 1rem;
            background: #f8d7da;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .success-message {
            color: #155724;
            padding: 1rem;
            background: #d4edda;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .empty-content {
            text-align: center;
            padding: 2rem;
            color: #aaa;
        }

        .empty-content div {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .current-file-info {
            background: #f5f6fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #222;
        }

        .current-file-info span {
            font-weight: 600;
            color: #63b3ed;
        }

        .file-tabs {
            display: flex;
            align-items: center;
            background: #f5f6fa;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 100;
            height: 48px;
            padding-left: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: #718096 #1a202c;
        }

        .file-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .file-tabs::-webkit-scrollbar-track {
            background: #1a202c;
        }

        .file-tabs::-webkit-scrollbar-thumb {
            background: #718096;
            border-radius: 3px;
        }

        .file-tabs::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .file-tabs-container {
            display: flex;
            align-items: center;
            min-width: max-content;
            padding-right: 1rem;
        }
        .file-tab {
            display: flex;
            align-items: center;
            background: #f5f6fa;
            color: #222;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 0.5rem;
            padding: 0.5rem 1.2rem 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.95rem;
            position: relative;
            transition: background 0.2s, color 0.2s;
        }
        .file-tab.active {
            background: #fff;
            color: #222;
            border-color: #ddd;
        }
        .file-tab .close-btn {
            margin-left: 0.7rem;
            color: #666;
            font-size: 1.1rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 0.2rem;
            border-radius: 3px;
        }
        .file-tab .close-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        /* crawl ì…€ ìŠ¤íƒ€ì¼ */
        .crawl-cell-content {
            padding: 0.5rem;
        }

        .crawl-controls {
            margin-bottom: 1rem;
        }

        .crawl-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .crawl-row label {
            min-width: 100px;
            font-weight: 500;
            color: #222;
            font-size: 0.8rem;
        }

        .crawl-row select,
        .crawl-row input {
            flex: 1;
            padding: 0.5rem 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #000;
            font-size: 0.8rem;
            min-height: 35px;
            transition: all 0.2s ease;
        }

        .crawl-row select:focus,
        .crawl-row input:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            background: #fff;
        }

        .crawl-row select:hover,
        .crawl-row input:hover {
            border-color: #999;
            background: #fff;
        }

        .crawl-params {
            margin-top: 1.5rem;
        }

        .crawl-param-field {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .crawl-param-field label {
            min-width: 120px;
            font-weight: 500;
            color: #222;
            font-size: 0.8rem;
        }

        .crawl-param-field input,
        .crawl-param-field select {
            flex: 1;
            padding: 0.5rem 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #000;
            font-size: 0.8rem;
            min-height: 35px;
            transition: all 0.2s ease;
        }

        .crawl-param-field input:focus,
        .crawl-param-field select:focus {
            outline: none;
            border-color: #999;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            background: #fff;
        }

        .crawl-param-field input:hover,
        .crawl-param-field select:hover {
            border-color: #999;
            background: #fff;
        }

        /* JSON ì¶œë ¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .xml-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .xml-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ddd;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: #fff;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #666;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        /* JSON ì¶œë ¥ ì„¹ì…˜ */
        .xml-output-section {
            margin-top: 1rem;
            border-top: 1px solid #e0e0e0;
            padding-top: 1rem;
        }

        .xml-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .xml-header h4 {
            margin: 0;
            color: #222;
            font-size: 0.9rem;
        }

        .xml-copy-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #e2e8f0;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .xml-copy-btn:hover {
            background: #63b3ed;
            border-color: #63b3ed;
        }

        .xml-output-textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.8rem;
            border: 1px solid #718096;
            border-radius: 4px;
            background: #1a202c;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            resize: vertical;
        }

        .xml-output-textarea:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.2);
        }

        /* Crawl ì…€ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
        .crawl-cell-content {
            padding: 1rem;
        }

        .crawl-controls {
            margin-bottom: 1rem;
        }

        .crawl-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            gap: 0.8rem;
        }

        .crawl-row label {
            min-width: 80px;
            font-weight: 500;
            color: #e2e8f0;
        }

        .crawl-row select,
        .crawl-row input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: #000;
        }

        .crawl-params {
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .jupyter-layout {
                flex-direction: column;
                height: auto;
            }
            
            .file-browser-sidebar {
                width: 100%;
                height: 300px;
            }
        }

        .crawl-row select,
        .crawl-row input,
        .crawl-param-field input,
        .crawl-param-field select {
            flex: 1;
            padding: 0.4rem 0.7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            color: #000;
            font-size: 0.8rem;
            min-height: 32px;
            transition: all 0.2s ease;
        }

        .crawl-row label,
        .crawl-param-field label {
            font-size: 0.92rem;
            min-width: 90px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ““ NP Notebook</h1>
        <div class="nav-links">
            <a href="/?file={{ selected_file }}" class="nav-link">í™ˆ</a>
            <a href="/worker?file={{ selected_file }}" class="nav-link">Worker</a>
            <a href="/jobs?file={{ selected_file }}" class="nav-link">Jobs</a>
            <a href="/kernel" class="nav-link">ì»¤ë„</a>
        </div>
    </div>

    <!-- íŒŒì¼ë³„ íƒ­ ë°” -->
    <div class="file-tabs" id="fileTabs">
        <div class="file-tabs-container"></div>
    </div>

    <div class="jupyter-layout">
        <!-- íŒŒì¼ ë¸Œë¼ìš°ì € ì‚¬ì´ë“œë°” -->
        <div class="file-browser-sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchSidebarTab('fileTreePanel')" title="íŒŒì¼ íƒìƒ‰ê¸°">ğŸ“</div>
                <div class="sidebar-tab" onclick="switchSidebarTab('kernelPanel')" title="ì»¤ë„">ğŸ§ </div>
            </div>
            <div class="sidebar-content">
                <div id="fileTreePanel" class="sidebar-panel active">
                    <div class="file-browser-header">
        
                        <div class="file-browser-controls">
                            <button class="btn btn-primary" onclick="refreshFileTree()">ìƒˆë¡œê³ ì¹¨</button>
                            <button class="btn btn-success" onclick="createNewFile()">ìƒˆ íŒŒì¼</button>
                            <button class="btn btn-secondary" onclick="uploadFile()">ì—…ë¡œë“œ</button>
                        </div>
                        <input type="text" class="search-box" placeholder="íŒŒì¼ ê²€ìƒ‰..." onkeyup="filterFiles(this.value)">
                    </div>
                    <div class="file-tree" id="fileTree">
                        <div class="loading">
                            <div class="spinner"></div>
                            íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
                <div id="kernelPanel" class="sidebar-panel">
                    <div class="file-browser-header">
                        <h3 style="color: #000000;">ğŸ§  ì»¤ë„ ê´€ë¦¬</h3>
                    </div>
                    <div style="padding: 1rem; color: #000000; font-size: 0.9rem;">
                        <div style="margin-bottom: 1rem;">
                            <strong>í˜„ì¬ í™œì„± ì»¤ë„:</strong><br>
                            <span id="currentKernelInfo">ì—†ìŒ</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>í™œì„± ì»¤ë„ ìƒíƒœ:</strong><br>
                            <span id="kernelStatusText">ì¤€ë¹„ë¨</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ì—´ë¦° íŒŒì¼:</strong><br>
                            <div id="openFilesList" style="font-size: 0.8rem; margin-top: 0.5rem;">
                                ì—†ìŒ
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ëª¨ë“  ì»¤ë„ ëª©ë¡:</strong><br>
                            <div id="allKernelsList" style="font-size: 0.8rem; margin-top: 0.5rem;">
                                ì—†ìŒ
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #718096;">
                            <strong>ì»¤ë„ ì •ë¦¬:</strong><br>
                            <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                <button class="btn btn-warning" onclick="cleanupInactiveKernels()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                                    ğŸ§¹ ë¹„í™œì„± ì»¤ë„ ì •ë¦¬
                                </button>
                                <button class="btn btn-danger" onclick="cleanupAllKernels()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                                    ğŸ’¥ ëª¨ë“  ì»¤ë„ ì •ë¦¬
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë…¸íŠ¸ë¶ ë©”ì¸ ì˜ì—­ -->
        <div class="notebook-main">
            <!-- í˜„ì¬ íŒŒì¼ ì •ë³´ ë° ì €ì¥ ë²„íŠ¼ -->
            <div id="currentFileInfo" style="display: none;" class="current-file-info">
                <span id="currentFileName"></span>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span id="kernelStatusDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background: #4a5568; border-radius: 4px; color: #000000;">
                        ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±
                    </span>
                    <span id="kernelTimeDisplay" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background: #2d3748; border-radius: 4px; color: #ffffff;">
                        ë‚¨ì€ ì‹œê°„: --:--:--
                    </span>
                    <button class="btn btn-primary" onclick="initializeKernel()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                        ğŸ”„ ì»¤ë„ ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-success" onclick="extendKernelTimeout()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                        â° 12ì‹œê°„ ì—°ì¥
                    </button>
                    <button class="btn btn-danger" onclick="shutdownKernel()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                        â¹ï¸ ì»¤ë„ ì¢…ë£Œ
                    </button>
                    <button class="btn btn-secondary" onclick="saveNotebookToFile()" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                        ğŸ’¾ ë…¸íŠ¸ë¶ ì €ì¥
                    </button>
                </div>
            </div>
            
            <!-- ë…¸íŠ¸ë¶ ì…€ë“¤ -->
            <div id="notebookCells"></div>
            
            <!-- í•˜ë‹¨ ë¹ˆ ê³µê°„ (ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì—¬ë°±) -->
            <div style="height: 200px; padding: 20px; text-align: center; color: #a0aec0; font-size: 0.9rem;">
                <div style="margin-top: 50px;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“</div>
                    <div>ë…¸íŠ¸ë¶ ë</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">ë” ë§ì€ ì…€ì„ ì¶”ê°€í•˜ë ¤ë©´ ìœ„ì˜ â• ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span>ğŸ““ NP Notebook v1.0</span>
            </div>
            <div class="footer-right">
                <span id="footer-status">ì¤€ë¹„ë¨</span>
            </div>
        </div>
    </footer>

    <!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
    <div class="context-menu" id="contextMenu" style="display: none;">
        <div class="context-menu-item" onclick="openFile()">ì—´ê¸°</div>
        <div class="context-menu-item" onclick="renameFile()">ì´ë¦„ ë³€ê²½</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="copyFilePath()">ê²½ë¡œ ë³µì‚¬</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteFile()" style="color: #dc3545;">ì‚­ì œ</div>
    </div>

    <script src="{{ url_for('static', filename='js/screenshot-monitor.js') }}"></script>

    <script>
        let currentFile = null;
        let fileTreeData = [];
        let selectedFileItem = null;
        let cellCounter = 0;
        let cells = [];
        let openFiles = [];
        let fileCells = {}; // { filePath: [cell, ...] }
        let fileKernels = {}; // { filePath: kernelId }
        let activeFile = null;

        // ì…€ ì‹¤í–‰ í ì‹œìŠ¤í…œ
        let cellExecutionQueue = []; // ì‹¤í–‰ ëŒ€ê¸° ì¤‘ì¸ ì…€ë“¤
        let isExecuting = false; // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
        let currentExecutingCell = null; // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì…€ ID

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // íŒŒì¼ ë¸Œë¼ìš°ì € ì½œë°± ì„¤ì •
            window.onFileSelect = selectFile;
            
            loadFileTree();
            setupEventListeners();
            loadJobTypes();
            
            // ìƒˆë¡œê³ ì¹¨ ì‹œ ì»¤ë„ ìƒíƒœ ë³µì›
            restoreKernelState();
            
            // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ ê¸°ë³¸ ì…€ ì¶”ê°€
            if (!activeFile) {
                addCell(); // ì²« ë²ˆì§¸ ì…€ ì¶”ê°€
            }
            
            // í™œì„± íŒŒì¼ì´ ìˆìœ¼ë©´ ì‹œê°„ì œí•œ ì—…ë°ì´íŠ¸ ì‹œì‘
            if (activeFile) {
                startKernelTimeUpdate();
            }
            // checkKernelStatus(); // ì„¸ì…˜ ì»¤ë„ ìƒíƒœ í™•ì¸ ì œê±°
        });
        
        // Job Types ë¡œë“œ
        async function loadJobTypes() {
            try {
                const response = await fetch('/api/job_types');
                const data = await response.json();
                window.jobTypes = data.job_types;
                window.focusTypes = data.focus_types;
        
            } catch (error) {
                console.error('Failed to load job types:', error);
            }
        }

        // ê¸°ì¡´ íŒŒì¼ ë¸Œë¼ìš°ì € í•¨ìˆ˜ë“¤...
        function setupEventListeners() {
            // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // ESC í‚¤ë¡œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });

        }

        // ì„œë²„ì—ì„œ í™œì„± ì»¤ë„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function restoreKernelState() {
            // ì„œë²„ì—ì„œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ë³µì›
            fetch('/api/kernels/file-mappings')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.mappings) {
        
                        
                        // ì„œë²„ì˜ ë§¤í•‘ ì •ë³´ë¥¼ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¡œ ë³µì›
                        fileKernels = data.mappings;
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateKernelInfo();
                        
                        // ê° íŒŒì¼ì˜ ì»¤ë„ ìƒíƒœ í™•ì¸
                        Object.keys(fileKernels).forEach(filePath => {
                            const kernelId = fileKernels[filePath];

                        });
                    }
                })
                .catch(error => {
                    console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                });
        }

        function loadFileTree() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    fileTreeData = data.files || [];
                    renderFileTree(fileTreeData);
                })
                .catch(error => {
                    console.error('íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('fileTree').innerHTML = 
                        '<div class="error-message">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                });
        }

        function renderFileTree(files) {
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = '';
            if (!files || files.length === 0) {
                fileTree.innerHTML = '<div class="empty-content"><p>íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            files.forEach(file => {
                const fileItem = createFileItemRecursive(file, 0);
                fileTree.appendChild(fileItem);
            });
        }

        function createFileItemRecursive(file, depth = 0) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.setAttribute('data-path', file.path);
            fileItem.setAttribute('data-type', file.type);
            fileItem.setAttribute('data-depth', depth);

            // í´ë”/íŒŒì¼ ì•„ì´ì½˜
            let folderIcon = '';
            if (file.type === 'directory') {
                folderIcon = '<span class="folder-toggle" style="user-select:none;cursor:pointer;">â–¶</span>';
            }

            fileItem.innerHTML = `
                <div class="file-row">
                    <div class="file-info">
                        ${folderIcon}
                        <span class="file-icon"></span>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn" onclick="event.stopPropagation(); showContextMenu(event, '${file.path}')">â‹®</button>
                    </div>
                </div>
            `;

            // í´ë” í´ë¦­ ì‹œ children í† ê¸€
            if (file.type === 'directory') {
                fileItem.addEventListener('click', function(e) {
                    e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
                    if (e.target.classList.contains('folder-toggle')) {
                        const childrenContainer = fileItem.querySelector('.folder-children');
                        const toggle = fileItem.querySelector('.folder-toggle');
                        if (childrenContainer) {
                            const isOpen = childrenContainer.classList.contains('expanded');
                            if (isOpen) {
                                childrenContainer.classList.remove('expanded');
                                toggle.textContent = 'â–¶';
                            } else {
                                childrenContainer.classList.add('expanded');
                                toggle.textContent = 'â–¼';
                            }
                        }
                    }
                });
            } else {
                fileItem.addEventListener('click', (e) => {
                    e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
                    selectFile(file);
                });
            }

            fileItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, file.path);
            });

            // childrenì´ ìˆìœ¼ë©´ ì¬ê·€ì ìœ¼ë¡œ ë Œë”ë§, ê¸°ë³¸ì€ ë‹«í˜
            if (file.type === 'directory' && file.children && file.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'folder-children';
                file.children.forEach(child => {
                    const childItem = createFileItemRecursive(child, depth + 1);
                    childrenContainer.appendChild(childItem);
                });
                fileItem.appendChild(childrenContainer);
            }

            return fileItem;
        }

        // íŒŒì¼ ë¸Œë¼ìš°ì €ì—ì„œ íŒŒì¼ í´ë¦­ ì‹œ
        function selectFile(file) {
            // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (imageExtensions.includes(fileExtension)) {
                // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ëª¨ë‹¬ì—ì„œ ì´ë¯¸ì§€ ë³´ì—¬ì£¼ê¸°
                showImageModal(file);
                return;
            }
            
            // íƒ­ì´ ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ í•´ë‹¹ íƒ­ìœ¼ë¡œ ì „í™˜
            if (openFiles.includes(file.path)) {
                setActiveFileTab(file.path);
                return;
            }
            // íƒ­ ì¶”ê°€
            openFiles.push(file.path);
            renderFileTabs();
            setActiveFileTab(file.path);
            
            // íŒŒì¼ë³„ ìƒˆë¡œìš´ ì»¤ë„ ìƒì„± ì œê±° - ìˆ˜ë™ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ë„ë¡ ë³€ê²½
            // const fileName = file.name.toLowerCase();
            // if (fileName.endsWith('.py') || fileName.endsWith('.ipynb') || fileName.endsWith('.npn')) {
            //     createKernelForFile(file.path);
            // }
            
            // íŒŒì¼ ë‚´ìš© ë¡œë“œ ë° ì…€ ìƒì„±
            fetch(`/api/files/content?path=${encodeURIComponent(file.path)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', data.message);
                        return;
                    }
                    
                    let cells = [];
                    
                    if (!data.content) {
                        cells.push({ content: '', output: '', status: 'idle', id: null });
                        fileCells[file.path] = cells;
                        renderNotebookCells();
                        return;
                    }
                    
                    // ipynb/npn íŒŒì¼ ì²˜ë¦¬
                    if (file.name.endsWith('.ipynb') || file.name.endsWith('.npn')) {
                        try {
                            const notebook = JSON.parse(data.content);
                            if (notebook.cells && Array.isArray(notebook.cells)) {
                                notebook.cells.forEach(cell => {
                                    let content = '';
                                    let cellType = cell.cell_type;
                                    
                                    if (cell.cell_type === 'code') {
                                        const source = cell.source || '';
                                        content = Array.isArray(source) ? source.join('') : source;
                                    } else if (cell.cell_type === 'markdown') {
                                        const source = cell.source || '';
                                        content = `# ${Array.isArray(source) ? source.join('') : source}`;
                                    } else if (cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') {
                                        const source = cell.source || '';
                                        
                                        if (Array.isArray(source)) {
                                            content = source.join('');
                                        } else if (typeof source === 'object' && source !== null) {
                                            content = JSON.stringify(source, null, 2);
                                        } else {
                                            content = source;
                                        }
                                    }
                                    
                                    const cellData = {
                                        content: content, 
                                        output: '', 
                                        status: 'idle', 
                                        id: null,
                                        cell_type: cellType
                                    };
                                    
                                    // ipynb í‘œì¤€ outputsë¥¼ output_historyë¡œ ë³€í™˜
                                    if (cell.outputs && Array.isArray(cell.outputs)) {
                                        cellData.output_history = cell.outputs.map(output => ({
                                            timestamp: new Date().toISOString(),
                                            output: output.text || output.data || '',
                                            execution_count: cell.execution_count || 1
                                        }));
                                    } else if (cell.output_history) {
                                        cellData.output_history = cell.output_history;
                                    }
                                    
                                    cells.push(cellData);
                                });
                            } else {
                                cells.push({ content: data.content, output: '', status: 'idle', id: null });
                            }
                        } catch (e) {
                            cells.push({ content: data.content, output: '', status: 'idle', id: null });
                        }
                    } else {
                        // ì¼ë°˜ íŒŒì¼
                        cells.push({ content: data.content, output: '', status: 'idle', id: null });
                    }
                    
                    fileCells[file.path] = cells;
                    
                    // crawl ì…€ë“¤ì— ìë™ ë²ˆí˜¸ ë¶€ì—¬
                    cells.forEach((cell, index) => {
                        if ((cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') && (!cell.name || cell.name === '')) {
                            cell.name = `Crawl_${index + 1}`;
                        }
                    });
                    
                    renderNotebookCells();
                    // ë¹ˆ íŒŒì¼(0ê°œ ì…€)ì¼ ë•Œ ìë™ìœ¼ë¡œ ì…€ ì¶”ê°€
                    if (fileCells[file.path] && fileCells[file.path].length === 0) {
                        activeFile = file.path;
                        addCell();
                    }
                });
        }

        // íŒŒì¼ë³„ ì»¤ë„ ìƒì„±
        function createKernelForFile(filePath) {
            
            
            // íŒŒì¼ íƒ€ì… ì²´í¬
            const fileName = filePath.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {

                return;
            }
            
            fetch('/api/kernels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}) // ë¹ˆ JSON ê°ì²´ ì¶”ê°€
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    fileKernels[filePath] = data.kernel_id;
                    const kernelIdStr = typeof data.kernel_id === 'object' ? JSON.stringify(data.kernel_id) : String(data.kernel_id);

                    updateKernelInfo();
                    // ì»¤ë„ ìƒì„± í›„ ìƒíƒœ í™•ì¸
                    setTimeout(() => checkKernelStatus(), 1000);
                } else {
                    console.error('ì»¤ë„ ìƒì„± ì‹¤íŒ¨:', data.error || data.message);
                    alert(`ì»¤ë„ ìƒì„± ì‹¤íŒ¨: ${data.error || data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            })
            .catch(error => {
                console.error('ì»¤ë„ ìƒì„± ì˜¤ë¥˜:', error);
                alert(`ì»¤ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            });
        }

        function renderFileTabs() {
            const fileTabs = document.getElementById('fileTabs');
            const fileTabsContainer = fileTabs.querySelector('.file-tabs-container');
            fileTabsContainer.innerHTML = '';
            openFiles.forEach(path => {
                const tab = document.createElement('div');
                tab.className = 'file-tab' + (activeFile === path ? ' active' : '');
                
                // íŒŒì¼ëª… í‘œì‹œ
                const fileName = path.split('/').pop();
                const hasKernel = fileKernels[path];
                const kernelIcon = hasKernel ? 'ğŸ§ ' : 'âšª';
                tab.innerHTML = `<span>${kernelIcon} ${fileName}</span>`;
                
                tab.onclick = () => setActiveFileTab(path);
                // ë‹«ê¸° ë²„íŠ¼
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeFileTab(path);
                };
                tab.appendChild(closeBtn);
                fileTabsContainer.appendChild(tab);
            });
        }

        function setActiveFileTab(path) {
            activeFile = path;
            renderFileTabs();
            renderNotebookCells();
            // íŒŒì¼ëª… ë° ì €ì¥ ë²„íŠ¼ í‘œì‹œ
            document.getElementById('currentFileInfo').style.display = 'flex';
            const fileName = path.split('/').pop();
            
            const hasKernel = fileKernels[path];
            const kernelId = hasKernel ? fileKernels[path] : 'ì—†ìŒ';
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            document.getElementById('currentFileName').textContent = fileName;
            
            // ì»¤ë„ ì´ˆê¸°í™” ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const initButton = document.querySelector('#currentFileInfo .btn-primary');
            if (initButton) {
                initButton.innerHTML = hasKernel ? 'ğŸ”„ ì»¤ë„ ì¬ì‹œì‘' : 'ğŸ”„ ì»¤ë„ ì´ˆê¸°í™”';
            }
            
            // ì…€ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì…€ ì¶”ê°€
            if (!fileCells[path] || fileCells[path].length === 0) {
                addCell();
            }
            
            // ì»¤ë„ ì •ë³´ ì—…ë°ì´íŠ¸ ë° ì‹œê°„ì œí•œ ì—…ë°ì´íŠ¸ ì‹œì‘
            updateKernelInfo();
            startKernelTimeUpdate();
        }

        function closeFileTab(path) {
            const idx = openFiles.indexOf(path);
            if (idx !== -1) {
                openFiles.splice(idx, 1);
                delete fileCells[path];
                
                // í•´ë‹¹ íŒŒì¼ì˜ ì»¤ë„ ì¢…ë£Œ
                if (fileKernels[path]) {
                    shutdownKernelForFile(path);
                }
                delete fileKernels[path];
                
                // íƒ­ ë‹«ì€ í›„ ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
                if (openFiles.length > 0) {
                    setActiveFileTab(openFiles[Math.max(0, idx - 1)]);
                } else {
                    activeFile = null;
                    renderFileTabs();
                    document.getElementById('notebookCells').innerHTML = '';
                    document.getElementById('currentFileInfo').style.display = 'none';
                }
            }
        }

        // íŒŒì¼ë³„ ì»¤ë„ ì¢…ë£Œ
        function shutdownKernelForFile(filePath) {
            const kernelId = fileKernels[filePath];
            if (!kernelId) return;
            
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            if (!confirm(`"${filePath.split('/').pop()}" íŒŒì¼ì˜ ì»¤ë„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            fetch(`/api/kernels/${kernelIdStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {

                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ì»¤ë„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: ${filePath.split('/').pop()}`;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ì„œë²„ì—ì„œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±°
                    fetch('/api/kernels/file-mapping', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file_path: filePath
                        })
                    })
                    .then(response => response.json())
                    .then(mappingData => {
                        if (!mappingData.success) {
                            console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì‹¤íŒ¨:', mappingData.error);
                        }
                    })
                    .catch(error => {
                        console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì˜¤ë¥˜:', error);
                    });
                    
                    // ì»¤ë„ ID ì œê±°
                    delete fileKernels[filePath];
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateKernelInfo();
                    
                    // ë§Œì•½ ì¢…ë£Œëœ ì»¤ë„ì´ í˜„ì¬ í™œì„± íŒŒì¼ì˜ ì»¤ë„ì´ì—ˆë‹¤ë©´
                    if (filePath === activeFile) {
                        document.getElementById('currentKernelInfo').textContent = 'ì—†ìŒ';
                        document.getElementById('kernelStatusText').textContent = 'ì»¤ë„ ì—†ìŒ';
                    }
                } else {
                    alert(data.message || 'ì»¤ë„ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì»¤ë„ ì¢…ë£Œ ì˜¤ë¥˜:', error);
                alert('ì»¤ë„ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function renderNotebookCells() {
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            
            // ëª¨ë“  ì…€ì˜ textarea í¬ê¸° ìë™ ì¡°ì •
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ì…€ ì¶”ê°€ í•¨ìˆ˜ (íŒŒì¼ë³„)
        function addCell(content = '', cellId = null) {
            if (!activeFile) return;
            const cells = fileCells[activeFile] || [];
            
            // ìƒˆ ì…€ ìƒì„±
            const newCell = {
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: content,
                output: '',
                status: '',
                cell_type: 'code' // ê¸°ë³¸ ì…€ íƒ€ì…ì„ codeë¡œ ì„¤ì •
            };
            
            if (cellId) {
                // íŠ¹ì • ì…€ ë‹¤ìŒì— ì¶”ê°€
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, newCell);
                } else {
                    cells.push(newCell);
                }
            } else {
                // ë§¨ ë§ˆì§€ë§‰ì— ì¶”ê°€
                cells.push(newCell);
            }
            
            fileCells[activeFile] = cells;
            renderNotebookCells();
            
            // ìƒˆ ì…€ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const textarea = document.getElementById(newCell.id)?.querySelector('.cell-input');
                if (textarea) textarea.focus();
            }, 50);
            return newCell;
        }

        // ì…€ ìƒì„± í•¨ìˆ˜ (íŒŒì¼ë³„)
        function createCellElement(cell, idx) {
            const cellDiv = document.createElement('div');
            cellDiv.className = 'cell';
            cellDiv.id = cell.id;
            
            // í˜„ì¬ íŒŒì¼ì˜ ì…€ ê°œìˆ˜ í™•ì¸
            const currentCells = fileCells[activeFile] || [];
            const isOnlyCell = currentCells.length === 1;
            
            // crawl íƒ€ì… ì…€ì¸ì§€ í™•ì¸
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            const isJsonMode = cell.cell_type === 'crawl_json';
            
            if (isCrawlCell) {
                // crawl ì…€ìš© UI
                cellDiv.innerHTML = `
                    <div class="cell-header">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-number">Crawl [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            <div class="cell-name-input">
                                <input type="text" id="cell-name-${cell.id}" placeholder="ì…€ ì´ë¦„" value="${cell.name || ''}" onchange="updateCellName('${cell.id}', this.value)" style="width: 120px; padding: 0.3rem 0.5rem; font-size: 0.8rem; border: 1px solid #718096; border-radius: 4px; background: #4a5568; color: #e2e8f0;">
                            </div>
                            <div class="xml-toggle">
                                <label class="switch">
                                    <input type="checkbox" id="xml-toggle-${cell.id}" onchange="toggleJsonOutput('${cell.id}')" ${isJsonMode ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <span class="xml-label">JSON</span>
                            </div>
                            <button class="cell-btn run" onclick="runCell('${cell.id}')" title="ì‹¤í–‰">â–¶ï¸</button>
                            <button class="cell-btn add" onclick="addCell('', '${cell.id}')" title="ì…€ ì¶”ê°€">â•</button>
                            ${isOnlyCell ? '' : `<button class="cell-btn delete" onclick="deleteCell('${cell.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>`}
                            ${activeFile && activeFile.toLowerCase().endsWith('.npn') ? `<button class="cell-btn add" onclick="addCrawlCell('${cell.id}')" title="ìˆ˜ì§‘ ì¶”ê°€">ğŸ•·ï¸</button>` : ''}
                        </div>
                    </div>
                    <div class="crawl-cell-content">
                        <div class="crawl-controls" id="crawl-controls-${cell.id}" ${isJsonMode ? 'style="display: none;"' : ''}>
                            <div class="crawl-row">
                                <label>Job Type:</label>
                                <select class="crawl-job-type" onchange="updateCrawlCell('${cell.id}', 'job_type', this.value)">
                                    <option value="do">Do</option>
                                    <option value="find">Find</option>
                                    <option value="data">Data</option>
                                    <option value="save">Save</option>
                                    <option value="load">Load</option>
                                    <option value="python">Python</option>
                                    <option value="wait">Wait</option>
                                    <option value="request">Request</option>
                                    <option value="run">Run</option>
                                    <option value="test">Test</option>
                                </select>
                            </div>
                            <div class="crawl-row">
                                <label id="action-label-${cell.id}">Action:</label>
                                <select class="crawl-action" onchange="updateCrawlCell('${cell.id}', 'action', this.value)">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                            <div class="crawl-params" id="crawl-params-${cell.id}">
                                <!-- ë™ì ìœ¼ë¡œ íŒŒë¼ë¯¸í„° í•„ë“œë“¤ì´ ìƒì„±ë¨ -->
                            </div>
                        </div>
                        <div class="xml-output-section" id="xml-output-${cell.id}" ${isJsonMode ? '' : 'style="display: none;"'}>
                            <div class="xml-header">
                                <h4>JSON ì¶œë ¥</h4>
                                <button class="xml-copy-btn" onclick="copyJsonOutput('${cell.id}')" title="JSON ë³µì‚¬">ğŸ“‹</button>
                            </div>
                            <textarea class="xml-output-textarea" id="xml-content-${cell.id}" placeholder="JSON ì¶œë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..." oninput="updateJsonContent('${cell.id}'); autoResizeTextarea(this)"></textarea>
                        </div>
                    </div>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
                
                // crawl ì…€ ì´ˆê¸°í™”
                setTimeout(() => {
                    initializeCrawlCell(cell.id, cell.content);
                    
                    // crawl_json íƒ€ì…ì¼ ë•ŒëŠ” JSON ì¶œë ¥ ìë™ ìƒì„± (ë¹ˆ ë‚´ìš©ì¼ ë•Œë§Œ)
                    if (cell.cell_type === 'crawl_json') {
                        setTimeout(() => {
                            const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                            if (jsonTextarea && !jsonTextarea.value.trim()) {
                                generateJsonOutput(cell.id);
                            }
                        }, 100);
                    }
                }, 10);
            } else {
                // ì¼ë°˜ ì½”ë“œ ì…€
                cellDiv.innerHTML = `
                    <div class="cell-header">
                        <div style="display: flex; align-items: center;">
                            <span class="cell-number">In [${idx + 1}]:</span>
                            <span class="execution-count" id="exec-${cell.id}"></span>
                            <span class="cell-status ${cell.status}" id="status-${cell.id}"></span>
                        </div>
                        <div class="cell-actions">
                            <button class="cell-btn run" onclick="runCell('${cell.id}')" title="ì‹¤í–‰">â–¶ï¸</button>
                            <button class="cell-btn add" onclick="addCell('', '${cell.id}')" title="ì…€ ì¶”ê°€">â•</button>
                            ${isOnlyCell ? '' : `<button class="cell-btn delete" onclick="deleteCell('${cell.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>`}
                            ${activeFile && activeFile.toLowerCase().endsWith('.npn') ? `<button class="cell-btn add" onclick="addCrawlCell('${cell.id}')" title="ìˆ˜ì§‘ ì¶”ê°€">ğŸ•·ï¸</button>` : ''}
                        </div>
                    </div>
                    <textarea class="cell-input" placeholder="Python ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKeyDown(event, '${cell.id}')" oninput="autoResizeTextarea(this)">${cell.content}</textarea>
                    <div class="cell-output" id="output-${cell.id}" style="display: none;"></div>
                `;
            }

            // ì…€ ìƒì„± í›„ textarea í¬ê¸° ìë™ ì¡°ì • ë° output ë¡œë“œ
            setTimeout(() => {
                const textarea = cellDiv.querySelector('.cell-input');
                if (textarea) {
                    autoResizeTextarea(textarea);
                }
                
                // ì €ì¥ëœ output ë¡œë“œ
                loadCellOutput(cell.id);
            }, 10);

            return cellDiv;
        }

        function autoResizeTextarea(textarea) {
            // ë†’ì´ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ ì •í™•í•œ ìŠ¤í¬ë¡¤ ë†’ì´ ê³„ì‚°
            textarea.style.height = 'auto';
            
            // ë‚´ìš©ì— ë”°ë¥¸ ë†’ì´ ê³„ì‚° (ìµœì†Œ 100px, ë¼ì¸ë‹¹ ì•½ 20px)
            const minHeight = 100;
            const lineHeight = 20;
            const lines = textarea.value.split('\n').length;
            const calculatedHeight = Math.max(minHeight, lines * lineHeight);
            
            // ë†’ì´ ì„¤ì •
            textarea.style.height = calculatedHeight + 'px';
            
            // ìŠ¤í¬ë¡¤ë°”ê°€ ìƒê¸°ì§€ ì•Šë„ë¡ ì¶”ê°€ ì¡°ì •
            if (textarea.scrollHeight > calculatedHeight) {
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }

        // ì…€ output ì €ì¥ í•¨ìˆ˜
        function saveCellOutput(cellId, output) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell) {
                // output íˆìŠ¤í† ë¦¬ ë°°ì—´ ì´ˆê¸°í™”
                if (!cell.output_history) {
                    cell.output_history = [];
                }
                
                // ìƒˆë¡œìš´ outputìœ¼ë¡œ ë®ì–´ì“°ê¸° (ì´ì „ íˆìŠ¤í† ë¦¬ ì œê±°)
                cell.output_history = [{
                    timestamp: new Date().toISOString(),
                    output: output,
                    execution_count: cell.execution_count || 1
                }];
                
                // íŒŒì¼ì— ì €ì¥
                saveNotebookToFile();
            }
        }

        // ì…€ output ë¡œë“œ í•¨ìˆ˜
        function loadCellOutput(cellId) {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (cell && cell.output_history && cell.output_history.length > 0) {
                const outputDiv = document.getElementById(`output-${cellId}`);
                if (outputDiv) {
                    outputDiv.style.display = 'block';
                    
                    // ê¸°ì¡´ output ì œê±°
                    outputDiv.innerHTML = '';
                    
                    // ê°€ì¥ ìµœê·¼ outputë§Œ í‘œì‹œ (ë®ì–´ì“°ê¸° ë°©ì‹)
                    const latestEntry = cell.output_history[cell.output_history.length - 1];
                    const outputEntryDiv = document.createElement('div');
                    outputEntryDiv.className = 'cell-output-new';
                    outputEntryDiv.textContent = latestEntry.output;
                    outputEntryDiv.setAttribute('data-timestamp', latestEntry.timestamp);
                    outputEntryDiv.setAttribute('data-execution-count', latestEntry.execution_count);
                    outputDiv.appendChild(outputEntryDiv);
                }
            }
        }

        function handleKeyDown(event, cellId) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                runCell(cellId);
            } else if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                addCellAfter(cellId);
            } else if (event.key === 's' && event.ctrlKey) {
                event.preventDefault();
                saveNotebookToFile();
            }
        }

        // ì…€ ì‹¤í–‰ í ì²˜ë¦¬ í•¨ìˆ˜
        function processCellQueue() {
            if (isExecuting) {
                return;
            }
            
            if (cellExecutionQueue.length === 0) {
                return;
            }
            
            isExecuting = true;
            const nextCell = cellExecutionQueue.shift();
            currentExecutingCell = nextCell;
            
            // ì‹¤ì œ ì…€ ì‹¤í–‰
            executeCell(nextCell);
        }

        // ì‹¤ì œ ì…€ ì‹¤í–‰ í•¨ìˆ˜
        function executeCell(cellId) {
            if (!activeFile) {
                alert('ì‹¤í–‰í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            // íŒŒì¼ íƒ€ì… ì²´í¬
            const fileName = activeFile.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                alert('Python íŒŒì¼(.py), Jupyter ë…¸íŠ¸ë¶(.ipynb), NPN(.npn) íŒŒì¼ë§Œ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            if (!fileKernels[activeFile]) {
                alert('ì»¤ë„ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì»¤ë„ì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.');
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) {
                isExecuting = false;
                currentExecutingCell = null;
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                return;
            }

            const outputDiv = document.querySelector(`#output-${cell.id}`);
            const statusSpan = document.querySelector(`#status-${cell.id}`);
            const execSpan = document.querySelector(`#exec-${cell.id}`);

            // crawl ì…€ì¸ì§€ í™•ì¸
            const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
            
            let code = '';
            
            if (isCrawlCell) {
                // crawl ì…€ì˜ ê²½ìš° crawl_dataì—ì„œ ì½”ë“œ ìƒì„±
                if (!cell.crawl_data) {
                    alert('crawl ì…€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì…€ì„ ë‹¤ì‹œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                    return;
                }
                
                // name inputì—ì„œ job name ê°€ì ¸ì˜¤ê¸°
                const nameInput = document.getElementById(`cell-name-${cellId}`);
                const jobName = nameInput ? nameInput.value.trim() : `crawl_${cellId}`;
                
                // class_job import ë° job ì„ ì–¸ ì½”ë“œ ìƒì„±
                code = generateCrawlCode(cell.crawl_data, jobName);
            } else {
                // ì¼ë°˜ ì½”ë“œ ì…€ì˜ ê²½ìš° textareaì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
                const textarea = document.querySelector(`#${cellId} .cell-input`);
                code = textarea.value.trim();
                if (!code) {
                    isExecuting = false;
                    currentExecutingCell = null;
                    processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
                    return;
                }
            }

            // ìƒíƒœ ì—…ë°ì´íŠ¸ - ì‹¤í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½
            cell.status = 'running';
            statusSpan.textContent = 'ì‹¤í–‰ì¤‘...';
            statusSpan.className = 'cell-status running';
            outputDiv.style.display = 'block';
            
            // ê¸°ì¡´ output ëª¨ë‘ ì§€ìš°ê³  ì‹¤í–‰ì¤‘ í‘œì‹œë§Œ ì¶”ê°€
            outputDiv.innerHTML = '';
            const runningDiv = document.createElement('div');
            runningDiv.innerHTML = '<div class="spinner"></div> ì‹¤í–‰ì¤‘...';
            runningDiv.className = 'cell-output-running';
            outputDiv.appendChild(runningDiv);
            
            outputDiv.className = 'cell-output';

            // í˜„ì¬ í™œì„± íƒ­ì˜ ì»¤ë„ì— ì½”ë“œ ì‹¤í–‰ ìš”ì²­
            const kernelId = fileKernels[activeFile];
            
            // crawl ì…€ì˜ ê²½ìš° ìƒì„±ëœ ì½”ë“œë¥¼ ì½˜ì†”ì— ì¶œë ¥
            if (isCrawlCell) {
                // ì½”ë“œ ì‹¤í–‰
            }
            
            fetch(`/api/kernels/${kernelId}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cell.status = 'completed';
                    statusSpan.textContent = 'ì™„ë£Œ';
                    statusSpan.className = 'cell-status completed';
                    outputDiv.className = 'cell-output success';
                    
                    // stdout/result/stderrë¥¼ ê²°í•©í•˜ì—¬ ì¶œë ¥
                    let output = '';
                    
                    if (data.result && data.result.stdout && data.result.stdout.trim() !== '') {
                        output += data.result.stdout;
                    }
                    // resultê°€ ë¬¸ìì—´ì´ê³  'None'ì´ ì•„ë‹ ë•Œë§Œ ì¶”ê°€
                    if (data.result && typeof data.result.result === 'string' && data.result.result.trim() !== '' && data.result.result !== 'None') {
                        if (output) output += '\n';
                        output += data.result.result;
                    }
                    if (data.result && data.result.stderr && data.result.stderr.trim() !== '') {
                        if (output) output += '\n';
                        output += data.result.stderr;
                    }
                    

                    
                    // ì‹¤í–‰ì¤‘ í‘œì‹œ ì œê±°
                    const runningDiv = outputDiv.querySelector('.cell-output-running');
                    if (runningDiv) {
                        runningDiv.remove();
                    }
                    
                    // ìƒˆë¡œìš´ output ì¶”ê°€ (ì´ì „ output ìœ ì§€)
                    if (output && output.trim() !== '') {
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = output;
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ì…€ ë°ì´í„°ì— output ì €ì¥
                        saveCellOutput(cellId, output);
                    } else if (!output || output.trim() === '') {
                        // outputì´ ì—†ìœ¼ë©´ "ì‹¤í–‰ ì™„ë£Œ" í‘œì‹œ
                        const newOutputDiv = document.createElement('div');
                        newOutputDiv.className = 'cell-output-new';
                        newOutputDiv.textContent = 'ì‹¤í–‰ ì™„ë£Œ';
                        outputDiv.appendChild(newOutputDiv);
                        
                        // ì…€ ë°ì´í„°ì— output ì €ì¥
                        saveCellOutput(cellId, 'ì‹¤í–‰ ì™„ë£Œ');
                    }
                    
                    console.log('outputDiv ì„¤ì • í›„ ë‚´ìš©:', outputDiv.textContent);
                    execSpan.textContent = `[${data.execution_count || '?'}]`;
                } else {
                    cell.status = 'error';
                    statusSpan.textContent = 'ì˜¤ë¥˜';
                    statusSpan.className = 'cell-status error';
                    outputDiv.className = 'cell-output error';
                    
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    let errorOutput = '';
                    if (data.error) {
                        errorOutput += data.error;
                    }
                    if (data.result && data.result.stderr) {
                        errorOutput += '\n' + data.result.stderr;
                    }
                    
                    outputDiv.textContent = errorOutput || 'ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
            })
            .catch(error => {
                cell.status = 'error';
                statusSpan.textContent = 'ì˜¤ë¥˜';
                statusSpan.className = 'cell-status error';
                outputDiv.className = 'cell-output error';
                outputDiv.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                console.error('ì…€ ì‹¤í–‰ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                // ì…€ ì‹¤í–‰ ì™„ë£Œ í›„ í ìƒíƒœ ì´ˆê¸°í™” ë° ë‹¤ìŒ ì…€ ì²˜ë¦¬
                isExecuting = false;
                currentExecutingCell = null;
                
                processCellQueue(); // ë‹¤ìŒ ì…€ ì²˜ë¦¬
            });
        }

        // crawl ì…€ìš© ì½”ë“œ ìƒì„± í•¨ìˆ˜
        function generateCrawlCode(crawlData, jobName) {
            const { job_type, action, params } = crawlData;
            
            // ê¸°ë³¸ import ì½”ë“œ
            let code = `import sys\n`;
            code += `import os\n`;
            code += `# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê¸°\n`;
            code += `current_dir = os.getcwd()\n`;
            code += `# CLASSë‚˜ MODULE í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ê²½ë¡œ ì„¤ì •\n`;
            code += `if os.path.exists(os.path.join(current_dir, 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, 'MODULE'))\n`;
            code += `elif os.path.exists(os.path.join(current_dir, '..', 'CLASS')):\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'CLASS'))\n`;
            code += `    sys.path.append(os.path.join(current_dir, '..', 'MODULE'))\n`;
            code += `else:\n`;
            code += `    print("CLASS/MODULE í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")\n`;
            code += `    print(f"í˜„ì¬ ë””ë ‰í† ë¦¬: {current_dir}")\n`;
            code += `from class_job import Job\n\n`;
            
            // shared_dict ì´ˆê¸°í™” (ì»¤ë„ì—ì„œ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©)
            code += `# ì»¤ë„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ shared_dict ì‚¬ìš©\n`;
            code += `if 'shared_dict' not in globals():\n`;
            code += `    globals()['shared_dict'] = {}\n`;
            code += `    print("ê³µìš© ë°ì´í„° ë”•ì…”ë„ˆë¦¬ ì´ˆê¸°í™”ë¨")\n`;
            code += `shared_dict = globals()['shared_dict']\n\n`;
            
            // job ì„ ì–¸ - nameì€ name inputì—ì„œ ê°€ì ¸ì˜´
            code += `# ${jobName} - ${job_type} ${action}\n`;
            code += `job_name = "${jobName}"\n`;
            
            // argsë¥¼ JSON í˜•íƒœë¡œ êµ¬ì„± (paramsì—ì„œ action ì œê±°)
            let args = {
                type: job_type
            };
            
            // paramsì—ì„œ action í‚¤ë¥¼ ì œì™¸í•˜ê³  ë³µì‚¬
            Object.keys(params).forEach(key => {
                if (key !== 'action') {
                    args[key] = params[key];
                }
            });
            
            // job_typeì— ë”°ë¼ actionì„ ì ì ˆí•œ íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜í•˜ê³  paramsì—ì„œ action ì œê±°
            if (job_type === 'request') {
                args.request_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'find') {
                args.find_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'data') {
                args.convert_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'save') {
                args.save_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'load') {
                args.load_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'python') {
                args.python_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'wait') {
                args.wait_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else if (job_type === 'test') {
                args.test_type = action;
                delete args.action; // action í‚¤ ì œê±°
            } else {
                // do íƒ€ì…ì˜ ê²½ìš° action ê·¸ëŒ€ë¡œ ì‚¬ìš©
                args.action = action;
            }
            
            code += `# job args êµ¬ì„±\n`;
            code += `job_args = ${JSON.stringify(args, null, 4)}\n`;
            
            // Job ê°ì²´ ìƒì„± ë° ì‹¤í–‰
            code += `\n# Job ê°ì²´ ìƒì„± ë° ì‹¤í–‰\n`;
            code += `try:\n`;
            code += `    job = Job(job_name, job_args, shared_dict)\n`;
            code += `    result = job.run()\n`;
            code += `    print(f"Job '{job_name}' ì‹¤í–‰ ê²°ê³¼: {result}")\n`;
            code += `    # job ê²°ê³¼ë¥¼ shared_dictì— job nameì„ í‚¤ë¡œ ì €ì¥\n`;
            code += `    shared_dict[job_name] = result\n`;
            code += `    print(f"Job ê²°ê³¼ê°€ shared_dict['{job_name}']ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")\n`;
            code += `    if hasattr(result, 'data') and result.data is not None:\n`;
            code += `        print(f"ê²°ê³¼ ë°ì´í„°: {result.data}")\n`;
            code += `    if hasattr(result, 'message') and result.message:\n`;
            code += `        print(f"ë©”ì‹œì§€: {result.message}")\n`;
            code += `except Exception as e:\n`;
            code += `    print(f"Job ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")\n`;
            code += `    import traceback\n`;
            code += `    traceback.print_exc()\n`;
            code += `\n`;
            code += `print("Job ì‹¤í–‰ ì™„ë£Œ")\n`;
            
            return code;
        }

        function addCellAfter(cellId) {
            const newCell = addCell('', cellId);
            
            // ìƒˆ ì…€ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const newCellElement = document.getElementById(newCell.id);
                if (newCellElement) {
                    const textarea = newCellElement.querySelector('.cell-input');
                    if (textarea) textarea.focus();
                }
            }, 100);
        }

        function deleteCell(cellId) {
            if (!activeFile || !fileCells[activeFile]) {
                alert('ì‚­ì œí•  íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const currentCells = fileCells[activeFile];
            if (currentCells.length <= 1) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ì…€ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const cellIndex = currentCells.findIndex(c => c.id === cellId);
            if (cellIndex === -1) return;

            currentCells.splice(cellIndex, 1);
            document.getElementById(cellId).remove();
            
            // ì…€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            updateCellNumbers();
        }

        function updateCellNumbers() {
            cells.forEach((cell, index) => {
                const numberSpan = document.querySelector(`#${cell.id} .cell-number`);
                if (numberSpan) {
                    numberSpan.textContent = `In [${index + 1}]:`;
                }
            });
        }

        function runAllCells() {
            cells.forEach(cell => {
                if (cell.content.trim()) {
                    setTimeout(() => runCell(cell.id), 100);
                }
            });
        }

        function clearAllOutputs() {
            cells.forEach(cell => {
                const outputDiv = document.querySelector(`#output-${cell.id}`);
                if (outputDiv) {
                    outputDiv.style.display = 'none';
                    outputDiv.textContent = '';
                }
                const statusSpan = document.querySelector(`#status-${cell.id}`);
                if (statusSpan) {
                    statusSpan.textContent = 'ëŒ€ê¸°ì¤‘';
                    statusSpan.className = 'cell-status';
                }
                const execSpan = document.querySelector(`#exec-${cell.id}`);
                if (execSpan) {
                    execSpan.textContent = '';
                }
            });
        }

        function clearAllCells() {
            if (!confirm('ëª¨ë“  ì…€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            cells = [];
            document.getElementById('notebookCells').innerHTML = '';
            cellCounter = 0;
            addCell();
        }

        function checkKernelStatus() {
            // ì»¤ë„ ìƒíƒœ í™•ì¸ í™œì„±í™”
            console.log('checkKernelStatus í˜¸ì¶œë¨');
            
            console.log('checkKernelStatus í˜¸ì¶œë¨ - ìŠ¤íƒ:', new Error().stack);
            
            if (!activeFile || !fileKernels[activeFile]) {
                const statusElement = document.getElementById('kernelStatusText');
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (statusElement) {
                    statusElement.textContent = 'ì»¤ë„ ì—†ìŒ';
                }
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                    displayElement.style.color = '#a0aec0';
                }
                return;
            }

            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            console.log(`íŒŒì¼ë³„ ì»¤ë„ ìƒíƒœ í™•ì¸: ${activeFile} -> ${kernelIdStr}`);
            
            fetch(`/api/kernels/${kernelIdStr}/status`)
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (data.success) {
                        let statusText = '';
                        let displayText = '';
                        let statusColor = '#a0aec0';
                        
                        if (data.status === 'idle' || data.status === 'ready') {
                            statusText = 'ì¤€ë¹„ë¨';
                            displayText = 'ì»¤ë„ ìƒíƒœ: í™œì„±';
                            statusColor = '#68d391';
                        } else if (data.status === 'busy') {
                            statusText = 'ì‹¤í–‰ì¤‘';
                            displayText = 'ì»¤ë„ ìƒíƒœ: ì‹¤í–‰ì¤‘';
                            statusColor = '#f6ad55';
                        } else {
                            statusText = data.status;
                            displayText = `ì»¤ë„ ìƒíƒœ: ${data.status}`;
                            statusColor = '#fc8181';
                        }
                        
                        if (statusElement) {
                            statusElement.textContent = statusText;
                        }
                        if (displayElement) {
                            displayElement.textContent = displayText;
                            displayElement.style.color = statusColor;
                        }
                    } else {
                        if (statusElement) {
                            statusElement.textContent = 'ì˜¤ë¥˜';
                        }
                        if (displayElement) {
                            displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ì˜¤ë¥˜';
                            displayElement.style.color = '#fc8181';
                        }
                    }
                })
                .catch(error => {
                    const statusElement = document.getElementById('kernelStatusText');
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    
                    if (statusElement) {
                        statusElement.textContent = 'ì—°ê²° ì‹¤íŒ¨';
                    }
                    if (displayElement) {
                        displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨';
                        displayElement.style.color = '#fc8181';
                    }
                    console.error('ì»¤ë„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                });
        }

        function saveNotebookToFile() {
            console.log('=== saveNotebookToFile í˜¸ì¶œë¨ ===');
            
            if (!activeFile) {
                console.log('activeFileì´ ì—†ìŒ');
                alert('ì €ì¥í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('activeFile:', activeFile);
            console.log('fileCells ì „ì²´:', fileCells);
            console.log('fileCells[activeFile]:', fileCells[activeFile]);
            
            // í˜„ì¬ ë…¸íŠ¸ë¶ì˜ ëª¨ë“  ì…€ ë‚´ìš©ì„ ìˆ˜ì§‘
            const cells = fileCells[activeFile] || [];
            
            // ë””ë²„ê¹…: ì €ì¥ ì‹œì‘ ì‹œ ìƒíƒœ í™•ì¸
            console.log('=== ì €ì¥ ì‹œì‘ ===');
            console.log('activeFile:', activeFile);
            console.log('fileCells:', fileCells);
            console.log('cells ë°°ì—´:', cells);
            console.log('cells ê¸¸ì´:', cells.length);
            console.log('cells íƒ€ì…:', typeof cells);
            console.log('cellsê°€ ë°°ì—´ì¸ê°€?', Array.isArray(cells));
            
            if (!Array.isArray(cells) || cells.length === 0) {
                console.log('ì…€ì´ ì—†ê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹˜');
                alert('ì €ì¥í•  ì…€ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const notebookContent = [];
            
            cells.forEach(cell => {
                console.log('=== ì…€ ì²˜ë¦¬ ì‹œì‘ ===', cell);
                let content = '';
                
                // crawl ì…€ì¸ì§€ í™•ì¸
                const isCrawlCell = cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json';
                
                console.log(`ì…€ ${cell.id} íƒ€ì… í™•ì¸:`, {
                    cell_type: cell.cell_type,
                    is_crawl: isCrawlCell,
                    cell_id: cell.id
                });
                
                if (isCrawlCell) {
                    // crawl ì…€ì˜ ê²½ìš° JSON ëª¨ë“œ ë˜ëŠ” combobox UI ëª¨ë“œ í™•ì¸
                    const jsonTextarea = document.getElementById(`xml-content-${cell.id}`);
                    const xmlToggle = document.getElementById(`xml-toggle-${cell.id}`);
                    const isJsonMode = xmlToggle && xmlToggle.checked; // í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœë¡œ íŒë‹¨
                    const cellType = isJsonMode ? 'crawl_json' : 'crawl_ui';
                    
                    console.log(`Crawl ì…€ ${cell.id} ì €ì¥ ëª¨ë“œ í™•ì¸:`, {
                        cell_type: cell.cell_type,
                        has_json_textarea: !!jsonTextarea,
                        has_xml_toggle: !!xmlToggle,
                        toggle_checked: xmlToggle?.checked,
                        is_json_mode: isJsonMode
                    });
                    
                    if (isJsonMode) {
                        // JSON ëª¨ë“œ: xml-content textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                        content = jsonTextarea.value;
                        console.log(`Crawl ì…€ ${cell.id} JSON ëª¨ë“œì—ì„œ ë‚´ìš© ê°€ì ¸ì˜´:`, content.substring(0, 100) + '...');
                    } else {
                        // Combobox UI ëª¨ë“œ: í˜„ì¬ ì„¤ì •ëœ ê°’ë“¤ì„ JSONìœ¼ë¡œ ë³€í™˜
                        let crawlData = null;
                        
                        // 1. crawl_dataê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                        if (cell.crawl_data) {
                            crawlData = cell.crawl_data;
                            console.log(`Crawl ì…€ ${cell.id} crawl_data ì‚¬ìš©:`, crawlData);
                        } else {
                            // 2. UI ìš”ì†Œì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                            const jobTypeSelect = document.querySelector(`#${cell.id} .crawl-job-type`);
                            const actionSelect = document.querySelector(`#${cell.id} .crawl-action`);
                            
                            console.log(`Crawl ì…€ ${cell.id} UI ìš”ì†Œ ì°¾ê¸°:`, {
                                jobTypeSelect: !!jobTypeSelect,
                                actionSelect: !!actionSelect,
                                jobTypeValue: jobTypeSelect?.value,
                                actionValue: actionSelect?.value
                            });
                            
                            if (jobTypeSelect && actionSelect) {
                                crawlData = {
                                    job_type: jobTypeSelect.value || 'do',
                                    action: actionSelect.value || '',
                                    params: {}
                                };
                                
                                // íŒŒë¼ë¯¸í„° ê°’ë“¤ ìˆ˜ì§‘
                                const paramInputs = document.querySelectorAll(`#${cell.id} input[name], #${cell.id} select[name]`);
                                console.log(`Crawl ì…€ ${cell.id} íŒŒë¼ë¯¸í„° ì…ë ¥ í•„ë“œ:`, paramInputs.length);
                                
                                paramInputs.forEach(input => {
                                    if (input.name && input.value) {
                                        crawlData.params[input.name] = input.value;
                                        console.log(`íŒŒë¼ë¯¸í„° ì¶”ê°€: ${input.name} = ${input.value}`);
                                    }
                                });
                                
                                // focus íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                                const focusInput = document.querySelector(`#${cell.id} input[name="focus"]`);
                                const currentCheckbox = document.querySelector(`#${cell.id} #current-checkbox-${cell.id}`);
                                
                                if (focusInput && currentCheckbox) {
                                    const isCurrent = currentCheckbox.checked;
                                    const focusValue = focusInput.value;
                                    
                                    if (isCurrent) {
                                        crawlData.params.focus = 'current';
                                        console.log(`Focus íŒŒë¼ë¯¸í„° ì¶”ê°€: current`);
                                    } else if (focusValue) {
                                        crawlData.params.focus = { xpath: focusValue };
                                        console.log(`Focus íŒŒë¼ë¯¸í„° ì¶”ê°€: xpath = ${focusValue}`);
                                    }
                                }
                                
                                console.log(`Crawl ì…€ ${cell.id} UI ëª¨ë“œì—ì„œ ìƒì„±ëœ ë°ì´í„°:`, crawlData);
                            }
                        }
                        
                        if (crawlData) {
                            content = JSON.stringify(crawlData, null, 2);
                            console.log(`Crawl ì…€ ${cell.id} ìµœì¢… JSON ìƒì„±:`, content);
                        } else {
                            // 3. ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•˜ë©´ ê¸°ì¡´ content ì‚¬ìš©
                            content = cell.content || '';
                            console.log(`Crawl ì…€ ${cell.id} ëª¨ë“  ë°©ë²• ì‹¤íŒ¨, ê¸°ì¡´ content ì‚¬ìš©:`, content.substring(0, 100) + '...');
                        }
                    }
                } else {
                    // ì¼ë°˜ ì½”ë“œ ì…€: cell-input textareaì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
                    const textarea = document.querySelector(`#${cell.id} .cell-input`);
                    content = textarea ? textarea.value : cell.content;
                }
                
                // contentê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                if (typeof content !== 'string') {
                    content = String(content);
                }
                
                // ë””ë²„ê¹…: ê° ì…€ì˜ ì²˜ë¦¬ ê³¼ì • ë¡œê·¸
                console.log(`ì…€ ${cell.id} ì²˜ë¦¬:`, {
                    cell_type: cell.cell_type,
                    is_crawl: isCrawlCell,
                    content_length: content.length,
                    content_preview: content.substring(0, 100) + '...',
                    has_json_textarea: !!document.getElementById(`xml-content-${cell.id}`),
                    json_textarea_display: document.getElementById(`xml-content-${cell.id}`)?.style.display
                });
                
                if (content.trim() !== '') {
                    if (isCrawlCell) {
                        console.log(`Crawl ì…€ ${cell.id} JSON ë¶„í•  ì‹œì‘:`, content);
                        function splitJsonObjects(jsonStr) {
                            const objects = [];
                            let current = '';
                            let braceCount = 0;
                            let inString = false;
                            let escapeNext = false;
                            for (let i = 0; i < jsonStr.length; i++) {
                                const char = jsonStr[i];
                                if (escapeNext) { current += char; escapeNext = false; continue; }
                                if (char === '\\') { escapeNext = true; current += char; continue; }
                                if (char === '"' && !escapeNext) { inString = !inString; }
                                if (!inString) {
                                    if (char === '{') { if (braceCount === 0) { current = char; } else { current += char; } braceCount++; }
                                    else if (char === '}') { current += char; braceCount--; if (braceCount === 0) { const trimmed = current.trim(); if (trimmed) { objects.push(trimmed); } current = ''; } }
                                    else { if (braceCount > 0) { current += char; } }
                                } else { current += char; }
                            }
                            return objects;
                        }
                        const jsonObjects = splitJsonObjects(content);
                        console.log(`Crawl ì…€ ${cell.id} JSON ë¶„í•  ê²°ê³¼:`, {
                            original_length: content.length,
                            split_count: jsonObjects.length,
                            objects: jsonObjects.map((obj, idx) => ({ index: idx, length: obj.length, preview: obj.substring(0, 50) + '...' }))
                        });
                        
                        // JSON ëª¨ë“œì¸ì§€ í™•ì¸
                        const xmlToggle2 = document.getElementById(`xml-toggle-${cell.id}`);
                        const isJsonMode2 = xmlToggle2 && xmlToggle2.checked; // í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœë¡œ íŒë‹¨
                        const cellType = isJsonMode2 ? 'crawl_json' : 'crawl_ui';
                        
                        if (jsonObjects.length > 1) {
                            jsonObjects.forEach((jsonStr, index) => {
                                try {
                                    JSON.parse(jsonStr);
                                    const cellData = { 
                                        cell_type: cellType, 
                                        content: jsonStr, 
                                        metadata: { name: cell.name || '' }, // ì…€ ì´ë¦„ ì €ì¥
                                        output_history: cell.output_history || []
                                    };
                                    notebookContent.push(cellData);
                                    console.log(`Crawl ì…€ ${cell.id} ë¶„í•  ${index + 1} ì¶”ê°€ë¨ (íƒ€ì…: ${cellType}, name: ${cell.name}, output_history: ${cell.output_history ? cell.output_history.length : 0}ê°œ)`);
                                } catch (parseError) { 
                                    console.error(`Crawl ì…€ ${cell.id} ë¶„í•  ${index + 1} íŒŒì‹± ì‹¤íŒ¨:`, parseError);
                                }
                            });
                        } else {
                            const cellData = { 
                                cell_type: cellType, 
                                content: content, 
                                metadata: { name: cell.name || '' }, // ì…€ ì´ë¦„ ì €ì¥
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            console.log(`Crawl ì…€ ${cell.id} ë‹¨ì¼ ê°ì²´ë¡œ ì¶”ê°€ë¨ (íƒ€ì…: ${cellType}, name: ${cell.name}, output_history: ${cell.output_history ? cell.output_history.length : 0}ê°œ)`);
                        }
                                            } else {
                            // output_historyë„ í•¨ê»˜ ì €ì¥
                            const cellData = { 
                                cell_type: 'code', 
                                content: content, 
                                metadata: {},
                                output_history: cell.output_history || []
                            };
                            notebookContent.push(cellData);
                            console.log(`ì½”ë“œ ì…€ ${cell.id} ì¶”ê°€ë¨ (output_history: ${cell.output_history ? cell.output_history.length : 0}ê°œ)`);
                        }
                } else {
                    console.log(`ì…€ ${cell.id} ë¹ˆ ë‚´ìš©ìœ¼ë¡œ ê±´ë„ˆëœ€`);
                }
            });
            // ë””ë²„ê¹…: ë¶„í• ëœ notebookContent ì¶œë ¥
            console.log('notebookContent:', notebookContent);

            if (notebookContent.length === 0) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì €ì¥ í˜•ì‹ ê²°ì •
            const fileName = activeFile.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();
            console.log('íŒŒì¼ í™•ì¥ì í™•ì¸:', { fileName, fileExtension, activeFile });
            let contentToSave = '';
            if (fileExtension === 'ipynb') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        execution_count: null, 
                        metadata: item.metadata, 
                        outputs: item.output_history ? item.output_history.map(entry => ({
                            output_type: "stream",
                            name: "stdout",
                            text: entry.output
                        })) : [], 
                        source: item.content
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else if (fileExtension === 'npn') {
                const notebook = {
                    cells: notebookContent.map(item => ({ 
                        cell_type: item.cell_type, 
                        metadata: item.metadata, 
                        source: item.content,
                        output_history: item.output_history || []
                    })),
                    metadata: { kernelspec: { display_name: "Python 3", language: "python", name: "python3" }, language_info: { codemirror_mode: { name: "ipython", version: 3 }, file_extension: ".py", mimetype: "text/x-python", name: "python", nbconvert_exporter: "python", pygments_lexer: "ipython3", version: "3.8.0" } }, nbformat: 4, nbformat_minor: 4 };
                contentToSave = JSON.stringify(notebook, null, 2);
            } else {
                contentToSave = notebookContent.map(item => item.content).join('\n\n');
            }
            // ë””ë²„ê¹…: ì €ì¥ ì§ì „ contentToSave ì¶œë ¥
            console.log('contentToSave:', contentToSave);

            // íŒŒì¼ ì €ì¥ API í˜¸ì¶œ
            fetch('/api/files/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ path: activeFile, content: contentToSave })
            })
            .then(response => response.json())
            .then(data => {
                // ë””ë²„ê¹…: ì €ì¥ API ì‘ë‹µ ì¶œë ¥
                console.log('save API response:', data);
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = `ë…¸íŠ¸ë¶ì´ "${fileName}"ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ì €ì¥ í›„ ìë™ reload ì œê±°
                    // checkFileUpdatedAndReload(activeFile, contentToSave);
                    
                } else {
                    alert(data.message || 'íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function initializeKernel() {
            if (!activeFile) {
                alert('ì´ˆê¸°í™”í•  íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            // íŒŒì¼ íƒ€ì… ì²´í¬
            const fileName = activeFile.split('/').pop().toLowerCase();
            if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
                alert('Python íŒŒì¼(.py), Jupyter ë…¸íŠ¸ë¶(.ipynb), NPN(.npn) íŒŒì¼ë§Œ ì»¤ë„ì„ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì»¤ë„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ì»¤ë„ì´ ìˆìœ¼ë©´ ì¢…ë£Œ í›„ ìƒˆ ì»¤ë„ì´ ìƒì„±ë©ë‹ˆë‹¤. ëª¨ë“  ë³€ìˆ˜ì™€ ì‹¤í–‰ ê¸°ë¡ì´ ì§€ì›Œì§‘ë‹ˆë‹¤.')) {
                return;
            }

            const oldKernelId = fileKernels[activeFile];
            // 1. ê¸°ì¡´ ì»¤ë„ì´ ìˆìœ¼ë©´ ì¢…ë£Œ
            const shutdownOldKernel = oldKernelId ? fetch(`/api/kernels/${oldKernelId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            }).then(r => r.json()) : Promise.resolve({ success: true });

            // 2. ìƒˆ ì»¤ë„ ìƒì„±
            shutdownOldKernel.then(() => {
                fetch('/api/kernels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) // ë¹ˆ JSON ê°ì²´ ì¶”ê°€
                })
                .then(response => {
                    console.log('ì»¤ë„ ì´ˆê¸°í™” ì‘ë‹µ ìƒíƒœ:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('ì»¤ë„ ì´ˆê¸°í™” ì‘ë‹µ ë°ì´í„°:', data);
                    if (data.success) {
                        fileKernels[activeFile] = data.kernel_id;
                        
                        // ì„œë²„ì— íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì €ì¥
                        fetch('/api/kernels/file-mapping', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                file_path: activeFile,
                                kernel_id: data.kernel_id
                            })
                        })
                        .then(response => response.json())
                        .then(mappingData => {
                            if (mappingData.success) {
                                console.log('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì €ì¥ ì„±ê³µ:', mappingData.message);
                            } else {
                                console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì €ì¥ ì‹¤íŒ¨:', mappingData.error);
                            }
                        })
                        .catch(error => {
                            console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì €ì¥ ì˜¤ë¥˜:', error);
                        });
                        
                        updateKernelInfo();
                        
                        // ì»¤ë„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                        const displayElement = document.getElementById('kernelStatusDisplay');
                        if (displayElement) {
                            displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: í™œì„±';
                            displayElement.style.color = '#68d391';
                        }
                        

                        
                        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                        const successDiv = document.createElement('div');
                        successDiv.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #22543d;
                            color: #9ae6b4;
                            padding: 1rem;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            z-index: 1000;
                            animation: slideIn 0.3s ease;
                        `;
                        successDiv.textContent = 'ìƒˆ ì»¤ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        document.body.appendChild(successDiv);
                        setTimeout(() => {
                            successDiv.style.animation = 'slideOut 0.3s ease';
                            setTimeout(() => {
                                if (successDiv.parentNode) {
                                    successDiv.parentNode.removeChild(successDiv);
                                }
                            }, 300);
                        }, 3000);
                        // ëª¨ë“  ì…€ì˜ ì¶œë ¥ ì§€ìš°ê¸°
                        clearAllOutputs();
                    } else {
                        alert(data.error || data.message || 'ì»¤ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('ì»¤ë„ ìƒì„± ì‹¤íŒ¨:', error);
                    alert(`ì»¤ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });
            });
        }

        function shutdownKernel() {
            if (!activeFile || !fileKernels[activeFile]) {
                alert('ì¢…ë£Œí•  ì»¤ë„ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm('ì»¤ë„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë³€ìˆ˜ì™€ ì‹¤í–‰ ê¸°ë¡ì´ ì§€ì›Œì§‘ë‹ˆë‹¤.')) {
                return;
            }

            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            fetch(`/api/kernels/${kernelIdStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = 'ì»¤ë„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);

                    // ëª¨ë“  ì…€ì˜ ì¶œë ¥ ì§€ìš°ê¸°
                    clearAllOutputs();
                    
                    // ì»¤ë„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                    const displayElement = document.getElementById('kernelStatusDisplay');
                    if (displayElement) {
                        displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                        displayElement.style.color = '#a0aec0';
                    }
                    
                    // ì„œë²„ì—ì„œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±°
                    fetch('/api/kernels/file-mapping', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            file_path: activeFile
                        })
                    })
                    .then(response => response.json())
                    .then(mappingData => {
                        if (mappingData.success) {
                            console.log('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì„±ê³µ:', mappingData.message);
                        } else {
                            console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì‹¤íŒ¨:', mappingData.error);
                        }
                    })
                    .catch(error => {
                        console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ì œê±° ì˜¤ë¥˜:', error);
                    });
                    
                    // ì»¤ë„ ID ì œê±°
                    delete fileKernels[activeFile];
                } else {
                    alert(data.message || 'ì»¤ë„ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì»¤ë„ ì¢…ë£Œ ì‹¤íŒ¨:', error);
                alert('ì»¤ë„ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function showContextMenu(event, filePath) {
            event.preventDefault();
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ì— íŒŒì¼ ê²½ë¡œ ì €ì¥
            contextMenu.setAttribute('data-file-path', filePath);
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        function openFile() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            const file = fileTreeData.find(f => f.path === filePath);
            if (file) {
                selectFile(file);
            }
            hideContextMenu();
        }

        function refreshFileTree() {
            loadFileTree();
        }

        function filterFiles(searchTerm) {
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const fileName = item.querySelector('.file-name').textContent.toLowerCase();
                if (fileName.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'block'; // í‘œì‹œ
                } else {
                    item.style.display = 'none'; // ìˆ¨ê¹€
                }
            });
        }

        function createNewFile() {
            const fileName = prompt('ìƒˆ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: example.npn):');
            if (!fileName) return;

            // .npn íŒŒì¼ì¸ì§€ í™•ì¸
            const isNpnFile = fileName.toLowerCase().endsWith('.npn');
            
            let initialContent = '';
            if (isNpnFile) {
                // .npn íŒŒì¼ìš© í…œí”Œë¦¿ - ê¸°ë³¸ê°’ì´ í¬í•¨ëœ crawl ì…€
                const crawlData = {
                    "job_type": "do",
                    "action": "click",
                    "params": {
                        "focus": "{\"xpath\": \"//button[@id='login']\"}",
                        "speed": 1.0
                    }
                };
                
                // ê¸°ë³¸ê°’ ì¶”ê°€
                const crawlDataWithDefaults = addDefaultParams(crawlData);
                
                initialContent = JSON.stringify({
                    "cells": [
                        {
                            "cell_type": "crawl_ui",
                            "metadata": {},
                            "source": JSON.stringify(crawlDataWithDefaults, null, 2)
                        }
                    ],
                    "metadata": {
                        "kernelspec": {
                            "display_name": "Python 3",
                            "language": "python",
                            "name": "python3"
                        },
                        "language_info": {
                            "codemirror_mode": {
                                "name": "ipython",
                                "version": 3
                            },
                            "file_extension": ".py",
                            "mimetype": "text/x-python",
                            "name": "python",
                            "nbconvert_exporter": "python",
                            "pygments_lexer": "ipython3",
                            "version": "3.8.0"
                        }
                    },
                    "nbformat": 4,
                    "nbformat_minor": 4
                }, null, 2);
            }

            fetch('/api/files/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: fileName,
                    content: initialContent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFileTree();
                } else {
                    alert(data.message || 'íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ìƒì„± ì‹¤íŒ¨:', error);
                alert('íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function uploadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadFileTree();
                    } else {
                        alert(data.message || 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            };
            input.click();
        }

        function renameFile() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            const file = fileTreeData.find(f => f.path === filePath);
            if (!file) return;

            const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', file.name);
            if (!newName || newName === file.name) return;

            fetch('/api/files/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    old_path: filePath,
                    new_name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFileTree();
                } else {
                    alert(data.message || 'íŒŒì¼ ì´ë¦„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨:', error);
                alert('íŒŒì¼ ì´ë¦„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function deleteFile() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            const file = fileTreeData.find(f => f.path === filePath);
            if (!file) return;

            if (!confirm(`ì •ë§ë¡œ "${file.name}"ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            fetch('/api/files/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    path: filePath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadFileTree();
                } else {
                    alert(data.message || 'íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function copyFilePath() {
            const filePath = document.getElementById('contextMenu').getAttribute('data-file-path');
            navigator.clipboard.writeText(filePath).then(() => {
                alert('íŒŒì¼ ê²½ë¡œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            });
        }

        function switchSidebarTab(panelId) {
            console.log('íƒ­ ì „í™˜ ì‹œë„:', panelId);
            
            // ëª¨ë“  íƒ­ê³¼ íŒ¨ë„ ë¹„í™œì„±í™”
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
                console.log('íƒ­ ë¹„í™œì„±í™”:', tab);
            });
            
            document.querySelectorAll('.sidebar-panel').forEach(panel => {
                panel.classList.remove('active');
                console.log('íŒ¨ë„ ë¹„í™œì„±í™”:', panel.id);
            });
            
            // í´ë¦­ëœ íƒ­ í™œì„±í™” (ì²« ë²ˆì§¸ íƒ­ì€ fileTreePanel, ë‘ ë²ˆì§¸ íƒ­ì€ kernelPanel)
            const tabIndex = panelId === 'fileTreePanel' ? 0 : 1;
            const clickedTab = document.querySelectorAll('.sidebar-tab')[tabIndex];
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('íƒ­ í™œì„±í™”:', panelId);
            }
            
            // í•´ë‹¹ íŒ¨ë„ í™œì„±í™”
            const targetPanel = document.getElementById(panelId);
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('íŒ¨ë„ í™œì„±í™”:', panelId);
                
                // ì»¤ë„ íŒ¨ë„ì´ í™œì„±í™”ë˜ë©´ ì •ë³´ ì—…ë°ì´íŠ¸
                if (panelId === 'kernelPanel') {
                    updateKernelInfo();
                    // checkKernelStatus(); // ì œê±°
                }
            }
        }

        function updateKernelInfo() {
            // í˜„ì¬ í™œì„± íŒŒì¼ì˜ ì»¤ë„ ì •ë³´ í‘œì‹œ
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                document.getElementById('currentKernelInfo').textContent = 
                    `${activeFile.split('/').pop()} (${kernelIdStr})`;
                
                // ì»¤ë„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: í™œì„±';
                    displayElement.style.color = '#68d391';
                }
                
                // ì»¤ë„ ë§¤ë‹ˆì € íŒ¨ë„ì˜ ìƒíƒœ í…ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸
                const statusTextElement = document.getElementById('kernelStatusText');
                if (statusTextElement) {
                    statusTextElement.textContent = 'ì¤€ë¹„ë¨';
                }
                
                // ì»¤ë„ ì‹œê°„ì œí•œ ì •ë³´ ì—…ë°ì´íŠ¸
                updateKernelTimeDisplay(kernelIdStr);
            } else {
                document.getElementById('currentKernelInfo').textContent = 'ì—†ìŒ';
                
                // ì»¤ë„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                    displayElement.style.color = '#a0aec0';
                }
                
                // ì‹œê°„ì œí•œ í‘œì‹œ ì´ˆê¸°í™”
                const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                if (timeDisplayElement) {
                    timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: --:--:--';
                }
            }
            
            // ì—´ë¦° íŒŒì¼ ëª©ë¡ í‘œì‹œ
            const openFilesList = document.getElementById('openFilesList');
            if (openFiles.length > 0) {
                openFilesList.innerHTML = openFiles.map(path => 
                    `<div style="margin-bottom: 0.3rem; ${path === activeFile ? 'color: #63b3ed;' : ''}">${path.split('/').pop()}</div>`
                ).join('');
            } else {
                openFilesList.innerHTML = 'ì—†ìŒ';
            }
            
            // ëª¨ë“  ì»¤ë„ ëª©ë¡ í‘œì‹œ
            const allKernelsList = document.getElementById('allKernelsList');
            const kernelEntries = Object.entries(fileKernels);
            if (kernelEntries.length > 0) {
                allKernelsList.innerHTML = kernelEntries.map(([filePath, kernelId]) => {
                    const fileName = filePath.split('/').pop();
                    const isActive = filePath === activeFile;
                    const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                    return `
                        <div style="margin-bottom: 0.5rem; padding: 0.3rem; background: ${isActive ? '#2c5282' : '#4a5568'}; border-radius: 4px; border-left: 3px solid ${isActive ? '#63b3ed' : '#718096'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="${isActive ? 'color: #63b3ed;' : ''}">${fileName}</span>
                                <button onclick="shutdownKernelForFile('${filePath}')" 
                                        style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.7rem; cursor: pointer;">
                                    ì¢…ë£Œ
                                </button>
                            </div>
                            <div style="font-size: 0.7rem; color: #a0aec0; margin-top: 0.2rem;">
                                ì»¤ë„ ID: ${kernelIdStr}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                allKernelsList.innerHTML = 'ì—†ìŒ';
            }
        }

        function cleanupInactiveKernels() {
            if (!confirm('12ì‹œê°„ ì´ìƒ ë¹„í™œì„±ì¸ ì»¤ë„ë“¤ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            fetch('/api/kernels/cleanup-inactive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = data.message;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);

                    // UI ì—…ë°ì´íŠ¸
                    updateKernelInfo();
                } else {
                    alert(data.error || 'ë¹„í™œì„± ì»¤ë„ ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ë¹„í™œì„± ì»¤ë„ ì •ë¦¬ ì‹¤íŒ¨:', error);
                alert('ë¹„í™œì„± ì»¤ë„ ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function cleanupAllKernels() {
            if (!confirm('ëª¨ë“  ì»¤ë„ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            fetch('/api/kernels/cleanup-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #742a2a;
                        color: #feb2b2;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = data.message;
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);

                    // ëª¨ë“  ì»¤ë„ ID ì œê±°
                    fileKernels = {};
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateKernelInfo();
                    
                    // í˜„ì¬ í™œì„± íŒŒì¼ì˜ ì»¤ë„ ì •ë³´ë„ ì´ˆê¸°í™”
                    if (activeFile) {
                        document.getElementById('currentKernelInfo').textContent = 'ì—†ìŒ';
                        document.getElementById('kernelStatusText').textContent = 'ì»¤ë„ ì—†ìŒ';
                        
                        // ì»¤ë„ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                        const displayElement = document.getElementById('kernelStatusDisplay');
                        if (displayElement) {
                            displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                            displayElement.style.color = '#a0aec0';
                        }
                    }
                } else {
                    alert(data.error || 'ëª¨ë“  ì»¤ë„ ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ëª¨ë“  ì»¤ë„ ì •ë¦¬ ì‹¤íŒ¨:', error);
                alert('ëª¨ë“  ì»¤ë„ ì •ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì»¤ë„ ì‹œê°„ì œí•œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        let kernelTimeInterval = null;

        function updateKernelTimeDisplay(kernelId) {
            // ì„œë²„ì—ì„œ í•œ ë²ˆë§Œ ì‹œê°„ì œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            fetch(`/api/kernels/${kernelId}/remaining-time`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.remaining_time) {
                        const remaining = data.remaining_time;
                        const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                        
                        if (remaining.expired) {
                            timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: ë§Œë£Œë¨';
                            timeDisplayElement.style.background = '#e53e3e';
                            timeDisplayElement.style.color = '#ffffff';
                        } else {
                            const hours = remaining.remaining_hours;
                            const minutes = remaining.remaining_minutes;
                            const seconds = remaining.remaining_seconds_only;
                            
                            timeDisplayElement.textContent = `ë‚¨ì€ ì‹œê°„: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            // ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e'; // ë¹¨ê°„ìƒ‰
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e'; // ì£¼í™©ìƒ‰
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748'; // ê¸°ë³¸ìƒ‰
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('ì»¤ë„ ì‹œê°„ì œí•œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: ì˜¤ë¥˜';
                    timeDisplayElement.style.background = '#e53e3e';
                    timeDisplayElement.style.color = '#ffffff';
                });
        }

        function startKernelTimeUpdate() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
            }
            
            // ë¨¼ì € ì„œë²„ì—ì„œ í˜„ì¬ ì‹œê°„ì œí•œ ì •ë³´ë¥¼ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸°
            if (activeFile && fileKernels[activeFile]) {
                const kernelId = fileKernels[activeFile];
                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                updateKernelTimeDisplay(kernelIdStr);
            }
            
            // ê·¸ í›„ì—ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ 1ì´ˆì”© ì¤„ì´ê¸°
            kernelTimeInterval = setInterval(() => {
                if (activeFile && fileKernels[activeFile]) {
                    const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                    const currentText = timeDisplayElement.textContent;
                    
                    if (currentText.includes(':')) {
                        const timeParts = currentText.split(':');
                        
                        if (timeParts.length >= 3) {
                            // ì‹œê°„ íŒŒíŠ¸ê°€ 4ê°œì¸ ê²½ìš°: ['ë‚¨ì€ ì‹œê°„', ' 11', '58', '42']
                            // ì‹œê°„ íŒŒíŠ¸ê°€ 3ê°œì¸ ê²½ìš°: ['11', '58', '42']
                            let hours, minutes, seconds;
                            
                            if (timeParts.length === 4) {
                                // 4ê°œ íŒŒíŠ¸ì¸ ê²½ìš°: ['ë‚¨ì€ ì‹œê°„', ' 11', '58', '42']
                                hours = parseInt(timeParts[1].trim());
                                minutes = parseInt(timeParts[2]);
                                seconds = parseInt(timeParts[3]);
                            } else {
                                // 3ê°œ íŒŒíŠ¸ì¸ ê²½ìš°: ['11', '58', '42']
                                hours = parseInt(timeParts[0].replace('ë‚¨ì€ ì‹œê°„: ', ''));
                                minutes = parseInt(timeParts[1]);
                                seconds = parseInt(timeParts[2]);
                            }
                            
                            // NaN ì²´í¬
                            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) {
                                const kernelId = fileKernels[activeFile];
                                const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
                                updateKernelTimeDisplay(kernelIdStr);
                                return;
                            }
                            
                            seconds--;
                            if (seconds < 0) {
                                seconds = 59;
                                minutes--;
                                if (minutes < 0) {
                                    minutes = 59;
                                    hours--;
                                    if (hours < 0) {
                                        // ì‹œê°„ ë§Œë£Œ
                                        timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: ë§Œë£Œë¨';
                                        timeDisplayElement.style.background = '#e53e3e';
                                        timeDisplayElement.style.color = '#ffffff';
                                        return;
                                    }
                                }
                            }
                            
                            const newText = `ë‚¨ì€ ì‹œê°„: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            timeDisplayElement.textContent = newText;
                            
                            // ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                            if (hours < 1) {
                                timeDisplayElement.style.background = '#e53e3e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else if (hours < 3) {
                                timeDisplayElement.style.background = '#d69e2e';
                                timeDisplayElement.style.color = '#ffffff';
                            } else {
                                timeDisplayElement.style.background = '#2d3748';
                                timeDisplayElement.style.color = '#ffffff';
                            }
                        }
                    }
                }
            }, 1000);
        }

        function stopKernelTimeUpdate() {
            if (kernelTimeInterval) {
                clearInterval(kernelTimeInterval);
                kernelTimeInterval = null;
            }
        }

        function extendKernelTimeout() {
            if (!activeFile || !fileKernels[activeFile]) {
                alert('í™œì„± ì»¤ë„ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const kernelId = fileKernels[activeFile];
            const kernelIdStr = typeof kernelId === 'object' ? JSON.stringify(kernelId) : String(kernelId);
            
            fetch(`/api/kernels/${kernelIdStr}/extend-timeout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    additional_hours: 12
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const successDiv = document.createElement('div');
                    successDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #22543d;
                        color: #9ae6b4;
                        padding: 1rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        animation: slideIn 0.3s ease;
                    `;
                    successDiv.textContent = 'ì»¤ë„ ì‹œê°„ì œí•œì´ 12ì‹œê°„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    document.body.appendChild(successDiv);
                    
                    // 3ì´ˆ í›„ ìë™ ì œê±°
                    setTimeout(() => {
                        successDiv.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (successDiv.parentNode) {
                                successDiv.parentNode.removeChild(successDiv);
                            }
                        }, 300);
                    }, 3000);
                    
                    // ì‹œê°„ì œí•œ ì—°ì¥ í›„ ì„œë²„ì—ì„œ ìƒˆë¡œ ê°€ì ¸ì˜¤ê¸°
                    updateKernelTimeDisplay(kernelIdStr);
                } else {
                    alert(data.error || 'ì»¤ë„ ì‹œê°„ì œí•œ ì—°ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì»¤ë„ ì‹œê°„ì œí•œ ì—°ì¥ ì‹¤íŒ¨:', error);
                alert('ì»¤ë„ ì‹œê°„ì œí•œ ì—°ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ ì»¤ë„ ìƒíƒœ í™•ì¸ - ì œê±°
        // setInterval(checkKernelStatus, 10000);

        // crawl ì…€ ì´ˆê¸°í™”
        function initializeCrawlCell(cellId, content) {
            try {
                let crawlData;
                
                // contentê°€ ì´ë¯¸ ê°ì²´ì¸ì§€ í™•ì¸
                if (typeof content === 'object' && content !== null) {
                    // ì´ë¯¸ ê°ì²´ë¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    crawlData = content;
                } else {
                    // contentê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                    let contentStr = content;
                    if (typeof content !== 'string') {
                        contentStr = String(content);
                    }
                    
                    // ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ "[object Object]"ì¸ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                    if (!contentStr || contentStr === '[object Object]' || contentStr.trim() === '') {
                        crawlData = { job_type: 'do', action: 'click', params: {} };
                    } else {
                        crawlData = JSON.parse(contentStr);
                    }
                }
                
                // ê¸°ë³¸ê°’ ì¶”ê°€
                crawlData = addDefaultParams(crawlData);
                
                const cell = fileCells[activeFile].find(c => c.id === cellId);
                if (cell) {
                    cell.crawl_data = crawlData;
                }
                
                // Job Type ì„¤ì •
                const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
                if (jobTypeSelect) {
                    jobTypeSelect.value = crawlData.job_type || 'do';
                    updateCrawlActions(cellId, crawlData.job_type || 'do');
                    
                    // Action ì„¤ì • (ì•½ê°„ì˜ ì§€ì—° í›„)
                    setTimeout(() => {
                        const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                        if (actionSelect && crawlData.action) {
                            actionSelect.value = crawlData.action;
                            renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                            
                            // íŒŒë¼ë¯¸í„° ê°’ë“¤ ë³µì› (ì•½ê°„ì˜ ì§€ì—° í›„)
                            setTimeout(() => {
                                if (crawlData.params) {
                                    Object.keys(crawlData.params).forEach(paramName => {
                                        if (paramName === 'focus') {
                                            // focus íŒŒë¼ë¯¸í„° íŠ¹ë³„ ì²˜ë¦¬
                                            const focusData = crawlData.params[paramName];
                                            if (typeof focusData === 'object') {
                                                const focusType = Object.keys(focusData)[0];
                                                const focusValue = focusData[focusType];
                                                
                                                const focusTypeSelect = document.querySelector(`#${cellId} select[name="focus_type"]`);
                                                const focusXpathInput = document.querySelector(`#${cellId} input[name="focus_xpath"]`);
                                                
                                                if (focusTypeSelect && focusXpathInput) {
                                                    // focus íƒ€ì… ì„¤ì •
                                                    focusTypeSelect.value = focusType;
                                                    // xpath ê°’ ë³µì›
                                                    focusXpathInput.value = focusValue;
                                                    console.log(`Focus íŒŒë¼ë¯¸í„° ë³µì›: ${focusType} = ${focusValue}`);
                                                }
                                            }
                                        } else {
                                            const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                            if (paramInput) {
                                                paramInput.value = crawlData.params[paramName];
                                            }
                                        }
                                    });
                                }
                                
                                // XML ì¶œë ¥ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì´ˆê¸° XML ìƒì„±
                                const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
                                if (xmlToggle && xmlToggle.checked) {
                                    generateJsonOutput(cellId);
                                    
                                    // JSON textarea í¬ê¸° ìë™ ì¡°ì •
                                    setTimeout(() => {
                                        const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                                        if (jsonTextarea) {
                                            autoResizeTextarea(jsonTextarea);
                                        }
                                    }, 100);
                                }
                            }, 50);
                        }
                    }, 50);
                }
            } catch (e) {
                console.error('Crawl ì…€ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
            }
        }

        // crawl ì…€ ì—…ë°ì´íŠ¸
        function updateCrawlCell(cellId, field, value) {
            const cell = fileCells[activeFile].find(c => c.id === cellId);
            if (!cell) return;
            
            if (!cell.crawl_data) {
                cell.crawl_data = { job_type: 'do', action: 'click', params: {} };
            }
            
            if (field === 'job_type') {
                cell.crawl_data.job_type = value;
                cell.crawl_data.action = '';
                cell.crawl_data.params = {};
                updateCrawlActions(cellId, value);
            } else if (field === 'action') {
                cell.crawl_data.action = value;
                renderCrawlParams(cellId, cell.crawl_data.job_type, value);
                
                // actionì´ ë³€ê²½ë˜ë©´ ê¸°ë³¸ê°’ ì¶”ê°€
                cell.crawl_data = addDefaultParams(cell.crawl_data);
            } else if (field.startsWith('param_')) {
                const paramName = field.replace('param_', '');
                cell.crawl_data.params[paramName] = value;
                
                // ë™ì  íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (key_count, arg_count ë³€ê²½ ì‹œ)
                if (paramName === 'key_count' && cell.crawl_data.job_type === 'data' && cell.crawl_data.action === 'key_to_list') {
                    handleKeyCountChange(cellId, value);
                } else if (paramName === 'arg_count' && cell.crawl_data.job_type === 'python' && cell.crawl_data.action === 'file') {
                    handleArgCountChange(cellId, value);
                }
            }
            
            // ì…€ ë‚´ìš© ì—…ë°ì´íŠ¸
            cell.content = JSON.stringify(cell.crawl_data, null, 2);
            
            // JSON ì¶œë ¥ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ìë™ ì—…ë°ì´íŠ¸
            const xmlToggle = document.getElementById(`xml-toggle-${cellId}`);
            if (xmlToggle && xmlToggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // crawl ì•¡ì…˜ ì—…ë°ì´íŠ¸ - ëª¨ë“  í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±
        function updateCrawlActions(cellId, jobType) {
            const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
            if (!actionSelect) return;
            
            actionSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            // ì•¡ì…˜ ë¼ë²¨ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            const actionLabel = document.getElementById(`action-label-${cellId}`);
            if (actionLabel) {
                const labelMap = {
                    'do': 'Action:',
                    'find': 'Find Type:',
                    'request': 'Request Type:',
                    'data': 'Convert Type:',
                    'save': 'Save Type:',
                    'load': 'Load Type:',
                    'python': 'Python Type:',
                    'wait': 'Wait Type:',
                    'test': 'Test Type:'
                };
                actionLabel.textContent = labelMap[jobType] || 'Action:';
            }
            
            // job_typesì—ì„œ ë™ì ìœ¼ë¡œ ì•¡ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                
                // jobTypeDataì—ì„œ _typesë‚˜ actionsë¡œ ëë‚˜ëŠ” í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê¸°
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    // job íƒ€ì…ì— ë§ëŠ” ì •í™•í•œ ì•¡ì…˜ íƒ€ì… í‚¤ ì°¾ê¸°
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // ê¸°ë³¸ê°’
                    }
                    
                    const actions = Object.keys(jobTypeData[actionType]);
                    
                    actions.forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        // JOB_TYPESì—ì„œ nameì„ ê°€ì ¸ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©
                        const actionData = jobTypeData[actionType][action];
                        const displayName = actionData && actionData.name ? actionData.name : action.charAt(0).toUpperCase() + action.slice(1);
                        option.textContent = displayName;
                        actionSelect.appendChild(option);
                    });
                }
            }
            
            // íŒŒë¼ë¯¸í„° ì˜ì—­ ì´ˆê¸°í™”
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (paramsDiv) {
                paramsDiv.innerHTML = '';
            }
        }

        // crawl íŒŒë¼ë¯¸í„° ë Œë”ë§
        function renderCrawlParams(cellId, jobType, action) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            paramsDiv.innerHTML = '';
            
            const params = getCrawlParams(jobType, action);
            params.forEach(param => {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                
                let input;
                if (param.name === 'focus') {
                    // focus ì½¤ë³´ë°•ìŠ¤ (xpath, selector, current)
                    const focusTypeSelect = document.createElement('select');
                    focusTypeSelect.name = 'focus_type';
                    ['xpath', 'selector', 'current'].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        focusTypeSelect.appendChild(option);
                    });
                    
                    // xpath ì…ë ¥ë€ (í•­ìƒ ë³´ì„)
                    const focusXpathInput = document.createElement('input');
                    focusXpathInput.name = 'focus_xpath';
                    focusXpathInput.type = 'text';
                    focusXpathInput.placeholder = 'xpath ê°’ (ì˜ˆ: //button[@id="login"])';
                    focusXpathInput.style.marginLeft = '0.5em';
                    
                    // current ì„ íƒ ì‹œ xpath ì…ë ¥ë€ ìˆ¨ê¹€
                    focusTypeSelect.onchange = (e) => {
                        if (e.target.value === 'current') {
                            focusXpathInput.style.display = 'none';
                        } else {
                            focusXpathInput.style.display = '';
                        }
                    };
                    
                    paramField.appendChild(label);
                    paramField.appendChild(focusTypeSelect);
                    paramField.appendChild(focusXpathInput);
                    paramsDiv.appendChild(paramField);
                    return;
                }
                if (param.type === 'select') {
                    input = document.createElement('select');
                    input.name = param.name;
                    param.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                } else {
                    input = document.createElement('input');
                    input.name = param.name;
                    input.type = param.type || 'text';
                    input.placeholder = param.placeholder || '';
                }
                input.onchange = (e) => {
                    updateCrawlCell(cellId, `param_${param.name}`, e.target.value);
                    if (param.name === 'key_count' && jobType === 'data' && action === 'key_to_list') {
                        handleKeyCountChange(cellId, e.target.value);
                    } else if (param.name === 'arg_count' && jobType === 'python' && action === 'file') {
                        handleArgCountChange(cellId, e.target.value);
                    }
                };
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            });
        }
        
        // key_count ë³€ê²½ ì‹œ ë™ì  í‚¤ ì…ë ¥ í•„ë“œ ìƒì„±
        function handleKeyCountChange(cellId, keyCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // ê¸°ì¡´ key_ í•„ë“œë“¤ ì œê±°
            const existingKeyFields = paramsDiv.querySelectorAll('.dynamic-key-field');
            existingKeyFields.forEach(field => field.remove());
            
            // ìƒˆë¡œìš´ key_ í•„ë“œë“¤ ìƒì„±
            for (let i = 0; i < parseInt(keyCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-key-field';
                
                const label = document.createElement('label');
                label.textContent = `Key ${i}`;
                
                const input = document.createElement('input');
                input.name = `key_${i}`;
                input.type = 'text';
                input.placeholder = `data_key_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_key_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }
        
        // arg_count ë³€ê²½ ì‹œ ë™ì  from_ ì…ë ¥ í•„ë“œ ìƒì„±
        function handleArgCountChange(cellId, argCount) {
            const paramsDiv = document.querySelector(`#crawl-params-${cellId}`);
            if (!paramsDiv) return;
            
            // ê¸°ì¡´ from_ í•„ë“œë“¤ ì œê±°
            const existingFromFields = paramsDiv.querySelectorAll('.dynamic-from-field');
            existingFromFields.forEach(field => field.remove());
            
            // ìƒˆë¡œìš´ from_ í•„ë“œë“¤ ìƒì„±
            for (let i = 0; i < parseInt(argCount); i++) {
                const paramField = document.createElement('div');
                paramField.className = 'crawl-param-field dynamic-from-field';
                
                const label = document.createElement('label');
                label.textContent = `From ${i}`;
                
                const input = document.createElement('input');
                input.name = `from_${i}`;
                input.type = 'text';
                input.placeholder = `data_source_${i}`;
                
                input.onchange = (e) => updateCrawlCell(cellId, `param_from_${i}`, e.target.value);
                
                paramField.appendChild(label);
                paramField.appendChild(input);
                paramsDiv.appendChild(paramField);
            }
        }

        // íŒŒë¼ë¯¸í„° íƒ€ì… ê²°ì • í•¨ìˆ˜
        function getParamType(param) {
            const numberParams = ['speed', 'sleep', 'max_time', 'speed_variation', 'wait_time', 'key_count', 'arg_count', 'time'];
            const selectParams = ['find_range', 'print_result'];
            
            if (selectParams.includes(param)) {
                return 'select';
            } else if (numberParams.includes(param)) {
                return 'number';
            } else {
                return 'text';
            }
        }

        // íŒŒë¼ë¯¸í„° ì˜µì…˜ ìƒì„± í•¨ìˆ˜
        function getParamOptions(param) {
            if (param === 'find_range') {
                return [
                    { value: 'self', label: 'Self' },
                    { value: 'all', label: 'All' },
                    { value: 'contain', label: 'Contain' },
                    { value: 'first', label: 'First' },
                    { value: 'last', label: 'Last' },
                    { value: 'next', label: 'Next' },
                    { value: 'parent', label: 'Parent' },
                    { value: 'children', label: 'Children' },
                    { value: 'siblings', label: 'Siblings' }
                ];
            } else if (param === 'print_result') {
                return [
                    { value: 'true', label: 'True' },
                    { value: 'false', label: 'False' }
                ];
            }
            return undefined;
        }

        // íŒŒë¼ë¯¸í„° placeholder ìƒì„± í•¨ìˆ˜
        function getParamPlaceholder(param) {
            const placeholders = {
                'focus': '{"xpath": "//button[@id=\'login\']"}',
                'speed': '1.0',
                'text': 'ì…ë ¥í•  í…ìŠ¤íŠ¸',
                'sleep': '1',
                'max_time': '10',
                'speed_variation': '0.1',
                'value': 'true',
                'find_item': 'main-content',
                'find_attribute': 'data-id',
                'url': 'https://example.com',
                'data': '{"username": "user", "password": "pass"}',
                'wait_time': '2',
                'from': 'extracted_data',
                'to': 'result_data',
                'href_arg': 'https://',
                'text_arg': '\\n',
                'key_count': '3',
                'name': 'result.xlsx',
                'encoding': 'utf-8',
                'script_path': 'process_data.py',
                'arg_count': '2',
                'time': '5',
                'print_result': 'true',
                'filename': 'screenshot.png'
            };
            return placeholders[param] || param;
        }

        // crawl íŒŒë¼ë¯¸í„° ì •ì˜ - ëª¨ë“  í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±
        function getCrawlParams(jobType, action) {
            // JOB_TYPESì—ì„œ ë™ì ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
            if (window.jobTypes && window.jobTypes[jobType]) {
                const jobTypeData = window.jobTypes[jobType];
                
                // jobTypeDataì—ì„œ _typesë‚˜ actionsë¡œ ëë‚˜ëŠ” í‚¤ë¥¼ ë™ì ìœ¼ë¡œ ì°¾ê¸°
                const actionTypeKeys = Object.keys(jobTypeData).filter(key => 
                    key.endsWith('_types') || key === 'actions'
                );
                
                if (actionTypeKeys.length > 0) {
                    // job íƒ€ì…ì— ë§ëŠ” ì •í™•í•œ ì•¡ì…˜ íƒ€ì… í‚¤ ì°¾ê¸°
                    let actionType;
                    if (jobType === 'do') {
                        actionType = 'actions';
                    } else if (jobType === 'find') {
                        actionType = 'find_types';
                    } else if (jobType === 'request') {
                        actionType = 'request_types';
                    } else if (jobType === 'data') {
                        actionType = 'convert_types';
                    } else if (jobType === 'save') {
                        actionType = 'save_types';
                    } else if (jobType === 'load') {
                        actionType = 'load_types';
                    } else if (jobType === 'python') {
                        actionType = 'python_types';
                    } else if (jobType === 'wait') {
                        actionType = 'wait_types';
                    } else if (jobType === 'test') {
                        actionType = 'test_types';
                    } else {
                        actionType = actionTypeKeys[0]; // ê¸°ë³¸ê°’
                    }
                    
                    if (jobTypeData[actionType] && jobTypeData[actionType][action]) {
                        const actionData = jobTypeData[actionType][action];
                        return actionData.params.map(param => ({
                            name: param,
                            label: param.charAt(0).toUpperCase() + param.slice(1).replace('_', ' '),
                            type: getParamType(param),
                            placeholder: getParamPlaceholder(param),
                            options: getParamOptions(param)
                        }));
                    }
                }
            }
            
            // ê¸°ë³¸ê°’ (JOB_TYPESê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ê²½ìš°)
            const params = {
                'save': {
                    'excel': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'excel' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.xlsx' }
                    ],
                    'csv': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'csv' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'txt' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'result.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'mysql' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'save_type', label: 'Save Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'load': {
                    'excel': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'excel' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.xlsx' }
                    ],
                    'csv': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'csv' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.csv' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'txt': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'txt' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'data.txt' },
                        { name: 'encoding', label: 'Encoding', type: 'text', placeholder: 'utf-8' }
                    ],
                    'mysql': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'mysql' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_results' }
                    ],
                    'elasticsearch': [
                        { name: 'load_type', label: 'Load Type', type: 'text', placeholder: 'elasticsearch' },
                        { name: 'from', label: 'From', type: 'text', placeholder: 'loaded_data' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'crawl_index' }
                    ]
                },
                'python': {
                    'file': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'file' },
                        { name: 'script_path', label: 'Script Path', type: 'text', placeholder: 'process_data.py' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' },
                        { name: 'arg_count', label: 'Arg Count', type: 'number', placeholder: '2' }
                    ],
                    'code': [
                        { name: 'python_type', label: 'Python Type', type: 'text', placeholder: 'code' },
                        { name: 'code', label: 'Code', type: 'text', placeholder: 'print(\'Hello World\')' },
                        { name: 'to', label: 'To', type: 'text', placeholder: 'result' }
                    ]
                },
                'wait': {
                    'fixed_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'fixed_time' },
                        { name: 'time', label: 'Time', type: 'number', placeholder: '2.5' }
                    ],
                    'load_time': [
                        { name: 'wait_type', label: 'Wait Type', type: 'text', placeholder: 'load_time' }
                    ]
                },
                'test': {
                    'variable': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'variable' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_var' },
                        { name: 'value', label: 'Value', type: 'text', placeholder: 'Hello World' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'list': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'list' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_list' },
                        { name: 'items', label: 'Items', type: 'text', placeholder: 'apple,banana,orange' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ],
                    'dict': [
                        { name: 'test_type', label: 'Test Type', type: 'text', placeholder: 'dict' },
                        { name: 'name', label: 'Name', type: 'text', placeholder: 'my_dict' },
                        { name: 'key_value_pairs', label: 'Key Value Pairs', type: 'text', placeholder: 'name:John,age:25,city:Seoul' },
                        { name: 'print_result', label: 'Print Result', type: 'select', options: [
                            { value: 'true', label: 'True' },
                            { value: 'false', label: 'False' }
                        ]}
                    ]
                }
            };
            
            return params[jobType]?.[action] || [];
        }

        // crawl ì…€ ì¶”ê°€ í•¨ìˆ˜
        function addCrawlCell(cellId = null) {
            if (!activeFile) return;
            
            const cells = fileCells[activeFile] || [];
            const crawlData = {
                job_type: 'do',
                action: 'click',
                params: {
                    focus: '{"xpath": "//button[@id=\'login\']"}',
                    speed: 1.0
                }
            };
            
            // ê¸°ë³¸ê°’ ì¶”ê°€
            const crawlDataWithDefaults = addDefaultParams(crawlData);
            
            const cell = {
                id: `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${cells.length}`,
                content: JSON.stringify(crawlDataWithDefaults, null, 2),
                output: '',
                status: '',
                cell_type: 'crawl_ui',
                crawl_data: crawlDataWithDefaults, // ê¸°ë³¸ê°’ì´ í¬í•¨ëœ crawl_data ì„¤ì •
                name: `Crawl_${cells.length + 1}` // ê¸°ë³¸ ì´ë¦„ ì„¤ì •
            };
            
            if (cellId) {
                // íŠ¹ì • ì…€ ë‹¤ìŒì— ì¶”ê°€
                const currentIndex = cells.findIndex(c => c.id === cellId);
                if (currentIndex !== -1) {
                    cells.splice(currentIndex + 1, 0, cell);
                } else {
                    cells.push(cell);
                }
            } else {
                // ë§¨ ë§ˆì§€ë§‰ì— ì¶”ê°€
                cells.push(cell);
            }
            
            fileCells[activeFile] = cells;
            renderNotebookCells();
            
            // ìƒˆ ì…€ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const newCell = document.getElementById(cell.id);
                if (newCell) {
                    newCell.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
            
            return cell;
        }

        // JSON ì¶œë ¥ í† ê¸€ í•¨ìˆ˜
        function toggleJsonOutput(cellId) {
            const jsonSection = document.getElementById(`xml-output-${cellId}`);
            const controlsSection = document.getElementById(`crawl-controls-${cellId}`);
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            
            if (toggle.checked) {
                // JSON ì¶œë ¥ í™œì„±í™”: combobox UI ìˆ¨ê¸°ê³  JSON ì¶œë ¥ í‘œì‹œ
                controlsSection.style.display = 'none';
                jsonSection.style.display = 'block';
                
                // JSON textarea í¬ê¸° ìë™ ì¡°ì •
                setTimeout(() => {
                    const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                    if (jsonTextarea) {
                        // ì´ë¯¸ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
                        if (!jsonTextarea.value.trim()) {
                            generateJsonOutput(cellId);
                        }
                        autoResizeTextarea(jsonTextarea);
                    }
                }, 100);
            } else {
                // JSON ì¶œë ¥ ë¹„í™œì„±í™”: JSON ì¶œë ¥ ìˆ¨ê¸°ê³  combobox UI í‘œì‹œ
                jsonSection.style.display = 'none';
                controlsSection.style.display = 'block';
            }
        }

        // JSON ì¶œë ¥ ìƒì„± í•¨ìˆ˜
        function generateJsonOutput(cellId) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (!cell) return;

            try {
                // crawl ì…€ì˜ í˜„ì¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
                let crawlData;
                
                // crawl_dataê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš© (UIì—ì„œ ë³€ê²½ëœ ë°ì´í„°)
                if (cell.crawl_data) {
                    crawlData = cell.crawl_data;
                } else {
                    // crawl_dataê°€ ì—†ìœ¼ë©´ contentë¥¼ íŒŒì‹±
                    let contentStr = cell.content;
                    
                    // contentê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
                    if (typeof contentStr !== 'string') {
                        contentStr = String(contentStr);
                    }
                    
                    if (contentStr) {
                        crawlData = JSON.parse(contentStr);
                    } else {
                        crawlData = { job_type: 'do', action: '', params: {} };
                    }
                }

                // JSON ì¶œë ¥ ì˜ì—­ì— í‘œì‹œ (ê¸°ë³¸ê°’ ì¶”ê°€í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ í‘œì‹œ)
                const jsonContent = JSON.stringify(crawlData, null, 2);
                
                // JSON ì¶œë ¥ ì˜ì—­ì— í‘œì‹œ
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    // ì´ë¯¸ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
                    if (!jsonTextarea.value.trim()) {
                        jsonTextarea.value = jsonContent;
                    }
                    autoResizeTextarea(jsonTextarea);
                }
            } catch (error) {
                console.error('JSON ìƒì„± ì˜¤ë¥˜:', error);
                const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
                if (jsonTextarea) {
                    jsonTextarea.value = `// JSON ìƒì„± ì˜¤ë¥˜: ${error.message}`;
                }
            }
        }

        // íŒŒë¼ë¯¸í„°ì— ê¸°ë³¸ê°’ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function addDefaultParams(crawlData) {
            const jobType = crawlData.job_type || 'do';
            const action = crawlData.action || '';
            
            // ê¸°ë³¸ íŒŒë¼ë¯¸í„° ì •ì˜
            const defaultParams = {
                'do': {
                    'click': { focus: '{"xpath": "//button[@id=\'login\']"}', speed: 1.0 },
                    'text': { focus: '{"xpath": "//input[@name=\'username\']"}', text: 'ì…ë ¥í•  í…ìŠ¤íŠ¸', speed: 1.0 },
                    'clear': { focus: '{"xpath": "//input[@name=\'username\']"}', speed: 1.0 },
                    'enter': {},
                    'pagedown': {},
                    'radio': { focus: '{"xpath": "//input[@type=\'radio\']"}', value: 'true' },
                    'scroll': { sleep: 1, max_time: 10, speed_variation: 0.1 },
                    'scroll_to_element': { focus: '{"xpath": "//div[@class=\'content\']"}', sleep: 1, speed: 0.5, speed_variation: 0.1, max_time: 10 }
                },
                'find': {
                    'id': { find_item: 'main-content', find_range: 'first' },
                    'class': { find_item: 'title', find_range: 'first' },
                    'name': { find_item: 'div', find_range: 'first' },
                    'text': { find_item: 'ë¡œê·¸ì¸', find_range: 'first' },
                    'attribute': { find_attribute: 'data-id', find_item: '123', find_range: 'first' }
                },
                'data': {
                    'to_html': { from: 'extracted_data', to: 'html_data' },
                    'to_xpath': { from: 'extracted_data', to: 'xpath_data' },
                    'to_dataframe': { from: 'extracted_data', to: 'df_data' },
                    'get_href': { from: 'link_data', to: 'href_data', href_arg: 'https://' },
                    'get_hrefs': { from: 'links_data', to: 'hrefs_data', href_arg: 'https://' },
                    'get_text_all': { from: 'html_data', to: 'text_data', text_arg: '\\n' },
                    'get_texts_all': { from: 'html_data', to: 'texts_data', text_arg: '\\n' },
                    'get_text_all_tagonly': { from: 'html_data', to: 'tag_text_data', text_arg: '\\n' },
                    'get_text_all_without_script': { from: 'html_data', to: 'clean_text_data', text_arg: '\\n' },
                    'key_to_list': { to: 'combined_list', key_count: 3 }
                },
                'save': {
                    'excel': { save_type: 'excel', to: 'result_data', name: 'result.xlsx' },
                    'csv': { save_type: 'csv', to: 'result_data', name: 'result.csv', encoding: 'utf-8' },
                    'txt': { save_type: 'txt', to: 'result_data', name: 'result.txt', encoding: 'utf-8' },
                    'mysql': { save_type: 'mysql', to: 'result_data', name: 'crawl_results' },
                    'elasticsearch': { save_type: 'elasticsearch', to: 'result_data', name: 'crawl_index' }
                },
                'load': {
                    'excel': { load_type: 'excel', from: 'loaded_data', name: 'data.xlsx' },
                    'csv': { load_type: 'csv', from: 'loaded_data', name: 'data.csv', encoding: 'utf-8' },
                    'txt': { load_type: 'txt', from: 'loaded_data', name: 'data.txt', encoding: 'utf-8' },
                    'mysql': { load_type: 'mysql', from: 'loaded_data', name: 'crawl_results' },
                    'elasticsearch': { load_type: 'elasticsearch', from: 'loaded_data', name: 'crawl_index' }
                },
                'python': {
                    'file': { python_type: 'file', script_path: 'process_data.py', to: 'result', arg_count: 2 },
                    'code': { python_type: 'code', code: 'print(\'Hello World\')', to: 'result' }
                },
                'wait': {
                    'fixed_time': { wait_type: 'fixed_time', time: 2.5 },
                    'load_time': { wait_type: 'load_time' }
                },
                'request': {
                    'get': { url: 'https://example.com' },
                    'post': { url: 'https://api.example.com', data: '{"username": "user", "password": "pass"}' },
                    'selenium': { url: 'https://example.com', wait_time: 2 }
                },
                'test': {
                    'variable': { test_type: 'variable', name: 'my_var', value: 'Hello World', print_result: 'true' },
                    'list': { test_type: 'list', name: 'my_list', items: 'apple,banana,orange', print_result: 'true' },
                    'dict': { test_type: 'dict', name: 'my_dict', key_value_pairs: 'name:John,age:25,city:Seoul', print_result: 'true' }
                }
            };

            // í˜„ì¬ job_typeê³¼ actionì— ëŒ€í•œ ê¸°ë³¸ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
            const defaults = defaultParams[jobType]?.[action] || {};
            
            // ê¸°ì¡´ íŒŒë¼ë¯¸í„°ì™€ ê¸°ë³¸ê°’ ë³‘í•©
            const mergedParams = { ...defaults, ...crawlData.params };
            
            return {
                ...crawlData,
                params: mergedParams
            };
        }

        // JSON ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡)
        function updateJsonContent(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            try {
                // JSONì„ íŒŒì‹±í•˜ì—¬ crawl ë°ì´í„°ë¡œ ë³€í™˜
                const jsonContent = jsonTextarea.value.trim();
                
                // ë¹ˆ ë‚´ìš©ì´ë©´ ë¬´ì‹œ
                if (!jsonContent) {
                    return;
                }
                
                const crawlData = JSON.parse(jsonContent);
                
                // ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
                const cells = fileCells[activeFile] || [];
                const cell = cells.find(c => c.id === cellId);
                if (cell) {
                    cell.content = JSON.stringify(crawlData, null, 2);
                    cell.crawl_data = crawlData;
                    
                    // crawl ì…€ UI ì—…ë°ì´íŠ¸
                    updateCrawlCellFromJson(cellId, crawlData);
                }
            } catch (error) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì‚¬ìš©ìê°€ ê³„ì† í¸ì§‘í•  ìˆ˜ ìˆë„ë¡ í•¨
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ textareaì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }
        }

        // JSONì—ì„œ íŒŒì‹±ëœ ë°ì´í„°ë¡œ crawl ì…€ UI ì—…ë°ì´íŠ¸
        function updateCrawlCellFromJson(cellId, crawlData) {
            // job_type ì—…ë°ì´íŠ¸
            const jobTypeSelect = document.querySelector(`#${cellId} .crawl-job-type`);
            if (jobTypeSelect && crawlData.job_type) {
                jobTypeSelect.value = crawlData.job_type;
                // job_typeì´ ë³€ê²½ë˜ë©´ action ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
                updateCrawlActions(cellId, crawlData.job_type);
            }
            
            // action ì—…ë°ì´íŠ¸ (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                const actionSelect = document.querySelector(`#${cellId} .crawl-action`);
                if (actionSelect && crawlData.action) {
                    actionSelect.value = crawlData.action;
                    // actionì´ ë³€ê²½ë˜ë©´ íŒŒë¼ë¯¸í„° í•„ë“œë“¤ë„ ì—…ë°ì´íŠ¸
                    renderCrawlParams(cellId, crawlData.job_type, crawlData.action);
                    
                    // íŒŒë¼ë¯¸í„° ê°’ë“¤ ë³µì› (ì•½ê°„ì˜ ì§€ì—° í›„)
                    setTimeout(() => {
                        if (crawlData.params) {
                            Object.keys(crawlData.params).forEach(paramName => {
                                const paramInput = document.querySelector(`#${cellId} input[name="${paramName}"], #${cellId} select[name="${paramName}"]`);
                                if (paramInput) {
                                    paramInput.value = crawlData.params[paramName];
                                }
                            });
                        }
                    }, 50);
                }
            }, 50);
        }

        // JSON ì¶œë ¥ ë³µì‚¬ í•¨ìˆ˜
        function copyJsonOutput(cellId) {
            const jsonTextarea = document.getElementById(`xml-content-${cellId}`);
            if (!jsonTextarea) return;

            jsonTextarea.select();
            jsonTextarea.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ì„ ìœ„í•œ ì„¤ì •

            try {
                document.execCommand('copy');
                
                // ë³µì‚¬ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const copyBtn = document.querySelector(`#xml-output-${cellId} .xml-copy-btn`);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                copyBtn.style.background = '#48bb78';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('JSON ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // crawl ì…€ ì‹¤í–‰ ì‹œ JSON ì¶œë ¥ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
        function runCrawlCell(cellId) {
            // ê¸°ì¡´ ì‹¤í–‰ ë¡œì§...
            
            // JSON ì¶œë ¥ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
            const toggle = document.getElementById(`xml-toggle-${cellId}`);
            if (toggle && toggle.checked) {
                setTimeout(() => {
                    generateJsonOutput(cellId);
                }, 100);
            }
        }

        // íŒŒì¼ ì—…ë°ì´íŠ¸ í™•ì¸ ë° reload í•¨ìˆ˜
        function checkFileUpdatedAndReload(filePath, expectedContent, retryCount = 0) {
            const maxRetries = 10; // ìµœëŒ€ 10ë²ˆ ì‹œë„
            const retryDelay = 200; // 200ms ê°„ê²©
            
            fetch(`/api/files/content?path=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // íŒŒì¼ ë‚´ìš©ì´ ì˜ˆìƒí•œ ë‚´ìš©ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                        if (data.content === expectedContent) {
                            console.log('íŒŒì¼ ì—…ë°ì´íŠ¸ í™•ì¸ë¨, reload ì‹œì‘');
                            // íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        } else if (retryCount < maxRetries) {
                            // ì•„ì§ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì‹œë„
                            console.log(`íŒŒì¼ ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘... (${retryCount + 1}/${maxRetries})`);
                            setTimeout(() => {
                                checkFileUpdatedAndReload(filePath, expectedContent, retryCount + 1);
                            }, retryDelay);
                        } else {
                            console.log('íŒŒì¼ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨, ìˆ˜ë™ reload');
                            // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìœ¼ë¯€ë¡œ ê°•ì œ reload
                            const fileName = filePath.split('/').pop();
                            const file = { path: filePath, name: fileName };
                            selectFile(file);
                        }
                    } else {
                        console.error('íŒŒì¼ ë‚´ìš© í™•ì¸ ì‹¤íŒ¨:', data.message);
                        // í™•ì¸ ì‹¤íŒ¨ ì‹œ ê°•ì œ reload
                        const fileName = filePath.split('/').pop();
                        const file = { path: filePath, name: fileName };
                        selectFile(file);
                    }
                })
                .catch(error => {
                    console.error('íŒŒì¼ ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°•ì œ reload
                    const fileName = filePath.split('/').pop();
                    const file = { path: filePath, name: fileName };
                    selectFile(file);
                });
        }

        function renderNotebookCells() {
            const notebookCells = document.getElementById('notebookCells');
            notebookCells.innerHTML = '';
            if (!activeFile || !fileCells[activeFile]) return;
            fileCells[activeFile].forEach((cell, idx) => {
                cell.id = `cell-${activeFile.replace(/[^a-zA-Z0-9]/g, '_')}-${idx}`;
                const cellDiv = createCellElement(cell, idx);
                notebookCells.appendChild(cellDiv);
            });
            
            // ëª¨ë“  ì…€ì˜ textarea í¬ê¸° ìë™ ì¡°ì •
            setTimeout(() => {
                document.querySelectorAll('.cell-input').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        // ì…€ ì´ë¦„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCellName(cellId, name) {
            const cells = fileCells[activeFile] || [];
            const cell = cells.find(c => c.id === cellId);
            if (cell) {
                cell.name = name;
                // ì…€ ì´ë¦„ì´ ë³€ê²½ë˜ë©´ ìë™ ì €ì¥
                setTimeout(() => saveNotebookToFile(), 500);
            }
        }

        // crawl ì…€ì— ìë™ ë²ˆí˜¸ ë¶€ì—¬í•˜ëŠ” í•¨ìˆ˜
        function renumberCrawlCells() {
            if (!activeFile || !fileCells[activeFile]) return;
            
            const cells = fileCells[activeFile];
            cells.forEach((cell, index) => {
                if ((cell.cell_type === 'crawl' || cell.cell_type === 'crawl_ui' || cell.cell_type === 'crawl_json') && (!cell.name || cell.name === '')) {
                    cell.name = `Crawl_${index + 1}`;
                }
            });
            
            renderNotebookCells();
            saveNotebook();
        }

        function runCell(cellId) {
            // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì…€ì´ë©´ íì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (currentExecutingCell === cellId) {
                console.log(`ì…€ ${cellId}ëŠ” ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
                return;
            }
            
            // ì´ë¯¸ íì— ìˆëŠ” ì…€ì´ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (cellExecutionQueue.includes(cellId)) {
                console.log(`ì…€ ${cellId}ëŠ” ì´ë¯¸ íì— ìˆìŠµë‹ˆë‹¤.`);
                return;
            }
            
            // íì— ì…€ ì¶”ê°€
            cellExecutionQueue.push(cellId);
            console.log(`ì…€ ${cellId}ê°€ íì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ í:`, cellExecutionQueue);
            
            // ëŒ€ê¸°ì¤‘ ìƒíƒœë¡œ ë³€ê²½
            const statusSpan = document.querySelector(`#status-${cellId}`);
            if (statusSpan) {
                statusSpan.textContent = 'ëŒ€ê¸°ì¤‘';
                statusSpan.className = 'cell-status waiting';
            }
            
            // í ì²˜ë¦¬ ì‹œì‘
            processCellQueue();
        }

        // focus íŒŒë¼ë¯¸í„°ë¥¼ ì˜¬ë°”ë¥¸ êµ¬ì¡°ë¡œ ì €ì¥
        function updateFocusParam(cellId, focusType, focusValue) {
            let value;
            if (focusType === 'current') {
                value = 'current';
            } else {
                value = {};
                value[focusType] = focusValue;
            }
            updateCrawlCell(cellId, 'param_focus', value);
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë³´ì—¬ì£¼ê¸°
        function showImageModal(file) {
            // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }

            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <h3>${file.name}</h3>
                        <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
                    </div>
                    <div class="image-modal-body">
                        <img src="/api/files/image?path=${encodeURIComponent(file.path)}" alt="${file.name}" style="max-width: 100%; max-height: 80vh; object-fit: contain;">
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            });
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>

    <style>
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .image-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .image-modal-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .image-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            color: #333;
        }

        .image-modal-body {
            padding: 20px;
            text-align: center;
            background: white;
        }

        /* Footer ìŠ¤íƒ€ì¼ */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-top: 1px solid #4a5568;
            z-index: 1000;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-left, .footer-right {
            font-size: 0.9rem;
        }

        /* ì‹¤ì‹œê°„ ìŠ¤í¬ë¦°ìƒ· íƒ­ ìŠ¤íƒ€ì¼ */
        .screenshot-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px 0 0 8px;
            padding: 1rem;
            cursor: pointer;
            z-index: 2000;
            transition: all 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }

        .screenshot-tab:hover {
            background: #4a5568;
        }

        .screenshot-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1a202c;
            color: #e2e8f0;
            z-index: 1999;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .screenshot-panel.open {
            right: 0;
        }

        .screenshot-header {
            background: #2d3748;
            padding: 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .screenshot-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .screenshot-close {
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-close:hover {
            color: #f56565;
        }

        .screenshot-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .screenshot-info {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .screenshot-image-container {
            background: #2d3748;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .screenshot-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            border: 1px solid #4a5568;
        }

        .screenshot-status {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #2d3748;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</body>
</html>