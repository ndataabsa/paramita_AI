<!-- ì»¤ë„ ê´€ë¦¬ì ì»´í¬ë„ŒíŠ¸ -->
<div class="kernel-manager-content" style="max-height: 80vh; overflow-y: auto;">
    <div style="padding: 1rem;">
        <h3 style="margin-top:0; font-size: 1.1rem;">ì»¤ë„ ê´€ë¦¬ì</h3>
        <div style="margin-bottom: 1rem;">
            <strong style="font-size: 0.9rem;">í”„ë¡œì íŠ¸ ì»¤ë„ ëª©ë¡:</strong>
            <div id="projectKernelsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #4a5568; border-radius: 4px; padding: 0.5rem;">ì—†ìŒ</div>
        </div>
        <div style="margin-bottom: 1rem;">
            <strong style="font-size: 0.9rem;">ìŠ¤ìº”ëœ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ëª©ë¡:</strong>
            <div id="scannedKernelsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #4a5568; border-radius: 4px; padding: 0.5rem;">ì—†ìŒ</div>
        </div>
        <div style="margin-bottom: 1rem;">
            <button class="btn btn-secondary" onclick="updateKernelList()" style="font-size: 0.75rem;">ğŸ“‹ ì»¤ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-info" onclick="scanProcessKernels()" style="font-size: 0.75rem;">ğŸ” í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº”</button>
            <button class="btn btn-warning" onclick="cleanupInactiveKernels()" style="font-size: 0.75rem;">12ì‹œê°„ ì´ìƒ ë¹„í™œì„± ì»¤ë„ ì •ë¦¬</button>
            <button class="btn btn-danger" onclick="cleanupAllKernels()" style="font-size: 0.75rem;">ëª¨ë“  ì»¤ë„ ì •ë¦¬</button>
        </div>
    </div>
</div>
<link rel="stylesheet" href="/templates/component/kernel_manager/kernel_manager.css">
<script>
// --- ì»¤ë„ ê´€ë¦¬ì í•¨ìˆ˜ë“¤ (notebook.html.bakì—ì„œ ì¶”ì¶œ) ---
function initializeKernel() {
    // console.log('=== initializeKernel í˜¸ì¶œ ===');
    // console.log('activeFile:', activeFile);
    // console.log('activeFile íƒ€ì…:', typeof activeFile);
    
    if (!activeFile) {
        return;
    }
    const fileName = activeFile.split('/').pop().toLowerCase();
    // console.log('íŒŒì¼ëª…:', fileName);
    // console.log('ì „ì²´ ê²½ë¡œ:', activeFile);
    
    if (!fileName.endsWith('.py') && !fileName.endsWith('.ipynb') && !fileName.endsWith('.npn')) {
        return;
    }
    if (!confirm('ì»¤ë„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ì»¤ë„ì´ ìˆìœ¼ë©´ ì¢…ë£Œ í›„ ìƒˆ ì»¤ë„ì´ ìƒì„±ë©ë‹ˆë‹¤. ëª¨ë“  ë³€ìˆ˜ì™€ ì‹¤í–‰ ê¸°ë¡ì´ ì§€ì›Œì§‘ë‹ˆë‹¤.')) {
        return;
    }
    const oldKernelId = fileKernels[activeFile];
    const shutdownOldKernel = oldKernelId ? fetch(`/api/kernels/${oldKernelId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    }).then(r => r.json()) : Promise.resolve({ success: true });
    shutdownOldKernel.then(() => {
        // ìƒˆë¡œìš´ íŒŒì¼-ì‚¬ìš©ì ì»¤ë„ ìƒì„± API ì‚¬ìš©
        fetch('/api/kernels/file-user', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                file_path: activeFile
            })
        })
        .then(response => response.json())
        .then(data => {
            // console.log('ì»¤ë„ ì´ˆê¸°í™” ì‘ë‹µ:', data);
            if (data.success) {
                fileKernels[activeFile] = data.kernel_id;
                updateKernelInfo();
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: í™œì„±';
                    displayElement.style.color = '#68d391';
                }
                
                // ì»¤ë„ ìƒì„± í›„ ì¦‰ì‹œ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                if (typeof startKernelTimeUpdate === 'function') {
                    startKernelTimeUpdate();
                }
                
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #22543d; color: #9ae6b4; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
                successDiv.textContent = 'ìƒˆ ì»¤ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                document.body.appendChild(successDiv);
                setTimeout(() => {
                    successDiv.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
                }, 3000);
                clearAllOutputs && clearAllOutputs();
            }
        })
        .catch(error => {
            // console.error('ì»¤ë„ ìƒì„± ì‹¤íŒ¨:', error);
        });
    });
}
function shutdownKernel() {
    if (!activeFile || !fileKernels[activeFile]) {
        return;
    }
    if (!confirm('ì»¤ë„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë³€ìˆ˜ì™€ ì‹¤í–‰ ê¸°ë¡ì´ ì§€ì›Œì§‘ë‹ˆë‹¤.')) {
        return;
    }
    const kernelId = fileKernels[activeFile];
    fetch(`/api/kernels/${kernelId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
            .then(data => {
            if (data.success) {
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #742a2a; color: #feb2b2; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
                successDiv.textContent = 'ì»¤ë„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                document.body.appendChild(successDiv);
                setTimeout(() => {
                    successDiv.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
                }, 3000);
                clearAllOutputs && clearAllOutputs();
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                    displayElement.style.color = '#a0aec0';
                }
                
                // ì»¤ë„ ì¢…ë£Œ í›„ ì‹œê°„ í‘œì‹œ ì´ˆê¸°í™”
                const timeDisplayElement = document.getElementById('kernelTimeDisplay');
                if (timeDisplayElement) {
                    timeDisplayElement.textContent = 'ë‚¨ì€ ì‹œê°„: --:--:--';
                }
                
                // ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘ì§€
                if (typeof stopKernelTimeUpdate === 'function') {
                    stopKernelTimeUpdate();
                }
                
                delete fileKernels[activeFile];
        }
    })
    .catch(error => {
        // console.error('ì»¤ë„ ì¢…ë£Œ ì‹¤íŒ¨:', error);
    });
}
function refreshKernelList() {
    // console.log('=== ì»¤ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ ===');
    
    // ì„œë²„ì—ì„œ ì»¤ë„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    fetch('/api/kernels')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // console.log('ì„œë²„ ì»¤ë„ ëª©ë¡:', data.kernels);
                
                // íŒŒì¼-ì»¤ë„ ë§¤í•‘ ìƒˆë¡œê³ ì¹¨
                if (typeof restoreKernelState === 'function') {
                    restoreKernelState();
                }
                
                // ì¶”ê°€ë¡œ íŒŒì¼-ì»¤ë„ ë§¤í•‘ë„ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
                fetch('/api/kernels/file-mappings')
                    .then(response => response.json())
                    .then(mappingData => {
                        if (mappingData.success && mappingData.mappings) {
                            // console.log('íŒŒì¼-ì»¤ë„ ë§¤í•‘:', mappingData.mappings);
                            fileKernels = mappingData.mappings;
                        }
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateKernelInfo();
                        

                    })
                    .catch(error => {
                        // console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                        // ë§¤í•‘ ì‹¤íŒ¨í•´ë„ UI ì—…ë°ì´íŠ¸
                        updateKernelInfo();
                    });
            } else {
                // console.error('ì»¤ë„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', data.error);
            }
        })
        .catch(error => {
            // console.error('ì»¤ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
        });
}

function scanProcessKernels() {
    // console.log('=== í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº” ì‹œì‘ ===');
    
    // í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº” API í˜¸ì¶œ
    fetch('/api/kernels/scan-process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // console.log('í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº” ê²°ê³¼:', data.kernels);
            
            // ìŠ¤ìº”ëœ ì»¤ë„ ëª©ë¡ ì—…ë°ì´íŠ¸
            updateScannedKernelsList();
        } else {
            // console.error('í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº” ì‹¤íŒ¨:', data.error);
        }
    })
    .catch(error => {
        // console.error('í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº” ì˜¤ë¥˜:', error);
    });
}

function updateKernelInfo() {
    // console.log('=== updateKernelInfo í˜¸ì¶œ ===');
    // console.log('activeFile:', activeFile);
    // console.log('fileKernels:', fileKernels);
    
    // í”„ë¡œì íŠ¸ ì»¤ë„ ëª©ë¡ ì—…ë°ì´íŠ¸
    const projectKernelsList = document.getElementById('projectKernelsList');
    const kernelEntries = Object.entries(fileKernels || {});
    // console.log('kernelEntries:', kernelEntries);
    
    if (kernelEntries.length > 0) {
        projectKernelsList.innerHTML = kernelEntries.map(([filePath, kernelId]) => {
            const fileName = filePath.split('/').pop();
            const isActive = filePath === activeFile;
            return `<div style="margin-bottom: 0.3rem; padding: 0.3rem; background: ${isActive ? '#2c5282' : '#4a5568'}; border-radius: 4px; border-left: 3px solid ${isActive ? '#63b3ed' : '#718096'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <span style="${isActive ? 'color: #63b3ed;' : 'color: #e2e8f0;'} font-weight: bold; font-size: 0.85rem;">${fileName}</span>
                        <span style="color: #a0aec0; font-size: 0.65rem; margin-left: 0.5rem;">${isActive ? '(í™œì„±)' : ''}</span>
                    </div>
                    <button onclick="shutdownKernelForFile('${filePath}')" style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.65rem; cursor: pointer;">ì¢…ë£Œ</button>
                </div>
            </div>`;
        }).join('');
    } else {
        projectKernelsList.innerHTML = 'ì—†ìŒ';
    }
    
    // console.log('=== updateKernelInfo ì™„ë£Œ ===');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” (ìŠ¤ìº” ì—†ì´)
document.addEventListener('DOMContentLoaded', function() {
    updateKernelInfo();
    updateKernelList(); // ì»¤ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì¶”ê°€
    // ìŠ¤ìº”ëœ ì»¤ë„ ëª©ë¡ì€ ìˆ˜ë™ìœ¼ë¡œë§Œ ì—…ë°ì´íŠ¸
    document.getElementById('scannedKernelsList').innerHTML = 'í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì„ ìŠ¤ìº”í•˜ë ¤ë©´ "í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ìŠ¤ìº”" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.';
});

function updateScannedKernelsList() {
    // ê¸°ì¡´ ì»¤ë„ ëª©ë¡ë§Œ ê°€ì ¸ì˜¤ê¸° (ìŠ¤ìº” ì—†ì´)
    fetch('/api/kernels')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const scannedKernelsList = document.getElementById('scannedKernelsList');
            const scannedKernels = [];
            
            // í”„ë¡œì„¸ìŠ¤ ì»¤ë„ë§Œ í•„í„°ë§
            Object.entries(data.kernels).forEach(([kernelId, status]) => {
                if (kernelId.startsWith('process_kernel_')) {
                    scannedKernels.push({ kernelId, status });
                }
            });
            
            if (scannedKernels.length > 0) {
                scannedKernelsList.innerHTML = scannedKernels.map(({ kernelId, status }) => {
                    const pid = kernelId.replace('process_kernel_', '');
                    
                    return `<div style="margin-bottom: 0.3rem; padding: 0.3rem; background: #4a5568; border-radius: 4px; border-left: 3px solid #68d391;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <span style="color: #68d391; font-weight: bold; font-size: 0.85rem;">PID: ${pid}</span>
                            </div>
                            <div style="display: flex; gap: 0.2rem;">
                                <button onclick="toggleProcessDetails('${kernelId}')" style="background: #718096; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.65rem; cursor: pointer;">ìƒì„¸</button>
                                <button onclick="addProcessKernelToProject('${kernelId}')" style="background: #3182ce; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.65rem; cursor: pointer;">ì¶”ê°€</button>
                                <button onclick="terminateProcessKernel('${kernelId}')" style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.65rem; cursor: pointer;">ì¢…ë£Œ</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                scannedKernelsList.innerHTML = 'ìŠ¤ìº”ëœ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì´ ì—†ìŠµë‹ˆë‹¤.';
            }
        } else {
            document.getElementById('scannedKernelsList').innerHTML = 'ì»¤ë„ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        }
    })
    .catch(error => {
        document.getElementById('scannedKernelsList').innerHTML = 'ì»¤ë„ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    });
}

function toggleProcessDetails(kernelId) {
    // console.log('=== í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´ í† ê¸€ ===');
    
    // ê¸°ì¡´ ìƒì„¸ íŒ¨ë„ ì œê±°
    const existingPanel = document.getElementById('process-details-panel');
    if (existingPanel) {
        existingPanel.remove();
    }
    
    // ê°™ì€ ì»¤ë„ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš° íŒ¨ë„ì„ ë‹«ìŒ
    if (window.currentDetailKernelId === kernelId) {
        window.currentDetailKernelId = null;
        return;
    }
    
    // ì„œë²„ì—ì„œ ì»¤ë„ ìƒíƒœì™€ í”„ë¡œì íŠ¸ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    Promise.all([
        fetch(`/api/kernels/${kernelId}/status`).then(response => response.json()),
        fetch(`/api/kernels/${kernelId}/project-status`).then(response => response.json())
    ])
    .then(([statusData, projectData]) => {
        if (statusData.success) {
            const status = statusData.status;
            const pid = kernelId.replace('process_kernel_', '');
            const cmdline = status.cmdline ? status.cmdline.join(' ') : 'Unknown';
            const username = status.username || 'Unknown';
            
            // í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸
            let projectStatusHtml = '';
            if (projectData.success) {
                if (projectData.is_project_kernel) {
                    const projectInfo = projectData.project_info;
                    projectStatusHtml = `
                        <div style="margin-bottom: 0.5rem; padding: 0.3rem; background: #22543d; border-radius: 3px;">
                            <strong style="color: #9ae6b4;">âœ… í”„ë¡œì íŠ¸ ì»¤ë„</strong>
                            <div style="color: #9ae6b4; font-size: 0.7rem; margin-top: 0.2rem;">íŒŒì¼: ${projectInfo.file_name}</div>
                        </div>
                    `;
                } else {
                    projectStatusHtml = `
                        <div style="margin-bottom: 0.5rem; padding: 0.3rem; background: #744210; border-radius: 3px;">
                            <strong style="color: #fbd38d;">âš ï¸ ì™¸ë¶€ í”„ë¡œì„¸ìŠ¤</strong>
                            <div style="color: #fbd38d; font-size: 0.7rem; margin-top: 0.2rem;">í”„ë¡œì íŠ¸ì— ì¶”ê°€ë˜ì§€ ì•ŠìŒ</div>
                        </div>
                    `;
                }
            }
            
            // ìƒì„¸ íŒ¨ë„ ìƒì„±
            const panel = document.createElement('div');
            panel.id = 'process-details-panel';
            panel.style.cssText = `
                position: absolute;
                background: #2d3748;
                border: 2px solid #4a5568;
                border-radius: 8px;
                padding: 1rem;
                z-index: 1000;
                max-width: 500px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.5);
                font-size: 0.8rem;
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #4a5568; padding-bottom: 0.5rem;">
                    <h4 style="margin: 0; color: #e2e8f0;">í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´</h4>
                    <button onclick="this.parentElement.parentElement.remove(); window.currentDetailKernelId = null;" style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; cursor: pointer; font-size: 0.7rem;">ë‹«ê¸°</button>
                </div>
                ${projectStatusHtml}
                <div style="margin-bottom: 0.5rem;"><strong style="color: #e2e8f0;">PID:</strong> <span style="color: #a0aec0;">${pid}</span></div>
                <div style="margin-bottom: 0.5rem;"><strong style="color: #e2e8f0;">ì‚¬ìš©ì:</strong> <span style="color: #a0aec0;">${username}</span></div>
                <div style="margin-bottom: 0.5rem;"><strong style="color: #e2e8f0;">CPU:</strong> <span style="color: #a0aec0;">${status.cpu_percent || 0}%</span></div>
                <div style="margin-bottom: 0.5rem;"><strong style="color: #e2e8f0;">ë©”ëª¨ë¦¬:</strong> <span style="color: #a0aec0;">${status.memory_percent || 0}%</span></div>
                <div style="margin-bottom: 0.5rem;"><strong style="color: #e2e8f0;">ì‹œì‘ ì‹œê°„:</strong> <span style="color: #a0aec0;">${status.create_time || 'Unknown'}</span></div>
                <div style="margin-bottom: 0.5rem;"><strong style="color: #e2e8f0;">ëª…ë ¹ì–´:</strong></div>
                <div style="background: #1a202c; padding: 0.5rem; border-radius: 4px; font-family: monospace; color: #a0aec0; word-break: break-all; white-space: pre-wrap; font-size: 0.7rem; margin-bottom: 1rem;">${cmdline}</div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button onclick="addProcessKernelToProject('${kernelId}')" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.7rem;">í”„ë¡œì íŠ¸ì— ì¶”ê°€</button>
                    <button onclick="terminateProcessKernel('${kernelId}')" style="background: #e53e3e; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.7rem;">ì¢…ë£Œ</button>
                </div>
            `;
                
                // ìƒì„¸ ë²„íŠ¼ ìœ„ì¹˜ ì°¾ê¸°
                const button = document.querySelector(`button[onclick="toggleProcessDetails('${kernelId}')"]`);
                if (button) {
                    const rect = button.getBoundingClientRect();
                    panel.style.left = (rect.right + 10) + 'px';
                    panel.style.top = rect.top + 'px';
                }
                
                document.body.appendChild(panel);
                window.currentDetailKernelId = kernelId;
                
                // íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                document.addEventListener('click', function closePanel(e) {
                    if (!panel.contains(e.target) && !button.contains(e.target)) {
                        panel.remove();
                        window.currentDetailKernelId = null;
                        document.removeEventListener('click', closePanel);
                    }
                });
            }
        })
        .catch(error => {
            // console.error('ì»¤ë„ ìƒíƒœ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
        });
}

function terminateProcessKernel(kernelId) {
    // console.log('=== í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¢…ë£Œ ===');
    // console.log('kernelId:', kernelId);
    
    if (!confirm('ì´ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    // ì„œë²„ì— í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¢…ë£Œ ìš”ì²­
    fetch(`/api/kernels/${kernelId}/terminate-process`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ìƒì„¸ íŒ¨ë„ì´ ì—´ë ¤ìˆê³  ì¢…ë£Œëœ ì»¤ë„ì˜ ê²ƒì´ë¼ë©´ ë‹«ê¸°
            if (window.currentDetailKernelId === kernelId) {
                const existingPanel = document.getElementById('process-details-panel');
                if (existingPanel) {
                    existingPanel.remove();
                    window.currentDetailKernelId = null;
                }
            }
            
            // ì„±ê³µ ë©”ì‹œì§€
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #742a2a; color: #feb2b2; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
            successDiv.textContent = `í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: ${kernelId}`;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
            }, 3000);
            
                        // ì»¤ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            updateScannedKernelsList();
        }
    })
    .catch(error => {
        // console.error('í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¢…ë£Œ ì˜¤ë¥˜:', error);
    });
}

function showProcessDetails(kernelId, pid, status, cmdline) {
    // console.log('=== í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´ í‘œì‹œ ===');
    
    // íŒì—… ìƒì„±
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #2d3748;
        border: 2px solid #4a5568;
        border-radius: 8px;
        padding: 1.5rem;
        z-index: 10000;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    `;
    
    popup.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #4a5568; padding-bottom: 0.5rem;">
            <h3 style="margin: 0; color: #e2e8f0;">í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´</h3>
            <button onclick="this.parentElement.parentElement.remove()" style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem;">ë‹«ê¸°</button>
        </div>
        <div style="margin-bottom: 1rem;">
            <strong style="color: #e2e8f0;">ì»¤ë„ ID:</strong>
            <span style="color: #a0aec0; margin-left: 0.5rem;">${kernelId}</span>
        </div>
        <div style="margin-bottom: 1rem;">
            <strong style="color: #e2e8f0;">í”„ë¡œì„¸ìŠ¤ ID:</strong>
            <span style="color: #a0aec0; margin-left: 0.5rem;">${pid}</span>
        </div>
        <div style="margin-bottom: 1rem;">
            <strong style="color: #e2e8f0;">ìƒíƒœ:</strong>
            <span style="color: ${status === 'ì‹¤í–‰ ì¤‘' ? '#68d391' : '#e53e3e'}; margin-left: 0.5rem;">${status}</span>
        </div>
        <div style="margin-bottom: 1rem;">
            <strong style="color: #e2e8f0;">ëª…ë ¹ì–´:</strong>
            <div style="background: #1a202c; padding: 0.5rem; border-radius: 4px; margin-top: 0.3rem; font-family: monospace; font-size: 0.8rem; color: #a0aec0; word-break: break-all; white-space: pre-wrap;">${cmdline}</div>
        </div>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button onclick="addProcessKernelToProjectFromPopup('${kernelId}', this)" style="background: #3182ce; color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer;">í”„ë¡œì íŠ¸ì— ì¶”ê°€</button>
        </div>
    `;
    
    // ë°°ê²½ ì˜¤ë²„ë ˆì´ ì¶”ê°€
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    `;
    overlay.onclick = () => {
        overlay.remove();
        popup.remove();
    };
    
    document.body.appendChild(overlay);
    document.body.appendChild(popup);
}

function addProcessKernelToProjectFromPopup(kernelId, buttonElement) {
    // console.log('=== íŒì—…ì—ì„œ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì„ í”„ë¡œì íŠ¸ì— ì¶”ê°€ ===');
    
    // ì‚¬ìš©ìì—ê²Œ íŒŒì¼ëª… ì…ë ¥ë°›ê¸°
    const fileName = prompt('ì´ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì„ ì—°ê²°í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: process_script.py):');
    if (!fileName) {
        return;
    }
    
    // íŒŒì¼ ê²½ë¡œ ìƒì„± (í˜„ì¬ ë””ë ‰í† ë¦¬ ê¸°ì¤€)
    const filePath = fileName;
    
    // ì„œë²„ì— í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¶”ê°€ ìš”ì²­
    fetch('/api/kernels/add-process-to-project', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            file_path: filePath,
            kernel_id: kernelId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì„ í”„ë¡œì íŠ¸ ì»¤ë„ë¡œ ì¶”ê°€
            fileKernels[filePath] = kernelId;
            
            // UI ì—…ë°ì´íŠ¸
            updateKernelInfo();
            
            // íŒì—… ë‹«ê¸°
            const popup = buttonElement.closest('div[style*="position: fixed"]');
            const overlay = document.querySelector('div[style*="background: rgba(0,0,0,0.5)"]');
            if (popup) popup.remove();
            if (overlay) overlay.remove();
            
            // ì„±ê³µ ë©”ì‹œì§€
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #22543d; color: #9ae6b4; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
            successDiv.textContent = `í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì´ í”„ë¡œì íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
            }, 3000);
        }
    })
    .catch(error => {
        // console.error('í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¶”ê°€ ì˜¤ë¥˜:', error);
    });
}

function addProcessKernelToProject(kernelId) {
    // ì‚¬ìš©ìì—ê²Œ íŒŒì¼ëª… ì…ë ¥ë°›ê¸°
    const fileName = prompt('ì´ í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì„ ì—°ê²°í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: process_script.py):');
    if (!fileName) {
        return;
    }
    
    // íŒŒì¼ ê²½ë¡œ ìƒì„± (í˜„ì¬ ë””ë ‰í† ë¦¬ ê¸°ì¤€)
    const filePath = fileName;
    
    // ì„œë²„ì— í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¶”ê°€ ìš”ì²­
    fetch('/api/kernels/add-process-to-project', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            file_path: filePath,
            kernel_id: kernelId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // UI ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ë§¤í•‘ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ í‘œì‹œ)
            updateKernelList();
            
            // ì„±ê³µ ë©”ì‹œì§€
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #22543d; color: #9ae6b4; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
            successDiv.textContent = `í”„ë¡œì„¸ìŠ¤ ì»¤ë„ì´ í”„ë¡œì íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
            }, 3000);
        }
    })
    .catch(error => {
        // console.error('í”„ë¡œì„¸ìŠ¤ ì»¤ë„ ì¶”ê°€ ì˜¤ë¥˜:', error);
    });
}
function shutdownKernelForFile(filePath) {
    // íŒŒì¼ ê²½ë¡œë¡œ ì»¤ë„ IDë¥¼ ì°¾ê¸° ìœ„í•´ ì„œë²„ì— ìš”ì²­
    fetch(`/api/kernels/file-mapping?file_path=${encodeURIComponent(filePath)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.kernel_id) {
                const kernelId = data.kernel_id;
                
                if (!confirm(`"${filePath.split('/').pop()}" íŒŒì¼ì˜ ì»¤ë„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
                
                fetch(`/api/kernels/${kernelId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ìƒì„¸ íŒ¨ë„ì´ ì—´ë ¤ìˆê³  ì¢…ë£Œëœ ì»¤ë„ì˜ ê²ƒì´ë¼ë©´ ë‹«ê¸°
                        if (window.currentDetailKernelId === kernelId) {
                            const existingPanel = document.getElementById('process-details-panel');
                            if (existingPanel) {
                                existingPanel.remove();
                                window.currentDetailKernelId = null;
                            }
                        }
                        
                        const successDiv = document.createElement('div');
                        successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #742a2a; color: #feb2b2; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
                        successDiv.textContent = `ì»¤ë„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: ${filePath.split('/').pop()}`;
                        document.body.appendChild(successDiv);
                        setTimeout(() => {
                            successDiv.style.animation = 'slideOut 0.3s ease';
                            setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
                        }, 3000);
                        
                        // UI ì—…ë°ì´íŠ¸ (ì„œë²„ì—ì„œ ë§¤í•‘ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ í‘œì‹œ)
                        updateKernelList();
                    }
                })
                .catch(error => {
                    // console.error('ì»¤ë„ ì¢…ë£Œ ì˜¤ë¥˜:', error);
                });
            }
        })
        .catch(error => {
            // console.error('íŒŒì¼-ì»¤ë„ ë§¤í•‘ í™•ì¸ ì˜¤ë¥˜:', error);
        });
}
function cleanupInactiveKernels() {
    if (!confirm('12ì‹œê°„ ì´ìƒ ë¹„í™œì„±ì¸ ì»¤ë„ë“¤ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    fetch('/api/kernels/cleanup-inactive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #22543d; color: #9ae6b4; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
            successDiv.textContent = data.message;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
            }, 3000);
            updateKernelInfo();
        }
    })
    .catch(error => {
        // console.error('ë¹„í™œì„± ì»¤ë„ ì •ë¦¬ ì‹¤íŒ¨:', error);
    });
}
function cleanupAllKernels() {
    if (!confirm('ëª¨ë“  ì»¤ë„ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    fetch('/api/kernels/cleanup-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ëª¨ë“  ì»¤ë„ì´ ì •ë¦¬ë˜ë¯€ë¡œ ìƒì„¸ íŒ¨ë„ë„ ë‹«ê¸°
            const existingPanel = document.getElementById('process-details-panel');
            if (existingPanel) {
                existingPanel.remove();
                window.currentDetailKernelId = null;
            }
            
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `position: fixed; top: 20px; right: 20px; background: #742a2a; color: #feb2b2; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease;`;
            successDiv.textContent = data.message;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => { if (successDiv.parentNode) { successDiv.parentNode.removeChild(successDiv); } }, 300);
            }, 3000);
            fileKernels = {};
            updateKernelInfo();
            if (activeFile) {
                document.getElementById('currentKernelInfo').textContent = 'ì—†ìŒ';
                document.getElementById('kernelStatusText').textContent = 'ì»¤ë„ ì—†ìŒ';
                const displayElement = document.getElementById('kernelStatusDisplay');
                if (displayElement) {
                    displayElement.textContent = 'ì»¤ë„ ìƒíƒœ: ë¹„í™œì„±';
                    displayElement.style.color = '#a0aec0';
                }
            }
        }
    })
    .catch(error => {
        // console.error('ëª¨ë“  ì»¤ë„ ì •ë¦¬ ì‹¤íŒ¨:', error);
    });
}

// ìƒˆë¡œìš´ í•¨ìˆ˜: ì„œë²„ì—ì„œ ì§ì ‘ ì»¤ë„ ëª©ë¡ ê°€ì ¸ì™€ì„œ ë³´ì—¬ì£¼ê¸°
function updateKernelList() {
    // ì¼ë°˜ ì»¤ë„ ëª©ë¡ë§Œ ê°€ì ¸ì˜¤ê¸° (íŒŒì¼-ì»¤ë„ ë§¤í•‘ ê¸°ë°˜)
    fetch('/api/kernels/file-mappings')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const projectKernelsList = document.getElementById('projectKernelsList');
                const kernelEntries = Object.entries(data.mappings || {});
                
                if (kernelEntries.length > 0) {
                    projectKernelsList.innerHTML = kernelEntries.map(([filePath, kernelId]) => {
                        const fileName = filePath.split('/').pop();
                        return `<div style="margin-bottom: 0.3rem; padding: 0.3rem; background: #4a5568; border-radius: 4px; border-left: 3px solid #718096;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <span style="color: #e2e8f0; font-weight: bold; font-size: 0.85rem;">${fileName}</span>
                                    <span style="color: #a0aec0; font-size: 0.65rem; margin-left: 0.5rem;">${kernelId}</span>
                                </div>
                                <button onclick="shutdownKernelById('${kernelId}')" style="background: #e53e3e; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.4rem; font-size: 0.65rem; cursor: pointer;">ì¢…ë£Œ</button>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    projectKernelsList.innerHTML = 'ì—†ìŒ';
                }
            } else {
                document.getElementById('projectKernelsList').innerHTML = 'ì»¤ë„ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        })
        .catch(error => {
            document.getElementById('projectKernelsList').innerHTML = 'ì»¤ë„ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        });
}


</script> 